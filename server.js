const chalk=require("chalk"),log=console.log,URL_API="https://dinogen-account-us.wilkingames.net/api/";var settings=require("./settings.json"),stats=require("./stats.json"),gameInstance=require("./assets/js/game");const GameUtil={RandomId:()=>Math.random().toString(36).substring(2,10),FormatNum:e=>isNaN(e)||null==e?"0":e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),ConvertToTimeString:e=>{var a=(e=Math.max(0,Math.ceil(e)))%60,t=Math.floor(e%3600/60),r=Math.floor(e/3600);function s(e){return e<10?"0"+e:String(e)}return(0==r?"":s(r)+":")+(s(t)+":")+s(a)}},MathUtil={Random:(e,a)=>Math.floor(Math.random()*(a-e+1))+e,RandomBoolean:()=>Math.random()>=.5},EventUtil={IsHalloween:()=>{var e=new Date(Date.now());return 9==e.getMonth()&&31==e.getDate()},IsChristmas:()=>{var e=new Date(Date.now());return 11==e.getMonth()&&25==e.getDate()},IsFriday13th:()=>{var e=new Date(Date.now());return 13==e.getDate()&&5==e.getDay()},IsGoodFriday:()=>{var e=new Date(Date.now());return 4==e.getMonth()&&e.getDate()>=7&&e.getDate()<=8},IsThanksgiving:()=>{var e=new Date(Date.now());return 10==e.getMonth()&&e.getDate()>=24&&e.getDate()<28}},ServerData={VERSION:"1.0.2",GAME_VERSION:"1.0.4"},Lobby={COUNTDOWN_INTERMISSION:30,COUNTDOWN_PREPARING:30,COUNTDOWN_STARTING:3,COUNTDOWN_END:15,JOIN_SUCCESS:"LOBBY_JOIN_SUCCESS",JOIN_FAIL_LOCKED:"JOIN_FAIL_LOCKED",JOIN_FAIL_CAPACITY:"JOIN_FAIL_CAPACITY",JOIN_FAIL_ERROR:"JOIN_FAIL_ERROR",MAX_PLAYERS:12,TYPE_ALL:"all",TYPE_STANDARD:"standard",TYPE_SURVIVAL:"survival",TYPE_SCENARIO:"scenario",REASON_KICKED:"kicked",REASON_CLIENT_QUIT:"client_quit",REASON_LEAVE:"leave",REASON_PARTY_HOST_LEAVE:"party_host_leave",REASON_LOBBY_REMOVED:"lobby_removed"},LobbyState={INTERMISSION:"intermission",WAITING_HOST:"waiting_host",WAITING:"waiting",PREPARING:"preparing",STARTING:"starting",IN_PROGRESS:"in_progress"},GameMode={RANDOM:"random",SCENARIO:"scenario",FREE_FOR_ALL:"deathmatch",TEAM_DEATHMATCH:"team_deathmatch",DOMINATION:"domination",CONQUEST:"conquest",TYRANT:"tyrant",EVOLUTION:"evolution",RAPTOR_HUNT:"raptor_hunt",HUMANS_VS_DINOSAURS:"humans_vs_dinosaurs",DESTRUCTION:"destruction",CAPTURE_THE_FLAG:"capture_the_flag",SURVIVAL_CHAOS:"survival_chaos",SURVIVAL_DINO:"survival_dino",SURVIVAL_MILITIA:"survival_militia",SURVIVAL_ZOMBIE:"survival_zombie",SURVIVAL_CHICKEN:"survival_chicken"},Map={RANDOM:"map_random",RIVERSIDE:"map_riverside",COMPLEX:"map_complex",DISTRICT:"map_district",SANDSTORM:"map_sandstorm",HEXAGON:"map_hexagon",FIRING_RANGE:"map_firing_range",FIELD:"map_field",CAMPSITE:"map_campsite",VILLA:"map_villa",LABORATORY:"map_laboratory",OASIS:"map_oasis",COMPOUND:"map_compound"},BotSkill={AUTO:-1,EASY:0,NORMAL:1,HARD:2,INSANE:3,GOD:4},GameServer={EVENT_ERROR:0,EVENT_BATCH:1,EVENT_GAME_INIT:2,EVENT_GAME_TIMER:3,EVENT_GAME_PRE_TIMER:4,EVENT_GAME_START:5,EVENT_GAME_END:6,EVENT_GAME_UPDATE:7,EVENT_PLAYER_JOIN:8,EVENT_PLAYER_LEAVE:9,EVENT_PLAYER_UPDATE:10,EVENT_SPAWN_CHARACTER:11,EVENT_OBJECT_UPDATE:12,EVENT_PLAYER_INPUT:13,EVENT_PLAYER_TRIGGER_WEAPON:14,EVENT_PAWN_DAMAGE:19,EVENT_PAWN_DIE:20,EVENT_PAWN_ACTION:21,EVENT_PLAYER_MULTI_KILL:35,EVENT_PLAYER_INTERACT:38,EVENT_PLAYER_UPDATE_INVENTORY:39,EVENT_PLAYER_TRIGGER_EQUIPMENT:41,EVENT_PLAYER_TRIGGER_GRENADE:43,EVENT_KILLFEED_ADD:45,EVENT_MESSAGE_ADD:46,EVENT_SPAWN_OBJECT:47,EVENT_SPAWN_BULLET:48,EVENT_SPAWN_EXPLOSION:49,EVENT_GAME_PAUSE:50,EVENT_REMOVE_OBJECT:61,PAWN_FIRE_WEAPON:1,PAWN_HIT_SHIELD:2,PAWN_START_REVIVE:3,PAWN_END_REVIVE:4,PAWN_SHARED_CRATE:5,PAWN_STOLE_CRATE:6,PAWN_START_INTERACTION:7,PAWN_NO_AMMO:8,PAWN_OPEN_LAPTOP:9,PAWN_ON_FIRE:10,PAWN_STUN:11,PAWN_FLASH:12,PAWN_FREEZE:13,PAWN_SET_JAMMED:14,PAWN_UPDATE_DOOR:15,PAWN_INVESTIGATE:16,PAWN_TROPHY_HIT:17,PAWN_START_SHIELD_COOLDOWN:18,PAWN_END_SHIELD_COOLDOWN:19,PAWN_END_FIRE_DELAY:20,PAWN_END_BOLT_DELAY:21,PAWN_END_THROW_DELAY:22,PAWN_END_EQUIPMENT_DELAY:23,PAWN_END_MELEE_DELAY:24,PAWN_RELOAD_COMPLETE:25,PAWN_CLOSE_LAPTOP:26,PAWN_START_FLAME:27,PAWN_END_FLAME:28,PAWN_RELOAD:29,PAWN_PULL_BOLT:30,PAWN_CANCEL_RELOAD:31,PAWN_CANCEL_BOLT_PULL:32,PAWN_THROW_GRENADE:33,PAWN_USE_STIM:34,PAWN_RECEIVE_STIM:35,PAWN_PLACE_EQUIPMENT:36,PAWN_MELEE_ATTACK:37,PAWN_FIRE_MELEE:38,PAWN_FIRE_ROCKET:39,PAWN_TRIGGER_MINE:40,PAWN_END_INTERACTION:41,PAWN_JUMP:42,PAWN_ON_BOOST:43,PAWN_START_LADDER_CLIMB:44,PAWN_LEAVE_LADDER:45,PAWN_DROP_CRATE:46,PAWN_FLAG:47,PAWN_HIT:48,PAWN_VEHICLE_START:49,PAWN_VEHICLE_LEAVE:50,INV_CLASS_DATA:1,INV_CURRENT_INVENTORY_INDEX:2,INV_FIRE:3,INV_PERK_ADD:4,INV_PERKS:5,INV_PERKS_SET:6,INV_MOD_SET:7,INV_EQUIPMENT_SET:8,INV_EQUIPMENT_ADD:9,INV_AMMO:10,INV_AMMO_ADD:11,INV_MAG:12,INV_MAG_ADD:13,INV_BURSTS:14,INV_BURSTS_ADD:15,INV_ITEM:16,INV_ITEM_ADD:17,INV_ITEM_REPLACE:18,INV_INVENTORY_REPLACE:19,INV_INVENTORY:21,INV_EQUIPMENT:22},Character={INDEX_MELEE:2,INDEX_EQUIPMENT:3,INDEX_GRENADE:4,STYLE_DINOGEN:"dinogen",STYLE_MILITIA:"militia",STYLE_JUGGERNAUT:"juggernaut",HAIR_COLOUR_BROWN:"HAIR_COLOUR_BROWN",HAIR_COLOUR_BROWN_LIGHT:"HAIR_COLOUR_BROWN_LIGHT",HAIR_COLOUR_BLACK:"HAIR_COLOUR_BLACK",HAIR_COLOUR_BLONDE:"HAIR_COLOUR_BLONDE",HAIR_COLOUR_GINGER:"HAIR_COLOUR_GINGER",HAIR_COLOUR_GREY:"HAIR_COLOUR_GREY",HAIR_COLOUR_WHITE:"HAIR_COLOUR_WHITE",HAIR_COLOUR_RED:"HAIR_COLOUR_RED",HAIR_COLOUR_BLUE:"HAIR_COLOUR_BLUE",HAIR_COLOUR_GREEN:"HAIR_COLOUR_GREEN",FACE_DEFAULT:"face0000",FACE_TAN:"face0001",FACE_DARK:"face0002",FACE_FEMALE:"face0009",FACE_ZOMBIE_1:"face0003",FACE_ZOMBIE_2:"face0004",FACE_ZOMBIE_3:"face0005",FACE_ZOMBIE_4:"face0006",FACE_ZOMBIE_FAT:"face0007",FACE_ZOMBIE_EXPLODER:"face0008",FACE_ZOMBIE_SPITTER:"face0009",FACE_ZOMBIE_SPRINTER:"face0010",FACE_ZOMBIE_SPRINTER_BOSS:"face0011",FACE_INFESTOR:"face00012",HAIR_SHORT:"hair0000",HAIR_BALD:"hair0008",HAIR_LONG:"hair0002",HAIR_PONYTAIL:"hair0003",HAIR_UNDERCUT:"hair0006",HAIR_SPIKES:"hair0005",HAIR_BUZZED:"hair0004",HAIR_FLAT:"hair0001",HAIR_STYLED:"hair0007",HAIR_HORSESHOE:"hair0009",HAIR_MOHAWK:"hair0010",BEARD_NONE:"beard0000",BEARD_STUBBLE:"beard0001",BEARD_FULL:"beard0002",BEARD_CIRCLE:"beard0003",BEARD_GOATEE:"beard0004",BEARD_MOUSTACHE:"beard0005",BEARD_SIDEBURNS:"beard0006",EYEWEAR_NONE:"eyewear0000",EYEWEAR_SHADES:"eyewear0001",EYEWEAR_GLASSES:"eyewear0002",EYEWEAR_GOGGLES_YELLOW:"eyewear0003",EYEWEAR_GOGGLES_ORANGE:"eyewear0004",EYEWEAR_GOGGLES_WHITE:"eyewear0005",EYEWEAR_GOGGLES_BLACK:"eyewear0006",FACEWEAR_NONE:"facewear0000",FACEWEAR_MASK:"facewear0001",FACEWEAR_SKULLMASK:"facewear0002",FACEWEAR_GHILLIE:"facewear0003",FACEWEAR_SCARF_OPFOR:"facewear0004",FACEWEAR_BALACLAVA:"facewear0005",FACEWEAR_SCARF_SPETSNAZ:"facewear0006",FACEWEAR_BANDANA:"facewear0007",FACEWEAR_GAS_MASK:"facewear0008",FACEWEAR_BANDANA_GENERIC:"facewear0009",FACEWEAR_GAITER:"facewear0010",FACEWEAR_TWOPLAYER:"facewear0019",HEAD_ERIC_HELMET:"head0082",HEAD_AETIC:"head0089",HEAD_NONE:"head0000",HEAD_MASK:"head0001",HEAD_GAS_MASK:"head0002",HEAD_RADIO:"head0003",HEAD_US_MASK:"head0004",HEAD_US_CAP:"head0005",HEAD_US_CAP_BACKWARDS:"head0006",HEAD_US_SPEC_OPS:"head0007",HEAD_US_HELMET:"head0008",HEAD_US_HELMET_TACTICAL:"head0009",HEAD_US_BOONIE:"head0010",HEAD_US_GHILLIE:"head0011",HEAD_GIGN_HELMET:"head0012",HEAD_GIGN_HELMET_2:"head0013",HEAD_GIGN_CAP:"head0014",HEAD_GSG9_HELMET:"head0015",HEAD_GSG9_HELMET_2:"head0016",HEAD_GSG9_HELMET_3:"head0017",HEAD_OPFOR_SCARF:"head0018",HEAD_OPFOR_HELMET:"head0019",HEAD_OPFOR_HELMET_2:"head0020",HEAD_OPFOR_BERET:"head0021",HEAD_OPFOR_SHADES:"head0022",HEAD_OPFOR_COMMANDER:"head0023",HEAD_RU_MASK:"head0024",HEAD_RU_HAT:"head0025",HEAD_RU_SCARF:"head0026",HEAD_RU_TOQUE:"head0027",HEAD_RU_BERET:"head0028",HEAD_RU_CAP:"head0029",HEAD_RU_RECON:"head0030",HEAD_RU_HELMET:"head0031",HEAD_MILITIA_RADIO:"head0032",HEAD_MILITIA_BAND:"head0033",HEAD_MILITIA_BANDANA:"head0034",HEAD_MILITIA_CAP:"head0035",HEAD_MILITIA_SNIPER:"head0036",HEAD_JUGGERNAUT_HELMET:"head0037",HEAD_RIOT_HELMET:"head0055",HEAD_RIOT_HELMET_VISOR_UP:"head0056",HEAD_UN_BERET:"head0057",HEAD_UN_HELMET:"head0058",HEAD_NIGHTVISION:"head0059",HEAD_ALTYN_HELMET:"head0060",HEAD_ALTYN_HELMET_VISOR_UP:"head0061",HEAD_HOOD:"head0062",HEAD_BALLISTIC_MASK_BLACK:"head0045",HEAD_BALLISTIC_MASK_WHITE:"head0046",BODY_DINOGEN:"body0000",BODY_MILITIA:"body0001",BODY_DINOGEN_RIG:"body0003",BODY_DINOGEN_HEAVY:"body0006",BODY_MILITIA_RIG:"body0004",BODY_MILITIA_HEAVY:"body0007",BODY_JUGGERNAUT:"body0002",BODY_SHIRTLESS:"body0005"};log(chalk.bgBlue("Dinogen Online | Multiplayer Server | "+ServerData.VERSION+" | Game Version: "+ServerData.GAME_VERSION));var serverStartTime=Date.now();log("Started:",new Date(serverStartTime).toString()),log(settings,"\n"),log(chalk.yellow("Loading modules..."));const{exec:exec}=require("child_process"),fs=require("fs"),cors=require("cors"),express=require("express"),app=express(),server=require("http").Server(app),customParser=require("socket.io-json-parser"),{Server:Server}=require("socket.io"),io=new Server(server,{parser:customParser,cors:{origin:"*",methods:["GET","POST"]}}),os=require("os-utils"),{RateLimiterMemory:RateLimiterMemory}=require("rate-limiter-flexible"),chatLimiter=new RateLimiterMemory({points:5,duration:5}),updateLimiter=new RateLimiterMemory({points:60,duration:1}),fetch=require("node-fetch"),smile=require("smile2emoji"),p2=require("p2"),astar=require("javascript-astar"),shared=require("./assets/json/shared.json"),bots=require("./assets/json/bots.json"),sprites=require("./assets/json/sprites.json"),weapons_world=require("./assets/images/world/atlas_weapons_world.json"),weapons=require("./assets/json/weapons.json"),items=require("./assets/json/items.json"),vehicles=require("./assets/json/vehicles.json"),mods=require("./assets/json/mods.json"),modes=require("./assets/json/modes.json"),maps=require("./assets/json/maps.json");for(var allMaps=[],i=0;i<maps.length;i++){let e=maps[i].id;try{allMaps.push(require("./assets/json/maps/"+e+".json"))}catch(a){console.warn("Missing map:",e)}}log("Loaded",allMaps.length,"maps"),log(chalk.green("Done"));var dummyTimeout,chatHistory=[];function incrementStat(e){if(stats||(stats={}),null==stats[e]&&(stats[e]=0),stats[e]++,settings.bPersistentStats)try{let e=JSON.stringify(stats);fs.writeFile("stats.json",e,(e=>{e&&console.warn(e)}))}catch(e){console.warn(e)}}function addReportedPlayer(e,a){if(stats&&e&&a){stats.reported||(stats.reported=[]);var t={id:getRandomUniqueId(),reported:{username:e.username,steamId:e.steamId},reporter:{username:a.username,steamId:a.steamId},date:Date.now()};if(stats.reported.push(t),settings.bPersistentStats){let e=JSON.stringify(stats);fs.writeFile("stats.json",e,(e=>{e&&console.warn(e)}))}return t.id}}function clearStats(){stats={},log("Stats cleared")}app.use(express.static(__dirname+"/public_html")),app.use(cors({origin:"*"})),app.get("/",((e,a)=>{var t="<head>";t+="<title>[Dinogen Online] "+settings.name+"</title></head><body><h1>Dinogen Online</h1><h3>MULTIPLAYER SERVER</h3>",t+="<link href='/styles/server.css' rel='stylesheet'>",t+="<b>"+getNumClients()+"</b> online | <b>"+getNumRealClients()+"</b> players",t+="<hr>";var r=convertMS(Date.now()-serverStartTime);t+="<b>Uptime:</b> "+r.day+"d "+r.hour+"h "+r.minute+"m "+r.seconds+"s<br>",t+="<b>Server Version:</b> "+ServerData.VERSION+"<br>",t+="<b>Required Game Version:</b> "+ServerData.GAME_VERSION,t+="<hr>";for(var s=Object.keys(stats),o=0;o<s.length;o++){var n;t+="<b>"+(n=s[o])+":</b> "+stats[n],o<s.length-1&&(t+="<br>")}var i=getClients();if(i.length>0){t+="<hr>",t+="<div><table style='width:100%'><tr><th>Index</th><th>Username</th><th>Name</th><th>Steam ID</th><th>Status</th><th>Time Online</th><th>Ping</th></tr>";for(let e=0;e<i.length;e++){let a=i[e];if(a){t+="<tr><td>"+e+"</td>",t+="<td>"+(a.username?"<a href='https://dinogenonlinedata.w3spaces.com/data.html?uname="+a.username+"'>"+a.username+"</a>":"-")+(a.bAdmin?" [ADMIN]":"")+"</td>",t+="<td>"+(a.name?a.name:"-")+"</td>",t+="<td>"+(a.steamId?"<a href='https://steamcommunity.com/profiles/"+a.steamId+"'>"+a.steamId+"</a>":"-")+"</td>",t+="<td>",t+=a.bInGame?a.gameModeId?a.gameModeId+" on "+a.mapId:"In Game":a.menu?a.menu:"-",t+="</td>",t+="<td>",t+=a.date?GameUtil.ConvertToTimeString((Date.now()-a.date)/1e3):"-",t+="</td>",t+="<td>",a.bBot?t+="Bot":null!=a.ping?t+=a.ping+" ms":t+="-",t+="</td>",t+="</tr>"}}}t+="</body>",a.send(t)})),app.get("/data",((e,a)=>{var t={time:Date.now(),name:settings.name,country:settings.country,numPlayers:getNumClients(),maxPlayers:settings.maxPlayers,type:settings.type};a.send(t)})),app.get("/stats",((e,a)=>{a.send(stats)})),app.get("/settings",((e,a)=>{a.send(settings)})),io.on("connection",(e=>{if(getNumClients()>=settings.maxPlayers)return e.emit("showWindow",{id:"mp_max_players",titleText:"STR_MULTIPLAYER",messageText:"STR_SERVER_FULL_DESC",type:"TYPE_MESSAGE",bShowOkayButton:!0}),void disconnectSocket(e,{reason:"max_players"});log(chalk.cyan(e.id),chalk.green("Connected")),incrementStat("playersConnected"),e.player={id:e.id.substr(2,6),name:"Player",level:0,date:Date.now()};var a={name:settings.name,url:settings.url,country:settings.country,port:settings.port,type:settings.type};e.emit("updateServer",a),e.emit("chatHistory",chatHistory),settings.welcome&&sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:settings.welcome}),e.on("ping",(e=>{"function"==typeof e&&e()})),e.on("vote",(a=>{log(chalk.cyan(e.id),"vote",a);var t=getLobbyData(e.player.lobbyId);if(t){var r=t.votes;if(r){for(var s=-1,o=0;o<r.length;o++){var n=r[o];if((s=n.players.indexOf(e.player.id))>=0){var i=o;n.players.splice(s,1)}}if(i!=a){var l=r[a];l&&l.players.push(e.player.id)}io.to(t.id).emit("updateLobby",{votes:getClientVotes(r)})}}})),e.on("createCustomLobby",(()=>{log(chalk.cyan(e.id),"create custom lobby");var a=createCustomLobby();a&&(joinLobby(e.player,a.id),sendChatMessageToAll({bServer:!0,locText:"STR_SERVER_X_CREATED_CUSTOM_LOBBY",params:[e.player.name]}),incrementStat("customLobbiesCreated")),emitLobbyChange()})),e.on("join",(a=>{if(log(chalk.cyan(e.id),"join",a),!e.player.lobbyId)if(a)if(a.lobbyId){var t=getLobbyData(a.lobbyId);t&&(canJoinLobby(t.id,e,a.type)==Lobby.JOIN_SUCCESS||e.player.bAdmin)?joinLobby(e.player,t.id):t?e.emit("showWindow",{titleText:"STR_CUSTOM_GAME",messageText:"STR_CUSTOM_LOBBY_LOCKED_DESC",bShowOkayButton:!0}):e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_LOBBY_NON_EXISTANT_DESC",messageParams:[a.lobbyId],highlights:[a.lobbyId],bShowOkayButton:!0})}else a.gameModeId;else{var r=getBestLobby(e.player);r&&canJoinLobby(r.id,e)==Lobby.JOIN_SUCCESS&&joinLobby(e.player,r.id)}})),e.on("leaveLobby",(function(){var a=e.player.lobbyId;if(a)if(log(e.id,"Wants to leave lobby",chalk.bgCyan(a)),getLobbyData(a)){leaveLobby(e.player,Lobby.REASON_LEAVE)}else console.warn("socket.on(leaveLobby) --\x3e Lobby doesn't exist:",e.player.lobbyId),e.player.lobbyId&&leaveLobby(e.player,Lobby.REASON_LEAVE)})),e.on("requestQuit",(()=>{var a=e.player.lobbyId;log(e.player.id,"Request quit in lobby",chalk.bgCyan(a)),(t=getParty(e.player.partyId))&&t.hostPlayerId!=e.player.id&&removePlayerFromParty(e);var t,r=getLobbyData(a);r?r.bCustom?r.hostPlayerId==e.player.id?(setLobbyState(a,LobbyState.WAITING_HOST),io.to(a).emit("updateLobby",getClientLobbyData(r))):leaveLobby(e.player,Lobby.REASON_CLIENT_QUIT):((t=getParty(e.player.partyId))&&t.hostPlayerId==e.player.id&&t.players.length>1&&removePlayerFromParty(e),leaveLobby(e.player,Lobby.REASON_CLIENT_QUIT)):disconnectSocket(e,{reason:Lobby.REASON_CLIENT_QUIT})})),e.on("lobbies",(a=>{var t=getLobbyListForSocket(e);e.emit("lobbies",t)})),e.on("clearStats",(a=>{e.player.bAdmin&&(clearStats(),sendChatMessageToAll({bServer:!0,messageText:"Server stats have been reset."}))})),e.on("banPlayer",(a=>{if(log(e.id,"wants to ban",a),e.player.bAdmin)if(isBanned(a))log("Already added to banned list");else{settings.banned.push(a);let e=JSON.stringify(settings,null,"\t");fs.writeFile("settings.json",e,(e=>{e?console.warn(e):(log("Data written to file"),sendChatMessageToAll({bServer:!0,bCritical:!0,messageText:a+" has been banned from the server."}))}));let t=getSocketByUsername(a);t&&(t.disconnect(),disconnectSocket(t,{reason:Lobby.REASON_KICKED}))}else console.warn("Insufficient privileges")})),e.on("kickPlayer",(a=>{log(e.id,"wants to kick",a);var t=getLobbyData(e.player.lobbyId);if(t){if(e.player.bAdmin||e.player.bLobbyHost)for(var r=0;r<t.players.length;r++){let s=t.players[r];if(s.id==a){s.bAdmin?sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTEKICK_ADMIN"}):leaveLobby(s,Lobby.REASON_KICKED);break}}}else if(e.player.bAdmin){var s=getSocketByPlayerId(a);s&&disconnectSocket(s,{reason:Lobby.REASON_KICKED})}})),e.on("kickIdlePlayers",(()=>{if(log(e.id,"wants to kick idle players"),e.player.bAdmin||e.player.bLobbyHost){var a=getLobbyData(e.player.lobbyId);a&&kickIdlePlayers(a)}})),e.on("reportPlayer",(a=>{log(e.id,"wants to report",a);getSocketByPlayerId(a)})),e.on("chat",(a=>{if(e.player)try{e.player.bAdmin?handleChatMessage(e,a):chatLimiter.consume(e.id).then((()=>{handleChatMessage(e,a)})).catch((a=>{sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:"You've sent too many messages."})}))}catch(e){console.warn("Error while sending chat message:",e)}})),e.on("update",(a=>{(a.steamId||a.username)&&fetch(URL_API+"isBanned?username="+(a.steamId?a.steamId:a.username)).then((a=>{a.json().then((a=>{a.bBanned?(log(chalk.red("Player is banned")),e.emit("showWindow",{id:"mp_banned",titleText:"STR_MULTIPLAYER",messageText:"STR_BANNED_DESC",type:"TYPE_MESSAGE",bShowOkayButton:!0}),disconnectSocket(e,{reason:"banned"})):log(chalk.green("Player is not banned"))}))})),updateLimiter.consume(e.id).then((()=>{updatePlayerData(e,a)})).catch((e=>{console.warn("Exceeded update limiter")}))})),e.on("latency",(a=>{e.player.ping=a;var t=getLobbyData(e.player.lobbyId);t&&t.game&&t.game.setPlayerPing(e.player.id,e.player.ping)})),e.on("startGame",(()=>{log(chalk.cyan(e.id),"start game");var a=getLobbyData(e.player.lobbyId);a&&a.state!=LobbyState.STARTING&&setLobbyState(e.player.lobbyId,LobbyState.STARTING)})),e.on("cancelGame",(()=>{log(chalk.cyan(e.id),"cancel game");var a=getLobbyData(e.player.lobbyId);a&&a.state==LobbyState.STARTING&&setLobbyState(e.player.lobbyId,a.bCustom?LobbyState.WAITING_HOST:LobbyState.WAITING)})),e.on("stopGame",(()=>{log(chalk.cyan(e.id),"stop game");var a=getLobbyData(e.player.lobbyId);a&&e.player.bAdmin&&setLobbyState(a.id,a.bCustom?LobbyState.WAITING_HOST:LobbyState.WAITING)})),e.on("setPlayerTeam",(a=>{log(chalk.cyan(e.id),a);var t=getSocketByPlayerId(a.id);if(t){t.player.desiredTeam=a.team;var r=getLobbyData(e.player.lobbyId);r&&io.to(r.id).emit("updateLobby",{players:r.players})}})),e.on("updateGameSettings",(a=>{if(log(chalk.cyan(e.id),a),a){var t=getLobbyData(e.player.lobbyId);if(t&&(e.player.bAdmin||e.player.bLobbyHost)){void 0!==a.scenario&&t.gameData.scenario&&(log("Resetting all settings"),t.gameData.settings={});for(var r=!1,s=[],o=t.gameData,n=Object.keys(a),i=0;i<n.length;i++){var l=n[i],b=a[l];if("settings"==l)for(var d=Object.keys(a.settings),m=0;m<d.length;m++){var y=d[m],c=a.settings[y];if(o.settings[y]!==c)switch(s.push(y),y){case"bPublic":r=!0,t.bPublic=1==c;break;default:o.settings[y]=c}}else{switch(l){case"scenario":if(b){o.scenario=clone(b);var E=o.scenario;if(E){var _=o.maxPlayers;o.settings=E.settings?E.settings:{},o.tiles=E.tiles?E.tiles:null,t.gameData.maxPlayers=_,o.mapId=E.mapId,o.gameModeId=E.gameModeId?E.gameModeId:GameMode.SCENARIO}else console.warn("Invalid scenario value")}else delete o.scenario,delete o.settings.preGameTimer,delete o.settings.bUseDefaultMapObjects,delete o.tiles;r=!0;break;case"maxPlayers":t.maxPlayers=Math.max(1,Math.min(Lobby.MAX_PLAYERS,b)),o.maxPlayers=t.maxPlayers,r=!0;break;case"bPublic":t.bPublic=1==b,o.bPublic=t.bPublic,r=!0;break;case"gameModeId":if(!getGameMode(b))return void console.warn("Invalid game mode",b)}t.gameData[l]!==b&&s.push(l),t.gameData[l]=b}}var g=getGameMode(t.gameData.gameModeId);t.bTeamSelection=t.bCustom&&(1==g.bTeam||o.settings.bTeam),io.to(t.id).emit("updateLobby",{bTeamSelection:t.bTeamSelection,gameData:t.gameData}),s.length>0&&sendChatMessageToLobby(t.id,{bServer:!0,locText:"STR_SERVER_SETTINGS_CHANGED_X",params:[s.length],changed:s}),r&&emitLobbyChange(t)}}})),e.on("requestEvent",(a=>{var t=getLobbyData(e.player.lobbyId);if(t){var r=t.game;if(r){switch(a.eventId){case GameServer.EVENT_PLAYER_UPDATE:case GameServer.EVENT_PLAYER_TRIGGER_EQUIPMENT:case GameServer.EVENT_PLAYER_TRIGGER_GRENADE:case GameServer.EVENT_PLAYER_TRIGGER_WEAPON:case GameServer.EVENT_PLAYER_INPUT:if(a.playerId){if(a.playerId!=e.player.id&&!e.player.bAdmin)return}else a.playerId=e.player.id}r.requestEvent(a)}}})),e.on("requestRestart",(()=>{log(chalk.cyan(e.id),"request restart");var a=getLobbyData(e.player.lobbyId);a&&(e.player.bAdmin||a.hostPlayerId==e.player.id)&&(setLobbyState(a.id,LobbyState.WAITING),setLobbyState(a.id,LobbyState.STARTING))})),e.on("requestGame",(()=>{log(chalk.cyan(e.id),"request game");var a=getLobbyData(e.player.lobbyId);if(a){var t=a.game;if(t&&t.bInit){var r=[];r.push(t.getInitEventData()),t.addPlayer(clone(e.player)),r.push(t.getGameModeEventData());for(var s=t.getPlayers(),o=0;o<s.length;o++){var n=s[o];n.id!=e.player.id&&r.push({eventId:GameServer.EVENT_PLAYER_JOIN,player:clone(n),bSilent:!0})}t.matchInProgress()&&r.push(t.getGameStartEventData());var i=t.getObjectsEventData();for(o=0;o<i.length;o++)r.push(i[o]);log(r.length,"events"),e.emit("gameEvent",{eventId:GameServer.EVENT_BATCH,lobbyId:a.id,items:r})}e.player.bReady=!0,a.gameData.scenario&&checkLobbyReady(a);var l=a.players;if(l.length>a.maxPlayers){log("Remove a bot...");for(o=0;o<l.length;o++){let e=l[o];if(e.bBot){log(o,e.name),leaveLobby(e,Lobby.REASON_KICKED);break}}}}})),e.on("requestChat",(()=>{e.emit("receiveChat",history)})),e.on("disconnect",(()=>{log(chalk.cyan(e.id),chalk.red("Disconnected")),leaveLobby(e.player,e.disconnectReason),io.emit("playerDisconnected",e.player.id)}))}));var minDummies=5,maxDummies=25,dummies=[],lobbies=[];if(createPublicLobby(Lobby.TYPE_ALL),createPublicLobby(Lobby.TYPE_STANDARD),createPublicLobby(Lobby.TYPE_SURVIVAL),!settings.bDisableDummies){var numDummies=MathUtil.Random(minDummies,maxDummies);for(i=0;i<numDummies;i++)addDummy(MathUtil.Random(0,3),bots[MathUtil.Random(0,bots.length-1)]);startDummyAutomation()}function startDummyAutomation(){dummyTimeout=setTimeout((()=>{var e=dummies[MathUtil.Random(0,dummies.length-1)];dummies.length<=minDummies?addDummy(MathUtil.Random(BotSkill.EASY,BotSkill.INSANE),bots[MathUtil.Random(0,bots.length-1)]):dummies.length>=maxDummies||MathUtil.RandomBoolean()?removeDummy(e):addDummy(MathUtil.Random(BotSkill.EASY,BotSkill.INSANE),bots[MathUtil.Random(0,bots.length-1)]),startDummyAutomation()}),3e4)}function stopDummyAutomation(){log("Stop dummy automation"),dummyTimeout&&clearTimeout(dummyTimeout)}function addDummy(e,a){var t=getBot(e);t.bDummy=!0,t.id=getRandomUniqueId(),t.name=(a||"Server Bot")+MathUtil.Random(1,999),t.latency=MathUtil.Random(10,100),t.classes=clone(shared.classes);var r=[Character.FACE_DEFAULT,Character.FACE_DEFAULT,Character.FACE_DEFAULT,Character.FACE_DEFAULT,Character.FACE_TAN,Character.FACE_DARK];t.classes.assault.avatar.dinogen.face=r[MathUtil.Random(0,r.length-1)];var s=[Character.HAIR_BALD,Character.HAIR_SHORT,Character.HAIR_LONG,Character.HAIR_MOHAWK,Character.HAIR_PONYTAIL,Character.HAIR_STYLED,Character.HAIR_UNDERCUT,Character.HAIR_HORSESHOE];t.classes.assault.avatar.dinogen.hair=s[MathUtil.Random(0,s.length-1)];var o=[Character.HAIR_COLOUR_BROWN,Character.HAIR_COLOUR_BROWN_LIGHT,Character.HAIR_COLOUR_BLACK,Character.HAIR_COLOUR_BLONDE,Character.HAIR_COLOUR_GINGER];t.classes.assault.avatar.dinogen.hairColour=o[MathUtil.Random(0,o.length-1)];var n=[Character.FACEWEAR_NONE,Character.FACEWEAR_NONE,Character.FACEWEAR_NONE,Character.FACEWEAR_NONE,Character.FACEWEAR_GAITER,Character.FACEWEAR_MASK,Character.FACEWEAR_BALACLAVA];t.classes.assault.avatar.dinogen.facewear=n[MathUtil.Random(0,n.length-1)];var i=[Character.HEAD_NONE,Character.HEAD_US_HELMET,Character.HEAD_US_HELMET_TACTICAL,Character.HEAD_OPFOR_HELMET,Character.HEAD_OPFOR_HELMET_2];return t.classes.assault.avatar.dinogen.head=i[MathUtil.Random(0,i.length-1)],t.classes.preferredClass="assault",dummies.push(t),io.emit("playerConnected",t),t}function removeDummy(e){var a=dummies.indexOf(e);a>=0&&(dummies.splice(a,1),io.emit("playerDisconnected",e.id))}async function createPublicLobby(e){var a={gameModeId:GameMode.FREE_FOR_ALL,mapId:Map.RANDOM,settings:{timeLimit:10,scoreLimit:100,allowFactions:"all",respawnTime:5,bSpawnProtection:!0,bMapVehicles:!0,bMapObjects:!0,bMapWeapons:!0,bots:8,botSkill:BotSkill.AUTO,botFaction:"all",updateRate:60}},t=12;switch(e){case Lobby.TYPE_ALL:case Lobby.TYPE_STANDARD:break;case Lobby.TYPE_SURVIVAL:case Lobby.TYPE_SCENARIO:t=8;break;default:console.warn("Unsupported lobby type:",e),e=Lobby.TYPE_ALL}var r={id:getRandomUniqueId(),bPublic:!0,type:e,state:LobbyState.WAITING,players:[],maxPlayers:t,chat:[],gameData:a};switch(a.maxPlayers=r.maxPlayers,settings.bAllowVotes&&initVotes(r),lobbies.push(r),e){case Lobby.TYPE_SCENARIO:a.bots=0;break;default:setLobbyState(r.id,LobbyState.STARTING)}return emitLobbyChange(),r}function createCustomLobby(){var e={gameModeId:GameMode.FREE_FOR_ALL,mapId:Map.RANDOM,settings:{timeLimit:10,scoreLimit:100,respawnTime:5,allowFactions:"all",bSpawnProtection:!0,bMapVehicles:!0,bMapObjects:!0,bMapWeapons:!0,bHardcore:!1,bUnlimitedAmmo:!1,bots:0,botTeam:BotSkill.AUTO,botSkill:0,botFaction:"all",updateRate:60}},a={id:getRandomUniqueId(),bPublic:!0,bCustom:!0,bTeamSelection:!1,state:LobbyState.WAITING_HOST,players:[],maxPlayers:Lobby.MAX_PLAYERS,chat:[],gameData:e};return lobbies.push(a),a}function triggerServerInfo(e){if(MathUtil.RandomBoolean())switch(MathUtil.Random(0,4)){case 0:var a="STR_SERVER_X_GAMES",t=[stats.games?stats.games:0];break;case 1:a="STR_SERVER_X_PLAYER_KILLS",t=[stats.kills?stats.kills:0];break;case 2:a="STR_SERVER_X_DINOSAUR_KILLS",t=[stats.dinoKills?stats.heliKills:0];break;case 3:a="STR_SERVER_X_HELI_KILLS",t=[stats.heliKills?stats.heliKills:0];break;case 4:a="STR_SERVER_X_EGG_KILLS",t=[stats.eggKills?stats.eggKills:0]}else a=settings.info[MathUtil.Random(0,settings.info.length-1)];sendChatMessageToLobby(e,{bServer:!0,locText:a,params:t})}function isTeamGameMode(e){if(modes)for(var a=0;a<modes.length;a++){var t=modes[a];if(t.id==e)return t.bTeam}return!1}function isSurvivalGameMode(e){if(modes)for(var a=0;a<modes.length;a++){var t=modes[a];if(t.id==e)return t.bSurvival}return!1}function removeBotsFromLobby(e){var a=getLobbyData(e);if(a){for(var t=a.players,r=0,s=t.length-1;s>=0;s--){var o=t[s];o.bBot&&!o.bDummy&&(t.splice(s,1),r++)}r>0&&log("Removed",r,"bots from",chalk.bgCyan(e))}}function initVotes(e){switch(e.type){case Lobby.TYPE_SCENARIO:e.votes=[];try{log("Fetching featured scenarios...");var a=[];fetch(URL_API+"getFeaturedScenarios?data=1").then((t=>{log("Retrieved scenarios"),t.json().then((t=>{log("Converted to JSON");var r=t.scenarios;log(r.length,"scenarios");for(var s=0;s<r.length;s++){let e=r[s].scenario;e.settings.bAllowGameModeSelection&&(e.gameModeId=getRandomGameModeId()),e.settings.bAllowMapSelection&&(e.mapId=getRandomMapId()),a.push({id:GameMode.SCENARIO,scenario:e})}shuffleArray(a);for(s=0;s<Math.min(3,a.length);s++){let t=a[s];t.mapId=t.scenario.mapId,t.players=[],e.votes.push(t)}io.to(e.id).emit("updateLobby",{votes:getClientVotes(e.votes)})}))}))}catch(e){console.warn(e)}break;default:e.votes=getVotes(e.type)}}function getVotes(e){var a=[],t=[Map.RIVERSIDE,Map.COMPLEX,Map.DISTRICT,Map.SANDSTORM,Map.FIRING_RANGE,Map.HEXAGON,Map.CAMPSITE,Map.VILLA,Map.LABORATORY,Map.OASIS,Map.COMPOUND],r=[];switch(e){case Lobby.TYPE_SCENARIO:break;case Lobby.TYPE_STANDARD:for(var s=0;s<modes.length;s++){let e=modes[s];e.bSurvival||e.bHidden||r.push({id:e.id})}break;case Lobby.TYPE_SURVIVAL:for(s=0;s<modes.length;s++){let e=modes[s];e.bSurvival&&!e.bHidden&&r.push({id:e.id})}1==MathUtil.Random(1,5)&&r.push({id:GameMode.SURVIVAL_ZOMBIE});break;default:for(s=0;s<modes.length;s++){let e=modes[s];e.bHidden||r.push({id:e.id})}}if(shuffleArray(r),EventUtil.IsHalloween())switch(e){case Lobby.TYPE_ALL:case Lobby.TYPE_SURVIVAL:let e=r[0];e.id=GameMode.SURVIVAL_ZOMBIE,e.bEvent=!0,e.eventText="Halloween Event 🎃"}else if(EventUtil.IsThanksgiving())switch(e){case Lobby.TYPE_ALL:case Lobby.TYPE_SURVIVAL:let e=r[0];e.id=GameMode.SURVIVAL_CHICKEN,e.bEvent=!0,e.eventText="Thanksgiving Event 🦃"}else if(EventUtil.IsGoodFriday())switch(e){case Lobby.TYPE_ALL:case Lobby.TYPE_SURVIVAL:let e=r[0];e.id=GameMode.SURVIVAL_CHICKEN,e.bEvent=!0,e.eventText="Good Friday Event"}else if(EventUtil.IsChristmas())switch(e){case Lobby.TYPE_ALL:case Lobby.TYPE_SURVIVAL:let e=r[0];e.id=MathUtil.RandomBoolean()?GameMode.SURVIVAL_ZOMBIE:GameMode.SURVIVAL_CHICKEN,e.bEvent=!0,e.eventText="Christmas Event 🎄"}else if(EventUtil.IsFriday13th())switch(e){case Lobby.TYPE_ALL:case Lobby.TYPE_SURVIVAL:let e=r[0];e.id=GameMode.SURVIVAL_ZOMBIE,e.bEvent=!0,e.eventText="Friday the 13th"}for(s=0;s<Math.min(3,r.length);s++){let e=r[s];if(e.scenario)e.mapId=e.scenario.mapId;else{let a=MathUtil.Random(0,t.length-1);e.mapId=e.mapId?e.mapId:t[a],t.splice(a,1)}e.players=[],a.push(e)}return a}function getLobbyEvent(e){if(e){var a=e.votes;if(a)for(var t=0;t<a.length;t++){let e=a[t];if(e.bEvent)return e}}return null}function kickIdlePlayers(e){if(e){var a=e.players;if(a){for(var t=0;t<a.length;t++){let e=a[t];e.bBot||e.bReady||leaveLobby(e,Lobby.REASON_KICKED)}checkLobbyReady(e)}}}function resetLobby(e){if(e){delete e.numReady,delete e.numPlayers,resetPlayers(e.players),removeBotsFromLobby(e.id);var a=e.players;if(a){for(var t=0;t<a.length;t++){let e=a[t];e.votekicks&&delete e.votekicks,io.emit("updatePlayer",e)}io.to(e.id).emit("updateLobby",{players:a})}}else console.warn("Invalid lobby reference",e)}async function resetLobbyVotes(e){e.votes&&(initVotes(e),io.to(e.id).emit("updateLobby",{players:e.players,votes:getClientVotes(e.votes)}))}function getClientVotes(e){if(e){var a=clone(e);return a.scenario&&(a.scenario={name:a.scenario.name,desc:a.scenario.desc}),a}return e}function checkLobbyReady(e){try{if(e){for(var a=0,t=getNumRealPlayersInLobby(e.id),r=e.players,s=0;s<r.length;s++){let e=r[s];!e.bBot&&e.bReady&&a++}if(log(a,"of",t,"ready"),e.numReady=a,e.numPlayers=t,io.to(e.id).emit("updateLobby",{numReady:a,numPlayers:t}),a>=t||!t)if(initGame(e,e.gameData)){var o=[],n=e.game;o.push(n.getInitEventData());for(s=0;s<r.length;s++){var i=clone(r[s]);n.addPlayer(i),o.push({eventId:GameServer.EVENT_PLAYER_JOIN,player:i,bSilent:!0})}o.push(n.getGameModeEventData()),io.to(e.id).emit("gameEvent",{eventId:GameServer.EVENT_BATCH,lobbyId:e.id,items:o})}}}catch(e){console.warn(e)}}function resetPlayers(e){if(e){for(var a=0;a<e.length;a++)resetPlayer(e[a]);e.sort((function(e,a){return e.bLobbyHost?-1:a.bLobbyHost?1:e.bPartyHost?-1:a.bPartyHost?1:0}))}}function resetPlayer(e){delete e.bInGame,delete e.team,delete e.bReady}function getNumPlayersOnTeam(e,a){var t=0;if(e)for(var r=e.players,s=0;s<r.length;s++){r[s].team==a&&t++}return t}function getNumRealPlayersInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r=a.players,s=0;s<r.length;s++){let e=r[s];e.bBot&&!e.bDummy||t++}return t}return 0}function getNumRealTeamPlayersInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r={},s=a.players,o=0;o<s.length;o++){var n=s[o];n.bBot&&!n.bDummy||(n.partyId?(r[n.partyId]||t++,r[n.partyId]=!0):t++)}return t}return 0}function setLobbyTeams(e){if(e){var a=e.gameData.gameModeId,t=isTeamGameMode(a);e.gameData.scenario&&(t=t||1==e.gameData.scenario.settings.bTeam);var r=e.gameData.settings,s=e.players;if(s){var o=e.bCustom&&e.state!=LobbyState.IN_PROGRESS;if(!o&&t){s.sort(((e,a)=>e.partyId?a.partyId?e.partyId<a.partyId?-1:e.partyId>a.partyId?1:0:-1:1));for(var n=[],i=[],l=[],b=0;b<s.length;b++){(y=s[b]).partyId&&getNumPlayersInParty(y.partyId)>1?(-1==n.indexOf(y.partyId)&&n.push(y.partyId),y.team=n.indexOf(y.partyId)%2==0?0:1,i.push(y)):l.push(y)}l.sort(((e,a)=>e.prestige<a.prestige?1:e.prestige>a.prestige?-1:e.level<a.level?1:e.level>a.level?-1:0));for(b=0;b<l.length;b++)getNumPlayersOnTeam(e,0)>getNumPlayersOnTeam(e,1)?l[b].team=1:l[b].team=0;(s=i.concat(l)).sort(((e,a)=>e.team<a.team?-1:e.team>a.team?1:0)),e.players=s}var d=e.bTeamSelection||o&&t,m=MathUtil.Random(0,s.length-1);for(b=0;b<s.length;b++){var y=s[b];switch(a){case GameMode.SCENARIO:var c;y.team=0,(c=e.gameData.scenario).settings.bDeathmatch||c.gameModeId==GameMode.FREE_FOR_ALL?y.team=b:e.gameData.settings.bTeam&&null!=y.desiredTeam&&(y.team=y.desiredTeam),!0;break;case GameMode.FREE_FOR_ALL:y.team=b,!0;break;case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_DINO:case GameMode.SURVIVAL_MILITIA:case GameMode.SURVIVAL_ZOMBIE:case GameMode.SURVIVAL_CHICKEN:y.team=0,!0;break;default:o||a==GameMode.TYRANT&&(y.team=b==m?1:0),d?null!=y.desiredTeam?y.team=Math.min(1,y.desiredTeam):y.bBot&&r.botTeam>=0?y.team=r.botTeam:y.team=getBestTeam(s):null==y.team&&(y.team=MathUtil.Random(0,1)),!1}(c=e.gameData.scenario)&&(c.settings.bDeathmatch?y.team=b:c.settings.bTeam&&null!=y.desiredTeam&&(y.team=y.desiredTeam))}s.sort((function(e,a){return e.team<a.team?-1:e.team>a.team?1:0})),io.to(e.id).emit("updateLobby",{players:s})}}else log("Invalid lobby data!")}function getBestTeam(e){if(e){for(var a=[{team:0,num:0},{team:1,num:0}],t=0;t<e.length;t++){var r=e[t];if(null!==r.team){var s=a[r.team];s&&s.num++}}return a.sort((function(e,a){return e.num-a.num})),a[0].team}return 0}function getNumBotsInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r=a.players,s=0;s<r.length;s++){var o=r[s];o.bBot&&!o.bDummy&&t++}return t}return 0}function getNumDummiesInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r=a.players,s=0;s<r.length;s++){r[s].bDummy&&t++}return t}return 0}function getNumPlayersInParty(e){var a=getParty(e);return a?a.players.length:1}function canJoinLobby(e,a,t){var r=getLobbyData(e);if(r){if(!a.player)return Lobby.JOIN_FAIL_ERROR;var s=getNumBotsInLobby(r.id),o=getNumPlayersInParty(a.player.partyId);return r.players.length-s+o>r.maxPlayers?Lobby.JOIN_FAIL_CAPACITY:r.state==LobbyState.STARTING&&r.type!=Lobby.TYPE_SCENARIO?Lobby.JOIN_FAIL_LOCKED:lobbyCanAcceptPlayers(e,o)||a.player.bAdmin||"invite"==t?Lobby.JOIN_SUCCESS:Lobby.JOIN_FAIL_LOCKED}return Lobby.JOIN_FAIL_ERROR}function lobbyCanAcceptPlayers(e,a=1){var t=getLobbyData(e);if(t){if(t.state==LobbyState.STARTING&&t.type!=Lobby.TYPE_SCENARIO)return!1;var r=getNumBotsInLobby(t.id);if(t.players.length-r+a>t.maxPlayers)return!1;if(t.bCustom&&t.gameData&&!t.bPublic)return!1;var s=t.game;return!s||s.canAcceptNewPlayers()}return!1}function joinLobby(e,a){e.lobbyId&&leaveLobby(e,Lobby.REASON_LEAVE);var t=getLobbyData(a);if(t){var r=getSocketByPlayerId(e.id);r&&r.join(a),e.lobbyId=a,e.lobbyType=t.type,e.bCustom=t.bCustom;var s=t.players;s.push(e);var o=t.gameData;if(t.bCustom&&1==s.length)t.hostPlayerId=e.id,e.bLobbyHost=!0,e.team=0;else switch(t.gameData.gameModeId){case GameMode.SCENARIO:if(e.team=0,o.settings.bDeathmatch){for(var n=[],i=0;i<t.maxPlayers;i++)n.push(i);for(i=0;i<s.length;i++){let e=s[i].team;null!=e&&n.splice(n.indexOf(e),1)}e.team=n[0]}break;case GameMode.TYRANT:case GameMode.SURVIVAL_DINO:case GameMode.SURVIVAL_MILITIA:case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_ZOMBIE:case GameMode.SURVIVAL_CHICKEN:e.team=0;break;case GameMode.FREE_FOR_ALL:for(n=[],i=0;i<t.maxPlayers+1;i++)n.push(i);for(i=0;i<s.length;i++){let e=s[i].team;null!=e&&n.splice(n.indexOf(e),1)}e.team=n[0];break;default:var l=[0,0],b=null;for(i=0;i<s.length-1;i++){let a=s[i];null!=a.team&&l[a.team]++,e.partyId&&a.partyId==e.partyId&&(b=a.team)}if(null!=b)e.team=b;else if(l[0]>l[1])e.team=1;else if(l[0]<l[1])e.team=0;else{var d=t.game;e.team=d?d.getNewPlayerDesiredTeam():MathUtil.Random(0,1)}}if(!t.bCustom&&t.state==LobbyState.WAITING&&t.players.length>=1&&setLobbyState(t.id,LobbyState.PREPARING),null==e.team&&(e.team=0),e.desiredTeam=e.team,t.game||delete e.team,log(t.players.length,"in lobby",chalk.bgCyan(t.id),t.bCustom),r){try{r.emit("joinLobby",getClientLobbyData(t))}catch(e){return console.warn(e),void disconnectSocket(r,{reason:"error"})}io.emit("updatePlayer",r.player)}if(io.to(t.id).emit("updateLobby",{players:t.players}),t.game)if(r)(o=t.gameData).scenario&&(o.gameModeId=o.scenario.gameModeId,o.mapId=o.scenario.mapId),r.emit("prepareGame",o),setTimeout((()=>{enterGame(r)}),2e3);else t.game.addPlayer(clone(e));else sendChatMessageToLobby(t.id,{locText:"STR_X_JOINED",params:[e.name]});emitPlayerList(e),!t.bCustom&&getNumRealPlayers(t.players)>=t.maxPlayers&&(hasOpenPublicLobby(t.type)||createPublicLobby(t.type))}}function hasOpenPublicLobby(e){for(var a=0;a<lobbies.length;a++){let t=lobbies[a];if(!t.bCustom&&t.type==e){if(getNumRealPlayers(t.players)<t.maxPlayers)return!0}}return!1}function sendChatMessageToLobby(e,a){var t=getLobbyData(e);t&&(t.chat.length>50&&t.chat.splice(0,1),a.date=Date.now(),t.chat.push(a),io.to(t.id).emit("chat",a))}function sendChatMessageToSocket(e,a){e&&(a.date=Date.now(),e.emit("chat",a))}function sendChatMessageToAll(e,a=!1){e.date=Date.now(),chatHistory.length>=50&&chatHistory.splice(0,1),chatHistory.push(e);for(const[t,r]of io.of("/").sockets)r.player.lobbyId&&!a||r.emit("chat",e)}function enterGame(e){e&&(e.player&&(e.player.bInGame=!0),e.emit("enterGame"))}function removeLobby(e){log("Removing lobby: "+chalk.bgCyan(e));var a=getLobbyData(e);if(a){if(!a.players)return void log("Lobby is already destroyed");a.interval&&clearInterval(a.interval),a.infoInterval&&clearInterval(a.infoInterval);for(var t=a.players,r=t.length-1;r>=0;r--){var s=t[r];log(s.id,s.lobbyId),s?s.lobbyId&&leaveLobby(s,Lobby.REASON_LOBBY_REMOVED):console.warn(r,e,"Invalid player in lobby:",s)}destroyLobbyGame(a.id),index=lobbies.indexOf(a),index>=0&&lobbies.splice(index,1);var o=Object.keys(a);for(r=0;r<o.length;r++)delete a[o[r]];log("Lobby has been removed"),emitLobbyChange()}}function setLobbyState(e,a){var t=getLobbyData(e);if(t){switch(destroyLobbyGame(t.id),delete t.voteskips,delete t.kickTimer,t.timer=-1,t.state=a,t.chat=[],t.interval&&clearInterval(t.interval),t.infoInterval&&clearInterval(t.infoInterval),t.kickInterval&&clearInterval(t.kickInterval),log(chalk.magenta(t.id),t.state),a){case LobbyState.IN_PROGRESS:incrementStat("games");var r=t.gameData;if(r.mapId==Map.RANDOM){var s=[Map.RIVERSIDE,Map.COMPLEX,Map.DISTRICT,Map.SANDSTORM,Map.FIRING_RANGE,Map.HEXAGON];r.mapId=s[MathUtil.Random(0,s.length-1)]}if(r.bMultiplayer=!0,r.lobbyId=t.id,r.data={p2:p2,astar:astar.astar,astarGraph:astar.Graph,shared:shared,sprites:sprites,weapons_world:weapons_world,weapons:weapons,items:items,vehicles:vehicles,mods:mods,modes:modes,maps:allMaps,bots:bots,callbacks:{error:e=>{log("A game error occurred",e);var a=e?e.endTimer:null;onEndGame(t.id,null!=a?a:3)},chat:e=>{sendChatMessageToLobby(t.id,e)},onPlayerKill:()=>{incrementStat("kills")},onDinoKill:()=>{incrementStat("dinoKills")},onHeliKill:()=>{incrementStat("heliKills")},onVehicleKill:()=>{incrementStat("vehicleKills")},onEggKill:()=>{incrementStat("eggKills")}}},startGame(t.id,r),settings.info){t.infoInterval=setInterval((()=>{triggerServerInfo(t.id)}),6e4);for(var o=0;o<t.players.length;o++){var n=t.players[o];n.bInGame=!0,n.gameModeId=r.gameModeId,n.menu=null}}break;case LobbyState.STARTING:if(t.timer=Lobby.COUNTDOWN_STARTING,t.interval=setInterval((()=>{t.timer--,t.timer<0?setLobbyState(t.id,LobbyState.IN_PROGRESS):io.to(t.id).emit("updateLobby",{timer:t.timer})}),1e3),r=t.gameData,settings.bAllowVotes&&t.votes){var i=t.votes;if(Array.isArray(i)){i.sort(((e,a)=>e.players.length>a.players.length?-1:e.players.length<a.players.length?1:0));var l=i[0];r.gameModeId=l.id,l.mapId&&(r.mapId=l.mapId);let e=l.scenario;e&&(r.scenario=e,r.settings=e.settings?e.settings:{},r.tiles=e.tiles?e.tiles:null,r.mapId=e.mapId,r.gameModeId=e.gameModeId?e.gameModeId:GameMode.SCENARIO)}else console.warn(i)}if(!t.bCustom&&t.type!=Lobby.TYPE_SCENARIO){var b=shared.defaultGameSettings[r.gameModeId];if(b){var d=Object.keys(b);for(o=0;o<d.length;o++){var m=d[o];r.settings[m]=b[m]}}let e=[null,null,"night","dawn"];r.settings.worldType=e[MathUtil.Random(0,e.length-1)]}isSurvivalGameMode(r.gameModeId)&&r.settings.bHardcore&&(r.settings.bHardcore=!1,t.bCustom||(r.settings.bMapVehicles=!1,r.settings.bMapWeapons=!1));var y=t.gameData.settings.bots;t.bCustom||isSurvivalGameMode(r.gameModeId)&&(y=Math.min(y,2)),t.gameData.scenario&&!t.gameData.scenario.settings.bAllowGameModeSelection&&(y=0);var c=getAveragePlayerLevel(t.players),E=Math.floor(c/30);for(o=0;o<y&&t.players.length<t.maxPlayers;o++){var _=t.gameData.settings.botSkill;_!=BotSkill.AUTO&&t.bCustom||(_=isSurvivalGameMode(r.gameModeId)?Math.max(E,BotSkill.HARD):Math.min(E,BotSkill.HARD));var g=getBot(_);g.lobbyId=t.id,g.name=bots[MathUtil.Random(0,bots.length-1)]+" ("+getBotSkillString(_)+")",t.players.push(g)}setLobbyTeams(t);break;case LobbyState.PREPARING:resetLobby(t),t.timer=Lobby.COUNTDOWN_PREPARING,t.interval=setInterval((()=>{t.timer--,t.timer<0?setLobbyState(t.id,LobbyState.STARTING):io.to(t.id).emit("updateLobby",{timer:t.timer})}),1e3);break;case LobbyState.INTERMISSION:if(resetLobby(t),resetLobbyVotes(t),t.timer=Lobby.COUNTDOWN_INTERMISSION,t.interval=setInterval((()=>{t.timer--,t.timer<0?setLobbyState(t.id,LobbyState.PREPARING):io.to(t.id).emit("updateLobby",{timer:t.timer})}),1e3),!t.bCustom)if(0==getNumRealPlayers(t.players))getLobbiesByType(t.type).length>1&&(log("Removing extra public lobby:",t.type),removeLobby(t.id));break;case LobbyState.WAITING:case LobbyState.WAITING_HOST:resetLobby(t)}io.to(t.id).emit("updateLobby",{state:t.state,chat:t.chat,timer:t.timer}),emitLobbyChange(t)}}function getBotSkillString(e){switch(e){case BotSkill.AUTO:return"Auto";case BotSkill.EASY:return"Easy";case BotSkill.NORMAL:return"Normal";case BotSkill.HARD:return"Hard";case BotSkill.INSANE:return"Insane";default:return"God"}}function getClientLobbyData(e){var a=null;if(e){a={};for(var t=Object.keys(e),r=0;r<t.length;r++){let s=t[r];switch(s){case"game":case"infoInterval":case"interval":case"kickInterval":break;default:a[s]=e[s]}}}return a}function getLobbyPlayerIndex(e,a){for(var t=0;t<e.length;t++)if(e[t].id==a)return t;return-1}function leaveLobby(e,a){var t=getLobbyData(e.lobbyId);if(t){if(t.votes)for(var r=0;r<t.votes.length;r++){var s=t.votes[r].players;(n=s.indexOf(e.id))>=0&&s.splice(n,1)}if(t.voteskips){var o=t.voteskips.indexOf(e.id);o>=0&&t.voteskips.splice(o,1)}var n;t.game&&t.game.requestEvent({eventId:GameServer.EVENT_PLAYER_LEAVE,playerId:e.id,reason:a}),(n=getLobbyPlayerIndex(t.players,e.id))>=0?t.players.splice(n,1):console.warn("Invalid index",n),e.lobbyId=null,delete e.lobbyType,delete e.bLobbyHost,delete e.bCustom,resetPlayer(e);var i=getSocketByPlayerId(e.id);if(i&&(i.emit("leaveLobby",a),i.leave(t.id),io.emit("updatePlayer",i.player)),io.to(t.id).emit("updateLobby",{players:t.players}),log(t.players.length,"in lobby"),0==t.players.length)t.bCustom?removeLobby(t.id):t.type==Lobby.TYPE_SCENARIO&&setLobbyState(t.id,LobbyState.WAITING);else if(t.bCustom&&t.hostPlayerId==e.id)e.partyId||io.to(t.id).emit("showWindow",{titleText:"STR_CUSTOM_LOBBY_DISBANDED",messageText:"STR_HOST_LEFT_DESC",bShowOkayButton:!0}),removeLobby(t.id);else if(!t.game){switch(a){case Lobby.REASON_KICKED:var l="STR_X_KICKED";break;case"timed_out":l="STR_X_TIMED_OUT";break;default:l="STR_X_LEFT"}sendChatMessageToLobby(t.id,{locText:l,params:[e.name]})}}else log("[leaveLobby] Player isn't in lobby",chalk.yellow(e.name));e.bBot||emitPlayerList(e)}function startGame(e,a){var t=getLobbyData(e);if(t){destroyLobbyGame(e);!1,t.game=new gameInstance.GameInstance,t.gameData=a;var r=clone(t.players);if(a.players=r,a.scenario){t.kickTimer=30,io.to(t.id).emit("updateLobby",{kickTimer:t.kickTimer,kickTimerMax:30}),t.kickInterval=setInterval((()=>{t.kickTimer--,io.to(t.id).emit("updateLobby",{kickTimer:t.kickTimer,kickTimerMax:30}),t.kickTimer<=0&&(clearInterval(t.kickInterval),kickIdlePlayers(t))}),1e3)}else initGame(t,a);var s=clone(t.gameData);s.players=r,io.to(t.id).emit("prepareGame",s),setTimeout((()=>{io.to(t.id).emit("enterGame")}),3e3)}}function initGame(e,a){if(e){var t=e.game;if(!t)return void console.warn("Invalid game reference");if(!t.bInit)return t.init(a,(a=>{if(a){var t=null!=getLobbyData(e.id),r=getNumRealPlayers(e.players)>0;t&&r&&io.to(e.id).emit("gameEvent",a)}})),t.setEndCallback(onEndGame),e.gameData=a,!0;log("Game already initialized")}return!1}function onEndGame(e,a=Lobby.COUNTDOWN_END){var t=getLobbyData(e);t&&(a>0?(t.timer=a,t.interval&&clearInterval(t.interval),t.interval=setInterval((()=>{var a=getLobbyData(e);a&&(a.timer--,a.timer<0?setLobbyState(e,a.bCustom?LobbyState.WAITING_HOST:LobbyState.INTERMISSION):io.to(a.id).emit("updateLobby",{timer:a.timer}))}),1e3)):setLobbyState(e,t.bCustom?LobbyState.WAITING_HOST:LobbyState.INTERMISSION))}function destroyLobbyGame(e){var a=getLobbyData(e);if(a){var t=a.game;t?(t.destroy(),delete a.game):log("No game to destroy",e)}}function handleChatMessage(e,a){if(log(chalk.cyan(e.id),"chat",e.player.lobbyId?"<"+e.player.lobbyId+">":"<all>",a),a&&a.length&&a.trim().length&&a.replace(/\s/g,"").length){var t=smile.checkText(a),r={playerText:e.player.name,level:e.player.level,prestige:e.player.prestige,playerId:e.player.id,username:e.player.username,messageText:t},s=e.player.bAdmin,o=t.split(" ");if(o&&o.length>0){var n=getLobbyData(e.player.lobbyId);switch(e.player.lobbyId?sendChatMessageToLobby(e.player.lobbyId,r):sendChatMessageToAll(r),o[0]){case"/updateServer":if(s)try{log("Attempting git pull..."),exec("git pull",((a,t,r)=>{if(log(a,t,r),a)return console.warn(a.message),void sendChatMessageToSocket(e,{bServer:!0,bCritical:!0,messageText:a.message,bMonospace:!0},!0);r&&(log(r),sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:r,bMonospace:!0},!0)),log(t),sendChatMessageToAll({bServer:!0,messageText:t,bMonospace:!0},!0)}))}catch(e){console.warn(e)}break;case"/restartServer":if(s){let e=parseInt(o[1]);if(!isNaN(e)&&e>0){let a=e;sendChatMessageToAll({bServer:!0,messageText:"Server will restart in "+a+" seconds"},!0),setInterval((()=>{a--,(a<=10||a%(a>=300?60:30)==0)&&sendChatMessageToAll({bServer:!0,messageText:"Server will restart in "+a+" seconds"},!0),a<0&&process.exit(0)}),1e3)}else process.exit(0)}break;case"/end":s&&n&&n.game&&n.game.requestEvent({eventId:GameServer.EVENT_GAME_END,winningTeam:parseInt(o[1])});break;case"/stop":s&&n&&setLobbyState(n.id,n.bCustom?LobbyState.WAITING_HOST:LobbyState.WAITING);break;case"/start":s&&n&&(setLobbyState(n.id,LobbyState.WAITING),setLobbyState(n.id,LobbyState.STARTING));break;case"/resetLobby":s&&n&&(n.interval&&clearInterval(n.interval),setLobbyState(n.id,LobbyState.WAITING));break;case"/resetLobbyVotes":s&&n&&resetLobbyVotes(n);break;case"/createLobby":s&&createPublicLobby(o[1]);break;case"/dummy":s&&addDummy(MathUtil.Random(BotSkill.EASY,BotSkill.INSANE),bots[MathUtil.Random(0,bots.length-1)]);break;case"/kill":n&&n.game&&(s||n.bCustom)&&n.game.killPawn(e.player.id);break;case"/spectate":n&&n.game&&n.game.serverAction(e.player.id,o);break;case"/join":s&&canJoinLobby(o[1],e)==Lobby.JOIN_SUCCESS&&joinLobby(e.player,o[1]);break;case"/time":sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:new Date(Date.now()).toString()});break;case"/server":var i="",l=convertMS(Date.now()-serverStartTime);i+="Uptime: "+l.day+"d "+l.hour+"h "+l.minute+"m "+l.seconds+"s",i+="\n"+getNumClients()+" connected / "+lobbies.length+" lobbies / "+getLobbiesInProgress()+" games in progress",i+="\n---",i+="\n"+(settings.bAllowVotes?"☑":"☐")+" Map Voting",i+="\n"+(settings.bAllowVotekick?"☑":"☐")+" Votekick",i+="\n"+(settings.bAllowVoteskip?"☑":"☐")+" Voteskip",i+="\n---",sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:"Fetching server details..."}),os.cpuUsage((a=>{i+="\n"+os.platform()+" - "+os.cpuCount()+" CPUs",i+="\nCPU Usage: "+Math.round(100*a)+"%",i+="\nMemory Usage: "+Math.round(os.freemem())+" MB of "+Math.round(os.totalmem())+" MB ("+Math.round(100*os.freememPercentage())+"%)";for(var t=process.memoryUsage(),r=[],s=0;s<r.length;s++){var o=r[s];t[o]&&(i+="\n"+o+": "+toMB(t[o]))}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:settings.name+" ("+ServerData.VERSION+")\n"+i})}));break;case"/lobby":n&&sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:"Lobby ID: "+n.id+"\nType: "+(n.bCustom?"Custom":n.type)+"\nState: "+n.state+"\nMax Players: "+n.maxPlayers+"\nLobby is "+(n.bPublic?"public":"private 🔒")});break;case"/heapdump":break;case"/setSetting":n&&n.bCustom&&s&&(n.gameData.settings[o[1]]=o[2]);break;case"/host":if(n&&n.bCustom&&(e.player.bLobbyHost||s)){var b=parseInt(o[1],10),d=getPlayerById(n.hostPlayerId),m=n.players[b];m&&(m.bLobbyHost=!0,n.hostPlayerId=m.id,d&&delete d.bLobbyHost,io.to(n.id).emit("updateLobby",{hostPlayerId:m.id,players:n.players})),sendChatMessageToLobby(n.id,{bServer:!0,messageText:m.name+" is now the lobby host"})}break;case"/settings":if(n){for(var y="",c=Object.keys(n.gameData.settings),E=0;E<c.length;E++){var _=c[E];E>0&&(y+="\n"),y+=_+"="+n.gameData.settings[_]}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:y})}break;case"/createPublicLobby":if(s){let e=parseInt(o[1]);if(!isNaN(e)&&e>0)for(E=0;E<e;E++){let e=createPublicLobby(o[2]?o[2]:Lobby.TYPE_ALL);setLobbyState(e.id,LobbyState.IN_PROGRESS),setLobbyState(e.id,LobbyState.STARTING)}}break;case"/createLobby":s&&(newLobby=createPublicLobby(o[1]?o[1]:Lobby.TYPE_ALL));break;case"/removeLobby":if(s)if(n)removeLobby(n.id);else{let e=getLobbyData(o[1]);e&&removeLobby(e.id)}break;case"/removeAllLobbies":if(s){let a=0;for(E=lobbies.length-1;E>=0;E--){let e=lobbies[E];e&&(removeLobby(e.id),a++)}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:a+" lobbies removed"})}break;case"/removeExtraLobbies":if(s){let a=0;for(E=lobbies.length-1;E>=0;E--){let e=lobbies[E];if(e&&!e.bCustom&&0==getNumRealPlayers(e.players)){getLobbiesByType(e.type).length>1&&(log("Removing extra public lobby:",e.type),removeLobby(e.id),a++)}}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:a+" lobbies removed"})}break;case"/admin":if(e.player.bAdmin){y="ADMIN DASHBOARD\n";if(stats.reported){y+=stats.reported.length+" Reports\n";for(E=0;E<stats.reported.length;E++){let e=stats.reported[E];y+="  "+E+" ["+e.id+"] "+e.reported.username+" reported by "+e.reporter.username+"\n   -> "+Date(e.date)+"\n"}}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:y,bMonospace:!0})}else sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:"You must be an admin to view the Admin Dashboard."});break;case"/stats":if(stats){for(y="Server stats:\n",c=Object.keys(stats),E=0;E<c.length;E++){let e=c[E];switch(e){case"reported":break;default:y+=e+": "+GameUtil.FormatNum(stats[e]),E<c.length-1&&(y+="\n")}}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:y})}break;case"/help":sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:"Common commands:\n/server\n/votekick\n/voteskip\n/kick\n/report"});break;case"/report":if(n){let a=parseInt(o[1],10);if(isNaN(a))g=getPlayerByString(n,o[1]);else var g=getPlayerByIndex(n,a);if(g)if(g.bAdmin)sendChatMessageToLobby(n.id,{bServer:!0,messageText:"You can't report an admin."});else if(g.bBot)sendChatMessageToLobby(n.id,{bServer:!0,messageText:"You can't report a bot."});else if(g.id==e.player.id)sendChatMessageToLobby(n.id,{bServer:!0,messageText:"You can't report yourself."});else{var I=addReportedPlayer(g,e.player);I&&sendChatMessageToLobby(n.id,{bServer:!0,messageText:g.name+" has been reported. Report ID: "+I})}}break;case"/clearReports":s&&stats&&(stats.reports=[]);break;case"/kick":if(n&&(s||e.player.bLobbyHost)){let a=parseInt(o[1],10);if(isNaN(a))g=getPlayerByString(n,o[1]);else g=getPlayerByIndex(n,a);g&&(g.bAdmin||g.id==e.player.id||leaveLobby(g,Lobby.REASON_KICKED))}break;case"/bot":if(s&&n){var A=getBot(null!=o[2]?parseInt(o[2]):BotSkill.AUTO);A.name=bots[MathUtil.Random(0,bots.length-1)],A.team=null!=o[1]?parseInt(o[1],10):getBestTeam(n.players),joinLobby(A,n.id)}break;case"/rules":settings.rules&&sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:settings.rules});break;case"/players":n&&sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:1==n.players.length?"STR_X_PLAYER":"STR_X_PLAYERS",params:[n.players.length],players:n.players});break;case"/lobbies":for(y="Lobbies:",E=0;E<lobbies.length;E++){let e=lobbies[E];(e.bPublic||s)&&(y+="\n"+e.id+" | "+(e.bCustom?"custom":e.type))}sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,messageText:y});break;case"/voteskip":if(n&&!n.bCustom)if(settings.bAllowVoteskip)if(n.game){n.voteskips||(n.voteskips=[]),-1==n.voteskips.indexOf(e.player.id)&&n.voteskips.push(e.player.id);var u=Math.max(1,getNumRealPlayers(n.players));sendChatMessageToLobby(n.id,{bServer:!0,locText:"STR_SERVER_VOTESKIP_X_X",params:[n.voteskips.length,u]}),n.voteskips.length>=u&&n.game.requestEvent({eventId:GameServer.EVENT_GAME_END})}else sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTESKIP_GAME"});else sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTESKIP_DISABLED"});break;case"/votekick":if(n&&!n.bCustom)if(settings.bAllowVotekick){let a=parseInt(o[1],10);if(isNaN(a))S=getPlayerByString(n,o[1]);else var S=getPlayerByIndex(n,a);if(S)if(S.id==e.player.id)sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTEKICK_SELF"});else if(S.bAdmin)sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTEKICK_ADMIN"});else{null==S.votekicks&&(S.votekicks={}),S.votekicks[e.player.id]=1;var p=Object.keys(S.votekicks).length,L=Math.floor(.5*n.players.length)+1;if(sendChatMessageToLobby(n.id,{bServer:!0,locText:"STR_SERVER_VOTEKICK_VOTES_AGAINST_X_X_X",params:[S.name,p,L]}),p>=L){var T=getSocketByPlayerId(S.id);T?disconnectSocket(T,{reason:Lobby.REASON_KICKED}):leaveLobby(S,Lobby.REASON_KICKED)}}else isNaN(a)||"number"!=typeof a?sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTEKICK_INVALID"}):sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTEKICK_NOT_FOUND"})}else sendChatMessageToSocket(e,{bServer:!0,bDirect:!0,locText:"STR_SERVER_VOTEKICK_DISABLED"});break;case"/disconnect":disconnectSocket(e);break;case"/leave":leaveLobby(e.player,Lobby.REASON_CLIENT_QUIT);break;default:!1,s&&n&&n.game&&n.game.serverAction(e.player.id,o)}}}}function updatePlayerData(e,a){if(a){if(log(chalk.cyan(e.id),"update",Object.keys(a).length),a.version){var t=ServerData.GAME_VERSION.split("."),r=a.version.split(".");if(parseInt(r[0])<parseInt(t[0])||parseInt(r[1])<parseInt(t[1])||parseInt(r[2])<parseInt(t[2]))return e.emit("showWindow",{id:"mp_mismatch",titleText:"STR_MULTIPLAYER",messageText:"STR_VERSION_MISMATCH_DESC",messageParams:[a.version,ServerData.GAME_VERSION],version:a.version,required:Server.GAME_VERSION,type:"TYPE_MESSAGE",bShowOkayButton:!0,yesText:"STR_UPDATE",yesData:{rightIcon:"⧉"},yesURL:"https://dinogenonline.com"}),void disconnectSocket(e,{reason:"version_mismatch",version:a.version,gameVersion:ServerData.GAME_VERSION})}if(settings.admins&&settings.admins.indexOf(a.username)>=0&&(e.player.bAdmin=!0),a.name&&(e.player.name=a.name),void 0!==a.username&&(e.player.username=a.username),a.level){if(!e.player.level)var s=!0;e.player.level=a.level}if(null!=a.prestige&&(e.player.prestige=a.prestige),null!=a.xp&&(e.player.xp=a.xp),a.currentClass&&(e.player.currentClass=a.currentClass),a.classes&&(e.player.classes=a.classes),a.class&&(e.player.classes[a.class.id]=a.class.data),a.dinosaurs&&(e.player.dinosaurs=a.dinosaurs),a.dinosaur&&(e.player.dinosaurs[a.dinosaur.id]=a.dinosaur),a.preferredClass&&(e.player.classes.preferredClass=a.preferredClass),a.preferredFaction&&(e.player.classes.preferredFaction=a.preferredFaction),void 0!==a.menu&&(e.player.menu=a.menu),a.steamId&&(e.player.steamId=a.steamId),a.badges&&(e.player.badges=a.badges),isBanned(a.username)||isBanned(a.steamId))return console.warn(chalk.red("Player is banned"),e.player),e.emit("showWindow",{id:"mp_banned",titleText:"STR_MULTIPLAYER",messageText:"STR_BANNED_DESC",type:"TYPE_MESSAGE",bShowOkayButton:!0}),void disconnectSocket(e,{reason:"banned"});if(!validateClient(e.player))return console.warn(chalk.red("Validation failed"),e.player),e.emit("showWindow",{id:"mp_validation_failed",titleText:"STR_MULTIPLAYER",messageText:"STR_CLIENT_VALIDATION_FAILED_DESC",type:"TYPE_MESSAGE",bShowOkayButton:!0}),void disconnectSocket(e,{reason:"validation_failed"});var o=getLobbyData(e.player.lobbyId);if(o){io.to(o.id).emit("updateLobby",{players:o.players});var n=o.game;n&&n.updatePlayer(e.player)}s&&e.emit("players",getPlayerList()),io.emit("playerConnected",e.player),io.emit("updatePlayer",e.player)}}function getRequiredXPForLevel(e){for(var a=0,t=1;t<e+1;t++)a+=t<=1?0:2==t?1e3:15*t*50;return a}async function validateClient(e){try{if(null==e.level||e.level>100)return!1;if(null==e.prestige||e.prestige>10)return console.warn("Invalid prestige",e.prestige),!1;if(e.level>1){var a=getRequiredXPForLevel(e.level-1);e.xp<a&&console.warn("Invalid xp",e.xp,e.level,a)}if(!e.classes)return!1;for(var t=["assault","commando","support","hunter"],r=0;r<t.length;r++){var s=e.classes[t[r]];if(!s)return!1;if(!(isValidClassItem(s.primary.id)&&isValidClassItem(s.secondary.id)||e.bAdmin))return!1}}catch(e){return console.error(e),!1}return!0}function isValidClassItem(e){var a=getWeaponData(e);return!!a&&!(a.bHidden||a.bVehicle||a.bSurvival)}function getWeaponData(e){for(var a=0;a<weapons.length;a++){var t=weapons[a];if(t.id==e)return t}return null}function getRequiredXPForLevel(e){return e<=1?0:getRequiredXPForLevel(e-1)+15*e*50}function getParty(e){return null}function getLobbiesByType(e){for(var a=[],t=0;t<lobbies.length;t++){let r=lobbies[t];r.type==e&&a.push(r)}return a}function getLobbyData(e){if(!e)return null;for(var a=0;a<lobbies.length;a++)if(lobbies[a].id==e)return lobbies[a];return null}function getAveragePlayerLevel(e){if(!e||0==e.length)return 1;for(var a=0,t=0;t<e.length;t++){var r=e[t];r.bBot||(a+=r.level,r.prestige>=1&&(a+=100*r.prestige))}return Math.round(a/e.length)}function getBot(e){var a=1,t=Math.min(e,BotSkill.GOD);switch(e==BotSkill.AUTO&&(t=e=MathUtil.Random(BotSkill.EASY,BotSkill.HARD)),t){case 0:a=MathUtil.Random(1,9);break;case 1:a=MathUtil.Random(10,49);break;case 2:a=MathUtil.Random(50,74);break;case 3:a=MathUtil.Random(75,99);break;case 4:a=100}return{id:getRandomUniqueId(),name:"Bot",bBot:!0,botSkill:t,level:a}}function showWindowForSockets(e,a){if(e)for(var t=0;t<e.length;t++){var r=getSocketByPlayerId(e[t]);r&&r.emit("showWindow",a)}}function disconnectSocket(e,a){e&&(e.emit("disconnectInfo",a),e.disconnectReason=a?a.reason:null,e.disconnect())}function getNumRealPlayers(e){if(e){for(var a=0,t=0;t<e.length;t++){e[t].bBot||a++}return a}return 0}function getNumClients(){var e=0;return io._nsps.forEach((a=>{e+=a.sockets.size})),e+=dummies?dummies.length:0}function getNumRealClients(){var e=0;return io._nsps.forEach((a=>{e+=a.sockets.size})),e}function getClients(){var e=[];for(const[a,t]of io.of("/").sockets)e.push(t.player);return e=e.concat(dummies)}function getLobbyListForSocket(e){for(var a=[],t=0;t<lobbies.length;t++){var r=lobbies[t];if(r.bPublic){var s=getLobbyDataForSocket(e,r);a.push(s)}}return a}function getLobbyDataForSocket(e,a){if(!a.players)return null;var t=a.bPublic,r=null;if(a.gameData.scenario){var s=a.gameData.scenario;r={name:s.name,desc:s.desc,author:s.author}}var o={id:a.id,type:a.type,bPublic:t,bCustom:1==a.bCustom,scenario:r,numPlayers:a.players.length,numBots:getNumBotsInLobby(a.id),maxPlayers:a.maxPlayers,gameModeId:a.gameData.gameModeId,state:a.state,bCanJoin:!!e&&canJoinLobby(a.id,e)==Lobby.JOIN_SUCCESS};if(a.gameData&&a.state==LobbyState.IN_PROGRESS){o.mapId=a.gameData.mapId,o.gameModeId=a.gameData.gameModeId;try{if(a.game&&a.game.game){var n=a.game.game;if(n){var i=n.gameModeData;i&&(n.gameTimer&&(o.gameTimer=n.gameTimer),n.bSurvival&&(o.wave=i.wave))}}}catch(e){console.warn(e)}}if(a.bCustom){var l=getSocketByPlayerId(a.hostPlayerId);l&&(o.host=l.player)}var b=getLobbyEvent(a);return b&&(o.event=b),o}function toMB(e){return Number(e/1024/1024*100/100).toFixed(2)+" MB"}function getBestLobby(){for(var e=[],a=0;a<lobbies.length;a++){var t=lobbies[a];t.bPublic&&e.push({id:t.id,players:t.players.length,realPlayers:getNumRealPlayersInLobby(t.id),value:t.gameData.scenario?0:1})}return e.sort(((e,a)=>e.value>a.value?-1:e.value<a.value?1:e.realPlayers>a.realPlayers?-1:e.realPlayers<a.realPlayers?1:e.players>a.players?-1:e.players<a.players?1:0)),e.length>0?e[0]:null}function emitLobbyChange(e=null){for(const[a,t]of io.of("/").sockets)e?t.emit("lobbyData",getLobbyDataForSocket(t,e)):t.emit("lobbies",getLobbyListForSocket(t))}function getPlayerList(){var e=dummies?clone(dummies):[];for(const[a,t]of io.of("/").sockets)e.push(t.player);return e}function emitPlayerList(e){var a=getPlayerList();for(const[t,r]of io.of("/").sockets)e?r.emit("updatePlayer",e):r.emit("players",a)}function getGameMode(e){for(var a=0;a<modes.length;a++){var t=modes[a];if(t.id==e)return t}return null}function getPlayerByIndex(e,a){if(e&&null!=a&&!isNaN(a)&&"number"==typeof a){var t=e.players[a];if(t)return t}return null}function getPlayerByString(e,a){if(e&&null!=a&&"string"==typeof a)for(var t=e.players,r=0;r<t.length;r++){let e=t[r];if(0==e.name.indexOf(a))return e}return null}function getSocketByPlayerId(e){for(const[a,t]of io.of("/").sockets)if(t.player.id==e)return t;return null}function getPlayerById(e){for(const[e,a]of io.of("/").sockets)if(a.player.id==_val)return a.player;return null}function getSocketByUsername(e){for(const[a,t]of io.of("/").sockets)if(t.player.username==e)return t;return null}function getVotesAgainstPlayer(e){var a=getSocketByPlayerId(e);if(a&&a.player.votekicks)return Object.keys(a.player.votekicks).length;return 0}function getLobbiesInProgress(){for(var e=0,a=0;a<lobbies.length;a++){let t=lobbies[a];t&&t.state==LobbyState.IN_PROGRESS&&e++}return e}function getRandomUniqueId(){return Math.random().toString(36).substr(2,4)}function getRandomGameModeId(){var e=[GameMode.FREE_FOR_ALL,GameMode.TEAM_DEATHMATCH,GameMode.DOMINATION,GameMode.TYRANT,GameMode.EVOLUTION,GameMode.RAPTOR_HUNT,GameMode.HUMANS_VS_DINOSAURS,GameMode.DESTRUCTION,GameMode.CAPTURE_THE_FLAG,GameMode.SURVIVAL_CHAOS,GameMode.SURVIVAL_DINO,GameMode.SURVIVAL_MILITIA];return e[MathUtil.Random(0,e.length-1)]}function getRandomMapId(){var e=[Map.RIVERSIDE,Map.COMPLEX,Map.DISTRICT,Map.SANDSTORM,Map.FIRING_RANGE,Map.HEXAGON,Map.CAMPSITE,Map.VILLA,Map.LABORATORY,Map.OASIS,Map.COMPOUND];return e[MathUtil.Random(0,e.length-1)]}function shuffleArray(e){for(var a,t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),a=e[r-=1],e[r]=e[t],e[t]=a;return e}function clone(e){return JSON.parse(JSON.stringify(e))}function convertMS(e){var a,t,r;return r=Math.floor(e/1e3),t=Math.floor(r/60),r%=60,a=Math.floor(t/60),t%=60,{day:Math.floor(a/24),hour:a%=24,minute:t,seconds:r}}function isBanned(e){return!(!settings||!settings.banned)&&0==settings.banned.indexOf(e)}if(server.listen(process.env.PORT||settings.port,(()=>{log("\nListening on "+server.address().family+" "+chalk.inverse(server.address().address)+":"+chalk.inverse(server.address().port)+"\n")})),settings.maxUptimeHours>0){log(chalk.yellow("\nMax Uptime Enabled")),log("Server will stop after",settings.maxUptimeHours,"hours");var iterations=0,iterationTime=36e5;setInterval((function(){iterations++,(0==getLobbiesInProgress().length||0==getNumClients()||iterations>=settings.maxUptimeHours)&&(log("Max uptime reached"),process.exit(0))}),iterationTime)}
