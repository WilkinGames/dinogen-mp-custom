const GameServer={EVENT_ERROR:0,EVENT_BATCH:1,EVENT_GAME_INIT:2,EVENT_GAME_TIMER:3,EVENT_GAME_PRE_TIMER:4,EVENT_GAME_START:5,EVENT_GAME_END:6,EVENT_GAME_UPDATE:7,EVENT_PLAYER_JOIN:8,EVENT_PLAYER_LEAVE:9,EVENT_PLAYER_UPDATE:10,EVENT_SPAWN_CHARACTER:11,EVENT_OBJECT_UPDATE:12,EVENT_PLAYER_INPUT:13,EVENT_PLAYER_TRIGGER_WEAPON:14,EVENT_PAWN_DAMAGE:19,EVENT_PAWN_DIE:20,EVENT_PAWN_ACTION:21,EVENT_PLAYER_MULTI_KILL:35,EVENT_PLAYER_INTERACT:38,EVENT_PLAYER_UPDATE_INVENTORY:39,EVENT_PLAYER_TRIGGER_EQUIPMENT:41,EVENT_PLAYER_TRIGGER_GRENADE:43,EVENT_KILLFEED_ADD:45,EVENT_MESSAGE_ADD:46,EVENT_SPAWN_OBJECT:47,EVENT_SPAWN_BULLET:48,EVENT_SPAWN_EXPLOSION:49,EVENT_GAME_PAUSE:50,EVENT_INTERACTABLE_USED:60,EVENT_REMOVE_OBJECT:61,EVENT_BUY:62,EVENT_USE_ITEM:63,PAWN_FIRE_WEAPON:1,PAWN_HIT_SHIELD:2,PAWN_START_REVIVE:3,PAWN_END_REVIVE:4,PAWN_SHARED_CRATE:5,PAWN_STOLE_CRATE:6,PAWN_START_INTERACTION:7,PAWN_NO_AMMO:8,PAWN_OPEN_LAPTOP:9,PAWN_ON_FIRE:10,PAWN_STUN:11,PAWN_FLASH:12,PAWN_FREEZE:13,PAWN_SET_JAMMED:14,PAWN_UPDATE_DOOR:15,PAWN_INVESTIGATE:16,PAWN_TROPHY_HIT:17,PAWN_START_SHIELD_COOLDOWN:18,PAWN_END_SHIELD_COOLDOWN:19,PAWN_END_FIRE_DELAY:20,PAWN_END_BOLT_DELAY:21,PAWN_END_THROW_DELAY:22,PAWN_END_EQUIPMENT_DELAY:23,PAWN_END_MELEE_DELAY:24,PAWN_RELOAD_COMPLETE:25,PAWN_CLOSE_LAPTOP:26,PAWN_START_FLAME:27,PAWN_END_FLAME:28,PAWN_RELOAD:29,PAWN_PULL_BOLT:30,PAWN_CANCEL_RELOAD:31,PAWN_CANCEL_BOLT_PULL:32,PAWN_THROW_GRENADE:33,PAWN_USE_STIM:34,PAWN_RECEIVE_STIM:35,PAWN_PLACE_EQUIPMENT:36,PAWN_MELEE_ATTACK:37,PAWN_FIRE_MELEE:38,PAWN_FIRE_ROCKET:39,PAWN_TRIGGER_MINE:40,PAWN_END_INTERACTION:41,PAWN_JUMP:42,PAWN_ON_BOOST:43,PAWN_START_LADDER_CLIMB:44,PAWN_LEAVE_LADDER:45,PAWN_DROP_CRATE:46,PAWN_FLAG:47,PAWN_HIT:48,PAWN_VEHICLE_ENTER:49,PAWN_VEHICLE_LEAVE:50,PAWN_UPDATE:51,PAWN_PARACHUTE:52,PAWN_VEHICLE_HORN:54,PAWN_VEHICLE_UPDATE:54,PAWN_SWITCH_SEATS:55,PAWN_REQUEST:56,PAWN_WEAPON_COOLDOWN:57,PAWN_LOCK_ACQUIRED:58,PAWN_INTERACTABLE_USED:59,PAWN_MOVE:60,INV_CLASS_DATA:1,INV_CURRENT_INVENTORY_INDEX:2,INV_FIRE:3,INV_PERK_ADD:4,INV_PERKS:5,INV_PERKS_SET:6,INV_MOD_SET:7,INV_EQUIPMENT_SET:8,INV_EQUIPMENT_ADD:9,INV_AMMO:10,INV_AMMO_ADD:11,INV_MAG:12,INV_MAG_ADD:13,INV_BURSTS:14,INV_BURSTS_ADD:15,INV_ITEM:16,INV_ITEM_ADD:17,INV_ITEM_REPLACE:18,INV_INVENTORY_REPLACE:19,INV_INVENTORY:21,INV_EQUIPMENT:22,INV_UNDERBARREL_EQUIP:23},CollisionGroups={PAWN:Math.pow(2,0),HELICOPTER:Math.pow(2,1),OBJECT:Math.pow(2,2),GROUND:Math.pow(2,3),PROJECTILE:Math.pow(2,4),BOUNDS:Math.pow(2,5),SHIELD:Math.pow(2,6),FLAME:Math.pow(2,7)},ObjectType={GROUND:"ground",CHARACTER:"character",DINOSAUR:"dinosaur",DUMMY:"dummy",ROCKET:"rocket",GRENADE:"grenade",EQUIPMENT:"equipment",CAR:"car",TANK:"tank",HELICOPTER:"helicopter",MOUNTED_WEAPON:"mountedWeapon",WINDOW:"window",LEVER:"lever",DROPPED_WEAPON:"droppedWeapon",FLAG:"flag",CRATE:"crate",FLAME:"flame",OBSTACLE:"obstacle",DOOR:"door",REVIVER:"reviver",SHIELD:"shield",MONEY:"money",ARROW:"arrow",EGG:"egg",TREE:"tree",TRIGGER_AREA:"triggerArea",SPAWNER:"spawner",PROJECTILE:"projectile"},Material={DEFAULT:"default",METAL:"metal",WOOD:"wood",WATER:"water",FLESH:"flesh",VENOM:"venom",SANDBAG:"sandbag",GLASS:"glass"},Colours={WHITE:16777215,WHITE_STRING:"#FFFFFF",BLACK:0,BLACK_STRING:"#000000",XP:16770611,XP_STRING:"#FFE633",GREEN:6291327,GREEN_STRING:"#5FFF7F",RED:16736095,RED_STRING:"#FF5F5F",PLAYER:6291327,PLAYER_STRING:"#5FFF7F",ENEMY:16736095,ENEMY_STRING:"#FF5F5F",ALLY:4568036,ALLY_STRING:"#45B3E4",THEME:14177600,THEME_STRING:"#D85540",ORANGE:16756275,ORANGE_STRING:"#FFAE33"},DamageType={DAMAGE_BULLET:1,DAMAGE_MELEE:2,DAMAGE_EXPLOSIVE:3,DAMAGE_FIRE:4,DAMAGE_WORLD:5},BotSkill={SKILL_EASY:0,SKILL_NORMAL:1,SKILL_HARD:2,SKILL_INSANE:3,SKILL_GOD:4,SKILL_IMPOSSIBLE:5},FeedItem={TYPE_MESSAGE:"message",TYPE_KILL:"kill",TYPE_CHAT:"chat"},Control={LOOK:"look",INTERACT:"interact",RELOAD:"reload",SWITCH:"switch",INV_NEXT:"inv_next",INV_PREV:"inv_prev",GRENADE:"grenade",EQUIPMENT:"equipment",WEAPON:"weapon",LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",JUMP:"jump",CROUCH:"crouch",SPRINT:"sprint",MELEE:"melee",ITEM:"item",FIRE:"fire",ITEM_1:"item_1",ITEM_2:"item_2",ITEM_3:"item_3"},Rocket={DEFAULT:"TYPE_DEFAULT",HELLFIRE:"TYPE_HELLFIRE",NAPALM:"TYPE_NAPALM"},Item={AMMO_AIRDROP:"item_ammo",WEAPON_AIRDROP:"item_weapon",HEAVY_AIRDROP:"item_weapon_heavy",SENTRY:"item_sentry",SENTRY_SHOTGUN:"item_sentry_shotgun",SENTRY_SAM:"item_sentry_rocket",SENTRY_FLAME:"item_sentry_flame",SENTRY_GRENADE:"item_sentry_grenade",SENTRY_SNIPER:"item_sentry_sniper",SENTRY_RAILGUN:"item_sentry_railgun",M2:"item_m2",BGM71:"item_bgm71",M242:"item_m242",ESCORT_AIRDROP:"item_osprey",SUPPORT_AIRDROP:"item_mh6",QUAD:"item_quad",GROWLER:"item_growler",MRAP:"item_mrap",LAV25:"item_lav25",ABRAMS:"item_abrams",T90:"item_t90",COBRA:"item_cobra",BLACKHAWK:"item_blackhawk",APACHE:"item_apache",KIOWA:"item_kiowa",EGG_COMPY:"item_egg_compy",EGG_DILO:"item_egg_dilo",EGG_RAPTOR:"item_egg_raptor",EGG_NEEDLER:"item_egg_needler",EGG_ALLOSAURUS:"item_egg_allosaurus",EGG_SPINOSAURUS:"item_egg_spinosaurus"},Helicopter={MH6:"mh6",COBRA:"cobra",APACHE:"apache",SEAKNIGHT:"seaknight",KIOWA:"kiowa",BLACKHAWK:"blackhawk",OSPREY:"osprey",CHICKENCOPTER:"chickencopter"},Tank={ABRAMS:"abrams",T90:"t90"},Car={QUAD:"quad",GROWLER:"growler",PICKUP:"pickup",MRAP:"mrap",LAV25:"lav25"},MountedWeapon={SENTRY:"sentry",SENTRY_SHOTGUN:"sentry_shotgun",SENTRY_SNIPER:"sentry_sniper",SENTRY_GRENADE:"sentry_grenade",SENTRY_SAM:"sentry_rocket",SENTRY_FLAME:"sentry_flame",SENTRY_RAILGUN:"sentry_railgun",M2:"m2",BGM71:"bgm71",M242:"m242"},Commands={REQUEST_AMMO:1,REQUEST_VEHICLE:2,REQUEST_SUPPORT:3,REQUEST_FOLLOW:4,REQUEST_COVER:5,REQUEST_REPAIR:6,TAUNT:7},Crate={STORE:"CRATE_STORE",AMMO:"CRATE_AMMO",DECOY:"CRATE_DECOY",KILLSTREAK:"CRATE_KILLSTREAK",ITEM:"CRATE_ITEM",WEAPON:"CRATE_WEAPON",PERK:"CRATE_PERK",BOMB:"CRATE_BOMB",BOMB_GENERIC:"CRATE_BOMB_GENERIC",SHARD:"CRATE_SHARD",XP:"CRATE_XP",LIFE:"CRATE_LIFE",TURRET:"CRATE_TURRET"},Weapon={TYPE_MELEE:"TYPE_MELEE",TYPE_PISTOL:"TYPE_PISTOL",TYPE_MACHINE_PISTOL:"TYPE_MACHINE_PISTOL",TYPE_SMG:"TYPE_SMG",TYPE_SHOTGUN:"TYPE_SHOTGUN",TYPE_SNIPER:"TYPE_SNIPER",TYPE_DMR:"TYPE_DMR",TYPE_CARBINE:"TYPE_CARBINE",TYPE_RIFLE:"TYPE_RIFLE",TYPE_LMG:"TYPE_LMG",TYPE_LAUNCHER:"TYPE_LAUNCHER",TYPE_GRENADE:"TYPE_GRENADE",TYPE_EXPLOSIVE:"TYPE_EXPLOSIVE",TYPE_TACTICAL:"TYPE_TACTICAL",TYPE_WEAPON_TACTICAL:"TYPE_WEAPON_TACTICAL",MODE_AUTO:"MODE_AUTO",MODE_BURST:"MODE_BURST",MODE_SEMI:"MODE_SEMI"},Mods={TYPE_BASE:"base",TYPE_OPTIC:"optic",TYPE_AMMO:"ammo",TYPE_BARREL:"barrel",TYPE_ACCESSORY:"accessory",OPTIC_REFLEX:"reflex",OPTIC_EOTECH:"eotech",OPTIC_ACOG:"acog",OPTIC_SCOPE:"scope",OPTIC_SCOPE_DMR:"scope_dmr",BASE_DEADEYE:"base_marksman",BASE_RAPID_FIRE:"base_rapid_fire",BASE_LOCK_ON:"base_lock_on",BASE_DAMPER:"base_damper",BASE_SPEED:"base_speed",BASE_RANGE:"base_range",BASE_BURST_FIRE:"base_burst_fire",BASE_MODE_SELECTOR:"base_mode_selector",BASE_FULL_AUTO:"base_full_auto",BASE_SINGLE_FIRE:"base_single_fire",BASE_SHIELD_DAMAGE:"base_shield_damage",BASE_SHIELD_RAPID_FIRE:"base_shield_alloy",AMMO_FMJ:"ammo_fmj",AMMO_PIERCING:"ammo_ap",AMMO_IMPACT:"ammo_impact",AMMO_EXTENDED:"ammo_extended",AMMO_HOLLOW_POINT:"ammo_hollow_point",AMMO_STOPPING_POWER:"ammo_high_caliber",AMMO_LAUNCHER_RADIUS:"ammo_radius",AMMO_LAUNCHER_EXPLOSIVE:"ammo_explosive",AMMO_SLUG:"ammo_slug",AMMO_DRAGONS_BREATH:"ammo_fire",AMMO_EXPLOSIVE:"ammo_explosive",ARROW_POISON:"arrow_poison",ARROW_EXPLOSIVE:"arrow_explosive",GRENADE_SMOKE:"grenade_smoke",GRENADE_FLASH:"grenade_flash",GRENADE_STUN:"grenade_stun",GRENADE_HE:"grenade_he",GRENADE_FIRE:"grenade_fire",ACCESSORY_MAG_ASSIST:"ammo_magpull",AMMO_SPEED_LOADER:"ammo_speed_loader",AMMO_HIGH_CALIBER:"ammo_range",AMMO_NAPALM:"ammo_napalm",BARREL_SILENCER:"barrel_silencer",BARREL_COMPENSATOR:"barrel_compensator",BARREL_BRAKE:"barrel_booster",BARREL_HEAVY:"barrel_range",ACCESSORY_LASER:"acc_laser",ACCESSORY_MARKER:"acc_marker",ACCESSORY_GRIP:"acc_grip",ACCESSORY_GRIP_ANGLED:"acc_grip_angled",ACCESSORY_M203:"acc_m203",ACCESSORY_M320:"acc_m320",ACCESSORY_GP25:"acc_gp25",ACCESSORY_MASTERKEY:"acc_masterkey"},MatchState={STATE_PRE_GAME:"pre_game",STATE_IN_PROGRESS:"in_progress",STATE_POST_ROUND:"post_round",STATE_POST_GAME:"post_game",END_RESULT_WIN:"end_result_win",END_RESULT_LOSS:"end_result_loss",END_RESULT_DRAW:"end_result_draw",END_CONDITION_TIME:"end_condition_time",END_CONDITION_SCORE:"end_condition_score",END_CONDITION_TREX_KILLED:"end_condition_trex_killed",END_CONDITION_KIA:"end_condition_kia",END_CONDITION_OBJECTIVE_COMPLETED:"end_condition_objective_completed",END_CONDITION_OBJECTIVE_FAILED:"end_condition_objective_failed"},GameMode={SCENARIO:"scenario",FREE_FOR_ALL:"deathmatch",TEAM_DEATHMATCH:"team_deathmatch",DOMINATION:"domination",CONQUEST:"conquest",DESTRUCTION:"destruction",EVOLUTION:"evolution",CAPTURE_THE_FLAG:"capture_the_flag",RAPTOR_HUNT:"raptor_hunt",TYRANT:"tyrant",HUMANS_VS_DINOSAURS:"humans_vs_dinosaurs",SURVIVAL_CHAOS:"survival_chaos",SURVIVAL_MILITIA:"survival_militia",SURVIVAL_DINO:"survival_dino",SURVIVAL_ZOMBIE:"survival_zombie",SURVIVAL_CHICKEN:"survival_chicken"},Classes={ASSAULT:"assault",COMMANDO:"commando",SUPPORT:"support",HUNTER:"hunter"},Dinosaur={COMPY:"compy",DILO:"dilo",RAPTOR:"raptor",NEEDLER:"needler",PACHY:"pachy",SPINOSAURUS:"spinosaurus",ALLOSAURUS:"allosaurus",CARNOTAURUS:"carnotaurus",TREX:"trex",STEGOSAURUS:"stegosaurus",LIZARD:"lizard",CHICKEN:"chicken"},Egg={SMALL:"egg_small",LARGE:"egg_large",HUGE:"egg_huge",MASSIVE:"egg_massive"},Character={INDEX_MELEE:2,INDEX_EQUIPMENT:3,INDEX_GRENADE:4,STYLE_DINOGEN:"dinogen",STYLE_MILITIA:"militia",STYLE_JUGGERNAUT:"juggernaut",HAIR_COLOUR_BROWN:"HAIR_COLOUR_BROWN",HAIR_COLOUR_BROWN_LIGHT:"HAIR_COLOUR_BROWN_LIGHT",HAIR_COLOUR_BLACK:"HAIR_COLOUR_BLACK",HAIR_COLOUR_BLONDE:"HAIR_COLOUR_BLONDE",HAIR_COLOUR_GINGER:"HAIR_COLOUR_GINGER",HAIR_COLOUR_GREY:"HAIR_COLOUR_GREY",HAIR_COLOUR_WHITE:"HAIR_COLOUR_WHITE",HAIR_COLOUR_RED:"HAIR_COLOUR_RED",HAIR_COLOUR_BLUE:"HAIR_COLOUR_BLUE",HAIR_COLOUR_GREEN:"HAIR_COLOUR_GREEN",FACE_DEFAULT:"face0000",FACE_TAN:"face0001",FACE_DARK:"face0002",FACE_FEMALE:"face0009",FACE_ZOMBIE_1:"face0003",FACE_ZOMBIE_2:"face0004",FACE_ZOMBIE_3:"face0005",FACE_ZOMBIE_4:"face0006",FACE_ZOMBIE_FAT:"face0007",FACE_ZOMBIE_EXPLODER:"face0008",FACE_ZOMBIE_SPITTER:"face0009",FACE_ZOMBIE_SPRINTER:"face0010",FACE_ZOMBIE_SPRINTER_BOSS:"face0011",FACE_INFESTOR:"face00012",HAIR_SHORT:"hair0000",HAIR_BALD:"hair0008",HAIR_LONG:"hair0002",HAIR_PONYTAIL:"hair0003",HAIR_UNDERCUT:"hair0006",HAIR_SPIKES:"hair0005",HAIR_BUZZED:"hair0004",HAIR_FLAT:"hair0001",HAIR_STYLED:"hair0007",HAIR_HORSESHOE:"hair0010",HAIR_MOHAWK:"hair0010",BEARD_NONE:"beard0000",BEARD_STUBBLE:"beard0001",BEARD_FULL:"beard0002",BEARD_CIRCLE:"beard0003",BEARD_GOATEE:"beard0004",BEARD_MOUSTACHE:"beard0005",BEARD_SIDEBURNS:"beard0006",EYEWEAR_NONE:"eyewear0000",EYEWEAR_SHADES:"eyewear0001",EYEWEAR_GLASSES:"eyewear0002",EYEWEAR_GOGGLES_YELLOW:"eyewear0003",EYEWEAR_GOGGLES_ORANGE:"eyewear0004",EYEWEAR_GOGGLES_WHITE:"eyewear0005",EYEWEAR_GOGGLES_BLACK:"eyewear0006",FACEWEAR_NONE:"facewear0000",FACEWEAR_MASK:"facewear0001",FACEWEAR_SKULLMASK:"facewear0002",FACEWEAR_GHILLIE:"facewear0003",FACEWEAR_SCARF_OPFOR:"facewear0004",FACEWEAR_BALACLAVA:"facewear0005",FACEWEAR_SCARF_SPETSNAZ:"facewear0006",FACEWEAR_BANDANA:"facewear0007",FACEWEAR_GAS_MASK:"facewear0008",FACEWEAR_BANDANA_GENERIC:"facewear0009",FACEWEAR_GAITER:"facewear0010",FACEWEAR_TWOPLAYER:"facewear0019",HEAD_ERIC_HELMET:"head0082",HEAD_AETIC:"head0089",HEAD_NONE:"head0000",HEAD_MASK:"head0001",HEAD_GAS_MASK:"head0002",HEAD_RADIO:"head0003",HEAD_US_MASK:"head0004",HEAD_US_CAP:"head0005",HEAD_US_CAP_BACKWARDS:"head0006",HEAD_US_SPEC_OPS:"head0007",HEAD_US_HELMET:"head0008",HEAD_US_HELMET_TACTICAL:"head0009",HEAD_US_BOONIE:"head0010",HEAD_US_GHILLIE:"head0011",HEAD_GIGN_HELMET:"head0012",HEAD_GIGN_HELMET_2:"head0013",HEAD_GIGN_CAP:"head0014",HEAD_GSG9_HELMET:"head0015",HEAD_GSG9_HELMET_2:"head0016",HEAD_GSG9_HELMET_3:"head0017",HEAD_OPFOR_SCARF:"head0018",HEAD_OPFOR_HELMET:"head0019",HEAD_OPFOR_HELMET_2:"head0020",HEAD_OPFOR_BERET:"head0021",HEAD_OPFOR_SHADES:"head0022",HEAD_OPFOR_COMMANDER:"head0023",HEAD_RU_MASK:"head0024",HEAD_RU_HAT:"head0025",HEAD_RU_SCARF:"head0026",HEAD_RU_TOQUE:"head0027",HEAD_RU_BERET:"head0028",HEAD_RU_CAP:"head0029",HEAD_RU_RECON:"head0030",HEAD_RU_HELMET:"head0031",HEAD_MILITIA_RADIO:"head0032",HEAD_MILITIA_BAND:"head0033",HEAD_MILITIA_BANDANA:"head0034",HEAD_MILITIA_CAP:"head0035",HEAD_MILITIA_SNIPER:"head0036",HEAD_JUGGERNAUT_HELMET:"head0037",HEAD_RIOT_HELMET:"head0055",HEAD_RIOT_HELMET_VISOR_UP:"head0056",HEAD_UN_BERET:"head0057",HEAD_UN_HELMET:"head0058",HEAD_NIGHTVISION:"head0059",HEAD_ALTYN_HELMET:"head0060",HEAD_ALTYN_HELMET_VISOR_UP:"head0061",HEAD_HOOD:"head0062",HEAD_BALLISTIC_MASK_BLACK:"head0045",HEAD_BALLISTIC_MASK_WHITE:"head0046",BODY_DINOGEN:"body0000",BODY_MILITIA:"body0001",BODY_DINOGEN_RIG:"body0003",BODY_DINOGEN_HEAVY:"body0006",BODY_MILITIA_RIG:"body0004",BODY_MILITIA_HEAVY:"body0007",BODY_JUGGERNAUT:"body0002",BODY_SHIRTLESS:"body0005",BODY_SHIRTLESS_TAN:"body0008",BODY_SHIRTLESS_DARK:"body0009",BODY_ZOMBIE:"body0010",BODY_ZOMBIE_2:"body0011",BODY_ZOMBIE_3:"body0012",LEGS_BOOTS:"boots",LEGS_SHORTS:"shorts",LEGS_BAREFOOT:"barefoot",LEGS_JUGGERNAUT:"juggernaut"},AvatarPresets={JUGGERNAUT:"juggernaut",COMMANDER:"commander",DINOGEN:"dinogen",DINOGEN_HEAVY:"dinogen_heavy",DINOGEN_RANDOM:"dinogen_random",MILITIA:"militia",SHIRTLESS:"shirtless",PETERSON:"peterson",LIAM:"liam",BROCK:"brock",ZOMBIE:"zombie",ZOMBIE_JUGGERNAUT:"zombie_juggernaut"},Faction={DINOGEN:"dinogen",MILITIA:"militia",DINOSAURS:"dinosaurs"};class GameInstance{settings=this.getDefaultSettings();getDefaultSettings(){return{intermissionTimer:15,maxBatchItems:30,maxWorldSize:10240,maxPlayerMoney:1e5,maxScenarioObjects:2e3,maxPickups:16,maxCrates:8,maxPawns:75,maxDroppedWeapons:12,maxSpawners:64,maxVehicles:64,maxSurvivalEnemies:14,maxSurvivalCars:4,maxSurvivalTanks:1,maxSurvivalTurrets:16,maxSurvivalHelicopters:4,maxSurvivalDinosaurs:8,maxFlames:60,maxFlamesPerPlayer:40,maxTurretsPerPlayer:4,maxFlashTime:6,maxStunTime:6,vehicleExplosionDamage:0}}init(e,a){if(this.log("Initializing game instance"),this.bGameEnded)console.warn("Game already ended");else try{this.settings=this.getDefaultSettings(),this.data=e.data,this.lobbyId=e.lobbyId,this.onEventFunc=a,this.batchData=[];var t=null!=e.settings.tickRate?Math.min(e.settings.tickRate,60):60,i={fps:t,restitution:.1,updateTimerMax:Math.round(t/(null!=e.settings.updateRate?e.settings.updateRate:60))};this.data.p2?(this.log("Using supplied p2"),this.p2=this.data.p2):"undefined"!=typeof p2?(this.log("Using fallback p2"),this.p2=p2):console.error("Missing p2 reference!"),this.game={bPaused:!1,bMultiplayer:e.bMultiplayer,bRanked:!0,bSurvival:!1,bScenario:!1,bFriendlyFire:null==e.settings.bFriendlyFire||e.settings.bFriendlyFire,settings:i,frameRate:1/30,timestepMult:i.fps/60,fpsMult:i.fps/60,gameSettings:this.clone(e.settings),gameModeId:e.gameModeId,mapId:e.mapId,mapData:null,state:MatchState.STATE_PRE_GAME,players:[],scenario:e.scenario?this.clone(e.scenario):null,cinematic:null,actionQueue:[],gameModeData:{id:e.gameModeId,timeLimit:e.settings.timeLimit?60*e.settings.timeLimit:null,respawnTime:e.settings.respawnTime?e.settings.respawnTime:5,bAllowClassSelection:!0,bSpawnProtection:!1!==e.settings.bSpawnProtection,bMapVehicles:1==e.settings.bMapVehicles,bMapObjects:null==e.settings.bMapObjects||e.settings.bMapObjects,bMapWeapons:null==e.settings.bMapWeapons||e.settings.bMapWeapons,vehicleRespawnTime:null!=e.settings.vehicleRespawnTime?e.settings.vehicleRespawnTime:60,weaponRespawnTime:null!=e.settings.weaponRespawnTime?e.settings.weaponRespawnTime:60,bAllowRespawns:!0,bAllowRevives:!1,bHardcore:1==e.settings.bHardcore,bUnlimitedAmmo:1==e.settings.bUnlimitedAmmo,botFaction:e.settings.botFaction?e.settings.botFaction:"all",allowFactions:e.settings.allowFactions?e.settings.allowFactions:"all",factions:[Faction.DINOGEN,Faction.MILITIA],vars:{}},lobbyId:e.lobbyId,preGameTimer:null!=e.settings.preGameTimer?e.settings.preGameTimer:10,gameTimer:0,interval:null,timer_game:null,timer_preGame:null,world:new this.p2.World({gravity:[0,0],broadphase:new this.p2.NaiveBroadphase}),objects:{},types:{},spawners:[],toRemove:[],objectsToUpdate:null,updateTimer:1,mapNodes:null,nodes:null,nodeObjects:{},nodeThreshold:50,nodeTicker:0,nodeTickerMax:3*i.fps,callbacks:this.data.callbacks},this.game.world.islandSplit=!1,this.game.world.applyGravity=!1,this.game.world.applySpringForces=!1,this.game.nodeTicker=this.game.nodeTickerMax,this.game.world.sleepMode=this.p2.World.BODY_SLEEPING,this.game.world.defaultContactMaterial.friction=.5,this.game.world.on("beginContact",(e=>{this.onBeginContact(e)})),this.game.world.solver.tolerance=this.game.bMultiplayer?.1:.9,this.game.world.solver.iterations=this.game.bMultiplayer?2:1,this.game.world.solver.frictionIterations=0,this.game.bMultiplayer||(this.settings.maxTurretsPerPlayer=8);for(var s=Object.keys(this.settings),r=0;r<s.length;r++){let e=s[r],a=this.game.gameSettings[e];if(null!=a){let t=0,i=1e6;switch(e){case"maxSurvivalEnemies":t=1;break;case"maxPawns":t=1,i=200}this.settings[e]=Math.min(i,Math.max(t,a)),this.scenarioLog("Override "+e+": "+this.settings[e])}}var n=this.getCurrentMapData(),o=CollisionGroups.PAWN|CollisionGroups.HELICOPTER|CollisionGroups.OBJECT|CollisionGroups.PROJECTILE|CollisionGroups.FLAME,d=new this.p2.Body({angle:3*Math.PI/2});d.data={id:"bounds_l",type:ObjectType.GROUND,bBounds:!0,bSkipServerUpdate:!0},d.addShape(new this.p2.Plane({collisionGroup:CollisionGroups.BOUNDS,collisionMask:o})),this.addWorldBody(d);var l=new this.p2.Body({angle:Math.PI/2,position:[this.getMapWidth(),0]});l.data={id:"bounds_r",type:ObjectType.GROUND,bBounds:!0,bSkipServerUpdate:!0},l.addShape(new this.p2.Plane({collisionGroup:CollisionGroups.BOUNDS,collisionMask:o})),this.addWorldBody(l);var h=new this.p2.Body({angle:0,position:[0,0]});h.data={id:"bounds_t",type:ObjectType.GROUND,bBounds:!0,bSkipServerUpdate:!0},h.addShape(new this.p2.Plane({collisionGroup:CollisionGroups.BOUNDS,collisionMask:o})),this.addWorldBody(h);var m=new this.p2.Body({angle:this.ToRad(180),position:[0,this.getMapHeight()]});switch(m.data={id:"bounds_b",type:ObjectType.GROUND,bBounds:!0,bSkipServerUpdate:!0},m.addShape(new this.p2.Plane({collisionGroup:CollisionGroups.BOUNDS,collisionMask:o})),this.addWorldBody(m),this.game.gameModeData.scores=[0,0],this.game.gameModeData.scoreLimit=e.settings.scoreLimit,this.game.scenario&&(this.game.gameModeData.quests=[],this.game.gameModeData.hudElements={}),this.game.gameModeId){case GameMode.SCENARIO:this.game.bRanked=!1,this.game.bScenario=!0,this.game.gameModeData.bMapObjects=!0,this.game.gameModeData.bAllowRespawns=1==this.game.gameSettings.bAllowRespawns,this.game.gameModeData.bAllowRevives=1==this.game.gameSettings.bAllowRevives;break;case GameMode.FREE_FOR_ALL:this.game.gameModeData.factions=null;break;case GameMode.HUMANS_VS_DINOSAURS:this.game.gameModeData.allowFactions="humans_dinosaurs";break;case GameMode.TYRANT:case GameMode.RAPTOR_HUNT:case GameMode.HUMANS_VS_DINOSAURS:this.game.gameModeData.factions=[Faction.DINOGEN,Faction.DINOSAURS];break;case GameMode.DOMINATION:this.game.gameModeData.flags=[];for(r=0;r<3;r++){this.game.gameModeData.flags.push(null),n.flags[this.game.gameModeId]||(n.flags[this.game.gameModeId]=[]),this.createFlag(n.flags[this.game.gameModeId][r],{flagType:GameMode.DOMINATION,num:r}).mass=0}break;case GameMode.CONQUEST:this.game.gameModeData.flags=[];for(r=0;r<5;r++){this.game.gameModeData.flags.push(null),n.flags[this.game.gameModeId]||(n.flags[this.game.gameModeId]=[]),this.createFlag(n.flags[this.game.gameModeId][r],{flagType:GameMode.DOMINATION,num:r}).mass=0}break;case GameMode.CAPTURE_THE_FLAG:this.game.gameModeData.flags=[];for(r=0;r<2;r++)this.game.gameModeData.flags.push(r),n.flags[this.game.gameModeId]||(n.flags[this.game.gameModeId]=[]),this.createFlag(n.flags[this.game.gameModeId][r],{flagType:GameMode.CAPTURE_THE_FLAG,num:r,team:r});break;case GameMode.DESTRUCTION:this.game.gameModeData.bombs=[0,0,1,1],this.game.gameModeData.scoreLimit=2,this.game.gameModeData.allowFactions="all";break;case GameMode.EVOLUTION:this.game.gameModeData.factions=[Faction.DINOGEN,Faction.DINOSAURS],this.game.gameModeData.dinoIndex=0,this.game.gameModeData.dinoKills=0,this.game.gameModeData.dinos=[{id:Dinosaur.COMPY,kills:3},{id:Dinosaur.DILO,kills:5},{id:Dinosaur.PACHY,kills:5},{id:Dinosaur.RAPTOR,kills:5},{id:Dinosaur.NEEDLER,kills:5},{id:Dinosaur.STEGOSAURUS,kills:6},{id:Dinosaur.CARNOTAURUS,kills:6},{id:Dinosaur.ALLOSAURUS,kills:8},{id:Dinosaur.SPINOSAURUS,kills:8}],e.settings.bReverse&&this.game.gameModeData.dinos.reverse(),this.game.gameModeData.dino=this.game.gameModeData.dinos[0].id,this.game.gameModeData.dinoKillsMax=this.game.gameModeData.dinos[0].kills;break;case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_DINO:case GameMode.SURVIVAL_MILITIA:case GameMode.SURVIVAL_ZOMBIE:case GameMode.SURVIVAL_CHICKEN:this.game.preGameTimer=this.game.gameSettings.preGameTimer?this.game.gameSettings.preGameTimer:0,this.game.bRanked=!1,this.game.bSurvival=!0,this.game.bFriendlyFire=!1,this.game.gameModeData.bHardcore=!1,this.game.gameModeData.bIntermission=!0,this.game.gameModeData.scores=null,this.game.gameModeData.bAllowRevives=!0,this.game.gameModeData.timeLimit=null,this.game.gameModeData.bHardcore=!1,this.game.gameModeData.bMapVehicles=!1,this.game.gameModeData.bMapObjects=!0,this.game.gameModeData.bMapWeapons=!1,this.game.gameModeData.bAllowRespawns=!1,this.game.gameModeData.bSpawnProtection=!0,this.game.gameModeData.wave=0,this.game.gameModeData.enemies=0,this.game.gameModeData.kills=0,this.game.gameModeData.waveRevives=0,this.game.gameModeData.allowFactions="humans",this.game.gameModeData.factions=[Faction.DINOGEN]}switch(this.initMap(),this.game.gameModeId){case GameMode.SURVIVAL_CHICKEN:this.game.gameSettings.bDisableMoneyDrops=!0;break;case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_DINO:case GameMode.SURVIVAL_MILITIA:case GameMode.SURVIVAL_ZOMBIE:!0!==this.game.gameSettings.bHideDefaultStoreCrate&&this.createCrate(n.storeSpawn,{team:0,mass:0,frame:"crate_store",crateType:Crate.STORE,bDisposable:!1});break;case GameMode.DESTRUCTION:var c=n.bombs[this.game.gameModeId],p=0;if(c)for(r=0;r<c.length;r++){let e=c[r];for(var g=0;g<e.length;g++){let a=e[g];if(!a)throw new Error("Invalid bomb position at bomb index "+r);this.createObstacle({position:a,angle:0,obstacleId:"platform",bNoBody:!0}),this.createCrate(a,{mass:0,team:r,num:p,crateType:Crate.BOMB,bLimitInteractions:!0,itemData:{interactTime:3*this.game.settings.fps,interactTeam:0==r?1:0}});p++}}else console.warn("Invalid bomb spawn points",n.bombs)}this.game.nodeTicker=1,this.onEvent({eventId:GameServer.EVENT_GAME_INIT,shared:this.data.shared,mapId:this.game.mapId,gameModeId:this.game.gameModeId,settings:this.game.settings,gameModeData:this.game.gameModeData,mapData:this.getCurrentMapData()}),(this.game.gameModeData.timeLimit||this.game.scenario)&&(this.game.gameTimer=this.game.gameModeData.timeLimit,this.game.timer_game=setInterval((()=>{this.onGameTimer()}),1e3));var E=this.clone(e.players);if(this.game.scenario&&!this.game.scenario.settings.bAllowGameModeSelection&&e.settings.bots){console.log("Add",e.settings.bots,"scenario bots",e.settings.botSkill);for(r=0;r<e.settings.bots;r++){var b=this.getBot(null!=e.settings.botSkill?e.settings.botSkill:1);if(e.settings.bDeathmatch||this.game.gameModeId==GameMode.FREE_FOR_ALL)b.team=E.length;else if(-1==e.settings.botTeam)switch(this.game.gameModeId){case GameMode.TYRANT:b.team=0==r?1:0;break;default:b.team=r%2==0?0:1}else b.team=null!=e.settings.botTeam?e.settings.botTeam:0;E.push(b)}}for(r=0;r<E.length;r++){var u=E[r];!u.bBot&&this.game.bMultiplayer||this.addPlayer(u)}this.game.preGameTimer>0?(this.game.timer_preGame=setInterval((()=>{this.onPreGameTimer()}),1e3),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:this.game.gameModeData}),this.onEvent({eventId:GameServer.EVENT_GAME_PRE_TIMER,timer:this.game.preGameTimer})):(this.isGeneratingNodes(),this.game.state=MatchState.STATE_IN_PROGRESS,this.requestEvent({eventId:GameServer.EVENT_GAME_START,timer:this.game.gameTimer}),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:this.game.gameModeData})),e.settings.forest&&this.createForest(e.settings.forest),e.settings.boxes&&this.createBoxes(e.settings.boxes),this.game.bSurvival&&this.startSurvivalWaveIntermission(),clearInterval(this.game.interval),this.game.interval=setInterval((()=>{this.tick()}),1e3/this.game.settings.fps),this.bInit=!0}catch(e){this.onGameError(e)}}destroy(){this.log("Destroy game");var e=this.game;if(e){var a=e.world;if(a){a.time=0,a.fixedStepTime=0,a.solver&&a.solver.equations.length&&a.solver.removeAllEquations();for(var t=a.constraints,i=t.length-1;i>=0;i--)a.removeConstraint(t[i]);var s=a.bodies;for(i=s.length-1;i>=0;i--)a.removeBody(s[i]);var r=a.springs;for(i=r.length-1;i>=0;i--)a.removeSpring(r[i]);var n=a.contactMaterials;for(i=n.length-1;i>=0;i--)a.removeContactMaterial(n[i]);a.off("beginContact")}for(clearInterval(this.game.interval),delete this.game.interval,this.stopAllTimers();this.game.players.length>0;)this.removePlayer(this.game.players[0].id);delete this.game.gameModeData.vars;var o=Object.keys(this.game);for(i=0;i<o.length;i++)delete this.game[o[i]];delete this.game,delete this.onEndCallback,delete this.onEventFunc,delete this.batchData,delete this.onEndCallback,delete this.lobbyId;for(o=Object.keys(this.data),i=0;i<o.length;i++)delete this.data[o[i]];delete this.data,delete this.gpu,delete this.p2,delete this.bInit,delete this.settings}}setEndCallback(e){this.onEndCallback=e}log(e){console.log("[game.js] "+e)}scenarioLog(e,a){this.game.gameSettings.bDebug&&(console.log(e),this.triggerCallback("chat",{messageText:e,playerText:"Debug",fill:a,date:Date.now()}))}endGame(){if(!this.bGameEnded){this.log("End game"),this.bGameEnded=!0,this.game.state=MatchState.STATE_POST_GAME,this.game.gameModeData.bAllowRespawns=!1,this.resetPlayerInputs(),this.stopAllTimers();for(var e=this.getPawns(),a=0;a<e.length;a++){var t=e[a],i=t.data;switch(i.bWantsToFire&&(i.bWantsToFire=!1),i.type){case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:case ObjectType.MOUNTED_WEAPON:var s=i.weapons;if(s)for(var r=0;r<s.length;r++){var n=this.getCurrentVehicleWeapon(t,r);n&&(n.bWantsToFire=!1)}break;case ObjectType.CHARACTER:case ObjectType.DINOSAUR:i.bWantsToMove=!1,i.bWantsToFire=!1,this.triggerCharacterWeapon({playerId:i.id,value:!1}),this.cancelCharacterReload(t)}}this.onEndCallback&&this.onEndCallback(this.lobbyId)}}tick(){try{this.update()}catch(e){this.onGameError(e)}}delay(e){return new Promise((a=>setTimeout(a,e)))}async loop(){for(;this.game;)this.tick(),await this.delay(1e3/this.game.settings.fps)}onGameError(e,a){console.error(e),this.game&&(this.game.bMultiplayer?(this.triggerCallback("chat",{locText:"STR_ERROR_RUNTIME_X",params:[e.message],bError:!0}),this.triggerCallback("error",{endTimer:a})):this.onEventFunc({eventId:GameServer.EVENT_ERROR,error:e}))}update(){if(!this.game)return clearInterval(this.game.interval),void this.log("Clear game interval");if(this.game.bPaused)this.game.resetCallTime=!0;else{for(var e=0;e<this.game.players.length;e++){var a=this.game.players[e],t=this.getObjectById(a.id);if(a.bBot,!this.game.gameModeData.bAllowRespawns||this.game.gameSettings.bDisableRespawnTimer||a.bSpectator||null!=a.timer_respawn&&a.bWaitingToRespawn&&(a.timer_respawn>0?a.timer_respawn--:this.onRespawnTimer(a.id)),a.multiKillTimer>0?a.multiKillTimer--:0==a.multiKillTimer&&(this.endMultiKill(a),a.multiKillTimer=-1),a.avengerTimer>0?a.avengerTimer--:a.avengerTimer=-1,null!=a.timer_spawnProtection&&(a.timer_spawnProtection>0?a.timer_spawnProtection--:this.onSpawnProtectionTimer(a.id)),t&&t.data.health)a.bHasPawn||(a.bHasPawn=!0,this.game.gameModeData.bAllowRespawns&&(a.bWaitingToRespawn=!1),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{bHasPawn:a.bHasPawn,bWaitingToRespawn:a.bWaitingToRespawn}}));else if(a.bHasPawn)if(a.bHasPawn=!1,this.game.gameModeData.bAllowRespawns)(null==a.lives||a.lives>0)&&(a.bCanRespawn=!1,a.bWaitingToRespawn=!0,a.respawnTimer<=0&&(null==a.timer_respawn&&(a.respawnTimer=this.game.gameModeData.respawnTime+1,a.timer_respawn=this.game.settings.fps),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{bCanRespawn:a.bCanRespawn,bWaitingToRespawn:a.bWaitingToRespawn,bHasPawn:a.bHasPawn,respawnTimer:a.respawnTimer}})));else this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{bHasPawn:a.bHasPawn}})}if(this.game.bSurvival&&this.matchInProgress()){var i=this.game.gameModeData;if(i.waveTimer>0)i.waveTimer--,i.waveTimer<=0&&i.intermissionTimer>=0&&(i.intermissionTimer--,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{timer:i.intermissionTimer}}),-1==i.intermissionTimer?this.startSurvivalWave():i.waveTimer=this.game.settings.fps);else if(i.spawnTimer>0&&(i.spawnTimer--,i.spawnTimer<=0&&i.enemiesSpawned<i.numEnemies)){if(this.getNumPawnsOnTeam(1)<this.settings.maxSurvivalEnemies){var s=this.game.gameModeData.wave;switch(this.game.gameModeId){case GameMode.SURVIVAL_CHAOS:if(s%25==0)0==i.enemiesSpawned?(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++):this.spawnSurvivalEnemyVehicle();else if(8==s)i.enemiesSpawned<=2?(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++):(this.spawnSurvivalEnemyCharacter(),i.enemiesSpawned++);else if(s%5==0){let e=Math.max(0,Math.min(3,s/5-5));s>5&&i.enemiesSpawned<=e?this.spawnSurvivalEnemyVehicle():i.enemiesSpawned<=s/5?(this.spawnSurvivalEnemyCharacter(),i.enemiesSpawned++):(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++)}else 12==s?i.enemiesSpawned<5?this.spawnSurvivalEnemyTurret():(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++):3==s?0==i.enemiesSpawned?this.spawnSurvivalEnemyVehicle():(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++):s>5&&1==this.Random(1,Math.max(5,30-s))?this.getNumHelicoptersOnTeam(0)>=3?this.spawnSurvivalEnemyTurret():1==this.Random(1,s<20?2:1)?this.spawnSurvivalEnemyVehicle():this.spawnSurvivalEnemyTurret():s>5&&1==this.Random(1,Math.max(10,40-s))?this.spawnSurvivalEnemyEgg():1==this.Random(1,2)?(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++):(this.spawnSurvivalEnemyCharacter(),i.enemiesSpawned++);break;case GameMode.SURVIVAL_DINO:s%5==0&&s>25&&s%25!=0||s>5&&s%5!=0&&1==this.Random(1,Math.max(10,50-s))?this.spawnSurvivalEnemyEgg():(this.spawnSurvivalEnemyDinosaur(),i.enemiesSpawned++);break;case GameMode.SURVIVAL_MILITIA:if(s%5==0){let e=Math.max(0,Math.min(5,s/5-5));s>5&&i.enemiesSpawned<=e?this.spawnSurvivalEnemyVehicle():(this.spawnSurvivalEnemyCharacter(),i.enemiesSpawned++)}else 12==s?this.spawnSurvivalEnemyTurret():3==s?this.spawnSurvivalEnemyVehicle():s>5&&1==this.Random(1,Math.max(5,30-s))?this.getNumHelicoptersOnTeam(0)>=3?this.spawnSurvivalEnemyTurret():1==this.Random(1,s<20?2:1)?this.spawnSurvivalEnemyVehicle():this.spawnSurvivalEnemyTurret():(this.spawnSurvivalEnemyCharacter(),i.enemiesSpawned++);break;case GameMode.SURVIVAL_ZOMBIE:this.spawnSurvivalEnemyZombie(),i.enemiesSpawned++;break;case GameMode.SURVIVAL_CHICKEN:this.spawnSurvivalEnemyChicken(),i.enemiesSpawned++}}i.spawnTimer=i.spawnTimerMax}}if(!this.matchHasEnded()&&this.game.nodesToCheck){let e=this.game.bMultiplayer?10:100;for(let a=0;a<e;a++){let e=this.game.nodesToCheck[0];if(e&&this.checkPathNodeAtNode(e[0],e[1]),this.game.nodesToCheck.length>0&&this.game.nodesToCheck.splice(0,1),!this.game.nodesToCheck.length){delete this.game.nodesToCheck,delete this.game.numNodesToCheck,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bGeneratingNodes:!1}}),this.dispatchTrigger({event:"nodesGenerated"});break}this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{nodeProgress:1-this.game.nodesToCheck.length/this.game.numNodesToCheck}})}}var r=[],n=[],o=[],d=[],l=[],h=[];for(var m in this.game.objects){let e=this.game.objects[m];if(!e)continue;let a=e.data;if(a&&!a.bPendingRemoval){if(null!=a.destroyTimer&&(a.destroyTimer--,a.destroyTimer<=0&&this.removeNextStep(e)),a.bStunned&&(a.stunTimer>0?a.stunTimer--:(a.bStunned=!1,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_STUN,bValue:!1}))),a.bFlashed&&(a.flashTimer>0?a.flashTimer--:(a.flashIntensity=null,a.bFlashed=!1,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_FLASH,bValue:!1}))),a.bRegenHealth&&a.health>0){let t=!1,i=a.maxHealth*(null!=a.regenThreshold?a.regenThreshold:1);if(a.health<i)if(a.regenTimer<=0){let i=a.regenAmount?a.regenAmount:1;i/=this.game.fpsMult,this.isNearHealthBox(e)&&(i*=2),a.health=Math.min(a.maxHealth,a.health+i),this.pushObjectDataUpdate(a.id,["health"]),t=!0,a.damagedBy&&delete a.damagedBy}else a.regenTimer=Math.max(0,a.regenTimer-(this.isNearHealthBox(e)?5:1));this.setDataValue(e,"bRegen",t)}switch(this.isVehicle(e)&&!a.bDisabled&&l.push(e),a.type){case ObjectType.GROUND:case ObjectType.TREE:break;case ObjectType.SPAWNER:this.handleSpawner(e);break;case ObjectType.REVIVER:this.handleReviver(e);break;case ObjectType.DOOR:this.handleDoor(e);break;case ObjectType.SHIELD:this.handleShield(e);break;case ObjectType.CRATE:this.handleCrate(e);break;case ObjectType.FLAME:r.push(e),this.handleFlame(e);break;case ObjectType.MONEY:o.push(e),this.handleMoney(e);break;case ObjectType.ARROW:d.push(e),this.handleArrow(e);break;case ObjectType.EGG:this.handleEgg(e);break;case ObjectType.CHARACTER:this.handlePawn(e),a.bBot&&!this.matchHasEnded()&&this.handleAICharacter(e);break;case ObjectType.DINOSAUR:this.handleDinosaur(e),a.bBot&&!this.matchHasEnded()&&this.handleAICharacter(e);break;case ObjectType.HELICOPTER:this.handleHelicopter(e);break;case ObjectType.TANK:this.handleTank(e);break;case ObjectType.CAR:h.push(e),this.handleCar(e);break;case ObjectType.MOUNTED_WEAPON:this.handleMountedWeapon(e);break;case ObjectType.ROCKET:this.handleRocket(e);break;case ObjectType.GRENADE:this.handleGrenade(e);break;case ObjectType.EQUIPMENT:this.handleEquipment(e);break;case ObjectType.OBSTACLE:a.detonationTimer>0&&(a.detonationTimer--,a.detonationTimer<=0&&this.detonate(e));break;case ObjectType.FLAG:if(this.matchInProgress())switch(a.flagType){case GameMode.DOMINATION:this.handleDominationFlag(e);break;default:this.handleFlag(e)}break;case ObjectType.TRIGGER_AREA:this.handleTriggerArea(e);break;case ObjectType.DROPPED_WEAPON:n.push(e),this.isOutOfMap(e)&&this.removeNextStep(e);break;default:this.isOutOfMap(e)&&this.removeNextStep(e)}if(!a.bSkipServerUpdate){this.game.objectsToUpdate||(this.game.objectsToUpdate={});let t=this.game.objectsToUpdate,i=a.id;t[i]||(t[i]=[]);let s=t[i],r={};if(r.id=i,e.previousPosition&&e.position[0]==e.previousPosition[0]&&e.position[1]==e.previousPosition[1]||this.CheckValidArray(e.position)&&(r.position=this.RoundNumberArray(e.position)),this.CheckValidArray(e.velocity)&&(r.velocity=this.RoundNumberArray(e.velocity)),e.previousAngle&&e.previousAngle==e.angle||(r.rotation=e.angle),null!=a.bWantsToMove&&(r.bWantsToMove=a.bWantsToMove),null!=a.lookPos&&(r.lookPos=a.lookPos),null!=a.desiredAimRotation&&(r.desiredAimRotation=a.desiredAimRotation),null!=a.destroyTimer&&(r.destroyTimer=a.destroyTimer),this.isVehicle(e)){var c=a.weapons;if(c){r.weapons=[];for(var p=0;p<c.length;p++){r.weapons[p]=[];for(var g=c[p],E=0;E<g.length;E++){var b=g[E];b&&(r.weapons[p][E]={aimRotation:b.aimRotation,bCooldown:b.bCooldown},b.weaponData&&b.weaponData.overheatMax&&(r.weapons[p][E].overheat=b.overheat))}}}}Object.keys(r).length>0&&s.push(r)}}}if(r.length>this.settings.maxFlames&&this.removeNextStep(r[0]),n.length>this.settings.maxDroppedWeapons&&this.removeNextStep(n[0]),o.length>this.settings.maxPickups?this.removeNextStep(o[0]):d.length>this.settings.maxPickups&&this.removeNextStep(d[0]),l.length>this.settings.maxVehicles)for(e=0;e<l.length;e++){let a=l[e];if(!a.data.bPendingRemoval&&!this.vehicleHasOccupant(a)){console.log("Remove vehicle",e,a.data.type,this.settings.maxVehicles),this.removeNextStep(a);break}}if(this.game.actionQueue)for(e=0;e<this.game.actionQueue.length;e++){let a=this.game.actionQueue[e],t=a.action;t.delay>0&&(a.delayTimer>0?a.delayTimer--:(delete t.delay,t.delay=a.delay,this.executeTriggerAction(t,a.params),this.game.actionQueue.splice(e,1)))}if(this.handleCinematic(),this.dispatchTrigger({event:"gameTick"}),1==this.game.updateTimer){if(this.game.objectsToUpdate){var u=Object.keys(this.game.objectsToUpdate),I={},T=u.length;for(e=0;e<T;e++){let a=u[e];if(!a)continue;let t=this.game.objectsToUpdate[a];if(!t)continue;let i=t[t.length-1];if(i&&(I[a]=i.data,t.length==this.game.settings.updateTimerMax)){var v=[];for(p=0;p<t.length;p++){let e=t[p],a=null,i=null;if(p>0)a=t[p-1].data;else{let t=this.game.prevObjectData;t&&(a=t[e.id])}if(a){let a=null;if(a){let t=this.clone(e);t.data=a,v.push(t)}}i||(this.optimize(e),v.push(e))}v&&(this.game.objectsToUpdate[a]=v)}}this.onEvent({eventId:GameServer.EVENT_OBJECT_UPDATE,objects:this.game.objectsToUpdate}),this.game.prevObjectData=I,delete this.game.objectsToUpdate}this.game.updateTimer=this.game.settings.updateTimerMax}else this.game.updateTimer--;var y=this.game.world,A=0,O=Date.now(),R=this.game.bMultiplayer?10:1;if(this.game.resetCallTime?(A=0,this.game.resetCallTime=!1):void 0!==O&&void 0!==this.game.lastTimeMilliseconds&&(A=(O-this.game.lastTimeMilliseconds)/1e3),this.game.bMultiplayer&&A>1)return console.warn("timeSinceLastCall:",A),void this.onGameError(new Error("Game tick timeout"),0);if(y.step(this.game.frameRate,A,R),this.game.lastTimeMilliseconds=O,this.matchInProgress()&&!this.game.nodeBodies&&!this.game.gameSettings.tickRate&&A>0)if(this.game.msTracker||(this.game.msTracker=[]),this.game.msTracker.length<2*this.game.settings.fps)this.game.msTracker.push(A);else{var M=0;for(e=0;e<this.game.msTracker.length;e++)M+=this.game.msTracker[e];(M/=this.game.msTracker.length)>1.35*(1e3/this.game.settings.fps/1e3)&&this.setTickRate(30),this.game.msTracker=[]}for(;this.game.toRemove.length>0;){var _=this.game.toRemove[0];if(_&&_.data){var D=_.data.id;this.removeObject(_),this.onRemove(D)}this.game.toRemove.splice(0,1)}}this.sendBatchData()}setTickRate(e){var a=this.game.settings.fps,t=null!=e?Math.min(Math.max(1,e),60):60;this.game.settings.fps=t,this.game.settings.updateTimerMax=Math.ceil(t/(null!=this.game.settings.updateRate?this.game.settings.updateRate:60)),this.game.timestepMult=t/60,this.game.fpsMult=t/60,a!=t&&(console.log("New tick rate:",t),clearInterval(this.game.interval),this.game.interval=setInterval((()=>{this.tick()}),1e3/this.game.settings.fps),this.onTickRateChanged(t/a),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{tickRate:t}}),this.triggerCallback("chat",{messageText:"Tick rate set to "+t,bServer:!0}))}onRemove(e){switch(this.dispatchTrigger({event:"objectRemoved",objectId:e}),this.game.gameModeId){case GameMode.EVOLUTION:if(this.game.gameModeData.bEvolve){delete this.game.gameModeData.bEvolve;var a=this.getPlayerById(e);a&&1==a.team&&(this.respawnPlayer(a.id,{position:this.game.gameModeData.dinoPos}),a.respawnData&&delete a.respawnData.position)}}}isOutOfMap(e,a){if(e&&this.getCurrentMapData()){if(e.position[0]<0||e.position[0]>this.getMapWidth()||e.position[1]>this.getMapHeight()||isNaN(e.position[0])||isNaN(e.position[1]))return!0;if(a&&this.bodyIsInWall(e))return!0}return!1}isOutOfHelicopterArea(e){if(e&&(this.getCurrentMapData()&&(e.position[0]<0||e.position[0]>this.getMapWidth()||e.position[1]>this.getMapHeight()||isNaN(e.position[0])||isNaN(e.position[1]))))return!0;return!1}removeDuplicateKeys(e,a){if(e&&a){for(var t={},i=Object.keys(e),s=0;s<i.length;s++){var r=i[s],n=e[r];"boolean"==typeof n?n=n?1:0:"number"==typeof n&&n%1!=0&&(n=this.RoundDecimal(n));var o=a[r];"boolean"==typeof o&&(o=o?1:0),o!==n&&(t[r]=n)}if(t)return t}else console.warn("removeDuplicateKeys: Invalid source or target reference");return null}updateNodesForBody(e){var a=this.getNodesForObject(e),t=a.length;for(let e=0;e<t;e++){let t=a[e];this.checkPathNodeAtNode(t[0],t[1],!0)&&0}}addDirtyNodeObject(e){this.checkDirtyNodeObject(e.data.id),this.game.nodes&&this.updateNodesForBody(e)}checkDirtyNodeObject(e){let a=this.game.nodeObjects[e];if(a){for(var t=0,i=0;i<a.length;i++){let e=a[i];this.checkPathNodeAtNode(e[0],e[1])&&t++}t>0&&this.updateGraph()}}removeDirtyNodeObject(e){this.checkDirtyNodeObject(e)}checkDirtyNodeObjects(){for(var e=0;e<this.game.dirtyNodeObjects.length;e++){let t=this.game.dirtyNodeObjects[e],i=this.game.nodeObjects[t];if(i){for(var a=0;a<i.length;a++){let e=i[a];this.checkPathNodeAtNode(e[0],e[1])&&numChanged++,numChecked++}numChanged>0&&this.updateGraph()}}}checkPathNodeAtNode(e,a,t){var i=this.game.nodes;try{var s=i[e][a]}catch(e){return!1}var r=this.game.nodeThreshold,n=[e*r,a*r];if(this.game.mapNodes.length>0&&this.game.mapNodes[e]&&0==this.game.mapNodes[e][a])i[e][a]=0;else if(0===i[e][a]&&t);else{let t=this.getNodeBodies(n);i[e][a]=1;this.game.nodeThreshold;let s=[n];e:for(let r=0;r<s.length&&0!=i[e][a];r++){let n=s[r],o=this.game.world.hitTest(n,t,1);if(o){let t=o.length;for(let s=0;s<t;s++){let t=o[s];if(t&&t.data&&!t.data.bBounds&&!t.data.bPendingRemoval&&!t.data.bNoBody&&t.shapes.length){let s=t.data;switch(s.type){case ObjectType.GROUND:i[e][a]=0,s.spriteId&&(this.game.mapNodes[e]||(this.game.mapNodes[e]=[]),this.game.mapNodes[e][a]=0);break;case ObjectType.OBSTACLE:case ObjectType.MOUNTED_WEAPON:i[e][a]=0;break;case ObjectType.CRATE:t.mass!=Number.MAX_VALUE&&s.crateType!=Crate.BOMB||(i[e][a]=0);break;case ObjectType.CAR:case ObjectType.TANK:case ObjectType.HELICOPTER:(t.mass==Number.MAX_VALUE||s.bDisabled)&&(i[e][a]=0);break;case ObjectType.DOOR:s.bDisabled&&s.bClosed&&(i[e][a]=0)}if(0==i[e][a]||s.type==ObjectType.DOOR){if(s.id){this.game.nodeObjects[s.id]||(this.game.nodeObjects[s.id]=[]);let t=[e,a],i=this.game.nodeObjects[s.id],r=!0;a:for(let e=0;e<i.length;e++){let a=i[e];if(a[0]==t[0]&&a[1]==t[1]){r=!1;break a}}r&&i.push(t)}else console.warn("Missing id",s.type);break e}}}}}}return i[e][a]!=s}generateCurrentNode(){if(this.game.nodeBodies)try{var e=this.game.nodeBodies[this.game.nodeBodyIndex],a=this.getNodesForObject(e),t=a.length;for(let e=0;e<t;e++){let t=a[e];this.checkPathNodeAtNode(t[0],t[1],!0)&&0}this.game.nodeBodyIndex++,this.game.nodeBodyIndex>this.game.nodeBodies.length-1&&(console.log("Map node generation complete"),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bGeneratingNodes:!1}}),delete this.game.nodeBodies,delete this.game.nodeBodyIndex,this.updateGraph())}catch(e){this.onGameError(e)}}generateMapNodes(){this.log("generateMapNodes");var e=this.getCurrentMapData();this.game.mapNodes||(this.game.scenario&&this.game.scenario.nodes?this.game.mapNodes=this.clone(this.game.scenario.nodes):this.game.mapNodes=e.ai.nodes?this.clone(e.ai.nodes):[]);var a=this.bInit||this.game.scenario;this.game.nodes||(this.game.nodes=a?[]:this.clone(this.game.mapNodes)),a&&this.initNodes(),this.game.nodesToCheck=[];for(var t=this.getTypes([ObjectType.GROUND,ObjectType.OBSTACLE,ObjectType.MOUNTED_WEAPON,ObjectType.CRATE,ObjectType.CAR,ObjectType.TANK,ObjectType.HELICOPTER,ObjectType.DOOR]),i=0;i<t.length;i++){let e=t[i],a=e.data;if(e.data&&!e.data.bPendingRemoval&&!a.bNoBody&&e.shapes.length){let t=!1;switch(a.type){case ObjectType.GROUND:(a.spriteId||a.shape)&&(t=!0);break;case ObjectType.OBSTACLE:case ObjectType.MOUNTED_WEAPON:t=!0;break;case ObjectType.CRATE:case ObjectType.CAR:case ObjectType.TANK:case ObjectType.HELICOPTER:(e.mass==Number.MAX_VALUE||a.bDisabled)&&(t=!0);break;case ObjectType.DOOR:t=!0;break;default:t=!1}if(t){let a=this.getNodesForObject(e);for(let e=0;e<a.length;e++){let t=a[e];try{if(this.nodeExists(t))continue;0!=this.game.nodes[t[0]][t[1]]&&(this.game.nodesToCheck.push(t))}catch(e){}}}}}this.game.numNodesToCheck=this.game.nodesToCheck.length,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bGeneratingNodes:!0,nodeProgress:0}}),this.dispatchTrigger({event:"nodesGenerating"})}nodeExists(e){if(this.game.nodesToCheck)for(var a=0;a<this.game.nodesToCheck.length;a++){let t=this.game.nodesToCheck[a];if(t[0]==e[0]&&t[1]==e[1])return!0}return!1}initNodes(){console.log("Init nodes...");var e=this.game.nodes,a=this.game.nodeThreshold,t=Math.floor(this.getMapWidth()/a),i=Math.floor(this.getMapHeight()/a);for(let a=0;a<i;a++)for(let i=0;i<t;i++)e[i]||(e[i]=[]),null==e[i][a]&&(e[i][a]=1)}getNodesForObject(e){if(!e)return[];var a=[],t=this.game.nodeThreshold,i=e.getAABB();if(i)for(var s=Math.ceil(this.getMapWidth()/t),r=Math.ceil(this.getMapHeight()/t),n=[Math.floor((i.lowerBound[0]-0)/t),Math.floor((i.lowerBound[1]-0)/t)],o=[Math.ceil((i.upperBound[0]+0)/t),Math.ceil((i.upperBound[1]+0)/t)],d=n[0]-1;d<o[0]+1;d++)for(var l=n[1]-1;l<o[1]+1;l++)d>=0&&d<=s&&l>=0&&l<=r&&a.push([d,l]);return a}getAIBestDominationFlag(e){for(var a=e.data,t=this.getFlags(),i=null,s=Number.MAX_VALUE,r=!1,n=0;n<t.length;n++){var o=t[n];if(o.data.team!=a.team){var d=this.Dist(e.position[0],e.position[1],o.position[0],o.position[1]);d<s&&(r=!0,i=o,s=d)}}return r?i:t[this.Random(0,t.length-1)]}setLocalPlayerCamera(e){if(!this.game.bMultiplayer)for(var a=this.getObjectById("player"),t=e.scale,i=e.x,s=e.x+e.width/t,r=e.y,n=e.y+e.height/t,o=this.getTypes([ObjectType.OBSTACLE]),d=0;d<o.length;d++){let e=o[d],t=e?e.data:null;if(t&&!t.bNoBody&&!t.bPendingRemoval&&e.shapes.length){let o=e.position,d=a?this.DistBodies(a,e):Number.MAX_VALUE;switch(t.type){case ObjectType.GROUND:d>2e3&&(o[0]<i||o[0]>s||o[1]<r||o[1]>n)?this.removeBodyFromWorld(e):this.addBodyToWorld(e);case ObjectType.OBSTACLE:!e.data.bBlockLOS&&d>1e3&&(o[0]<i||o[0]>s||o[1]<r||o[1]>n)?this.removeBodyFromWorld(e):this.addBodyToWorld(e)}}}}removeBodyFromWorld(e){return!(!e||!e.world)&&(this.game.world.removeBody(e),!0)}addBodyToWorld(e){return!(!e||e.world)&&(this.game.world.addBody(e),!0)}randomizeAStarNodes(e){for(var a=this.clone(e),t=0;t<a.length;t++)for(var i=a[t],s=0;s<i.length;s++){1==i[s]&&(i[s]=this.Random(1,10))}return a}updateGraph(){}getAStarPath(e,a,t,i,s){var r,n=[];if(e&&e.length>0){var o=this.game.nodeThreshold;try{var d=this.data.astarGraph,l=this.game.graph?this.game.graph:new d(e),h=Math.round(a/o),m=Math.round(t/o),c=Math.round(i/o),p=Math.round(s/o),g=this.getNearestValidNode(e,{x:h,y:m}),E=this.getNearestValidNode(e,{x:c,y:p}),b=l.grid[g.x][g.y],u=l.grid[E.x][E.y];r=this.data.astar.search(l,b,u,{heuristic:this.data.astar.heuristics.diagonal})}catch(e){r=null}if(r)for(var I=0;I<r.length;I++){var T=r[I];n.push({data:{position:[T.x*o,T.y*o]}})}}return n.push({data:{position:[i,s]}}),n}getNearestValidPosition(e){var a=this.game.nodeThreshold,t=Math.round(e[0]/a),i=Math.round(e[1]/a),s=this.getNearestValidNode(this.game.nodes,{x:t,y:i});return s?[s.x*a,s.y*a]:e}getNearestValidNode(e,a){try{if(a.x=Math.min(e.length-1,Math.max(0,a.x)),a.y=Math.min(e[0].length-1,Math.max(0,a.y)),0==e[a.x][a.y])for(var t=1;t<10;t++)for(var i=[{x:a.x,y:a.y+t},{x:a.x,y:a.y-t},{x:a.x+t,y:a.y},{x:a.x+t,y:a.y+t},{x:a.x-t,y:a.y},{x:a.x-t,y:a.y-t},{x:a.x+t,y:a.y-t},{x:a.x-t,y:a.y+t}],s=0;s<i.length;s++){var r=i[s];if(null!=e[r.x]&&0!=e[r.x][r.y])return a.x=r.x,a.y=r.y,a}}catch(e){console.warn(e)}return a}getAIPath(e,a,t){return this.getAStarPath(this.game.nodes,e[0],e[1],a[0],a[1])}initMap(){var e=this.getCurrentMapData();if(this.game.gameSettings.bAllowMapSelection&&(this.game.gameSettings.bUseDefaultMapObjects=!0),!this.game.scenario||this.game.gameSettings.bUseDefaultMapObjects)var a=this.clone(e.objects);else a=[];if(this.game.scenario&&(this.game.gameSettings.bDisableTriggers&&(this.game.scenario.triggers=[]),this.game.scenario.objects&&!this.game.gameSettings.bUseDefaultMapObjects)){var t=this.game.scenario.objects;console.log("Scenario objects:",t.length),t.length>this.settings.maxScenarioObjects&&(console.warn("Exceeded max scenario objects:",t.length),this.scenarioLog("[WARNING] Exceeded max scenario objects: "+t.length+"/"+this.settings.maxScenarioObjects,Colours.RED_STRING));for(var i=Math.min(this.settings.maxScenarioObjects,t.length)-1;i>=0;i--){let e=t[i];e.position&&(e.position[0]>this.settings.maxWorldSize||e.position[0]<-this.settings.maxWorldSize||e.position[1]>this.settings.maxWorldSize||e.position[1]<-this.settings.maxWorldSize)&&t.splice(i,1)}a=a.concat(t)}for(i=0;i<a.length;i++)this.checkSpecialStringsInObject(a[i]),this.createObject(a[i])}isSpecialString(e){if(e&&"string"==typeof e){var a=e.indexOf("{");if(a>=0)if(e.indexOf("}")>=a)return!0;return"{"==e.charAt(0)&&"}"==e.charAt(e.length-1)}return!1}checkSpecialString(e){if(!e||"string"!=typeof e)return e;var a=e;if(this.isSpecialString(e)){let o=e.slice(1,-1),d=o.split(":");if(null!=d[1]){let e=o.indexOf("{");if(e>=0){let a=o.slice(e);d[1]=this.checkSpecialString(a)}switch(d[0]){case"random":a=this.Random(parseInt(d[1]),parseInt(d[2]));break;case"randomMods":a=this.getAllModsForWeapon(d[1]);break;case"special":switch(d[1]){case"randomPlayerId":a=this.game.players[this.Random(0,this.game.players.length-1)].id;break;case"numPlayers":a=this.game.players.length;break;case"lastLivingPlayerTeam":for(var t=[],i=0;i<this.game.players.length;i++){var s=this.game.players[i];this.getObjectById(s.id)&&-1==t.indexOf(s.team)&&t.push(s.team)}a=1==t.length?t[0]:null;break;case"lastLivingPlayerId":var r=[];for(i=0;i<this.game.players.length;i++){s=this.game.players[i];this.getObjectById(s.id)&&r.push(s.id)}a=1==r.length?r[0]:null;break;case"randomBoolean":a=this.RandomBoolean();break;case"randomRotation":a=this.Random(-180,180);break;case"randomAngle":a=this.RandomAngle();break;case"randomWeaponId":a=this.getRandomWeapon().id;break;case"randomFirearmId":a=this.getRandomFirearm().id;break;case"randomEquipmentId":a=this.getRandomEquipment().id;break;case"randomGrenadeId":a=this.getRandomGrenade().id;break;case"randomMeleeId":a=this.getRandomMelee().id;break;case"randomDinoId":a=this.getRandomDinosaur();break;case"uniqueId":a=this.getRandomUniqueId();break;default:console.warn("Unsupported",d)}break;case"data":(n=this.getObjectById(d[1]))&&n.data&&(a=n.data[d[2]]);break;case"x":(n=this.getObjectById(d[1]))&&(a=n.position[0]);break;case"y":(n=this.getObjectById(d[1]))&&(a=n.position[1]);break;case"position":switch(d[1]){case"topLeft":a=[0,0];break;case"topRight":a=[this.getMapWidth(),0];break;case"bottomLeft":a=[0,this.getMapHeight()];break;case"bottomRight":a=[this.getMapWidth(),this.getMapHeight()];break;case"random":a=this.getBestSpawnPosition(-1);break;default:(n=this.getObjectById(d[1]))&&(a=[n.position[0],n.position[1]])}break;case"angle":var n;(n=this.getObjectById(d[1]))&&(a=n.angle);break;case"setting":a=this.game.gameSettings[d[1]];break;case"var":this.game.gameModeData.vars&&(a=this.game.gameModeData.vars[d[1]]);break;case"gameData":a=this.game.gameModeData[d[1]];break;case"game":a=this.game[d[1]];break;case"playerData":(s=this.getPlayerById(d[1]))&&(a=s[d[2]]);break;case"playerId":(s=this.game.players[parseInt(d[1])])?a=s.id:this.scenarioLog("[playerId] No player at index "+d[1],Colours.RED_STRING);break;case"playerIndex":(s=this.getPlayerById(d[1]))?a=this.game.players.indexOf(s):this.scenarioLog("[playerIndex] No player with id "+d[1],Colours.RED_STRING);break;case"playerTeam":(s=this.getPlayerById(d[1]))?a=s.team:this.scenarioLog("[playerTeam] No player with id "+d[1],Colours.RED_STRING);break;case"playerName":(s=this.getPlayerById(d[1]))?a=s.name:this.scenarioLog("[playerName] No player with id "+d[1],Colours.RED_STRING);break;case"playerLevel":(s=this.getPlayerById(d[1]))?a=s.level:this.scenarioLog("[playerLevel] No player with id "+d[1],Colours.RED_STRING);break;default:console.warn("Unsupported",d)}}}else"false"===a&&(a=!1);return a}createObject(e){(e=this.clone(e)).id=e.id?e.id:this.getRandomUniqueId(),e.position||(e.position=this.getBestSpawnPosition(e.team)),this.getObjectById(e.id)&&(this.log("Object already exists: "+e.id),e.id=this.getRandomUniqueId());var a=this.getCurrentMapData(),t=null;switch(e.type){case ObjectType.SPAWNER:e.objectType&&(e.type=e.objectType),this.createSpawner(e.position,{id:e.id,timerMax:Math.round(this.game.settings.fps*e.timer),numObjects:e.numObjects,totalObjects:e.totalObjects,randomX:e.randomX,randomY:e.randomY,objectId:e.objectId,data:e});break;case"flagCTF":a.flags[GameMode.CAPTURE_THE_FLAG]||(a.flags[GameMode.CAPTURE_THE_FLAG]=[]),a.flags[GameMode.CAPTURE_THE_FLAG][e.team]=e.position,console.log(a.flags);var i=this.getFlagCTF(e.team);i&&this.setObjectPosition(i,e.position);break;case"flagDomination":a.flags[GameMode.DOMINATION]||(a.flags[GameMode.DOMINATION]=[]),a.flags[GameMode.DOMINATION][e.num]=e.position,(i=this.getFlagDomination(e.num))&&this.setObjectPosition(i,e.position);break;case"bombSpawn":a.bombs[GameMode.DESTRUCTION]||(a.bombs[GameMode.DESTRUCTION]=[[0,0],[0,0]]),a.bombs[GameMode.DESTRUCTION][e.team][e.num]=e.position;var s=this.getBomb(e.team,e.num);s&&(console.log("Move bomb"),this.setObjectPosition(s,e.position));break;case"spawnPoint":if(e.bStore){a.storeSpawn=e.position;var r=this.getStoreCrate();r&&this.setObjectPosition(r,e.position)}else a.spawns&&!this.game.settings.bOverrideSpawnPoints||(a.spawns=[]),a.spawns.push(e.position);break;case"teamSpawn":null!=e.team?(a.teamSpawns||(a.teamSpawns=[]),a.teamSpawns[e.team]={x:e.position[0],y:e.position[1],w:e.width?e.width:100,h:e.height?e.height:100}):this.scenarioLog("Invalid teamSpawn team: "+e);break;case"trigger":console.log(e),this.checkTriggerAndExecuteById(e.triggerId,e);break;case"event":this.dispatchTrigger({event:e.eventId});break;case"polygon":this.createPolygon(e);break;case ObjectType.GROUND:var n=new this.p2.Body({mass:0,position:e.position,angle:null!=e.rotation?this.ToRad(e.rotation):0});n.allowSleep=!0,n.data={id:e.id,type:e.type,material:e.material,bSkipServerUpdate:!0},n.addShape(new this.p2.Box({width:e.width,height:e.height,collisionGroup:CollisionGroups.GROUND,collisionMask:groundMask})),this.addWorldBody(n);break;case ObjectType.TRIGGER_AREA:t=this.createTriggerArea(e);break;case ObjectType.HELICOPTER:e.bRespawn?(!1!==this.game.gameModeData.bMapVehicles||this.game.scenario)&&this.createSpawner(e.position,{type:e.type,timerMax:Math.max(1,this.game.settings.fps*this.game.gameModeData.vehicleRespawnTime),data:e}):t=this.createHelicopter(e.position,e);break;case ObjectType.TANK:e.bRespawn?(!1!==this.game.gameModeData.bMapVehicles||this.game.scenario)&&this.createSpawner(e.position,{type:e.type,timerMax:Math.max(1,this.game.settings.fps*this.game.gameModeData.vehicleRespawnTime),data:e}):t=this.createTank(e.position,e);break;case ObjectType.CAR:if(e.bRespawn)(!1!==this.game.gameModeData.bMapVehicles||this.game.scenario)&&this.createSpawner(e.position,{type:e.type,timerMax:this.game.settings.fps*this.game.gameModeData.vehicleRespawnTime,data:e});else if(t=this.createCar(e.position,e),e.characters)for(var o=0;o<e.characters.length;o++){let a=e.characters[o],i=this.createCharacter(a);i&&(this.executeInteractable(t,i.data.id),this.game.bSurvival&&this.game.gameModeData.enemiesSpawned++)}break;case ObjectType.MOUNTED_WEAPON:e.bRespawn?(!1!==this.game.gameModeData.bMapWeapons||this.game.scenario)&&this.createSpawner(e.position,{type:e.type,timerMax:this.game.settings.fps*this.game.gameModeData.vehicleRespawnTime,data:e}):t=this.createMountedWeapon(e.position,e);break;case ObjectType.DROPPED_WEAPON:e.bRespawn?(!1!==this.game.gameModeData.bMapWeapons&&!this.game.bSurvival||this.game.scenario)&&this.createSpawner(e.position,{type:e.type,timerMax:this.game.settings.fps*this.game.gameModeData.weaponRespawnTime,data:e}):(t=this.createDroppedWeapon(e.position,e))&&e.bRandomVelocity&&(t.applyImpulse([this.Random(-500,500),this.Random(-500,500)],[0,0]),t.angularVelocity=this.Random(-10,10));break;case ObjectType.OBSTACLE:(!1!==this.game.gameModeData.bMapObjects||this.game.bScenario)&&(t=this.createObstacle(e));break;case ObjectType.EQUIPMENT:t=this.createEquipment(e.position,e);break;case ObjectType.DUMMY:e.bRespawn?this.createSpawner(e.position,{type:e.type,timerMax:Math.max(1,this.game.settings.fps),data:e}):t=this.createDummy(e);break;case ObjectType.TREE:t=this.createTree(e);break;case ObjectType.DOOR:t=this.createDoor(e);break;case ObjectType.CRATE:t=this.createCrate(e.position,e);break;case ObjectType.LEVER:t=this.createLever(e.position,e);break;case ObjectType.WINDOW:t=this.createWindow(e);break;case ObjectType.CHARACTER:t=this.createCharacter(e);break;case ObjectType.DINOSAUR:t=e.bSurvival?this.spawnSurvivalEnemyDinosaur(e.position,!0):this.createDinosaur(e);break;case ObjectType.MONEY:t=this.createMoney(e.position,e);break;case ObjectType.ARROW:t=this.createArrow(e.position,e);break;case ObjectType.EGG:t=this.createEgg(e.position,e);break;default:console.warn("Unhandled createObject",e.type)}if(t){null!=e.bDisabled&&this.setDataValue(t,"bDisabled",1==e.bDisabled);var d=t.data;this.removeUndefinedKeys(d)}return t}applyAABBBuoyancyForces(e,a,t,i){for(var s=this.p2,r=0;r<e.shapes.length;r++){var n,o=e.shapes[r];if(e.vectorToWorldFrame(shapePosition,o.position),s.vec2.add(shapePosition,shapePosition,e.position),shapeAngle=o.angle+e.angle,o.computeAABB(aabb,shapePosition,shapeAngle),aabb.upperBound[1]<a[1])s.vec2.copy(centerOfBouyancy,shapePosition),n=o.area;else{if(!(aabb.lowerBound[1]<a[1]))continue;var d=aabb.upperBound[0]-aabb.lowerBound[0],l=0-aabb.lowerBound[1];n=d*l,s.vec2.set(centerOfBouyancy,aabb.lowerBound[0]+d/2,aabb.lowerBound[1]+l/2)}s.vec2.subtract(liftForce,a,centerOfBouyancy),s.vec2.scale(liftForce,liftForce,n*t),liftForce[0]=0,s.vec2.subtract(centerOfBouyancy,centerOfBouyancy,e.position),e.getVelocityAtPoint(v,centerOfBouyancy),s.vec2.scale(viscousForce,v,-i),e.applyForce(viscousForce,centerOfBouyancy),e.applyForce(liftForce,centerOfBouyancy)}}vehicleHasOccupant(e){if(e&&e.data){var a=e.data;if(a.bAutomated)return!0;var t=a.seats;if(t)for(var i=0;i<t.length;i++)if(t[i].pawnId)return!0}return!1}canExitVehicle(e){return!!e&&(!e.data.vehicleCooldown&&!e.data.seatTimer)}canEnterVehicle(e,a){if(!e||!a)return!1;if(!e.data.type==ObjectType.CHARACTER)return!1;if(a.data.bAutomated)return!1;if(this.vehicleHasOccupant(a)){var t=a.data.seats;if(t)for(var i=0;i<t.length;i++){var s=t[i];if(s.pawnId){var r=this.getObjectById(s.pawnId);if(r&&r.data.team!=e.data.team)return!1}}}return!e.data.vehicleCooldown}enterVehicle(e,a,t){if(e&&a&&a.data.health){var i=a.data.seats;if(i){switch(this.setDataValue(a,"team",e.data.team),a.data.type){case ObjectType.HELICOPTER:a.data.bAutomated||(a.shapes[0].collisionMask=CollisionGroups.HELICOPTER|CollisionGroups.PROJECTILE|CollisionGroups.BOUNDS,a.damping=.5,a.angularDamping=.8)}e.data.seatIndex=t;var s=i[t];s.pawnId=e.data.id,s.bInvisible&&this.setDataValue(e,"bInvisible",!0),e.velocity=[0,0],e.shapes[0].collisionMask=CollisionGroups.PROJECTILE,e.data.bWantsToMove=!1,e.data.bSprinting=!1,e.data.controllableId=a.data.id,this.startVehicleCooldown(e),e.data.bWantsToFire=!1,this.cancelCharacterBoltPull(e),this.cancelCharacterReload(e),this.pushObjectDataUpdate(a.data.id,["seats"]),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_VEHICLE_ENTER,vehicleId:a.data.id,scale:a.data.scale,seatIndex:t,seat:i[t]})}this.vehicleHasOccupant(a)&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.data.id,type:GameServer.PAWN_VEHICLE_ENTER,seatIndex:t}),this.setPlayerControllable(e.data.id,a)}}exitVehicle(e,a){if(e){var t=this.getObjectById(e.data.controllableId);if(t){var i=t.data.seats;if(i){var s=i[e.data.seatIndex];if(s&&s.pawnId){var r=this.getObjectById(s.pawnId);r&&(r.data.controllableId=null),delete s.pawnId}this.setDataValue(e,"bInvisible",!1),e.angle=0,e.velocity=[0,0],e.shapes[0].collisionMask=CollisionGroups.GROUND|CollisionGroups.BOUNDS|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.PAWN,this.startVehicleCooldown(e),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_VEHICLE_LEAVE,bEject:a})}switch(this.pushObjectDataUpdate(t.data.id,["seats"]),t.data.type){case ObjectType.HELICOPTER:this.vehicleHasOccupant(t)||(t.shapes[0].collisionGroup=CollisionGroups.HELICOPTER,t.shapes[0].collisionMask=CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.PAWN|CollisionGroups.BOUNDS,t.damping=.95,t.angularDamping=.95);break;case ObjectType.MOUNTED_WEAPON:this.game.bSurvival&&0!=t.data.team&&this.killPawn(t.data.id)}this.vehicleHasOccupant(t)||(this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.data.id,type:GameServer.PAWN_VEHICLE_LEAVE}),this.setDataValue(t,"team",-1))}}}startVehicleCooldown(e){if(e){var a=e.data;a.vehicleCooldown=Math.round(this.game.settings.fps*(a.bBot?3:.5))}}triggerCountermeasure(e){if(!e.data.seatTimer){var a=this.getObjectById(e.data.controllableId);if(a&&!a.data.bCountermeasureCooldown){var t=60;switch(a.data.countermeasure){case"ejection_seat":t=10,this.clearPlayerControllable(e.data.id,!0),e.data.bBot&&(e.velocity=[0,this.getSharedData(ObjectType.CHARACTER).ejectionVelocity]);break;case"ecm":this.setDataValue(a,"bECM",!0),a.data.ecmTimer=15*this.game.settings.fps;break;case"flares":t=30;for(var i=0;i<5;i++)this.createRocket(a.position,{rocketType:Rocket.DEFAULT,team:a.data.team,playerId:a.data.id,causerId:a.data.id,angle:this.ToRad(-90)+this.ToRad(this.Random(-45,45)),weaponId:"rocket_flare",damage:0,radius:100})}this.setDataValue(a,"bCountermeasureCooldown",!0),a.data.countermeasureCooldownTimer=this.game.settings.fps*t,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.data.id,type:GameServer.PAWN_VEHICLE_UPDATE,bUseCountermeasure:!0,cooldown:a.data.countermeasureCooldownTimer})}}}getCurrentMapData(){this.game.mapData||(this.game.mapData=this.clone(this.getMapData(this.game.mapId)));var e=this.game.mapData;return e.spawns||(e.spawns=[]),e.flags||(e.flags={capture_the_flag:[[0,0],[0,0]],domination:[[0,0],[0,0],[0,0]]}),e.bombs||(e.bombs={destruction:[[[0,0],[0,0]],[[0,0],[0,0]]]}),e.ai||(e.ai={nodes:[]}),e}getMapWidth(){var e="map_custom"==this.game.mapId?0:this.getCurrentMapData().width;return this.game.gameSettings.width&&(e=Math.max(e,this.game.gameSettings.width)),Math.min(this.settings.maxWorldSize,e)}getMapHeight(){var e="map_custom"==this.game.mapId?0:this.getCurrentMapData().height;return this.game.gameSettings.height&&(e=Math.max(e,this.game.gameSettings.height)),Math.min(this.settings.maxWorldSize,e)}getCharacterSpeedMultiplier(e){var a=e.data,t=(null!=a.speedMultiplier?a.speedMultiplier:1)*(null!=a.baseSpeedMultiplier?a.baseSpeedMultiplier:1);return isNaN(t)&&(console.warn("Invalid character speed multiplier",t),t=1),a.bStoppingPower&&(t*=.5),t}handleAIPawn(e){var a=e.data;e.ai||(e.ai=this.initPawnAI(e,a.botSkill));var t=e.ai;if(t.ticker>0?t.ticker--:(t.tickerMax=Math.round(this.game.settings.fps*(e.world?a.type==ObjectType.DINOSAUR?.25:.5:3)),t.ticker=t.tickerMax),this.matchInProgress()){if((a.bFlashed||a.bStunned)&&(a.bWantsToFire=!1),t.enemy&&!t.enemy.data&&delete t.enemy,0==t.ticker){switch(t.botSkill){case BotSkill.SKILL_GOD:t.enemyDistMax=3e3,t.offsetX=0,t.offsetY=0;break;case BotSkill.SKILL_INSANE:t.enemyDistMax=800,t.offsetX=this.Random(-40,40),t.offsetY=this.Random(-40,40);break;case BotSkill.SKILL_HARD:t.enemyDistMax=600,t.offsetX=this.Random(-50,50),t.offsetY=this.Random(-50,50);break;case BotSkill.SKILL_NORMAL:t.enemyDistMax=500,t.offsetX=this.Random(-60,60),t.offsetY=this.Random(-60,60);break;default:t.enemyDistMax=400,t.offsetX=this.Random(-80,80),t.offsetY=this.Random(-80,80)}var i={};if(a.controllableId){var s=this.getObjectById(a.controllableId);this.getCurrentVehicleWeapon(s,a.seatIndex)&&s.data.vehicleId==MountedWeapon.BGM71&&(i.bLOS=!1)}null!=a.bIgnoreOutOfSight&&(s&&s.data.type==ObjectType.HELICOPTER||(i.bIgnoreOutOfSight=a.bIgnoreOutOfSight)),(i.bIgnoreOutOfSight||a.bIgnoreOutOfSight)&&(i.maxRange=a.maxRange?a.maxRange:(this.game.scenario?1e3:1500)+250*t.botSkill),this.getCurrentCharacterInventoryItem(e).range<200&&(i.pawnTypes=[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.MOUNTED_WEAPON,ObjectType.TANK,ObjectType.CAR,ObjectType.EGG]);var r=null;if(!a.bIgnoreEnemies&&!a.bStunned&&!a.bFlashed){var n=this.getNearestFriendlyPawn(e,{maxRange:100});r=n&&n.ai&&(!n.ai.bIgnoreOutOfSight||n.ai.bEnemyLOS)&&n.ai.enemy&&n.ai.enemy.data?n.ai.enemy:this.getNearestEnemyPawn(e,i)}if(a.lockOnTargetId=r?r.data.id:null,r){var o=null!=t.enemy,d=1==t.bEnemyLOS;if(t.enemy=r,t.bEnemyLOS=(t.botSkill>=BotSkill.SKILL_INSANE||!this.isInSmoke(e))&&this.checkLineOfSight(e.position,r.position,!0,r,!0),s&&s.data.type==ObjectType.HELICOPTER&&(t.bEnemyLOS=!0),this.game.bSurvival&&a.type==ObjectType.CHARACTER&&1==a.team&&t.bEnemyLOS&&!d&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_INVESTIGATE,value:"enemy",enemyId:r.data.id}),t.enemyDist=this.Dist(r.position[0],r.position[1],e.position[0],e.position[1]),t.enemyDist){let e=Math.max(0,t.enemyDist<50?0:.5-.1*t.botSkill);t.enemyDistMult=Math.max(e,t.enemyDist/t.enemyDistMax)}else t.enemyDistMult=1;r.data.bECM&&(a.lockOnTargetId=null),a.type!=ObjectType.CHARACTER||r.data.dinoType!=Dinosaur.TREX&&!r.data.bJuggernaut||t.bEnemyLOS&&1==this.Random(1,Math.round(t.enemyDist/50))&&this.setPawnRequest(e,Commands.REQUEST_SUPPORT),this.emitAISound(r.position,e.position,1e3,r.data.team),delete t.investigatePos,t.bInvestigate&&!o&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_INVESTIGATE,value:"enemy",enemyId:r.data.id})}else t.enemy&&!t.enemy.data.bPendingRemoval&&t.bInvestigate&&(this.emitAISound(t.enemy.position,e.position,1e3,999),this.setAIInvestigatePos(e,t.enemy.position),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_INVESTIGATE,value:"enemyLost"})),delete t.enemy,delete t.bEnemyLOS,delete t.enemyDist,a.lookPos&&1==this.Random(1,10)&&(a.lookPos[0]=e.position[0]+this.Random(-100,100),a.lookPos[1]=e.position[1]+this.Random(-100,100));if(t.actionTicker>0?t.actionTicker--:t.actionTicker=t.actionTickerMax,t.pathTicker>0)t.pathTicker--;else{if(t.moveToPos){var l=this.Dist(e.position[0],e.position[1],t.moveToPos[0],t.moveToPos[1]);(this.game.bSurvival||l>t.destThreshold)&&((!t.path||!t.lastMovePos||this.DistPositions(t.lastMovePos,t.moveToPos)>t.destThreshold)&&(t.path=this.getAIPath([e.position[0],e.position[1]],t.moveToPos,e),t.lastMovePos=this.clone(t.moveToPos)),0==t.path.length||(1==t.path.length?t.bShortPath=!0:delete t.bShortPath))}else t.wanderArea&&!t.enemy&&(t.wanderTicker>0?t.wanderTicker--:(t.wanderTicker=this.Random(1,t.wanderTickerMax),this.setAIInvestigatePos(e,[t.wanderArea.x+this.Random(-t.wanderArea.width,t.wanderArea.width),t.wanderArea.y+this.Random(-t.wanderArea.height,t.wanderArea.height)])));var h=0;if(a.type==ObjectType.CHARACTER)if(this.hasMeleeEquipped(e))h=0;else if(a.controllableId)h=3;else switch(t.botSkill){case BotSkill.SKILL_NORMAL:case BotSkill.SKILL_HARD:h=2;break;case BotSkill.SKILL_INSANE:case BotSkill.SKILL_GOD:h=1;break;default:h=3}t.pathTicker=h}}}else a.lookPos&&1==this.Random(1,100)&&(a.lookPos[0]+=this.Random(-20,20),a.lookPos[1]+=this.Random(-20,20))}setAICamp(e,a,t){var i=e.ai;i&&(a?(i.bCamp=!0,i.campPos=t,delete i.desiredItemId,delete i.bWantsItem,delete i.returnPos,delete i.investigatePos,delete i.followTargetId):(delete i.bCamp,delete i.campPos))}setAIDestination(e,a,t){var i=e.ai;i&&(i.destination=a,i.onDestinationTriggerId=t)}setAIObjectiveItemId(e,a){var t=e.ai;t&&(t.objectiveItemId=a,this.getObjectById(a)&&(t.desiredItemId=a,t.bWantsItem=!0))}setAIFollowTargetId(e,a){var t=e.ai;t&&(a?t.followTargetId=a:delete t.followTargetId)}setAIInteract(e,a){var t=e.ai;t&&(t.bInteract=a)}setAIInvestigate(e,a){var t=e.ai;t&&(t.bInvestigate=a)}setAIInvestigate(e,a){var t=e.ai;t&&(t.bInvestigate=a)}setAIWanderArea(e,a){var t=e.ai;a?(t.wanderArea={x:e.position[0]-.5*a,y:e.position[1]-.5*a,width:a,height:a},this.setAIInvestigatePos(e,[e.position[0]+this.Random(-a,a),e.position[1]+this.Random(-a,a)])):delete t.wanderArea}setAIInvestigatePos(e,a){var t=e.ai;t&&this.isValidArray(a)&&(t.returnPos||(t.returnPos=this.clone(e.position)),t.investigatePos=a)}handleAICharacter(e){if(this.handleAIPawn(e),!this.matchInProgress())return;var a=e.data,t=e.ai;if(a.bStunned||a.bFlashed)return;if(!t)return;if(0==t.actionTicker&&(t.actionTicker=-1,a.type==ObjectType.CHARACTER)){this.game.bSurvival&&this.game.gameModeData.bIntermission&&a.controllableId&&0==a.team&&a.bCanInteract&&this.getPlayerById(a.id)&&this.clearPlayerControllable(a.id);var i=this.getPlayerById(a.id);if(i?i.items&&i.items.length>0&&this.useItem(i.id):a.pawnItems&&a.pawnItems.length>0&&this.useItem(a.id),a.health<.25*a.maxHealth&&(!this.game.bSurvival||0==a.team)&&this.isTeamGameMode()?this.setPawnRequest(e,Commands.REQUEST_SUPPORT):this.needsAmmo(e)&&this.setPawnRequest(e,Commands.REQUEST_AMMO),t.bInteract&&a.bCanInteract&&!a.controllableId&&!a.bHasFlag)delete t.desiredItemId,delete t.bWantsItem,delete t.bWantsVehicle,delete t.desiredVehicleId,(T=(u=t.objectiveItemId?this.getObjectById(t.objectiveItemId):null)||this.getDesiredInteractable(e))?(t.desiredItemId=T.data.id,t.bWantsItem=!0):(t.bWantsVehicle=1==this.Random(1,8)&&this.getAvailableVehicles(e).length>0,t.desiredVehicleId=null)}0==t.ticker&&(this.characterHasEquipment(e,"ammo_box")&&(E=this.getNearbyRequest(e,Commands.REQUEST_AMMO))&&this.useCharacterEquipment(e,"equipment",E.position[0],E.position[1]));if(this.hasInventoryAmmo(e)){var s=this.getBestInventoryIndex(e,t.enemy,t.enemyDist);s!=a.currentInventoryIndex&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:a.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:s})}else(s=Character.INDEX_MELEE)!=a.currentInventoryIndex&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:a.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:s});var r=a.equipment;if(r&&r.ammo>0)switch(r.id){case"ammo_box":break;case"claymore":case"betty":if(t.enemy&&!t.bEnemyLOS&&Math.random()>.9){if(this.game.bSurvival&&1==a.team&&this.getMines(1).length>=10)break;this.useCharacterEquipment(e,"equipment",t.enemy.position[0],t.enemy.position[1])}break;case"juice":t.enemy&&Math.random()>.9&&this.useCharacterEquipment(e,"equipment",t.enemy.position[0],t.enemy.position[1]);break;case"stim":a.health<=.5*a.maxHealth&&this.useCharacterEquipment(e,"equipment",e.position[0],e.position[1]);break;case"jammer":case"sensor":t.enemy&&t.enemyDist<r.radius&&Math.random()>.9&&this.useCharacterEquipment(e,"equipment",t.enemy.position[0],t.enemy.position[1]);break;default:t.enemy&&t.enemyDist<750&&this.useCharacterEquipment(e,"equipment",t.enemy.position[0],t.enemy.position[1])}var n=a.grenade;if(n&&n.ammo>0&&(n.id,t.enemy&&t.bEnemyLOS&&t.enemyDist>250&&t.enemyDist<1e3&&Math.random()>.999&&this.useCharacterEquipment(e,"grenade",t.enemy.position[0],t.enemy.position[1])),delete a.moveAngle,t.path){var o=t.path[0];if(o&&o.data){a.moveAngle=this.Angle(e.position[0],e.position[1],o.data.position[0],o.data.position[1]);var d=t.path[t.path.length-1];if(t.ticker%10==0&&this.checkLineOfSight(e.position,d.data.position,!0,null,!0))var l=!0;if(l)t.path=[d];else{var h=a.type==ObjectType.DINOSAUR?20:32;a.controllableId&&(h=20),t.path.length<=1&&t.destThreshold?h=t.destThreshold:a.type==ObjectType.DINOSAUR&&(h=Math.round(h*(e.mass+1)));var m=this.getObjectById(a.controllableId),c=m||e;if(this.Dist(o.data.position[0],o.data.position[1],c.position[0],c.position[1])<h&&(t.path.splice(0,1),0==t.path.length)){if(delete a.moveAngle,a.bWantsToMove=!1,t.destination&&(t.onDestinationTriggerId&&(this.executeTriggerById(t.onDestinationTriggerId),delete t.onDestinationTriggerId),delete t.destination),!t.bCamp){if(t.investigatePos&&(delete t.investigatePos,delete t.investigatePriority,!t.enemy&&!t.wanderArea)){let a=250;this.setAIInvestigatePos(e,this.getNearestValidPosition([e.position[0]+this.Random(-a,a),e.position[1]+this.Random(-a,a)]))}t.returnPos&&delete t.returnPos}t.bPatrol&&t.patrolPoints&&t.patrolPoints.push(t.patrolPoints.shift())}}}if(0==t.path.length);else{var p=this.getCurrentCharacterInventoryItem(e);if(t.enemy&&!t.desiredItemId&&!t.enemy.data.shieldId&&(t.bEnemyLOS||t.enemy.data.type==ObjectType.HELICOPTER)){let e=p.dropRange?p.range*Math.max(.5,Math.min(1,t.botSkill/BotSkill.SKILL_GOD)):p.range;t.enemyDist<.2*e?this.getObjectById(t.followTargetId)&&t.followTargetDist>600||(a.moveAngle+=this.ToRad(180)):t.enemyDist<.25*e&&delete a.moveAngle}}}let g=this.getObjectById(a.interactableId);if(g?a.lookPos=[g.position[0],g.position[1]]:t.enemy&&t.enemy.data?(a.lookPos=[t.enemy.position[0],t.enemy.position[1]],t.offsetX&&t.enemyDistMult&&(a.type==ObjectType.DINOSAUR&&a.dinoType,a.lookPos[0]+=t.offsetX*t.enemyDistMult,a.lookPos[1]+=t.offsetY*t.enemyDistMult),!a.controllableId&&a.melee&&t.enemy.data.type==ObjectType.CHARACTER&&t.enemyDist<a.melee.range&&!t.bFireCooldown&&this.triggerCharacterMeleeAttack(e)):t.investigatePos?a.lookPos=[t.investigatePos[0],t.investigatePos[1]]:t.moveToPos&&(a.lookPos=this.clone(t.moveToPos)),this.game.cinematic&&a.cinematicLookPos&&(a.lookPos=a.cinematicLookPos),t.destThreshold=50,a.controllableId&&(t.distanceTimer>0?t.distanceTimer--:(this.game.bSurvival&&0==a.team&&a.bCanInteract&&1==this.Random(1,4)&&this.clearPlayerControllable(a.id),t.distanceTimer=t.distanceTimerMax)),a.controllableId){t.desiredVehicleId=null,(v=this.getObjectById(a.controllableId))&&v.data.seats&&v.data.seats.length>1&&0!=a.seatIndex&&(v.data.seats[0].pawnId||v.data.bAutomated||this.switchSeats(e))}else{var E;if(E=t.bInteract&&this.getNearbyRequest(e,Commands.REQUEST_SUPPORT,1e3,a.playerId))t.destThreshold=100,t.moveToPos=E.position,t.desiredVehicleId=null;else{var b=t.bInteract&&this.getNearbyRequest(e,Commands.REQUEST_FOLLOW,1e3,a.playerId);b&&(t.destThreshold=100,t.moveToPos=b.position,t.desiredVehicleId=null)}if(!b&&!E)if(t.destination)t.moveToPos=t.destination;else if(t.objectiveItemId){var u;(u=this.getObjectById(t.objectiveItemId))&&(t.moveToPos=u.position)}else if(t.followTargetId){t.destThreshold=200;var I=this.getObjectById(t.followTargetId);I&&(t.moveToPos=I.position,t.followTargetDist=this.DistBodies(I,e))}else if(t.desiredItemId){var T=this.getObjectById(t.desiredItemId);T?(t.desiredItemId=T.data.id,t.moveToPos=this.clone(T.position)):(t.desiredItem=null,t.moveToPos=null)}else if(t.desiredVehicleId){var v;(v=this.getObjectById(t.desiredVehicleId))&&this.hasAvailableSeat(v)?(t.desiredVehicleId=v.data.id,t.moveToPos=this.clone(v.position)):(t.desiredVehicleId=null,t.moveToPos=null)}else{if(t.moveToPos=null,t.desiredVehicleId=null,a.type==ObjectType.DINOSAUR&&a.playerId&&!t.enemy){let e=this.getObjectById(a.playerId);e&&(t.destThreshold=200,t.moveToPos=e.position)}if(t.bWantsItem||t.bWantsVehicle&&(v=this.getNearbyVehicle(e))&&(t.desiredVehicleId=v.data.id),this.game.gameModeId==GameMode.EVOLUTION&&0==a.team){var y=this.getAutomatedTurrets();y.sort(((a,t)=>{var i=this.DistBodies(e,a),s=this.DistBodies(e,t);return i<s?-1:i>s?1:0})),y[0]&&(t.destThreshold=200,t.moveToPos=y[0].position)}}t.bCamp&&(t.moveToPos=t.campPos)}if(!t.moveToPos)switch(this.game.gameModeId){case GameMode.HEADQUARTERS:case GameMode.DOMINATION:case GameMode.CONQUEST:if(t.bPreferObjective=this.Random(1,5)>1,t.bPreferObjective){var A=this.getAIBestDominationFlag(e);A&&(t.destThreshold=100,t.moveToPos=A.position)}else t.enemy&&(t.moveToPos=t.enemy.position);break;case GameMode.DESTRUCTION:if(t.bPreferObjective=a.type==ObjectType.CHARACTER,t.bPreferObjective)(M=this.getAIBestBombCrate(e)[0])?(t.destThreshold=M.data.bBombPlanted&&M.data.team!=a.team||M.data.currentPawnId?200:30,t.moveToPos=M.position):t.enemy&&(t.moveToPos=t.enemy.position);else t.enemy&&(t.moveToPos=t.enemy.position);break;case GameMode.CAPTURE_THE_FLAG:if(t.bPreferObjective=this.Random(1,5)>1,t.bPreferObjective||a.bHasFlag){var O=this.getFlagCTF(0==a.team?1:0),R=this.getFlagCTF(a.team);if(R&&O)if(O.data.carrierId==a.id)a.bHasFlag=!0,t.moveToPos=R.position;else if(delete a.bHasFlag,R.data.bAwayFromHome)this.Dist(R.position[0],R.position[1],e.position[0],e.position[1])<this.Dist(O.position[0],O.position[1],e.position[0],e.position[1])?t.moveToPos=R.position:(t.moveToPos=O.position,O.data.carrierId&&(t.destThreshold=200));else t.moveToPos=O.position,O.data.carrierId}else t.enemy&&(t.moveToPos=t.enemy.position);break;default:t.bPreferObjective=!1;var M=null;t.bWantsItem||(t.enemy?t.moveToPos=t.enemy.position:M?(t.destThreshold=M.data.bBombPlanted&&M.data.team!=a.team||M.data.currentPawnId?200:30,t.moveToPos=M.position):t.investigatePos?t.moveToPos=t.investigatePos:t.returnPos&&(t.moveToPos=t.returnPos))}p=this.getCurrentCharacterInventoryItem(e);if(a.bCanLunge){let a=p?p.lungeRange?p.lungeRange:p.range:1e3;this.setDataValue(e,"bLunge",t.enemyDist<50||t.bEnemyLOS&&t.enemyDist<a*(t.botSkill+1))}var _=!1;if(t.enemy){var D=e.getAABB(),S=t.enemy.getAABB();D&&S&&(_=D.overlaps(S))}var N=Math.min(p.range,3e3),C=(t.enemyDist<N||_)&&t.enemyDist<t.lookRange&&t.bEnemyLOS&&!a.bStunned&&!a.bFlashed;if(this.triggerCharacterWeapon({eventId:GameServer.EVENT_PLAYER_TRIGGER_WEAPON,playerId:a.id,value:C,worldPosition:a.lookPos}),a.bWantsToMove=null!=a.moveAngle,t.bFireCooldown?t.fireCooldownTimer>0?t.fireCooldownTimer--:(t.bFireCooldown=!1,t.fireCooldownTimer=t.fireCooldownTimerMax):t.fireBurstTimer>0?t.fireBurstTimer--:(t.bFireCooldown=!0,t.fireBurstTimer=t.fireBurstTimerMax),(P=a.inventory[a.currentInventoryIndex]).fireMode!=Weapon.MODE_SEMI?t.semiCooldownTimer=0:P.fireMode==Weapon.MODE_SEMI&&t.semiCooldownTimerMax>0&&(t.semiCooldownTimer<=0?t.semiCooldownTimer=t.semiCooldownTimerMax:t.semiCooldownTimer--),a.bWantsToFire){var P=a.inventory[a.currentInventoryIndex];t.bFireCooldown?a.bWantsToFire=!1:(a.bWantsToFire=a.bWantsToFire&&0==t.semiCooldownTimer,a.bWantsToFire&&(a.weapon.bFireHandler=!0))}else a.bWantsToFire=!1;if(a.type==ObjectType.CHARACTER){var f=!a.bWantsToFire&&a.bWantsToMove&&this.characterCanSprint(e);t.botSkill>=BotSkill.SKILL_HARD?(this.setDataValue(e,"bSprinting",f),this.setDataValue(e,"bCrouching",!a.bWantsToMove&&!a.bSprinting&&this.characterCanCrouch(e)&&!a.bZombie)):this.setDataValue(e,"bSprinting",f&&t.enemyDist>2e3)}if(a.controllableId){var w=this.getObjectById(a.controllableId);if(w){switch(w.data.type){case ObjectType.TANK:case ObjectType.HELICOPTER:case ObjectType.CAR:case ObjectType.MOUNTED_WEAPON:if(0==a.seatIndex){if(t.followTargetId&&this.getObjectById(t.followTargetId)&&(t.followTargetDist>600||w.data.type!=ObjectType.MOUNTED_WEAPON)&&this.clearPlayerControllable(a.id),!this.game.bSurvival||0==a.team)var G=this.getNearbyRequest(e,Commands.REQUEST_VEHICLE,w.data.type==ObjectType.MOUNTED_WEAPON?400:1500);if(G)if(this.hasAvailableSeat(w)&&G.dist>100)var k=G.position;else this.clearPlayerControllable(a.id);else if(t.enemy){switch(t.enemy.data.type){case ObjectType.HELICOPTER:k=[t.enemy.position[0],t.enemy.position[1]];break;default:k=(w.data.type,[t.enemy.position[0],t.enemy.position[1]])}k[1]=Math.max(0,k[1])}if(k){var L={up:0,down:0,left:0,right:0},B=this.Dist(k[0],k[1],w.position[0],w.position[1]);switch(w.data.type){case ObjectType.CAR:var j=30;break;case ObjectType.TANK:j=100;break;default:j=500}w.data.type==ObjectType.HELICOPTER?B>j?(k[0]<w.position[0]?L[Control.LEFT]=!0:k[0]>w.position[0]&&(L[Control.RIGHT]=!0),k[1]<w.position[1]?L[Control.UP]=!0:k[1]>w.position[1]&&(L[Control.DOWN]=!0)):k[0]<w.position[0]?L[Control.RIGHT]=!0:k[0]>w.position[0]&&(L[Control.LEFT]=!0):a.moveAngle&&(B>j?L[Control.UP]=!0:L[Control.DOWN]=!0,w.mass>0&&(w.angle-a.moveAngle>0?L[Control.LEFT]=!0:L[Control.RIGHT]=!0)),Object.keys(L).length>0&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_INPUT,playerId:a.id,keyInfo:L})}}if(w.data.weapons){var W=this.getCurrentVehicleWeapon(w,a.seatIndex);if(W&&W.weaponData&&W.weaponData.damage>0){w.data.vehicleId!=MountedWeapon.BGM71&&w.data.type!=ObjectType.HELICOPTER||(t.bEnemyLOS=!this.isInSmoke(e)),W.bWantsToFire=t.bEnemyLOS&&t.enemyDist<t.lookRange,W.weaponData.bRequireLock&&!this.isVehicle(t.enemy)&&t.botSkill;var V=this.getVehicleMuzzlePosition(w,a.seatIndex),U=t.botSkill>=BotSkill.SKILL_INSANE?1:.1;if(t.enemy){var H=[t.enemy.position[0],t.enemy.position[1]];t.offsetX&&t.offsetY&&(w.data.type==ObjectType.TANK?(H[0]+=t.offsetX*t.enemyDistMult*.1,H[1]+=t.offsetY*t.enemyDistMult*.1):w.data.type==ObjectType.MOUNTED_WEAPON?(H[0]+=t.offsetX*t.enemyDistMult*.9,H[1]+=t.offsetY*t.enemyDistMult*.9):(H[0]+=t.offsetX*t.enemyDistMult,H[1]+=t.offsetY*t.enemyDistMult));var x=this.Angle(V[0],V[1],H[0],H[1]);isNaN(x)&&console.warn(H,t.offsetX,t.offsetY,t.enemyDistMult),this.setVehicleWeaponAimRotation(W,x,U)}else a.lookPos&&(x=this.Angle(V[0],V[1],a.lookPos[0],a.lookPos[1]),this.setVehicleWeaponAimRotation(W,x,U))}}}this.canExitVehicle(e)&&w.data.type==ObjectType.CAR&&t.enemyDist<100&&Math.abs(this.getTotalVelocity(w)<50)}}else if(t.bInteract&&a.bCanInteract&&!a.bInteracting&&0==t.ticker){var F=this.getTouchingInteractable(e);F&&this.startInteraction(e,F)}if(a.lookPos){var Y=this.Angle(e.position[0],e.position[1],a.lookPos[0],a.lookPos[1]);isNaN(Y)?console.warn("PROBLEM!",e.data.id,e.position,a.lookPos):a.desiredAimRotation=Y}}getBestSurvivalSpawnPosition(e,a){var t=this.getCharactersOnTeam(0);return t.length>0?t[this.Random(0,t.length-1)].position:this.getBestSpawnPosition(e,a)}getRandomSpawnPosition(){var e=this.getCurrentMapData().spawns;return e&&e.length?e[this.Random(0,e.length-1)]:[this.Random(0,this.getMapWidth()),this.Random(0,this.getMapHeight())]}getBestSpawnPosition(e,a){try{var t=this.getCurrentMapData().spawns;if(!t||!t.length)return console.log("Random spawn point"),[this.Random(0,this.getMapWidth()),this.Random(0,this.getMapHeight())];if(0==this.getCharacters().length)return t[this.Random(0,t.length-1)];for(var i=[],s=this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.CAR,ObjectType.TANK,ObjectType.HELICOPTER,ObjectType.MOUNTED_WEAPON,ObjectType.FLAG]),r=0;r<t.length;r++){let d=t[r],l=0,h=0,m=0;for(var n=0;n<s.length;n++){let t=s[n];if(t&&t==a)continue;if(this.isVehicle(t)&&!t.data.bAutomated)continue;let i=this.Dist(t.position[0],t.position[1],d[0],d[1]),r=this.getMapWidth();if(i<r){var o=i/r;if(t.data.team!=e)switch((i<500||(this.game.bSurvival,!1))&&m++,t.data.type){case ObjectType.FLAG:this.game.gameModeData.id==GameMode.DOMINATION?l+=3*o:l+=o;break;default:l+=o}else switch(t.data.type){case ObjectType.FLAG:this.game.gameModeData.id==GameMode.DOMINATION&&(i<600&&h++,l-=3*o);break;default:l-=o}}}i.push({index:r,flags:h,enemies:m,danger:l})}if(1==i.length)(l=[(d=t[i[0].index])[0]+this.Random(-25,25),d[1]+this.Random(-25,25)])[0]=Math.max(0,Math.min(this.getMapWidth(),l[0])),l[1]=Math.max(0,Math.min(this.getMapHeight(),l[1]));else if(i.length>=2){var d,l;return i.sort((function(e,a){return e.flags>a.flags?-1:e.flags<a.flags||e.enemies>a.enemies?1:e.enemies<a.enemies||e.danger>a.danger?-1:e.danger<a.danger?1:0})),i=[i[0],i[1]],this.ShuffleArray(i),(l=[(d=t[i[0].index])[0]+this.Random(-25,25),d[1]+this.Random(-25,25)])[0]=Math.max(0,Math.min(this.getMapWidth(),l[0])),l[1]=Math.max(0,Math.min(this.getMapHeight(),l[1])),l}}catch(e){console.warn(e)}return[this.Random(0,this.getMapWidth()),this.Random(0,this.getMapHeight())]}isInLOS(e,a,t){var i=this.raycast(e[0],e[1],a[0],a[1],t);if(i){if(0==i.length)return!1;for(var s=0;s<i.length;s++){var r=i[s].body;if(i[s].distance<1e3)switch(r.data.type){case ObjectType.GROUND:return!1;case ObjectType.CHARACTER:return r==t}}}return!1}getBestInventoryIndex(e,a,t){var i=e.ai,s=e.data,r=s.inventory,n=s.currentInventoryIndex,o=0;if(s.type==ObjectType.CHARACTER&&s.bSwitchToMelee&&!s.controllableId&&i.enemy&&!i.enemy.data.controllableId&&!this.isVehicle(i.enemy)&&!i.bEnemyLOS&&t>1e3&&s.inventory[Character.INDEX_MELEE])return Character.INDEX_MELEE;for(var d=0;d<r.length;d++){var l=r[d];if(l){var h=l.damage;l.type==Weapon.TYPE_LAUNCHER&&(h*=.5);var m=h*l.magSize;(l.mag>0||l.ammo>0||s.weapon.bUnlimitedAmmo)&&(a&&(this.isVehicle(a)||a.data.controllableId||a.data.shieldId)?(l.bRocket||l.bGrenade)&&(n=d):a&&t<500&&l.type==Weapon.TYPE_SHOTGUN||a&&t<200&&"riot_shield"==l.id?n=d:m>o&&!l.bRequireLock&&(n=d,o=m))}}return n}setVehicleWeaponAimRotation(e,a,t,i){if(e){null==e.aimRotation&&(e.aimRotation=0);var s=a;isNaN(s)&&(s=0);var r=this.WrapAngle(e.aimRotation-a,!0),n=(e.aimSpeed?e.aimSpeed:1)*(t||1);i&&(n=1);var o=r*n;e.maxRad?e.aimRotation-=r>0?Math.min(e.maxRad,o):Math.max(-e.maxRad,o):e.aimRotation-=o,isNaN(e.aimRotation)&&(console.warn(e.aimRotation),e.aimRotation=0)}}needsAmmo(e){if(!e)return!1;var a=e.data;if(a.weapon.bUnlimitedAmmo)return!1;for(var t=a.inventory,i=0;i<Math.min(t.length,2);i++){var s=t[i];if(s&&!s.bMelee&&s.ammo<=s.ammoMax)return!0}return!1}hasInventoryAmmo(e){if(!e)return!1;for(var a=e.data,t=a.inventory,i=0;i<Math.min(t.length,2);i++){var s=t[i];if(s&&(s.mag>0||s.ammo>0))return!0}return!!a.weapon.bUnlimitedAmmo}getNearestFriendlyPawn(e,a){var t=null,i=!1,s=Number.MAX_VALUE,r=null,n=void 0,o=!1,d=!1;a&&(null!=a.bLOS&&(i=a.bLOS),null!=a.maxRange&&(s=a.maxRange),null!=a.pawnTypes&&(r=a.pawnTypes),null!=a.scale&&(n=a.scale),null!=a.bPlayerOnly&&(o=a.bPlayerOnly),null!=a.bInjured&&(d=a.bInjured));for(var l=this.getTypes(r||[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR,ObjectType.MOUNTED_WEAPON,ObjectType.EGG]),h=0;h<l.length;h++){let a=l[h],c=a.data;if(c&&c.health&&c.team==e.data.team&&(a.data.id!=e.data.id&&!(o&&a.data.bBot||d&&a.data.health>=a.data.maxHealth||r&&r.indexOf(a.data.type)<0))){if(null!=n)if(n>0){if(a.position[0]<e.position[0])continue}else if(n<0&&a.position[0]>e.position[0])continue;if((!i||this.checkLineOfSight(e.position,a.position))&&(a.data.type!=ObjectType.HELICOPTER||!a.data.bPendingRemoval)){var m=this.Dist(e.position[0],e.position[1],a.position[0],a.position[1]);m<s&&(s=m,t=a)}}}return t}getNearestEnemyPawn(e,a){if(this.game.cinematic||this.isGeneratingNodes()||!e.world)return null;var t=!1,i=!1,s=!1,r=null,n=void 0,o=this.settings.maxWorldSize,d=!1,l=null;a&&(null!=a.bLOS&&a.bLOS,null!=a.maxRange&&(o=a.maxRange),null!=a.pawnTypes&&(r=a.pawnTypes),null!=a.scale&&(n=a.scale),null!=a.bPreferDistance&&(t=a.bPreferDistance),null!=a.bIgnoreOutOfSight&&(i=a.bIgnoreOutOfSight),null!=a.bAllTypes&&(s=a.bAllTypes),a.priority&&(l=a.priority),null!=a.bLockOn&&(d=a.bLockOn));var h=[],m=this.getTypes(r||[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR,ObjectType.MOUNTED_WEAPON,ObjectType.EGG]);m.sort(((a,t)=>{let i=this.DistBodies(a,e),s=this.DistBodies(t,e);return i<s?-1:i>s?1:0}));for(var c=0;c<m.length;c++){let a=m[c],t=a.data;if(!t||t.bPendingRemoval||t.bUntargetable||t.bInvisible||t.bSpawnProtection||!t.health||t.team==e.data.team)continue;let l,g=!0,E=0,b=this.Dist(e.position[0],e.position[1],a.position[0],a.position[1]);if(b>o)continue;if(r&&-1==r.indexOf(a.data.type)){if(!s)continue;E=1}if(null!=n)if(n>0){if(a.position[0]<e.position[0])continue}else if(n<0&&a.position[0]>e.position[0])continue;if(d&&a.data.bECM)continue;if(this.isCharacter(a)){if(a.data.controllableId){var p=this.getObjectById(a.data.controllableId);if(p&&(p.data.type==ObjectType.TANK||p.data.type==ObjectType.HELICOPTER))continue}}else if(this.isVehicle(a)){if(!a.data.health||a.data.bDisabled)continue;if(!this.vehicleHasOccupant(a)){if(!this.game.bSurvival)continue;if(0==e.data.team)continue}}if(g&&b>100&&(l=this.checkLineOfSight(e.position,a.position,!0,e),!l)){if(i)continue;g=!1}let u={type:a.data.type,pawn:a,fallback:E,dist:b,bLOS:g};if(h.push(u),g&&!0===l)break}return h.length>0?(l?h.sort((function(e,a){return e.fallback<a.fallback?-1:e.fallback>a.fallback||e.bLOS<a.bLOS?1:e.bLOS>a.bLOS||e.type==l&&a.type!=l?-1:a.type==l&&e.type!=l?1:e.dist<a.dist?-1:e.dist>a.dist?1:0})):t?h.sort((function(e,a){return e.fallback<a.fallback?-1:e.fallback>a.fallback?1:e.dist<a.dist?-1:e.dist>a.dist||e.bLOS<a.bLOS?1:e.bLOS>a.bLOS?-1:0})):h.sort((function(e,a){return e.bLOS<a.bLOS?1:e.bLOS>a.bLOS||e.dist<a.dist?-1:e.dist>a.dist?1:0})),h[0].pawn):null}setDataValue(e,a,t){var i=e?e.data:null;if(i){if("number"==typeof t&&(t=Math.min(99999999,t)),this.game.bScenario)switch(a){case"id":case"reward":this.log("Access denied: "+a+"="+t)}var s=i[a];i[a]=t,s!==i[a]&&this.pushObjectDataUpdate(i.id,[a])}}pushObjectUpdate(e,a){var t=this.getObjectById(e);if(t){for(var i={id:e},s=0;s<a.length;s++){var r=a[s];i[r]=t[r]}this.onEvent({eventId:GameServer.EVENT_OBJECT_UPDATE,object:i})}}pushObjectDataUpdate(e,a){var t=this.getObjectById(e);if(t){for(var i={id:e},s=0;s<a.length;s++){var r=a[s];i[r]=t.data[r]}this.onEvent({eventId:GameServer.EVENT_OBJECT_UPDATE,object:i})}}checkLineOfSight(e,a,t,i,s=!1){var r=this.raycast(e[0],e[1],a[0],a[1],i);if(r){if(0==r.length)return!0;for(var n=0;n<r.length;n++){let a=r[n].body;if(a===i)return!0;if(a.data)switch(a.data.type){case ObjectType.GROUND:return!1;case ObjectType.OBSTACLE:if(t&&(a.data.bBlockLOS||s)){if(this.Dist(e[0],e[1],a.position[0],a.position[1])>50)return!1}break;case ObjectType.DOOR:if(t)return!1;if(a.data.bClosed)return!1;break;case ObjectType.CAR:case ObjectType.TANK:case ObjectType.HELICOPTER:if(!this.vehicleHasOccupant(a)&&t){if(this.Dist(e[0],e[1],a.position[0],a.position[1])>50)return!1}}}}return!0}returnFlagCTF(e,a){if(e){var t=e.data;if(t.flagType!=GameMode.CAPTURE_THE_FLAG)return void console.warn(t.flagType);this.setFlagCarrierId(e,null);var i=this.getCurrentMapData().flags[this.game.gameModeId][t.team];i?this.setObjectPosition(e,i):console.warn("Invalid flag position"),t.cooldownTimer=5,this.setDataValue(e,"bAwayFromHome",!1),a&&this.onFlagReturned(e,a)}}handleFlag(e){this.isOutOfMap(e)&&this.returnFlagCTF(e);var a=this.getCurrentMapData(),t=e.data;if(t.cooldownTimer>0?t.cooldownTimer--:delete t.cooldownTimer,t.carrierId){var i=this.getObjectById(t.carrierId);i?(i.data.health&&(e.position[0]=i.position[0],e.position[1]=i.position[1]),i.data.controllableId&&(this.onFlagDropped(e,t.carrierId),this.setFlagCarrierId(e,null))):(this.onFlagDropped(e,t.carrierId),this.setFlagCarrierId(e,null))}if(!t.bAwayFromHome){var s=a.flags[this.game.gameModeId][t.team];this.setObjectPosition(e,s)}if(!t.cooldownTimer)for(var r=this.getCharactersAndDinosaurs(),n=0;n<r.length;n++){let i=r[n];if(!i.data.controllableId)var o=e.getAABB().overlaps(i.getAABB());if(o)if(i.data.team==t.team){if(!t.carrierId&&t.bAwayFromHome)t.cooldownTimer=5,this.returnFlagCTF(e,i.data.id);else if(!t.bAwayFromHome){let s=this.getFlagCTF(1==t.team?0:1);if(s.data.carrierId==i.data.id){this.setFlagCarrierId(s,null),s.data.cooldownTimer=5;let r=a.flags[this.game.gameModeId][s.data.team];return this.setObjectPosition(s,r),this.setDataValue(s,"bAwayFromHome",!1),s.wakeUp(),t.cooldownTimer=5,void this.onFlagCaptured(e,[i.data.id])}}}else t.carrierId||(this.setFlagCarrierId(e,i.data.id),t.bAwayFromHome=!0,this.pushObjectDataUpdate(t.id,["bAwayFromHome"]),t.cooldownTimer=5,i.data.bBot&&this.setPawnRequest(i,Commands.REQUEST_COVER),this.onFlagPickedUp(e,i.data.id))}}setFlagCarrierId(e,a){e?(this.setDataValue(e,"carrierId",a),this.pushObjectDataUpdate(e.data.id,["carrierId"])):console.warn("Invalid flag body",a)}onFlagReturned(e,a){var t=this.getPlayerById(a);t&&(t.returns++,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a,data:{returns:t.returns}}),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{playerId:a,team:e.data.team,bFlagReturned:!0}}))}onFlagDropped(e,a){e.wakeUp(),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{playerId:a,team:e.data.team,bFlagDropped:!0}})}onFlagPickedUp(e,a){this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{playerId:a,team:e.data.team,bFlagPickedUp:!0}})}handleDominationFlag(e){for(var a,t=e.data,i=this.getCharactersAndDinosaurs(),s=0;s<i.length;s++){let t=i[s];e.getAABB().overlaps(t.getAABB())&&(a||(a={}),a[t.data.team]||(a[t.data.team]=[]),a[t.data.team].push(t.data.id))}var r=this.clone(t.captureTimer),n=[0,0];t.charsTouching&&(n[0]=null!=t.charsTouching[0]?t.charsTouching[0].length:0,n[1]=null!=t.charsTouching[1]?t.charsTouching[1].length:0);var o=t.bIsBeingCaptured,d=t.bIsContested,l=t.capturingTeam,h=t.team;if(t.charsTouching=a,t.bIsBeingCaptured=!1,t.bIsContested=!1,t.capturingTeam=null,a){var m=Object.keys(a);if(1==m.length){var c=parseInt(m[0]);if(c!=t.team)if(t.bIsBeingCaptured=!0,t.capturingTeam=c,t.captureTimer[c]>0){t.captureTimer[c]-=Math.min(a[c].length,4);for(s=0;s<a[c].length;s++){var p=this.getObjectById(a[c][s]);p&&(p.data.bIsCapturingFlag=!0)}}else t.captureTimer[c]=0,t.team=c,this.onFlagCaptured(e,a[c])}else m.length>1&&(t.bIsContested=!0)}else{switch(this.game.gameModeId){case GameMode.DOMINATION:case GameMode.CONQUEST:this.setDataValue(e,"captureTimerMax",10*this.game.settings.fps)}for(s=0;s<2;s++)t.captureTimer[s]<t.captureTimerMax&&(t.captureTimer[s]=Math.min(t.captureTimer[s]+2,t.captureTimerMax))}null!=t.team&&(t.pointTimer>0?t.pointTimer--:(this.onFlagPoint(t.team),t.pointTimer=t.pointTimerMax));var g=[];t.charsTouching&&(n[0]==(null!=t.charsTouching[0]?t.charsTouching[0].length:0)&&n[1]==(null!=t.charsTouching[1]?t.charsTouching[1].length:0)||g.push("charsTouching")),o!=t.bIsBeingCaptured&&g.push("bIsBeingCaptured"),d!=t.bIsContested&&g.push("bIsContested"),l!=t.capturingTeam&&g.push("capturingTeam"),h!=t.team&&g.push("team"),r[0]==t.captureTimer[0]&&r[1]==t.captureTimer[1]||g.push("captureTimer"),g.length>0&&this.pushObjectDataUpdate(t.id,g)}onFlagPoint(e,a){if(null!=e){var t=this.game.gameModeData.scores;t[e]++,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{scores:t,pointTeam:e}}),t[e]>=this.game.gameModeData.scoreLimit&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:e,cameraTargetId:a})}if(null!=a){var i=this.getPlayerStateById(a);i&&i.score>=0&&(i.score++,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a,data:{score:i.score}}))}}onFlagCaptured(e,a){var t=e.data.team;if(a){for(var i=0;i<a.length;i++){var s=this.getPlayerById(a[i]);s&&(s.captures++,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a[i],data:{captures:s.captures}}))}this.game.gameModeData.flags[e.data.num]=e.data.team;var r={eventId:GameServer.EVENT_GAME_UPDATE,data:{flags:this.game.gameModeData.flags,flagCaptured:e.data.num,playerIds:a}};this.onEvent(r)}switch(this.game.gameModeId){case GameMode.CAPTURE_THE_FLAG:var n=this.game.gameModeData.scores;n[t]++,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{scores:n}}),n[t]>=this.game.gameModeData.scoreLimit&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:t,cameraTargetId:a?a[0]:null})}}resetPlayerInputs(){for(var e=0;e<this.game.players.length;e++){let a=this.game.players[e];a&&(a.input={})}}startCinematic(e){console.log("startCinematic",e),this.resetPlayerInputs(),this.game.cinematic={id:e.id,actions:e.actions,index:0},this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{cinematic:this.game.cinematic}}),this.dispatchTrigger({event:"cinematicStarted",cinematicId:this.game.cinematic.id})}handleCinematic(){var e=this.game.cinematic;e&&(e.timer>0?e.timer--:this.loadNextCinematicAction())}loadNextCinematicAction(){console.log("loadNextCinematicAction");var e=this.game.cinematic;if(e){var a=e.actions[e.index];if(a){if(console.log(a),a.type,a.lookPositions)for(var t=0;t<a.lookPositions.length;t++){let e=a.lookPositions[t];if(e.targetId&&e.objectId){let a=this.getObjectById(e.targetId);if(a){let t=this.getObjectById(e.objectId);t&&(a.data.lookPos=t.position,a.data.cinematicLookPos=t.position)}}}a.functionId&&this.executeScenarioFunction(a.functionId),a.triggerId&&this.executeTriggerById(a.triggerId),e.timer=(a.timer?a.timer:2)*this.game.settings.fps,a.text&&(e.timer+=Math.min(60,a.text.length)),e.timerMax=e.timer,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{cinematicAction:a}}),e.index++}else this.endCinematic()}else console.warn("Invalid cinematic")}endCinematic(){console.log("endCinematic"),this.dispatchTrigger({event:"cinematicEnded",cinematicId:this.game.cinematic.id}),delete this.game.cinematic,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bCinematicMode:!1}})}isNearHealthBox(e){for(var a=this.getEquipment("health_box"),t=0;t<a.length;t++){let i=a[t];if(!i.data.bJammed&&i.data.team==e.data.team)return this.Dist(i.position[0],i.position[1],e.position[0],e.position[1])<i.data.weaponData.radius}return!1}handleEquipment(e){if(this.isOutOfMap(e))this.removeNextStep(e);else{var a=e.data,t=a.weaponData;if("jammer"!=t.id&&this.setDataValue(e,"bJammed",this.hasNearbyJammer(e)),!a.bDisabled)switch(t.id){case"sensor":break;case"health_box":if(a.bJammed)break;break;case"trophy":if(a.bJammed)break;if(a.blockNum>0)for(var i=this.getTypes([ObjectType.ROCKET,ObjectType.GRENADE]),s=0;s<i.length;s++){let r=i[s];if(r.data&&!r.data.bPendingRemoval&&r.data.team!=a.team){if(this.Dist(e.position[0],e.position[1],r.position[0],r.position[1])<=t.radius){a.blockNum--,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_TROPHY_HIT,pos:r.position}),this.removeNextStep(r),this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,x:r.position[0],y:r.position[1],radius:200,damage:0,playerId:null,causerId:null,weaponId:null});break}}}else this.removeNextStep(e);break;default:if(t.bMine)if(a.bTriggered)a.triggerTimer>0?a.triggerTimer--:this.detonate(e);else if(!a.bJammed){var r=this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR,ObjectType.EGG]);for(s=0;s<r.length;s++){let t=r[s];if(t.data&&!t.data.bPendingRemoval&&t.data.team!=a.team){if(this.isVehicle(t)&&!this.vehicleHasOccupant(t))continue;if(a.bUseScale){if(1==a.scale&&t.position[0]<e.position[0])continue;if(-1==a.scale&&t.position[0]>e.position[0])continue}if(this.Dist(t.position[0],t.position[1],e.position[0],e.position[1])<a.triggerRange&&this.checkLineOfSight(e.position,t.position,!1,t)){a.triggerType&&a.triggerType!=t.data.type||this.triggerMine(e,Math.ceil(.5*this.game.settings.fps));break}}}}}}}triggerMine(e,a){var t=e.data;t.bJammed||(t.bTriggered=!0,t.triggerTimer=a,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_TRIGGER_MINE}))}handleGrenade(e){var a=e.data;a.stuckToId&&(this.getObjectById(a.stuckToId)||e.constraint&&(this.game.world.removeConstraint(e.constraint),delete e.constraint));a.bDetonationTimerEnabled&&(a.detonationTimer>0?a.detonationTimer--:0==a.detonationTimer&&this.detonate(e)),a.bImpact&&a.lifespan++,a.minTimer>0&&(a.minTimer--,a.minTimer<=0&&delete a.minTimer)}handleRocket(e){var a=e.data;if(a.bAutoLock&&!a.enemyId){switch(a.vehicleId){case MountedWeapon.SENTRY_SAM:var t=[ObjectType.HELICOPTER]}(i=this.getNearestEnemyPawn(e,{bIgnoreOutOfSight:!1,maxRange:1e3,pawnTypes:t,bLOS:!0,bLockOn:!0}))&&this.setDataValue(e,"enemyId",i.data.id)}else if(a.enemyId&&!a.path){var i,s=this.getNearbyFlare(e);if(s&&this.setDataValue(e,"enemyId",s.data.id),i=this.getObjectById(a.enemyId)){if(i.data.bECM)this.setDataValue(e,"enemyId",null);else if(i.data.health||i.data.type==ObjectType.ROCKET){if(this.DistBodies(i,e)<75)return void this.detonate(e);var r=i.position[0]-e.position[0],n=i.position[1]-e.position[1],o=Math.atan2(n,r),d=300/this.game.fpsMult,l=this.WrapAngle(e.angle-o,!0);e.angle-=.1*l,e.applyForce([Math.cos(e.angle)*d,Math.sin(e.angle)*d],0,0),this.constrainVelocity(e,500)}}else a.bAutoLock&&this.setDataValue(e,"enemyId",null)}else if(a.bControllable){d=300;e.applyForce([Math.cos(e.angle)*d,Math.sin(e.angle)*d],0,0),this.constrainVelocity(e,750)}0==a.destroyTimer&&this.detonate(e)}handleVehicle(e){var a=e.data;if(!this.isOutOfMap(e)||this.vehicleHasOccupant(e)){if(a.bAutomated&&this.matchInProgress()){e.ai||(e.ai={ticker:0,tickerMax:5});var t=e.ai;t.ticker>0?t.ticker--:t.ticker=t.tickerMax;var i=this.getCurrentVehicleWeapon(e,0);if(!a.health||a.bStunned||a.bFlashed||a.bJammed)i&&(i.bWantsToFire=!1),this.setDataValue(e,"bWantsToFire",!1);else{if(a.weapons)for(var s=0;s<a.weapons[0].length&&(!(i=a.weapons[0][s])||i.bCooldown);s++);if(this.setVehicleWeaponIndex(e,0,s),i&&i.weaponData&&!a.bDisabled){var r=i.weaponData,n=Math.min(r.range,1e3),o={bLOS:!0};switch(a.type){case ObjectType.HELICOPTER:o.pawnTypes=a.enemyTypes?a.enemyTypes:[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.CAR,ObjectType.TANK,ObjectType.EGG],o.bLOS=!1;break;case ObjectType.MOUNTED_WEAPON:switch(o.maxRange=n,a.vehicleId){case MountedWeapon.BGM71:n=a.maxRange?a.maxRange:2e3,o.pawnTypes=null,o.bLOS=!1;break;case MountedWeapon.SENTRY_SAM:n=a.maxRange?a.maxRange:2e3,o.pawnTypes=[ObjectType.HELICOPTER],o.bLOS=!1;break;case MountedWeapon.SENTRY_SNIPER:n=a.maxRange?a.maxRange:4e3,o.bIgnoreOutOfSight=!0,o.priority=ObjectType.HELICOPTER,o.pawnTypes=[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.CAR,ObjectType.TANK];break;case MountedWeapon.SENTRY_RAILGUN:n=a.maxRange?a.maxRange:3500,o.bIgnoreOutOfSight=!0,o.priority=ObjectType.HELICOPTER,o.pawnTypes=[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.CAR,ObjectType.TANK];break;default:o.bIgnoreOutOfSight=!0,o.pawnTypes=[ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.CAR,ObjectType.TANK]}}0==t.ticker&&(t.enemy=this.getNearestEnemyPawn(e,o));var d=t.enemy;if(d&&d.data){a.enemyId=d.data.id,this.setVehicleWeaponAimRotation(i,this.Angle(e.position[0],e.position[1],d.position[0],d.position[1]));var l=this.DistBodies(e,d);i.bWantsToFire=l<n&&(a.type==ObjectType.HELICOPTER||r.bAutoLock||this.checkLineOfSight(e.position,d.position,!1,d))}else delete t.enemy,delete a.enemyId,i.bWantsToFire=!1,a.type==ObjectType.MOUNTED_WEAPON&&(i.aimRotation+=this.ToRad(1/this.game.fpsMult));(a.bStunned||a.bFlashed||a.bJammed||a.bDisabled)&&(i.bWantsToFire=!1),this.setDataValue(e,"bWantsToFire",i.bWantsToFire)}switch(a.type){case ObjectType.CAR:case ObjectType.TANK:case ObjectType.HELICOPTER:var h=100;if(a.bLeaveWhenNoOccupants&&!this.hasPawnOccupants(e)&&(a.destination||(a.destination=[this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],a.bRemove=!0)),a.destination)var m=a.destination;else if(d&&!a.bDisabled)m=d.position;else{var c=this.getObjectById(a.playerId);c&&(m=c.position,h=600)}if(m){var p=a.enemyThreshold?a.enemyThreshold:300,g=this.Angle(e.position[0],e.position[1],m[0],m[1]),E=this.Dist(e.position[0],e.position[1],m[0],m[1]),b=a.speed*(null==l||l>p?1:-1);E<2*h&&(e.velocity[0]*=.98,e.velocity[1]*=.98),E>h?e.applyForce([Math.cos(g)*b,Math.sin(g)*b]):a.destination&&(a.bDestinationReached=!0)}if(a.bDestinationReached)if(a.destinationTimer>0)a.destinationTimer--;else if(a.items&&a.items.length>0)if(a.itemTimer>0)a.itemTimer--;else{let e=a.items[0],t=a.destination;e.offset&&(t[0]+=this.Random(-e.offset,e.offset),t[1]+=this.Random(-e.offset,e.offset)),this.spawnItem(e,t,a.team),a.items.splice(0,1),a.itemTimer=a.itemTimerMax?a.itemTimerMax:5*this.game.settings.fps}else a.bRemove?this.removeNextStep(e):a.defendTimer>0?a.defendTimer--:(a.bRemove=!0,a.bDestinationReached=!1,a.destination=[this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],this.isOutOfHelicopterArea(e)&&this.removeNextStep(e))}}}if(a.attachId&&(this.getObjectById(a.attachId)||this.setDataValue(e,"attachId",null)),a.attachToId&&(this.getObjectById(a.attachToId)||this.setDataValue(e,"attachToId",null)),a.scaleCooldown>0&&a.scaleCooldown--,a.bECM&&a.ecmTimer>0&&(a.ecmTimer--,a.ecmTimer<=0&&(delete a.ecmTimer,this.setDataValue(e,"bECM",!1))),a.bCountermeasureCooldown&&a.countermeasureCooldownTimer>0&&(a.countermeasureCooldownTimer--,a.countermeasureCooldownTimer<=0&&(delete a.countermeasureCooldownTimer,this.setDataValue(e,"bCountermeasureCooldown",!1))),a.flares>0){var u=this.getIncomingGuidedRocket(e);u&&(this.ejectFlare(e,u),a.flares--)}var I=a.seats;if(I)for(s=0;s<I.length;s++){var T=I[s];if(T.pawnId)(_=this.getObjectById(T.pawnId))?(_.position=[e.position[0]+T.position[0],e.position[1]+T.position[1]],_.angle=e.angle):delete T.pawnId}var v=a.weapons;if(v)for(s=0;s<v.length;s++)for(var y=v[s],A=0;A<y.length;A++){if(i=y[A]){if(!I[s].pawnId&&!a.bAutomated&&(i.bWantsToFire=!1,s>0))switch(a.vehicleId){case Tank.ABRAMS:case Tank.T90:case Car.LAV25:i.aimRotation=v[0][0].aimRotation;break;default:i.aimRotation=e.angle}if(i.bFireDelay&&(i.fireDelayTimer--,0==i.fireDelayTimer&&(i.bFireDelay=!1)),i.overheat>0){var O=i.weaponData.cooldownNum?i.weaponData.cooldownNum:.5;i.overheat-=(i.bCooldown?O:null!=i.weaponData.overheatCooldownNum?i.weaponData.overheatCooldownNum:1)/this.game.fpsMult,i.overheat<=0&&i.bCooldown&&(null!=i.ammo&&(i.ammo=i.weaponData.ammoMax),i.bCooldown=!1,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_WEAPON_COOLDOWN,index:s,weaponIndex:A,value:i.bCooldown,ammo:i.ammo}))}var R=null==i.ammo||i.ammo>0,M=null!=i.weaponData&&this.matchInProgress();if(M&&i.weaponData.bRequireLock){var _=this.getObjectById(I[s].pawnId);M=M&&_&&_.data.lockOnTargetId}if(i.bWantsToFire&&!i.bFireDelay&&!i.bCooldown&&R&&M){var D=I[s].pawnId;D||(D=a.playerId);var S=this.getVehicleMuzzlePosition(e,s),N=(r=i.weaponData).type==Weapon.TYPE_SHOTGUN||r.bShotgun,C=1;N=r.type==Weapon.TYPE_SHOTGUN||r.bShotgun;r.id==Dinosaur.NEEDLER?C=2:N&&!r.bSlug&&(C=8);for(var P=0;P<C;P++){var f=i.aimRotation+this.ToRad(this.Random(-r.accuracy,r.accuracy));if(r.bAutoLock)(_=this.getObjectById(D))&&_.data.lockOnTargetId&&(f+=this.ToRad(this.Random(-15,15)));if(r.bRocket){_=this.getObjectById(D);this.createRocket(S,{rocketType:r.rocketType?r.rocketType:Rocket.DEFAULT,team:a.team,playerId:D,causerId:a.id,angle:f,weaponId:r.id,damage:r.damage,radius:r.radius,bRequireLock:r.bRequireLock,bAutoLock:r.bAutoLock,bCanLock:r.bCanLock,lockOnTargetId:a.enemyId?a.enemyId:_.data.lockOnTargetId})}else if(r.bGrenade)this.createGrenade(S,{team:a.team,playerId:D,causerId:a.id,rotation:f,velocity:1500,damage:r.damage,weaponId:r.id,weaponData:r,modId:r.mods?r.mods[Mods.TYPE_AMMO]:null,bImpact:!0,bMinimumDistance:!0});else if(r.bProjectile)a.attachId?this.detachRope(e):this.createProjectile(S,f,a.team,{playerId:D,causerId:a.id,rotation:f,weaponId:r.id,frameId:r.frameId,sourceId:a.id});else if(r.bFlame){var w=r.velocity?r.velocity:1500,G=this.Random(w,w+200);this.createFlame(S,[Math.cos(f)*G,Math.sin(f)*G],a.team,D,r,r.fireTime,!0).data.bAutomated=a.bAutomated}else this.createBullet({x:S[0],y:S[1],rotation:f,range:r.range,damage:r.damage,instigatorId:D,causerId:a.id,weaponId:r.id,weaponData:r,bDirectlyCausedByPlayer:!a.bAutomated,bMelee:r.bDinosaur,bIgnoreObstacles:a.type==ObjectType.HELICOPTER})}i.bFireDelay=!0,i.fireDelayTimer=Math.max(1,Math.ceil(r.fireRate*this.game.fpsMult)),null!=i.ammo&&(i.ammo--,a.type==ObjectType.MOUNTED_WEAPON&&!a.bUnlimitedAmmo&&i.ammo<=0&&a.bAutomated&&this.removeNextStep(e)),i.weaponData&&i.weaponData.overheatMax&&(i.overheat+=i.weaponData.overheatNum?i.weaponData.overheatNum:Math.round(1.75*r.fireRate),i.overheat>=i.weaponData.overheatMax&&(i.overheat=i.weaponData.overheatMax,i.bCooldown=!0,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_WEAPON_COOLDOWN,index:A,value:i.bCooldown}))),null==a.ammo||a.bUnlimitedAmmo||(this.setDataValue(e,"ammo",a.ammo-1),a.ammo<=0&&(this.exitAllPawnsFromVehicle(e),this.killPawn(a.id)));var k={eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_FIRE_WEAPON,index:s,angle:i.aimRotation,ammo:i.ammo,overheat:i.overheat};this.requestEvent(k),this.emitAISound(e.position,e.position,1e3,a.team)}}}}else this.removeNextStep(e)}handleTank(e){this.handleCar(e)}handleCar(e){this.handleVehicle(e);var a=e.data,t=a.speed?a.speed:100;if(a.type==ObjectType.TANK){this.constrainVelocity(e,a.maxSpeed?a.maxSpeed:275);var i=6}else if(this.constrainVelocity(e,(a.maxSpeed?a.maxSpeed:750)*(a.bReversing?.5:1)),e.mass<Number.MAX_VALUE){var s=.001*this.getTotalVelocity(e)/t;i=Math.min(t*Math.min(1,Math.abs(s)),100/(.3*e.mass)),i=Math.min(30,i)}else i=0;if(i/=this.game.fpsMult,this.vehicleHasOccupant(e)){var r=a.seats[0]?a.seats[0].pawnId:null,n=this.getPlayerById(r);if(n)var o=n.input;else{var d=this.getObjectById(r);d&&(o=d.input)}if(o)if(o[Control.UP]?(e.applyImpulse([Math.cos(e.angle)*t,Math.sin(e.angle)*t]),this.setDataValue(e,"bReversing",!1),this.setDataValue(e,"bGas",!0)):o[Control.DOWN]?(e.applyImpulse([Math.cos(e.angle)*-t,Math.sin(e.angle)*-t]),this.setDataValue(e,"bReversing",!0),this.setDataValue(e,"bGas",!0)):(this.setDataValue(e,"bGas",!1),this.setDataValue(e,"bReversing",!1)),o[Control.RIGHT]){e.wakeUp();var l=this.ToRad(i);a.bReversing?e.angularVelocity-=l:e.angularVelocity+=l,this.setDataValue(e,"turnDirection",1)}else o[Control.LEFT]?(e.wakeUp(),l=this.ToRad(i),a.bReversing?e.angularVelocity+=l:e.angularVelocity-=l,this.setDataValue(e,"turnDirection",-1)):this.setDataValue(e,"turnDirection",0)}else this.setDataValue(e,"turnDirection",0),this.setDataValue(e,"bGas",!1),this.setDataValue(e,"bReversing",!1);0==a.turnDirection&&(e.angularVelocity*=.25)}handleMountedWeapon(e){this.handleVehicle(e);var a=e.data;this.game.bSurvival&&1==a.team&&this.setDataValue(e,"bJammed",this.hasNearbyJammer(e))}handleHelicopter(e){this.handleVehicle(e);var a=e.data;if(this.constrainVelocity(e,a.maxSpeed?a.maxSpeed:1e3),a.swayMax>0&&(1==a.swayDir?(a.sway++,a.sway>a.swayMax&&(a.swayDir=-1)):(a.sway--,a.sway<-a.swayMax&&(a.swayDir=1))),this.vehicleHasOccupant(e)){var t=3*a.sway;e.applyForce([t,t]);var i=Math.atan2(-e.velocity[0],e.velocity[1])+this.ToRad(90),s=this.getCurrentVehicleWeapon(e,0);!a.bAutomated&&s.weaponData||s&&s.weaponData&&s.bWantsToFire?i=s.aimRotation:a.destination&&(i=this.Angle(e.position[0],e.position[1],a.destination[0],a.destination[1]));var r=this.WrapAngle(i-e.angle,!0);e.angularVelocity+=.05*r}}handleReviver(e){this.constrainVelocity(e,500);var a=e.data;a.currentPawnId||null==a.bleedTimer||a.bleedTimer>0&&(a.bleedTimer--,this.setDataValue(e,"bleedTimer",a.bleedTimer-1),a.bleedTimer<=0&&(a.bleedTimer=null,this.game.bOperation?this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_DEAD_ALLY,cameraTargetId:a.id}):this.removeNextStep(e)))}isInSmoke(e){if(e)for(var a=this.getSmokeGrenades(),t=0;t<a.length;t++){var i=a[t];if(this.Dist(i.position[0],i.position[1],e.position[0],e.position[1])<=this.getSharedData("smokeSize"))return!0}return!1}handleEgg(e){var a=e.data;if(this.matchInProgress()&&!a.bDisabled&&a.hatchTimer>0&&(a.hatchTimer--,a.hatchTimer<=0)){for(var t=a.items,i=0;i<t.length;i++)this.spawnItem(t[i],e.position,a.team);a.items=[],this.removeNextStep(e)}}handleMoney(e){var a=e,t=a.data;if(this.matchInProgress())for(var i=this.getCharacters(),s=0;s<i.length;s++){let e=i[s];if(!e.data||!e.data.health||e.data.bInvisible)continue;if(this.game.bSurvival&&0!=e.data.team)continue;if(this.game.bSurvival&&e.data.controllableId)continue;let r=this.getPlayerById(e.data.id);if(r&&r.money<this.settings.maxPlayerMoney){a.getAABB().overlaps(e.getAABB())&&(this.addPlayerMoney(e.data.id,t.value),this.removeNextStep(a))}}}handleArrow(e){var a=e;if(this.matchInProgress())for(var t=this.getCharacters(),i=0;i<t.length;i++){let e=t[i];if(!e.data||!e.data.health||e.data.bInvisible||e.data.controllableId)continue;let s=this.getCharacterInventoryItemIndex(e,"bow");if(-1==s&&(s=this.getCharacterInventoryItemIndex(e,"crossbow")),s>=0){a.getAABB().overlaps(e.getAABB())&&(this.addInventoryItemAmmo(e,s,1),this.removeNextStep(a))}}}handleFlame(e){var a=e,t=a.data;if(this.constrainVelocity(e,2e3),this.matchInProgress())if(this.isInSmoke(a))this.removeNextStep(a);else if(t.ticker<=0){for(var i=this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR,ObjectType.DUMMY,ObjectType.EGG,ObjectType.MOUNTED_WEAPON,ObjectType.EQUIPMENT,ObjectType.OBSTACLE]),s=0;s<i.length;s++){let r=i[s];if(!r.data||!r.data.health||r.data.bInvisible||r.data.controllableId||r.data.bPendingRemoval||r.data.bGodMode)continue;let n=this.getPlayerById(r.data.id);if(n&&n.bSpawnProtection)continue;let o=r.data.id==t.playerId;if(r.data.team!=t.team||o&&this.game.bFriendlyFire){if(t.cooldownTimer>0&&r.data.id==t.playerId)continue;if(!!a.getAABB()&&a.getAABB().overlaps(r.getAABB())){!o&&this.isValidArray(e.velocity)&&(e.velocity[0]*=.1,e.velocity[1]*=.1);let i=t.damage,s=Math.round(30*this.game.fpsMult);t.destroyTimer<s&&(i*=t.destroyTimer/s),this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_FIRE,damageAmount:i,pawnId:r.data.id,attackerId:t.playerId,causerId:t.id,weaponId:t.weaponId,bDirectlyCausedByPlayer:a.data.bFromWeapon})}}}t.cooldownTimer>0&&t.cooldownTimer--,t.ticker=t.tickerMax}else t.ticker--}handleCrate(e){var a=e.data;switch(a.crateType){case Crate.BOMB:case Crate.BOMB_GENERIC:a.bBombPlanted&&this.matchInProgress()&&(a.bombTimer>0?(a.bombTimer--,this.pushObjectDataUpdate(a.id,["bombTimer"])):a.bDetonated||this.detonate(e))}}handleDoor(e){var a=e.data;a.cooldownTimer>0&&a.cooldownTimer--}handleShield(e){var a=e.data,t=this.getObjectById(a.playerId);if(t&&t.data.health){var i=this.getCurrentCharacterInventoryItem(t);if(i&&"riot_shield"==i.id){var s=t.data.weapon;a.bActive=!(t.data.controllableId||t.data.bWantsToInteract||t.data.bDoorCooldown||s.bThrowDelay||s.bEquipmentDelay||s.bUseDelay),e.angle=t.data.aimRotation;e.position[0]=t.position[0]+25*Math.cos(e.angle),e.position[1]=t.position[1]+25*Math.sin(e.angle)}else this.removeNextStep(e)}else this.removeNextStep(e)}handleDinosaur(e){this.handlePawn(e);var a=e.data;if(a.bBot){if(this.getCurrentCharacterInventoryItem(e).type!=Weapon.TYPE_MELEE&&e.ai.bEnemyLOS||this.getTotalVelocity(e)<100)var t=a.aimRotation;else t=this.Angle(0,0,e.velocity[0],e.velocity[1]);var i=this.WrapAngle(e.angle-t,!0);e.angle-=.25*i/e.mass}else if(a.aimRotation){i=this.WrapAngle(e.angle-a.aimRotation,!0);e.angle-=.25*i}var s=a.maxSpeed?a.maxSpeed:100;a.bLunge&&(s*=a.lungeMult),this.constrainVelocity(e,s)}spawnItem(e,a,t){return a&&(e.position=a),null==e.team&&(e.team=t),this.createObject(e)}handlePawn(e){var a=e.data;if(this.game.bMultiplayer&&!a.controllableId&&this.isOutOfMap(e,!a.bBot))return(this.game.bSurvival||this.game.gameModeData.bAllowRevives)&&(e.position=this.getBestSpawnPosition(a.team,e)),void this.killPawn(a.id);if(a.controllableId&&(a.bSprinting=!1,a.bCrouching=!1),a.type==ObjectType.CHARACTER&&this.setDataValue(e,"bJammed",this.hasNearbyJammer(e)),a.health>a.maxHealth&&(a.health=a.maxHealth),a.bStunned?a.aimRotation-=.1*(a.aimRotation-a.desiredAimRotation):a.aimRotation=a.desiredAimRotation,a.controllableId)this.removeParachute(e);else if(a.bWantsToMove&&this.pawnCanMove(e)&&this.matchInProgress()){var t=a.maxSpeed*this.getCharacterSpeedMultiplier(e);if(a.bStunned||a.bFlashed)t*=.2;else if(a.type==ObjectType.CHARACTER){if(a.bJuiced&&(t*=this.getSharedData(ObjectType.CHARACTER).juiceSpeedMult),a.bSprinting)t*=i=this.getSharedData(ObjectType.CHARACTER).sprintMult;else if(a.bCrouching){var i;t*=null!=(i=this.getSharedData(ObjectType.CHARACTER).crouchMult)?i:1}}else a.type==ObjectType.DINOSAUR&&a.bLunge&&(t*=a.lungeMult);if(null!=a.moveAngle){var s=a.moveAngle;a.type,e.velocity[0]=Math.cos(s)*t,e.velocity[1]=Math.sin(s)*t}}a.bCrouching&&(a.bSprinting=!1);var r=a.weapon;if(r){var n=.95*this.game.fpsMult;r.recoil=this.RoundDecimal(r.recoil*n)}var o=this.getCurrentCharacterInventoryItem(e,!1),d=this.getCurrentCharacterInventoryItem(e);if(r.bFireHandler)if(a.bWantsToFire)if(this.characterCanFire(e,!0))switch(this.fireCharacterWeapon(e),d.fireMode){case Weapon.MODE_SEMI:r.bFireDelay=!0,r.fireDelayTimer=Math.floor(d.fireRate*this.game.fpsMult),r.bFireHandler=!1;break;case Weapon.MODE_BURST:r.bFireDelay=!0,r.fireDelayTimer=Math.floor(d.burstFireRate*this.game.fpsMult),d.bursts=(d.numBursts?d.numBursts:3)-1,r.burstTimer=Math.floor(d.fireRate*this.game.fpsMult),r.bBurstFireHandler=!0,r.bFireHandler=!1;break;case Weapon.MODE_AUTO:default:r.bFireDelay=!0,r.fireDelayTimer=Math.max(1,Math.ceil(d.fireRate*this.game.fpsMult))}else 0==d.mag||d.bRequireLock?this.reloadCharacterWeapon(e):a.bReloading&&d.bSingleRoundLoaded&&d.mag>0&&this.cancelCharacterReload(e);else r.bFireHandler=!1;if(r.bBurstFireHandler&&(d.bursts>0?r.burstTimer>0?r.burstTimer--:d.mag>0?(d.bursts>0&&d.bursts--,r.burstTimer=Math.round(d.fireRate*this.game.fpsMult),this.fireCharacterWeapon(e)):r.bBurstFireHandler=!1:r.bBurstFireHandler=!1),r.bFireDelay&&(r.fireDelayTimer--,r.fireDelayTimer<=0&&(r.bFireDelay=!1,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_FIRE_DELAY}),d.bNeedsBoltPull?this.pullCharacterBolt(e):0==d.mag&&(d.ammo>0&&this.reloadCharacterWeapon(e),this.onEndWeaponFire(e)))),r.bBoltDelay&&(r.boltDelayTimer--,r.boltDelayTimer<=0&&(r.bBoltDelay=!1,d.bNeedsBoltPull=!1,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_BOLT_DELAY}),0==d.mag&&d.ammo>0&&this.reloadCharacterWeapon(e))),r.bThrowDelay&&(r.throwDelayTimer--,r.throwDelayTimer<=0&&(r.bThrowDelay=!1,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_THROW_DELAY}))),r.bEquipmentDelay&&(r.equipmentDelayTimer>0?(r.equipmentDelayTimer--,a.bCrouching||this.setDataValue(e,"bCrouching",!0)):(r.bEquipmentDelay=!1,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_EQUIPMENT_DELAY}),this.setDataValue(e,"bCrouching",!1))),r.bUseDelay&&(r.useDelayTimer>0&&r.useDelayTimer--,0==r.useDelayTimer)){r.useDelayTimer=-1;var l=r.useData;l&&l.type}if(a.juiceTimer>0?a.juiceTimer--:(delete a.juiceTimer,this.setDataValue(e,"bJuiced",!1)),a.vehicleCooldown>0?a.vehicleCooldown--:delete a.vehicleCooldown,a.seatTimer>0&&(a.seatTimer--,a.seatTimer<=0)){this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_SWITCH_SEATS,value:!1}),delete a.seatTimer;var h=this.getObjectById(a.controllableId);if(h){var m=this.getAvailableSeatIndex(h);if(!a.bBot)for(var c=h.data.seats,p=0;p<c.length;p++){var g=c[p];if(p>e.data.seatIndex&&!g.pawnId){m=p;break}}null!=m&&(this.exitVehicle(e),this.enterVehicle(e,h,m))}}if(a.stoppingPowerTimer>0&&(a.stoppingPowerTimer--,a.stoppingPowerTimer<=0&&(delete a.stoppingPowerTimer,this.setDataValue(e,"bStoppingPower",!1))),a.currentRequest&&(a.requestTimer>0?a.requestTimer--:(delete a.requestTimer,this.setDataValue(e,"currentRequest",0))),a.bShieldCooldown&&(a.shieldCooldownTimer>0?a.shieldCooldownTimer--:(delete a.bShieldCooldown,delete a.shieldCooldownTimer,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_SHIELD_COOLDOWN,bDoor:a.bDoorCooldown}))),r.bMeleeDelay&&(r.meleeDelayTimer--,r.meleeDelayTimer<=0&&(r.bMeleeDelay=!1,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_MELEE_DELAY}),0==d.mag&&d.ammo>0&&this.reloadCharacterWeapon(e))),a.bReloading&&(a.reloadTimer--,0==a.reloadTimer)){if(a.bReloading=!1,d.bSingleRoundLoaded){var E=1;if(d.bSpeedLoader){(r.bUnlimitedAmmo||d.ammo>2&&d.mag+2<=d.magSize)&&(E=2)}r.bUnlimitedAmmo||(d.ammo=Math.max(d.ammo-E,0)),d.mag=Math.min(d.mag+E,d.magSize)}else d.ammo>=d.magSize||r.bUnlimitedAmmo?(r.bUnlimitedAmmo||(d.ammo-=d.magSize-d.mag),d.mag=d.magSize):d.ammo+d.mag>d.magSize?(r.bUnlimitedAmmo||(d.ammo-=d.magSize-d.mag),d.mag+=d.magSize-d.mag):(d.mag+=d.ammo,r.bUnlimitedAmmo||(d.ammo-=d.ammo));var b={eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:a.id,index:a.currentInventoryIndex,type:GameServer.INV_ITEM};o.bBarrel&&(b.bBarrel=1),this.requestEvent(b),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_RELOAD_COMPLETE}),d.bSingleRoundLoaded&&d.mag<d.magSize&&this.reloadCharacterWeapon(e)}if(a.bInteracting){var u=this.getObjectById(a.interactableId);u?a.interactTimer>0?a.interactTimer--:(a.interactableId&&this.executeInteractable(u,a.id),this.stopCharacterInteract(e)):this.stopCharacterInteract(e)}}getCharacterMuzzlePosition(e){if(e){var a=e.data,t=a.aimRotation,i=5;if(a.type==ObjectType.DINOSAUR){var s=this.getSharedData(a.dinoType,!1);i=s?s.size?s.size:.25*s.width:0}var r=e.position;return this.isValidArray(a.clientPos)&&(r=[a.clientPos[0],a.clientPos[1]]),[r[0]+Math.cos(t)*i,r[1]+Math.sin(t)*i]}return null}isValidArray(e){return!!e&&(!isNaN(e[0])&&!isNaN(e[1]))}hasUnderbarrelMod(e){return this.hasMod(e,Mods.ACCESSORY_M203)||this.hasMod(e,Mods.ACCESSORY_M320)||this.hasMod(e,Mods.ACCESSORY_GP25)||this.hasMod(e,Mods.ACCESSORY_MASTERKEY)}hasMod(e,a){if(e&&a){switch(a){case Mods.BARREL_SILENCER:if(e.bSilenced)return!0}var t=e.mods;if(t)for(var i=Object.keys(t),s=0;s<i.length;s++){if(t[i[s]]==a)return!0}}return!1}fireCharacterWeapon(e){var a=e.data,t=a.inventory[a.currentInventoryIndex];t.bBarrel&&t.barrel&&(t=t.barrel);var i=a.aimRotation,s=(this.hasMod(t,Mods.BARREL_SILENCER),this.getCharacterMuzzlePosition(e)),r=this.isMeleeWeapon(t),n=1,o=t.type==Weapon.TYPE_SHOTGUN||t.bShotgun;t.id==Dinosaur.NEEDLER?n=2:o&&!t.bSlug&&(n=8);for(var d=0;d<n;d++){var l=t.accuracy;t.type!=Weapon.TYPE_SHOTGUN&&(l*=a.bAiming?.8:1),l*=10;var h=i+this.ToRad(.1*this.Random(-l,l));if(h+=this.ToRad(a.weapon.recoil),t.bRocket){var m={rocketType:t.rocketType?t.rocketType:Rocket.DEFAULT,team:a.team,playerId:a.id,causerId:a.id,angle:h,weaponId:t.id,damage:t.damage,radius:t.radius,bRequireLock:t.bRequireLock,bCanLock:t.bCanLock,lockOnTargetId:a.lockOnTargetId};t.fireDamage&&(m.weaponData=t),this.createRocket(s,m)}else if(t.bGrenade){var c=t.damage;t.mods&&t.mods[Mods.TYPE_AMMO],this.createGrenade(s,{team:a.team,playerId:a.id,causerId:a.id,rotation:h,velocity:t.velocity?t.velocity:1500,damage:c,weaponData:t,weaponId:t.id,modId:t.mods?t.mods[Mods.TYPE_AMMO]:null,bImpact:!0,bMinimumDistance:!0})}else if(t.bProjectile)if(a.attachId)this.detachRope(e);else{var p=200;t.id==Dinosaur.NEEDLER&&(p=this.Random(200,250)),this.createProjectile(s,h,a.team,{playerId:a.id,causerId:a.id,rotation:h,velocity:p,weaponId:t.id,frameId:t.frameId,sourceId:a.id})}else if(t.bFlame){var g=t.velocity?t.velocity:1500,E=this.Random(g,g+200);this.createFlame(s,[Math.cos(h)*E,Math.sin(h)*E],a.team,a.id,t,t.fireTime,!0)}else if(t.bArrow){var b=t.damage;this.game.bSurvival&&(b*=5),this.createProjectile(s,h,a.team,{playerId:a.id,causerId:a.id,rotation:h,velocity:300,damage:b,weaponId:t.id,frameId:"arrow"})}else if("blowtorch"==t.id){var u=this.getTouchingVehicle(e,!0);if(!(u&&u.data.health<u.data.maxHealth))return;u.data.health=Math.min(u.data.maxHealth,u.data.health+10),this.pushObjectDataUpdate(u.data.id,["health"]);var I=!0}else{var T=t.damage;this.createBullet({x:s[0],y:s[1],rotation:h,range:t.range,damage:T,instigatorId:a.id,causerId:a.id,weaponId:t.id,weaponData:t,bDirectlyCausedByPlayer:!0,bMelee:r,bIgnoreObstacles:this.isInHelicopter(e)})}}var v=t.recoil;if(a.bAiming&&this.hasMod(t,Mods.ACCESSORY_GRIP_ANGLED)&&(v*=.25),!t.bBoltAction){var y=this.Random(1,2),A=1==a.scale?-1:1,O=a.bAiming?.5:1,R=v+.2*Math.abs(v);a.weapon.recoil+=-R*O*(1==y?A:-A)}if(t.type==Weapon.TYPE_MELEE){var M={eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_FIRE_MELEE,recoil:t.recoil};if(I&&(M.bRepair=1==I?1:0),this.requestEvent(M),a.bBot&&a.type==ObjectType.DINOSAUR){var _=-20*e.mass;e.applyImpulse([Math.cos(e.angle)*_,Math.sin(e.angle)*_],[0,0])}}else this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:a.id,index:a.currentInventoryIndex,type:GameServer.INV_FIRE}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_FIRE_WEAPON,recoil:v});if(t.bSilenced||this.hasMod(t,Mods.BARREL_SILENCER)||this.isMeleeWeapon(t)||"arrow"==t.round)var D=200;else D=1e3;this.emitAISound(e.position,e.position,D,a.team)}emitAISound(e,a,t,i){if(a||(a=e),this.game.scenario)for(var s=this.getCharactersAndDinosaurs(),r=0;r<s.length;r++){let o=s[r],d=o.data;if(d.bBot&&d.bIgnoreOutOfSight&&d.team!=i){var n=o.ai;if(n&&n.bInvestigate){this.DistPositions(o.position,a)<=t&&(o.wakeUp(),this.setAIInvestigatePos(o,this.clone(e)),n.enemy||this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:d.id,type:GameServer.PAWN_INVESTIGATE,value:"sound"}))}}}}createBullet(e){var a=e.x,t=e.y,i=e.rotation,s=e.range,r=e.damage,n=e.instigatorId,o=e.causerId,d=e.weaponData?e.weaponData.id:e.weaponId,l=e.weaponData,h=1==e.bDirectlyCausedByPlayer,m=1==e.bMelee,c=1==e.bIgnoreObstacles,p=s,g=Math.cos(i)*p,E=Math.sin(i)*p,b=this.getObjectById(o),u={eventId:GameServer.EVENT_SPAWN_BULLET,startX:Math.round(a),startY:Math.round(t),endX:Math.round(a+g),endY:Math.round(t+E),rotation:i,team:b?b.data.team:-1,damageAmount:r,controllerId:n,causerId:o,weaponId:d,weaponData:l};m&&(u.bMelee=!0),h&&(u.bDirectlyCausedByPlayer=!0),c&&(u.bIgnoreObstacles=!0),this.hasMod(l,Mods.BARREL_SILENCER)&&(u.bSilenced=!0),this.requestEvent(u)}addInventoryItemAmmo(e,a,t){if(e){var i=e.data,s=i.inventory[a];!s||s.bMelee||s.bEquipment||null==s.ammo||this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:i.id,index:a,type:GameServer.INV_AMMO_ADD,value:t})}}setCharacterCurrentInventoryItem(e,a){this.cancelCharacterReload(e),this.cancelCharacterBoltPull(e);var t=e.data,i=t.currentInventoryIndex;if(i==a&&s&&s.barrel)this.toggleUnderbarrelEquipped(e);else{var s=t.inventory[i];t.currentInventoryIndex=a,t.lockOnTargetId=null;var r=this.getCurrentCharacterInventoryItem(e);if(r)if(r.bBarrel&&r.barrel&&(r=r.barrel),s&&"riot_shield"==s.id&&(t.bShieldCooldown=!0,t.shieldCooldownTimer=Math.ceil(.25*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_START_SHIELD_COOLDOWN})),t.reloadTimerMax=Math.round(Math.ceil(r.reloadTime*this.game.settings.fps)/e.data.reloadMultiplier),t.reloadTimer=e.data.reloadTimerMax,t.aimRotation=this.ToRad(-90),t.speedMultiplier=null!=r.speedModifier?r.speedModifier:1,r.bNeedsBoltPull&&this.pullCharacterBolt(e),null!=t.lockOnTargetId&&(t.lockOnTargetId=null),0==r.mag&&this.reloadCharacterWeapon(e),"riot_shield"==r.id){var n=this.createShield(e);n&&(t.shieldId=n.data.id)}else t.shieldId&&(this.removeObjectById(e.data.shieldId),delete e.data.shieldId);else console.warn("Invalid inventory item at index",a)}}createShield(e){var a=e;if(!a)return null;var t=this.getSharedData("shield"),i=new this.p2.Body({damping:0,angularDamping:0,gravityScale:0,position:a.position});i.data={id:this.getRandomUniqueId(),type:ObjectType.SHIELD,material:Material.METAL,playerId:a.data.id,team:a.data.team,bActive:!0};var s=new this.p2.Box({width:t.width,height:t.height,collisionGroup:CollisionGroups.SHIELD,collisionMask:CollisionGroups.PROJECTILE});return i.addShape(s),this.addWorldBody(i),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,position:i.position,rotation:i.angle,data:i.data}),i}pullCharacterBolt(e){var a=e.data;if(a){a.weapon.bBoltDelay=!0;var t=this.getCurrentCharacterInventoryItem(e);t&&(a.weapon.boltDelayTimer=t.boltDelayTimer*this.game.settings.fps,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_PULL_BOLT,index:a.currentInventoryIndex}))}}cancelCharacterReload(e){var a=e.data;a&&(a.bReloading&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_CANCEL_RELOAD}),a.bReloading=!1)}cancelCharacterBoltPull(e){var a=e.data;a&&(a.weapon.bBoltDelay&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_CANCEL_BOLT_PULL}),a.weapon.bBoltDelay=!1)}getSurfaceNormal(e){if(e)for(var a=this.game.world,t=0;t<a.narrowphase.contactEquations.length;t++){var i=a.narrowphase.contactEquations[t];if(i.bodyA===e||i.bodyB===e)return i.normalA}return null}isCharacter(e){return!!e&&e.data.type==ObjectType.CHARACTER}isHelicopter(e){return!!e&&e.data.type==ObjectType.HELICOPTER}isInHelicopter(e){if(e){var a=e.data;if(a.controllableId){var t=this.getObjectById(a.controllableId);if(t)return t.data.type==ObjectType.HELICOPTER}}return!1}isTank(e){return!!e&&e.data.type==ObjectType.TANK}isCar(e){return!!e&&e.data.type==ObjectType.CAR}isVehicle(e,a){if(e)switch(e.data.type){case ObjectType.MOUNTED_WEAPON:if(!a)return!0;break;case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:return!0}return!1}pawnCanMove(e){var a=e.data,t=this.getPlayerById(a.id);return(!t||!t.controllableId)&&(!a.bEquipmentDelay&&!a.bInteracting&&!a.attachToId&&this.matchInProgress())}characterHasWeaponDelay(e){var a=e.data.weapon;return a.bFireDelay||a.bMeleeDelay||a.bThrowDelay||a.bEquipmentDelay||a.bUseDelay}onSpawnProtectionTimer(e){this.removeSpawnProtection(e)}startSpawnProtectionTimer(e){var a=this.getPlayerById(e);if(a){a.timer_spawnProtection=Math.ceil(1*this.game.settings.fps),a.bSpawnProtection=!0;var t=this.getObjectById(e);t&&this.setDataValue(t,"bSpawnProtection",a.bSpawnProtection),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{bSpawnProtection:a.bSpawnProtection}})}}removeSpawnProtection(e){var a=this.getPlayerById(e);if(a&&null!=a.timer_spawnProtection){delete a.timer_spawnProtection,a.bSpawnProtection=!1;var t=this.getObjectById(e);t&&this.setDataValue(t,"bSpawnProtection",a.bSpawnProtection),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{bSpawnProtection:a.bSpawnProtection}})}}onRespawnTimer(e){if(this.game&&!this.game.bPaused){var a=this.getPlayerById(e);a.id==e&&(a.controllableId||(a.respawnTimer--,a.respawnTimer<0?(a.respawnTimer=-1,a.bCanRespawn=!0,a.bWaitingToRespawn=!1,a.bAutoRespawn&&!a.bSpectator&&this.respawnPlayer(a.id)):a.timer_respawn=this.game.settings.fps,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{bWaitingSpawn:a.bWaitingToRespawn,bCanRespawn:a.bCanRespawn,respawnTimer:a.respawnTimer,bHasPawn:a.bHasPawn}})))}}isInitialized(){return this.bInit}setPaused(e){this.game.bPaused=e;for(var a=[this.game.timer_game,this.game.timer_preGame],t=0;t<a.length;t++){var i=a[t];i&&(e?i.pause():i.resume())}}onPreGameTimer(){if(this.game&&!this.game.bPaused)if(this.game.preGameTimer--,this.game.preGameTimer<0){clearInterval(this.game.timer_preGame),delete this.game.timer_preGame,delete this.game.preGameTimer;for(var e=this.game.players,a=0;a<e.length;a++){var t=e[a];t.bAutoRespawn=!0,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{bAutoRespawn:t.bAutoRespawn}})}this.game.state=MatchState.STATE_IN_PROGRESS,this.requestEvent({eventId:GameServer.EVENT_GAME_START,timer:this.game.gameTimer})}else this.onEvent({eventId:GameServer.EVENT_GAME_PRE_TIMER,timer:this.game.preGameTimer})}onGameTimer(){if(this.game&&!this.game.bPaused&&!this.game.preGameTimer&&!this.game.cinematic)//!this.isGeneratingNodes()
{if(this.game.gameModeId,this.game.gameModeData.timeLimit?this.game.gameTimer--:this.game.gameTimer++,this.game.gameSettings.bRandomAirdrops&&this.game.gameTimer%(null!=this.game.gameSettings.airdropTimer?this.game.gameSettings.airdropTimer:60)==0){var e=null!=this.game.gameSettings.airdropTeam?this.game.gameSettings.airdropTeam:100;if(this.getNumHelicoptersOnTeam(e,[Helicopter.MH6])<10)this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{vehicleId:Helicopter.MH6,team:e,destination:this.getBestSpawnPosition(e),items:[{type:ObjectType.CRATE,crateType:Crate.ITEM,itemId:this.getRandomItemId()}],bAutomated:!0})&&this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:"STR_AIRDROP_INBOUND",hqId:"hq_friendly_package"}})}if(this.game.gameModeData.timeLimit&&this.onEvent({eventId:GameServer.EVENT_GAME_TIMER,timer:this.game.gameTimer}),this.dispatchTrigger({event:"gameTimer",value:this.game.gameTimer}),this.game.gameTimer<0)if(clearInterval(this.game.timer_game),delete this.game.timer_game,null!=this.game.gameModeData.round);else{var a={eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_TIME};switch(this.game.gameModeId){case GameMode.SCENARIO:a.winningTeam=this.game.gameSettings.timeLimitWinningTeam;break;case GameMode.TYRANT:case GameMode.EVOLUTION:a.winningTeam=0,(i=this.game.gameModeData.scores)[0]++;break;case GameMode.FREE_FOR_ALL:var t=this.getPlayers();t.sort((function(e,a){return e.kills<a.kills?1:e.kills>a.kills?-1:0})),t.length>0&&(t.length>1&&t[1].kills==t[0].kills?a.winningTeam=-1:(a.winningTeam=t[0].team,a.playerId=t[0].id));break;default:var i;(i=this.game.gameModeData.scores)&&(i[0]>i[1]?a.winningTeam=0:i[1]>i[0]?a.winningTeam=1:a.winningTeam=-1)}i&&this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{scores:i}}),this.requestEvent(a)}}}isHoldingFlag(e){if(e)switch(this.game.gameModeId){case GameMode.DEFENDER:var a=null;if(a)return a.data.carrierId==e.data.id;break;case GameMode.CAPTURE_THE_FLAG:for(var t=[this.getFlagCTF(0),this.getFlagCTF(1)],i=0;i<t.length;i++)if((a=t[i])&&a.data.carrierId==e.data.id)return!0}return!1}isNearFlag(e){if(e)for(var a=this.getFlags(),t=0;t<a.length;t++){let i=a[t];if(this.DistBodies(e,i)<200)return!0}return!1}isNearFriendlyFlag(e){if(e){for(var a=this.getFlags(),t=0;t<a.length;t++){let i=a[t];if(this.DistBodies(e,i)<200)return i.data.team==e.data.team}var i=this.getBombCrates();for(t=0;t<i.length;t++){var s=i[t];if(this.Dist(s.position[0],s.position[1],e.position[0],e.position[1])<200)return s.data.team==e.data.team}}return!1}isNearEnemyFlag(e){if(e){for(var a=this.getFlags(),t=0;t<a.length;t++){let i=a[t];if(this.DistBodies(e,i)<200)return i.data.team!=e.data.team}var i=this.getBombCrates();for(t=0;t<i.length;t++){var s=i[t];if(this.Dist(s.position[0],s.position[1],e.position[0],e.position[1])<200)return s.data.team!=e.data.team}}return!1}sendBatchData(){this.game?this.batchData.length>0&&(this.onEventFunc({eventId:GameServer.EVENT_BATCH,lobbyId:this.lobbyId,items:this.batchData}),this.batchData=[]):console.log("Invalid game for batch data")}removePlayer(e){for(var a=this.game.players,t=0;t<a.length;t++){var i=a[t];if(i.id==e){var s=i.timer_respawn;return s&&delete i.timer_respawn,(s=i.timer_spawnProtection)&&delete i.timer_spawnProtection,a.splice(t,1),!0}}return console.warn("Player does not exist:",e),!1}stopAllTimers(){var e=this.game;if(e.timer_game){var a=e.timer_game;clearInterval(a),delete e.timer_game}e.timer_preGame&&(a=e.timer_preGame,clearInterval(a),delete e.timer_preGame);for(var t=e.players,i=0;i<t.length;i++){var s=t[i];(a=s.timer_respawn)&&delete s.timer_respawn,(a=s.timer_spawnProtection)&&delete s.timer_spawnProtection}}getSpawnPointForTeam(e){if(this.isPreGame()&&this.isTeamGameMode()||this.game.gameSettings.bUseTeamSpawns){var a=this.getCurrentMapData().teamSpawns;if(a){var t=a[e];if(t)return[this.Random(t.x,t.x+t.w),this.Random(t.y,t.y+t.h)];console.warn("Missing team",e,"for teamSpawn")}else console.warn("Invalid teamSpawns")}return this.getBestSpawnPosition(e)}getBot(e=1){(null==e||isNaN(e))&&(a=1);var a=Math.max(0,e);return{id:this.getRandomUniqueId(),name:this.getRandomBotName()+" ("+["Easy","Normal","Hard","Insane","God"][a]+")",bBot:!0,botSkill:a,level:this.Random(1,100)}}addPlayer(e){var a=this.clone(e);if(!this.getPlayerById(a.id)){switch(a.id||console.warn("Missing player id",e),(null==a.team||a.team<0)&&(a.team=0),a.bCanRespawn=!0,a.desiredSpawn=this.getSpawnPointForTeam(a.team),a.bAutoRespawn=!0,this.game.gameModeData.bAllowRespawns?a.respawnTimer=this.matchInProgress()?this.game.gameModeData.respawnTime+1:-1:a.respawnTimer=-1,a.bCanRespawn=!this.matchInProgress(),a.itemIndex=0,a.kills=0,a.headshots=0,a.assists=0,a.deaths=0,a.melees=0,a.money=Math.min(this.settings.maxPlayerMoney,this.game.gameSettings.money?this.game.gameSettings.money:0),a.items=[],a.killedBy=[],this.game.gameModeId){case GameMode.DOMINATION:case GameMode.CONQUEST:a.captures=0;break;case GameMode.CAPTURE_THE_FLAG:a.captures=0,a.returns=0;break;case GameMode.DESTRUCTION:a.plants=0,a.defuses=0;break;case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_DINO:case GameMode.SURVIVAL_MILITIA:case GameMode.SURVIVAL_ZOMBIE:case GameMode.SURVIVAL_CHICKEN:a.money=0,a.currentFaction=null}this.getGameModeData(this.game.gameModeId);if(a.bBot){a.classes||(a.classes=this.getBotClasses());var t=[Classes.ASSAULT,Classes.COMMANDO,Classes.SUPPORT,Classes.HUNTER];a.currentClass=t[this.Random(0,t.length-1)],a.dinosaurs||(a.dinosaurs={})}switch(a.currentClass||(a.currentClass=Classes.ASSAULT),a.currentDino||(a.currentDino=a.bBot?this.getRandomDinosaur():Dinosaur.COMPY),this.game.gameModeId){case GameMode.TYRANT:a.currentDino=Dinosaur.TREX;break;case GameMode.RAPTOR_HUNT:a.currentDino=this.game.gameSettings.dinoType?this.game.gameSettings.dinoType:Dinosaur.RAPTOR;break;case GameMode.EVOLUTION:a.currentDino=this.game.gameModeData.dino}if(this.setCurrentClass(a,a.currentClass),a.bBot)switch(this.game.gameModeData.botFaction){case"humans":a.currentFaction="human";break;case"dinosaurs":a.currentFaction=ObjectType.DINOSAUR;break;default:switch(this.game.gameModeData.allowFactions){case"humans":a.currentFaction="human";break;case"dinosaurs":a.currentFaction=ObjectType.DINOSAUR;break;case"humans_dinosaurs":this.game.gameModeData.factions=[Faction.DINOGEN,Faction.DINOSAURS],this.isTeamGameMode()?a.currentFaction=1==a.team?ObjectType.DINOSAUR:"human":a.currentFaction=this.RandomBoolean()?ObjectType.DINOSAUR:"human";break;default:a.currentFaction=1==this.Random(1,3)?ObjectType.DINOSAUR:"human"}}else switch(this.game.gameModeData.allowFactions){case"humans":a.currentFaction="human";break;case"dinosaurs":a.currentFaction=ObjectType.DINOSAUR;break;case"humans_dinosaurs":this.isTeamGameMode()?a.currentFaction=1==a.team?ObjectType.DINOSAUR:"human":a.currentFaction=this.RandomBoolean()?ObjectType.DINOSAUR:"human"}this.game.players.push(a),this.requestEvent({eventId:GameServer.EVENT_PLAYER_JOIN,player:a}),this.game.scenario?(this.dispatchTrigger({event:"playerJoined",playerId:a.id,playerIndex:this.game.players.indexOf(a),playerTeam:a.team}),this.game.gameModeData.bAllowRespawns?(a.bWaitingToRespawn=!0,a.respawnTimer=this.game.gameModeData.respawnTime,a.timer_respawn=this.game.settings.fps,a.bAutoRespawn&&!this.matchInProgress()&&this.respawnPlayer(a.id)):this.game.bSurvival&&this.game.gameModeData.bIntermission&&this.respawnPlayer(a.id)):this.game.bSurvival?this.game.gameModeData.bIntermission&&this.respawnPlayer(a.id):a.bAutoRespawn&&!this.matchInProgress()?this.respawnPlayer(a.id):(a.bWaitingToRespawn=!0,a.respawnTimer=this.game.gameModeData.respawnTime,a.timer_respawn=this.game.settings.fps)}}removePlayer(e){for(var a=this.game.players,t=0;t<a.length;t++){var i=a[t];if(i.id==e){var s=i.timer_respawn;return s&&delete i.timer_respawn,(s=i.timer_spawnProtection)&&delete i.timer_spawnProtection,a.splice(t,1),!0}}return!1}isGeneratingNodes(){return this.game&&null!=this.game.nodesToCheck}handleTriggerArea(e){var a=e.data;if(a.attachToId){var t=this.getObjectById(a.attachToId);t&&(e.position[0]=t.position[0],e.position[1]=t.position[1])}if(!this.isGeneratingNodes()&&this.matchInProgress()&&a.onTouchTriggerId)if(a.ticker>0)a.ticker--;else{a.ticker=1;for(var i=Math.max(a.areaWidth,a.areaHeight),s=this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR]),r=0;r<s.length;r++){let t=s[r];if(a.targetId){if(a.targetId!=t.data.id)continue}else if(null!=a.targetTeam&&a.targetTeam!=t.data.team)continue;if(null==a.targetType||a.targetType==t.data.type)if(a.bBotsCanTrigger||!t.data.bBot&&!t.data.bAutomated)if(this.DistBodies(e,t)<i&&e.getAABB().overlaps(t.getAABB())){let i=this.getTriggerById(a.onTouchTriggerId);if(i){let s=!0;if(i.conditions)for(r=0;r<i.conditions.length;r++){let e=i.conditions[r];if(!this.checkTriggerCondition(e,i)){s=!1;break}}s&&(this.executeTriggerById(a.onTouchTriggerId,{objectId:t.data.id,team:t.data.team}),null!=a.uses&&(a.uses--,a.uses<=0&&this.removeNextStep(e)))}break}}}}getTriggerById(e){var a=this.game.scenario;if(a&&a.triggers)for(var t=0;t<a.triggers.length;t++){var i=a.triggers[t];if(i&&i.id==e)return i}return null}checkTriggerAndExecuteById(e,a){var t=this.getTriggerById(e);if(t){let s=!0;if(t.conditions)for(var i=0;i<t.conditions.length;i++){let e=t.conditions[i];if(!this.checkTriggerCondition(e,a||t)){s=!1;break}}s&&this.executeTriggerById(e,a)}}executeTriggerById(e,a=null){try{var t=this.game?this.game.scenario:null;if(t&&t.triggers)for(var i=0;i<t.triggers.length;i++){var s=t.triggers[i];if(s&&s.id==e){this.executeTriggerActions(s.actions,s,a);break}}}catch(e){this.onGameError(e)}}dispatchTrigger(e){try{this.game&&this.game.scenario&&this.handleTrigger(e)}catch(e){this.onGameError(e)}}handleTrigger(e){if(!e.bDisabled){var a=this.game.scenario;if(a){var t=[],i=a.triggers;if(i)for(var s=0;s<i.length;s++){let a=i[s];if(a.event==e.event){a=this.clone(a),this.checkSpecialStringsInObject(a);let i=!0;switch(a.event){case"gameTimer":if(null!=a.value)i=e.value==a.value;else if(null!=a.threshold){this.checkSpecialString(a.threshold);i=e.value%parseFloat(a.threshold)==0}break;case"questObjectiveCompleted":i=e.questId==a.questId&&e.objectiveId==a.objectiveId;break;case"variableChanged":i=e.name===a.name,null!=a.value&&(i=i&&this.game.gameModeData.vars[a.name]===a.value),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{var:{name:a.name,value:this.game.gameModeData.vars[a.name]}}});break;case"objectRemoved":a.objectIds?i=a.objectIds.indexOf(e.objectId)>=0:a.objectId&&(i=e.objectId==a.objectId);break;case"objectCreated":a.objectId&&(i=e.objectId==a.objectId),null!=a.team&&(i=i&&e.team==a.team),null!=a.type&&(i=i&&e.type==a.type);break;case"objectKilled":a.objectIds?i=a.objectIds.indexOf(e.objectId)>=0:a.objectId&&(i=e.objectId==a.objectId),null!=a.team&&(i=i&&e.team==a.team),null!=a.type&&(i=i&&e.type==a.type);break;case"objectUsed":null!=a.objectId&&(i=i&&e.objectId==a.objectId),null!=a.userId&&(i=i&&e.userId==a.userId);break;case"doorOpened":case"doorClosed":null!=a.objectId&&(i=i&&e.objectId==a.objectId),null!=a.causerId&&(i=i&&e.causerId==a.causerId);break;case"pawnInvestigate":null!=a.pawnId&&(i=i&&e.pawnId==a.pawnId),null!=a.investigateType&&(i=i&&e.investigateType==a.investigateType);break;case"cinematicStarted":case"cinematicEnded":null!=a.cinematicId&&(i=i&&e.cinematicId==a.cinematicId);break;case"playerJoined":case"playerRespawned":a.playerId&&(i=i&&a.playerId==e.playerId),null!=a.playerIndex&&(console.log(a.playerIndex==e.playerIndex),i=i&&a.playerIndex==e.playerIndex),null!=a.playerTeam&&(i=i&&a.playerTeam==e.playerTeam);break;case"playerInput":a.playerId&&(i=i&&a.playerId==e.playerId),null!=a.keyId&&(i=i&&a.keyId==e.keyId),null!=a.bValue&&(i=i&&a.bValue==e.bValue)}if(i&&a.conditions)for(var r=0;r<a.conditions.length;r++){let t=a.conditions[r];if(!this.checkTriggerCondition(t,e)){i=!1;break}}if(i)if(a.delay>0)for(r=0;r<a.actions.length;r++){let t=a.actions[r];this.addToActionQueue(t,t.delay,e)}else t.push(a)}}if(t)for(s=0;s<t.length;s++){let a=t[s];this.executeTriggerActions(a.actions,a,e)}}}}checkTriggerCondition(e,a){if(e){switch(e=this.clone(e),this.checkSpecialStringsInObject(e),this.checkParamsInObject(e,a),e.condition){case"numDinosaurs":if(null!=e.team)var t=this.getNumDinosaursOnTeam(e.team);else t=this.getDinosaurs().length;break;case"numCharactersOnTeam":case"numCharacters":if(null!=e.team)t=this.getNumCharactersOnTeam(e.team);else t=this.getCharacters().length;break;case"numPawnsOnTeam":case"numPawns":t=null!=e.team?this.getNumPawnsOnTeam(e.team):this.getPawns().length;break;case"numPlayersAlive":for(var i=0,s=0;s<this.game.players.length;s++){let a=this.game.players[s];this.getObjectById(a.id)&&(null!=e.team&&a.team!=e.team||i++)}t=i;break;case"numHelicoptersOnTeam":case"numHelicopters":t=this.getNumHelicoptersOnTeam(e.team,e.heliTypes);break;case"variableValue":t=this.getScenarioVarValue(e.variableName);break;case"objectExists":t=null!=this.getObjectById(e.objectId);break;case"gameInProgress":t=this.matchInProgress();break;case"gameHasEnded":t=this.matchHasEnded();break;case"isMultiplayer":t=this.game.bMultiplayer;break;case"questIsComplete":var r=this.getQuestById(e.questId);t=!!r&&1==r.bComplete;break;case"questObjectiveIsComplete":var n=this.getQuestObjectiveById(e.questId,e.objectiveId);t=!!n&&1==n.bComplete;break;case"playerStateValue":var o=this.getPlayerById(e.playerId);o?t=o[e.key]:this.scenarioLog("[playerStateValue] Player doesn't exist with id "+e.playerId,Colours.RED_STRING);break;case"objectDataValue":var d=this.getObjectById(e.objectId);d&&d.data?t=d.data[e.key]:this.scenarioLog("[objectDataValue] Object doesn't exist with id "+e.objectId,Colours.RED_STRING);break;case"gameDataValue":t=this.game.gameModeData[e.key];break;default:this.log("Unhandled condition: "+e.condition)}if(void 0!==t)switch(e.operator){case"==":return t==e.value;case"!=":return t!=e.value;case"<":return t<e.value;case">":return t>e.value;case"<=":return t<=e.value;case">=":return t>=e.value;case"%":return t%e.value==0}}return!1}executeTriggerActions(e,a,t=null){if(a){if(null!=a.repeats&&(a.repeats--,a.repeats<=0)){let e=this.game.scenario.triggers.indexOf(a);e>=0&&(this.game.scenario.triggers.splice(e,1),console.log("Remove trigger",a.id))}this.scenarioLog("Trigger executed: "+a.id,Colours.GREEN_STRING)}var i=e;if(i)for(var s=0;s<i.length;s++){var r=i[s];r&&this.executeTriggerAction(r,t)}}addToActionQueue(e,a=1,t=null){var i={action:this.clone(e),delayMax:a,delayTimer:Math.max(1,Math.round(a*this.game.settings.fps)),params:t};this.game.actionQueue.push(i)}checkSpecialStringsInObject(e){for(var a in e)"object"==typeof e[a]&&null!==e[a]?this.checkSpecialStringsInObject(e[a]):e[a]=this.checkSpecialString(e[a])}checkParamsInObject(e,a){for(var t in e)"object"==typeof e[t]&&null!==e[t]?this.checkParamsInObject(e[t],a):e[t]=this.checkParamString(e[t],a)}checkParamString(e,a){let t=Object.keys(a);for(var i=0;i<t.length;i++){let s=t[i],r="{"+s+"}",n=a[s];if(e==r)return n;if("string"==typeof e){if(e.indexOf(r)>=0)return e.replace(r,n)}}return e}executeTriggerAction(e,a){if(e.delay>0)this.addToActionQueue(e,e.delay,a);else{if(e=this.clone(e),a){var t=Object.keys(e),i={};this.checkParamsInObject(e,a)}let _;switch(this.checkSpecialStringsInObject(e),e.action){case"disableTrigger":_=this.getTriggerById(e.triggerId),_&&(_.bDisabled=!0);break;case"enableTrigger":_=this.getTriggerById(e.triggerId),_&&delete _.bDisabled;break;case"log":this.scenarioLog((e.bWarning?"[WARNING] ":"")+e.message,e.bWarning?Colours.ORANGE_STRING:null);break;case"chat":this.triggerCallback("chat",{messageText:String(e.message),playerText:e.playerText,playerId:e.playerId,fill:e.fill,date:Date.now()});break;case"message":this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{playerId:e.playerId,message:this.checkSpecialString(e.message),timerMax:e.timerMax,hqId:e.hqId,bInfofeed:e.bInfofeed}});break;case"setGodMode":if(e.objectId)(c=this.getObjectById(e.objectId))&&this.setDataValue(c,"bGodMode",1==e.value);else for(var s=this.getCharactersOnTeam(0),r=0;r<s.length;r++){(g=s[r])&&this.setDataValue(g,"bGodMode",1==e.value)}break;case"setUnlimitedAmmo":if(e.objectId)(c=this.getObjectById(e.objectId))&&this.setDataValue(c,"bUnlimitedAmmo",1==e.value);else for(s=this.getCharactersOnTeam(0),r=0;r<s.length;r++){(g=s[r])&&(g.data.weapon.bUnlimitedAmmo=1==e.value)}break;case"setDataValue":(c=this.getObjectById(e.objectId))&&this.setDataValue(c,e.key,e.value);break;case"setDamageMultipliers":(c=this.getObjectById(e.objectId))?this.setDataValue(c,"damageMultipliers",e.damageMultipliers):this.scenarioLog("[setDamageMultipliers] Object doesn't exist: "+e.objectId,Colours.RED_STRING);break;case"exitAllPawnsFromVehicle":(n=this.getObjectById(e.objectId))?this.exitAllPawnsFromVehicle(n):this.scenarioLog("[exitAllPawnsFromVehicle] Object doesn't exist: "+e.objectId,Colours.RED_STRING);break;case"killAllPawnsInVehicle":var n;(n=this.getObjectById(e.objectId))?this.killAllPawnsInVehicle(n):this.scenarioLog("[exitAllPawnsFromVehicle] Object doesn't exist: "+e.objectId,Colours.RED_STRING);break;case"setGameValue":if(e.key){var o={};o[e.key]=e.value,this.game.gameModeData[e.key]=e.value,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:o})}break;case"setPlayerStateValue":if(e.key)if(d=this.getPlayerById(e.playerId)){d[e.key]=e.value;let a={};a[e.key]=d[e.key],this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:d.id,data:a})}break;case"setMass":(c=this.getObjectById(e.objectId))&&null!=e.mass&&(c.mass=e.mass,c.updateMassProperties());break;case"setDisabled":(c=this.getObjectById(e.objectId))&&this.setDataValue(c,"bDisabled",1==e.value);break;case"addPlayerMoney":if(e.playerId)var d=this.getPlayerById(e.playerId);else d=this.game.players[e.playerIndex];d&&this.addPlayerMoney(d.id,e.value);break;case"setVehicleWeapon":var l=this.getObjectById(e.objectId);if(l)if(console.log(e),e.inventoryItem){var h=this.getWeaponData(e.inventoryItem.id,e.inventoryItem);h&&!h.bEquipment?this.setVehicleWeapon(l,e.seatIndex,e.weaponIndex,h):this.log("Invalid vehicle weapon")}else this.log("Invalid vehicle inventory item");break;case"setAI":var m=this.getObjectById(e.objectId);m&&(null!=e.bInteract&&this.setAIInteract(m,e.bInteract),null!=e.bInvestigate&&this.setAIInvestigate(m,e.bInvestigate),e.investigatePosition&&this.setAIInvestigatePos(m,e.investigatePosition),void 0!==e.desiredItemId&&this.setAIObjectiveItemId(m,e.desiredItemId),void 0!==e.bCamp&&this.setAICamp(m,e.bCamp),void 0!==e.followTargetId&&this.setAIFollowTargetId(m,e.followTargetId),void 0!==e.wanderArea&&this.setAIWanderArea(m,e.wanderArea));break;case"emitAISound":console.log(e),this.emitAISound(e.targetPosition,e.sourcePosition,e.radius,e.team);break;case"setPlayerTeam":if(e.playerId)d=this.getPlayerById(e.playerId);else d=this.game.players[e.playerIndex];var c;d&&(d.team=e.value,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:d.id,data:{team:d.team}})),(c=this.getObjectById(e.playerId))&&this.setDataValue(c,"team",e.value);break;case"setVariable":this.game.gameModeData.vars[e.name]=e.value,this.dispatchTrigger({event:"variableChanged",name:e.name,value:this.game.gameModeData.vars[e.name]}),this.onScenarioVarChanged(e.name,this.game.gameModeData.vars[e.name]);break;case"addVariable":case"addToVariable":null==this.game.gameModeData.vars[e.name]&&(this.game.gameModeData.vars[e.name]=0),this.game.gameModeData.vars[e.name]=this.RoundDecimal(this.game.gameModeData.vars[e.name]+e.value),this.dispatchTrigger({event:"variableChanged",name:e.name,value:this.game.gameModeData.vars[e.name]}),this.onScenarioVarChanged(e.name,this.game.gameModeData.vars[e.name]);break;case"executeFunction":this.executeScenarioFunction(e.id);break;case"executeTrigger":this.executeTriggerById(e.triggerId);break;case"endGame":this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:e.endCondition?e.endCondition:MatchState.END_CONDITION_SCORE,conditionText:e.conditionText,winningTeam:e.winningTeam,playerId:e.playerId,cameraTargetId:e.cameraTargetId});break;case"applyDamage":this.getObjectById(e.objectId)?this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:e.damageType?e.damageType:DamageType.DAMAGE_WORLD,damageAmount:e.damage,pawnId:e.objectId,attackerId:e.attackerId,causerId:e.causerId,weaponId:e.weaponId}):this.scenarioLog("[applyDamage] No object with id "+e.objectId,Colours.RED_STRING);break;case"setCharacterAvatar":if((g=this.getObjectById(e.objectId))&&g.data.type==ObjectType.CHARACTER)if(e.avatarId){var p=this.getAvatarDataById(e.avatarId);p&&this.setDataValue(g,"avatar",p)}else e.avatar&&this.setDataValue(g,"avatar",e.avatar);else this.scenarioLog("[setCharacterAvatar] No character with id "+e.objectId,Colours.RED_STRING);break;case"setCharacterInventoryIndex":(g=this.getObjectById(e.objectId))&&g.data.type==ObjectType.CHARACTER?this.changeCharacterInventoryIndex(g,e.index):this.scenarioLog("[setCharacterInventoryIndex] No character with id "+e.objectId,Colours.RED_STRING);break;case"setCharacterInventory":if(e.inventory)if((g=this.getObjectById(e.objectId))&&g.data.type==ObjectType.CHARACTER){let a=[];for(r=0;r<e.inventory.length;r++){let t=e.inventory[r],i=this.getWeaponData(t.id,t);this.applyWeaponMods(i,t.mods),a.push(i)}this.setCharacterInventory(g,a)}break;case"setCharacterInventoryItem":var g;if((g=this.getObjectById(e.objectId))&&g.data.type==ObjectType.CHARACTER&&e.inventoryItem){var E=this.getWeaponData(e.inventoryItem.id,e.inventoryItem);this.applyWeaponMods(E,e.inventoryItem.mods),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:g.data.id,index:e.index,item:E,type:GameServer.INV_ITEM_REPLACE})}break;case"createObject":this.createObject(e);break;case"createProjectile":this.createProjectile(e.position,null!=e.angle?e.angle:this.ToRad(e.rotation),e.team,{playerId:e.playerId,causerId:e.id,velocity:e.velocity,weaponId:e.weaponId,frameId:e.frameId,sourceId:e.sourceId});break;case"createExplosion":e.eventId=GameServer.EVENT_SPAWN_EXPLOSION,this.createExplosion(e);break;case"removeObject":this.removeObjectById(e.objectId);break;case"setDestination":(b=this.getObjectById(e.objectId))?this.isVehicle(b)?(b.data.destination=e.position,b.data.bDestinationReached=!1):this.setAIDestination(b,e.position,e.onDestinationTriggerId):this.scenarioLog("[setDestination] No object with id "+e.objectId,Colours.RED_STRING);break;case"setPosition":(b=this.getObjectById(e.objectId))?(b.position=e.position,this.setObjectPosition(b,e.position)):this.scenarioLog("[setPosition] No object with id "+e.objectId,Colours.RED_STRING);break;case"setRotation":(b=this.getObjectById(e.objectId))?b.angle="number"==typeof e.rotation?this.ToRad(e.rotation):0:this.scenarioLog("[setRotation] No object with id "+e.objectId,Colours.RED_STRING);break;case"setAngle":(b=this.getObjectById(e.objectId))?b.angle="number"==typeof e.angle?e.angle:0:this.scenarioLog("[setAngle] No object with id "+e.objectId,Colours.RED_STRING);break;case"rotate":(b=this.getObjectById(e.objectId))?"number"==typeof e.degrees?(b.angle+=this.ToRad(e.degrees),b.data.bSkipServerUpdate=!1,b.world||this.addWorldBody(b,!0)):this.scenarioLog("[rotate] Invalid degrees "+e.degrees,Colours.RED_STRING):this.scenarioLog("[rotate] No object with id "+e.objectId,Colours.RED_STRING);break;case"move":(b=this.getObjectById(e.objectId))?("number"==typeof e.x&&(b.position[0]+=e.x),"number"==typeof e.y&&(b.position[0]+=e.y),b.data.bSkipServerUpdate=!1):this.scenarioLog("[move] No object with id "+e.objectId,Colours.RED_STRING);break;case"applyImpulse":(b=this.getObjectById(e.objectId))?(b.applyImpulse([e.x,e.y],[0,0]),null!=e.angularVelocity&&(b.angularVelocity+=e.angularVelocity)):this.scenarioLog("[applyImpulse] No object with id "+e.objectId,Colours.RED_STRING);break;case"applyForce":(b=this.getObjectById(e.objectId))?(b.applyForce([e.x,e.y],[0,0]),null!=e.angularVelocity&&(b.angularVelocity+=e.angularVelocity)):this.scenarioLog("[applyForce] No object with id "+e.objectId,Colours.RED_STRING);break;case"setIndicatorData":var b;(b=this.getObjectById(e.id))?this.setDataValue(b,"indicatorData",e.indicatorData):this.scenarioLog("[setIndicatorData] No object with id "+e.id,Colours.RED_STRING);break;case"setDoorLocked":if(I=this.getObjectById(e.doorId)){var u=I.data.bDisabled;I.data.bDisabled=1==e.value,(u!=I.data.bDisabled||I.data.bDisabled)&&this.addDirtyNodeObject(I)}break;case"setDoorClosed":var I;(I=this.getObjectById(e.doorId))&&this.setDoorClosed(I,1==e.value);break;case"respawn":var T=e.data?e.data:e;if(e.playerId)this.respawnPlayer(e.playerId,T);else if(null!=e.playerIndex){(d=this.game.players[e.playerIndex])?this.respawnPlayer(d.id,T):this.scenarioLog("No player at index "+e.playerIndex)}else this.respawnAllPlayers(T);break;case"setCurrentClass":if(e.playerId){d=this.getPlayerById(e.playerId);this.setCurrentClass(d,e.classId,e)}else{var v=this.getPlayers();for(r=0;r<v.length;r++){d=v[r];this.setCurrentClass(d,e.classId,e)}}break;case"setCurrentDinosaur":if(e.playerId){d=this.getPlayerById(e.playerId);this.setCurrentDinosaur(d,e.dinoId)}else for(v=this.getPlayers(),r=0;r<v.length;r++){d=v[r];this.setCurrentDinosaur(d,e.dinoId)}break;case"addQuest":var y=this.clone(e.quest);y.objectives||(y.objectives=[]),this.game.gameModeData.quests.push(y),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{newQuest:y}});break;case"addQuestObjective":if(y=this.getQuestById(e.questId))(A=this.getQuestObjectiveById(e.questId,e.objective.id))?console.warn("Objective already exists",e.questId,e.objective.id):(A=this.clone(e.objective),y.objectives||(y.objectives=[]),y.objectives.push(A)),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{questId:e.questId,objective:A}});else console.warn("Quest doesn't exist",e.questId);break;case"updateQuestObjective":var A;if((y=this.getQuestById(e.questId))&&e.objective)if(A=this.getQuestObjectiveById(e.questId,e.objective.id)){for(t=Object.keys(e.objective),r=0;r<t.length;r++){var O=t[r];switch(A[O]=e.objective[O],O){case"bComplete":1==e.objective[O]&&this.dispatchTrigger({event:"questObjectiveCompleted",questId:e.questId,objectiveId:e.objective.id})}}this.getNumQuestObjectivesComplete(e.questId)>=this.getNumQuestObjectives(e.questId)&&this.dispatchTrigger({event:"questCompleted",questId:e.questId}),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{questId:e.questId,objective:e.objective}})}else console.warn("Objective doesn't exist",e.questId,e.objective.id);else console.warn("Quest doesn't exist",e.questId);break;case"showTip":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:e});break;case"hideTip":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bHideTip:!0}});break;case"executeInteractable":if(e.objectId){var R=this.getObjectById(e.interactableId);R&&this.executeInteractable(R,e.objectId)}break;case"setCameraTarget":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{cameraTargetId:e.objectId,playerId:e.playerId}});break;case"setCameraToPlayer":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{setCameraToPlayer:1}});break;case"setCinematicMode":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bCinematicMode:1==e.value}});break;case"startCinematic":this.startCinematic(e.cinematic);break;case"fadeCameraIn":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{fadeCameraIn:1}});break;case"fadeCameraOut":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{fadeCameraOut:1}});break;case"setMusic":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{music:e.music,bFadeIn:e.bFadeIn}});break;case"setWorldType":this.game.gameSettings.worldType=e.worldType,this.game.gameSettings.worldTypeAlpha=e.alpha,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{worldType:e.worldType,alpha:e.alpha}});break;case"pulseHUD":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{pulseHUD:e.elementId}});break;case"setMatchTimer":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{matchTimer:e.value}});break;case"playWorldSound":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{worldSoundId:e.soundId,position:e.position,volumeMultiplier:e.volumeMultiplier,randomMax:e.randomMax}});break;case"playUISound":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{uiSoundId:e.soundId,volumeMultiplier:e.volumeMultiplier}});break;case"shakeCamera":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{shake:e.value}});break;case"setHUDElement":var M=this.game.gameModeData.hudElements[e.id];M?(M.label=e.label?e.label:M.label,M.value=e.value?e.value:M.value,M.variableName=e.variableName?e.variableName:M.variableName):(this.game.gameModeData.hudElements[e.id]=this.clone(e),M=this.game.gameModeData.hudElements[e.id]),M.variableName&&(M.value=this.game.gameModeData.vars[M.variableName]),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{hudElement:M}});break;case"removeHUDElement":delete this.game.gameModeData.hudElements[e.id],this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{removeHUDElementId:e.id}});break;case"setCameraScale":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{cameraScale:e.value}});break;case"addObjectiveArrow":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{objectiveArrowId:e.objectId}});break;case"removeObjectiveArrow":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{removeObjectiveArrowId:e.objectId}});break;case"setHUDPawn":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{hudPawnId:e.objectId,playerId:e.playerId}});break;case"removeHUDPawn":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{removeHUDPawnId:e.objectId}});break;case"openRespawnMenu":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{openRespawnMenu:1}});break;case"closeRespawnMenu":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{closeRespawnMenu:1}})}if(this.scenarioLog("Action: "+e.action,Colours.XP_STRING),i){let a=Object.keys(i);for(r=0;r<a.length;r++){let t=a[r];e[t]=i[t]}}}}getScenarioVarValue(e){return this.game.scenario&&this.game.gameModeData.vars?this.game.gameModeData.vars[e]:null}onScenarioVarChanged(e,a){if(this.game.scenario&&(this.scenarioLog(e+" = "+a),this.game.gameModeData.hudElements))for(var t=Object.keys(this.game.gameModeData.hudElements),i=0;i<t.length;i++){var s=t[i],r=this.game.gameModeData.hudElements[s];r&&r.variableName==e&&(r.value=a,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{hudElement:r}}))}}getQuestById(e){if(this.game.scenario){var a=this.game.gameModeData.quests;if(a)for(var t=0;t<a.length;t++)if(a[t].id==e)return a[t]}return null}getQuestObjectiveById(e,a){var t=this.getQuestById(e);if(t&&t.objectives)for(var i=0;i<t.objectives.length;i++)if(t.objectives[i].id==a)return t.objectives[i];return null}getNumQuestObjectives(e){var a=this.getQuestById(e);return a&&a.objectives?a.objectives.length:0}getNumQuestObjectivesComplete(e){var a=this.getQuestById(e);return a&&a.objectives?a.objectives.length:0}executeScenarioFunction(e){var a=this.game.scenario;if(a&&a.functions)for(var t=0;t<a.functions.length;t++){var i=a.functions[t];if(i&&i.id==e){this.scenarioLog("Function executed: "+i.id,Colours.GREEN_STRING),this.executeTriggerActions(i.actions);break}}}setCurrentDinosaur(e,a){if(this.game.scenario||!this.game.bSurvival&&"humans"!=this.game.gameSettings.allowFactions){var t=e;if(t){t.currentFaction=ObjectType.DINOSAUR,t.currentDino=a,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{currentFaction:t.currentFaction,currentDino:t.currentDino}});var i=this.getObjectById(t.id);if(i&&i.data.dinoType!=a&&(!this.matchInProgress()||this.game.bScenario)){var s=i.position;this.removeObject(i),this.respawnPlayer(t.id,{position:s}),t.respawnData&&delete t.respawnData.position}}}}setCurrentClass(e,a,t){var i=e;if(i){t||(t={}),i.currentFaction="human",a&&(i.currentClass=a),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:i.id,data:{currentFaction:i.currentFaction,currentClass:i.currentClass}});var s=i.classes[i.currentClass];i.avatar=s.avatar[i.classes.preferredFaction?i.classes.preferredFaction:Faction.DINOGEN],this.game.gameModeData.factions&&this.isTeamGameMode()&&this.game.gameModeData.factions[i.team]&&(i.avatar=s.avatar[this.game.gameModeData.factions[i.team]]),i.avatar||i.bBot||"human"!=i.currentFaction||console.log("Missing avatar");var r=!this.game.bSurvival;if(this.game.scenario&&(r=r||1==this.game.gameSettings.bAllowClassSelection),r){var n=this.getObjectById(i.id);if(n)if(n.data.type==ObjectType.CHARACTER){var o=this.getWeaponData(s.primary.id);this.applyWeaponMods(o,s.primary.mods);var d=this.getWeaponData(s.secondary.id);this.applyWeaponMods(d,s.secondary.mods);var l=[o,d,this.getWeaponData(s.melee),this.getWeaponData(s.equipment),this.getWeaponData(s.grenade)];this.setCharacterInventory(n,l),this.setDataValue(n,"avatar",i.avatar)}else{var h=n.position;this.removeObject(n),this.respawnPlayer(i.id,{position:h,inventory:t.inventory,melee:t.melee,grenade:t.grenade,equipment:t.equipment})}}}}changeCharacterInventoryIndex(e,a){e&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:e.data.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:a})}setCharacterInventory(e,a){if(e&&a){for(var t=e.data,i=0;i<5;i++)a[i]||(a[i]=null);a[Character.INDEX_MELEE]&&(t.melee=a[Character.INDEX_MELEE]),a[Character.INDEX_EQUIPMENT]&&(t.equipment=a[Character.INDEX_EQUIPMENT]),a[Character.INDEX_GRENADE]&&(t.grenade=a[Character.INDEX_GRENADE]);for(i=Character.INDEX_MELEE;i<=Character.INDEX_GRENADE;i++)a[i]||(a[i]=t.inventory[i]);this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.id,type:GameServer.INV_INVENTORY_REPLACE,inventory:a}),this.pushObjectDataUpdate(t.id,["melee","equipment","grenade"])}}onEvent(e){if(this.batchData)switch(this.lobbyId&&(e.lobbyId=this.lobbyId),this.batchData.push(e),e.eventId){case GameServer.EVENT_GAME_INIT:this.generateMapNodes(),this.dispatchTrigger({event:"gameInit"});break;case GameServer.EVENT_GAME_START:this.dispatchTrigger({event:"gameStart"});break;case GameServer.EVENT_SPAWN_OBJECT:var a=e.data,t=this.getPlayerById(a.id);this.dispatchTrigger({event:"objectCreated",objectId:a.id,type:a.type,team:a.team,playerId:t?t.id:null,playerIndex:t?this.game.players.indexOf(t):null})}}requestEvent(e){if(e){switch(e.eventId){case GameServer.EVENT_PLAYER_UPDATE:if(e.data)if(r=this.getPlayerById(e.playerId)){if(null!=e.data.itemIndex&&(r.itemIndex=Math.max(0,Math.min(r.items.length-1,e.data.itemIndex))),e.data.bChangeTeam&&this.isTeamGameMode()&&this.changeTeam(r.id),e.data.preferredFaction&&(r.classes.preferredFaction=e.data.preferredFaction),e.data.currentClass&&this.setCurrentClass(r,e.data.currentClass),e.data.currentDino&&this.setCurrentDinosaur(r,e.data.currentDino),e.data.vehicles)if(r.vehicles)for(var a=Object.keys(e.data.vehicles),t=0;t<a.length;t++){var i=a[t];r.vehicles[i]=e.data.vehicles[i]}else r.vehicles=e.data.vehicles;null!=e.data.desiredSpawn&&(r.desiredSpawn=e.data.desiredSpawn),null!=e.data.bAutoRespawn&&(r.bAutoRespawn=e.data.bAutoRespawn,r.bAutoRespawn&&r.bCanRespawn&&this.respawnPlayer(r.id))}break;case GameServer.EVENT_PLAYER_JOIN:break;case GameServer.EVENT_PLAYER_LEAVE:if(!this.game)break;(be=this.getObjectById(e.playerId))&&(this.exitVehicle(be),this.removeNextStep(be),this.game.bSurvival&&this.dropAllCharacterWeapons(be));var s=this.getMountedWeapons(e.playerId);for(t=0;t<s.length;t++)this.exitAllPawnsFromVehicle(s[t]),this.removeNextStep(s[t]);s=this.getVehicles(e.playerId);for(t=0;t<s.length;t++)this.removeNextStep(s[t]);this.removeEquipmentByPlayerId(e.playerId),this.removeNextStep(this.getReviverByPlayerId(e.playerId));var r=this.getPlayerById(e.playerId);if(this.dispatchTrigger({event:"playerLeft",playerId:e.playerId}),this.removePlayer(e.playerId),this.game.bScenario)this.getNumPawnsOnTeam(0,!0)<=0&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_KIA,result:MatchState.END_RESULT_LOSS});else if(this.game.bSurvival)this.getNumPawnsOnTeam(0,!0)<=0&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_KIA,result:MatchState.END_RESULT_LOSS,winningTeam:1});else switch(this.game.gameModeId){case GameMode.TYRANT:case GameMode.EVOLUTION:this.getNumPawnsOnTeam(1)<=0&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_KIA,result:MatchState.END_RESULT_WIN,winningTeam:0})}break;case GameServer.EVENT_SPAWN_EXPLOSION:e.damage&&this.checkExplosion(e);break;case GameServer.EVENT_PLAYER_INTERACT:if(this.matchInProgress())if((ie=this.getObjectById(e.playerId))&&ie.data.bCanInteract)(Z=this.getObjectById(e.itemId))?ie.data.bInteracting?this.stopCharacterInteract(ie):this.startInteraction(ie,Z):ie.data.bInteracting?this.stopCharacterInteract(ie):this.attemptInteract(e.playerId);break;case GameServer.PAWN_LOCK_ACQUIRED:if(e.bRocket)if((be=this.getObjectById(e.pawnId))&&be.data.bBot)(T=this.getObjectById(be.data.controllableId))&&this.triggerCountermeasure(be);break;case GameServer.EVENT_PAWN_ACTION:switch(e.type){case GameServer.PAWN_REQUEST:(be=this.getObjectById(e.pawnId))&&this.setPawnRequest(be,e.value==be.data.currentRequest?0:e.value);break;case GameServer.PAWN_INVESTIGATE:this.dispatchTrigger({event:"pawnInvestigate",pawnId:e.pawnId,investigateType:e.value})}if(void 0!==e.lockOnTargetId)(be=this.getObjectById(e.pawnId))&&(!be.data.lockOnTargetId&&e.lockOnTargetId&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.lockOnTargetId,type:GameServer.PAWN_LOCK_ACQUIRED}),be.data.lockOnTargetId=e.lockOnTargetId),e.bServer=!0;break;case GameServer.EVENT_PAWN_DAMAGE:if(!this.matchInProgress())break;var n=e.damageAmount;if(isNaN(n)||0==n){n=0;break}var o=this.getObjectById(e.pawnId);if(!o||!o.data)break;var d=this.getObjectById(e.causerId),l=this.getPlayerById(e.attackerId),h=this.getObjectById(e.attackerId),m=!0;if(d)switch(o.data.type){case ObjectType.WINDOW:m=!1;break;case ObjectType.OBSTACLE:if(m=null!=o.data.health,h){var c=this.Angle(d.position[0],d.position[1],o.position[0],o.position[1]),p=n;o.applyImpulse([Math.cos(c)*p,Math.sin(c)*p])}}if(o.data.bGodMode||o.data.bSpawnProtection)break;if(o.data.type==ObjectType.CHARACTER&&l&&l.id!=o.data.id&&l.team==o.data.team&&(n*=.25,console.warn("Friendly fire",o.data.type)),this.game.bSurvival){var g=this.getSeatData(o);g&&null!=g.damageMultiplier&&(n*=g.damageMultiplier)}if(e.weaponId==Dinosaur.DILO?this.characterHasEquipment(o,"dino_vest")&&(n*=.5):e.damageType==DamageType.DAMAGE_EXPLOSIVE&&this.characterHasEquipment(o,"blast_vest")&&(n*=.5),e.bHitmarker=1==m?1:0,o.data.health>0){var E=o.data.damageMultipliers;switch(E&&null!=E[e.damageType]&&(n*=E[e.damageType]),n=Math.ceil(n),o.data.health=Math.max(0,Math.round(o.data.health-n)),o.data.maxHealth&&(o.data.health=Math.min(o.data.health,o.data.maxHealth)),this.pushObjectDataUpdate(o.data.id,["health"]),o.data.bRegenHealth&&(o.data.regenTimer=o.data.regenTimerMax),o.data.type){case ObjectType.CHARACTER:if(o.data.bBot){let e=this.ToRad(n);o.data.desiredAimRotation=o.data.aimRotation+=e}break;case ObjectType.OBSTACLE:"barrel_explosive"!=o.data.obstacleId&&"barrel_poison"!=o.data.obstacleId&&"barrel_oil"!=o.data.obstacleId||(o.data.playerId=e.attackerId,o.data.detonationTimer=3*this.game.settings.fps,this.setDataValue(o,"bTriggered",!0))}if(o.data.bJuggernaut&&(e.bJuggernaut=1),o.data.dinoType==Dinosaur.TREX&&(e.bRex=1),o.data.health<=0){e.bKill=!0,o.data.type;var b=l==I;l&&o.data.id==l.id&&this.addEvolutionKill(null);var u=!!(u||!b&&l)&&l.team==o.data.team;if((o.data.type==ObjectType.CHARACTER||o.data.type==ObjectType.DINOSAUR)&&(this.game.bRanked||this.game.gameSettings.bUseKillfeed)){var I=this.getPlayerById(e.pawnId);l||(l=I),l&&I&&(b=l==I,this.onEvent({eventId:GameServer.EVENT_KILLFEED_ADD,type:FeedItem.TYPE_KILL,killerId:l.id,killerName:l.name,killerTeam:l.team,victimId:I.id,victimName:I.name,victimTeam:I.team,weaponId:e.useId?e.useId:e.weaponId,bHeadshot:e.bHeadshot,bDirectImpact:e.bDirectImpact,bSuicide:b}))}var T,v={type:o.data.type,damageType:e.damageType,weaponId:e.weaponId};switch(o.data.reward&&(v.reward=o.data.reward),o.data.type){case ObjectType.EQUIPMENT:v.equipmentId=o.data.weaponData.id;break;case ObjectType.DINOSAUR:v.dinoType=o.data.dinoType}if(d&&(v.causer=d.data.type,v.bXP=!d.data.bAutomated),h&&h.data.seatIndex>0&&(T=this.getObjectById(h.data.controllableId))&&T.data.type!=ObjectType.MOUNTED_WEAPON&&(v.bFromVehicle=1),o.data.controllableId&&(T=this.getObjectById(o.data.controllableId))&&T.data.type!=ObjectType.MOUNTED_WEAPON&&(v.bInVehicle=1),o.data.bJuggernaut&&(v.bJuggernaut=1),this.game.bSurvival&&o.data.reward&&(v.reward=o.data.reward),e.bDirectlyCausedByPlayer&&(v.bDirectlyCausedByPlayer=!0),(e.bTeamKill||u)&&(v.bTeamKill=!0),e.bMelee&&(v.bMelee=!0),b&&(v.bSuicide=!0),e.bHeadshot&&(v.bHeadshot=!0),e.bLongshot&&(v.bLongshot=!0),e.bDirectImpact&&(v.bDirectImpact=!0),(me=this.getWeaponData(e.weaponId))&&me.bDinosaur&&(v.bDinosaur=!0),o.data.type==ObjectType.CHARACTER||o.data.type==ObjectType.DINOSAUR)switch(this.game.gameModeId){case GameMode.DOMINATION:case GameMode.CONQUEST:case GameMode.HEADQUARTERS:case GameMode.DEMOLITION:this.isNearFriendlyFlag(o)?v.bOffensiveKill=!0:this.isNearEnemyFlag(o)&&(v.bDefensiveKill=!0);break;case GameMode.DEFENDER:case GameMode.CAPTURE_THE_FLAG:this.isHoldingFlag(o)&&(v.bEnemyHoldingFlag=!0);break;case GameMode.ASSASSINATION:l&&l.bVIP&&(v.bOffensiveKill=!0)}e.damageAmount=n;var y=e.causerId;d&&d.data.type==ObjectType.DINOSAUR&&d.data.playerId&&(y=d.data.playerId),this.onPlayerKill(e.attackerId,n,e.pawnId,y,v),this.onObjectDeath(e.pawnId,n,e.attackerId,e.causerId,v)}else{switch(o.data.type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:if(this.isTeamGameMode()){o.data.damagedBy||(o.data.damagedBy=[]);var A=o.data.damagedBy;-1==A.indexOf(e.attackerId)&&A.push(e.attackerId)}o.data.bBot&&(o.ai.enemy||this.emitAISound([o.position[0]+this.Random(-100,100),o.position[1]+this.Random(-100,100)],null,200,null))}"tazer"==e.weaponId&&o.data.dinoType!=Dinosaur.TREX&&(o.data.bStunned=!0,o.data.stunTimer=Math.round(3*this.game.settings.fps/o.mass),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:o.data.id,type:GameServer.PAWN_STUN,weaponId:e.weaponId,causerId:e.attackerId,bValue:!0}))}}break;case GameServer.EVENT_SPAWN_BULLET:var O=e.weaponData?e.weaponData:this.getWeaponData(e.weaponId),R=this.raycast(e.startX,e.startY,e.endX,e.endY,null,this.isMeleeWeapon(O));if(R){var M=this.Dist(e.startX,e.startY,e.endX,e.endY),_=[],D=0,S=O?O.penetration:1,N=Material.DEFAULT,C=!1,P={},f=this.Angle(e.startX,e.startY,e.endX,e.endY),w=null;for(t=0;t<R.length;t++){C=!1,w=null;var G=R[t];if(G){var k=G.body,L=k.data;if(!L)continue;if(L.bInvisible)continue;switch(N=L.material?L.material:Material.DEFAULT,L.type){case ObjectType.ROCKET:break;case ObjectType.GRENADE:"c4"==L.weaponId&&this.detonate(k);break;case ObjectType.EGG:D=S;break;case ObjectType.CHARACTER:case ObjectType.DINOSAUR:if((r=this.getPlayerById(L.id))&&r.bSpawnProtection)continue;this.characterHasEquipment(k,"kevlar"),L.team!=e.team&&(k.mass>=4&&(D=S),L.material==Material.METAL&&(D=S),C=!0);break;case ObjectType.GROUND:if(e.bIgnoreObstacles)continue;D=S,C=!0;break;case ObjectType.DOOR:if(e.bIgnoreObstacles)continue;L.bClosed&&(L.material==Material.METAL&&(D=S),C=!0);break;case ObjectType.SHIELD:if(k.data.bActive&&k.data.playerId!=e.causerId){var B=(d=this.getObjectById(e.causerId))?d.data.team:-1,j=!e.bMelee||this.game.bSurvival;j&&B==k.data.team&&this.game.bSurvival&&(j=!1),j&&(D=S,C=!0,w=k,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:k.data.playerId,type:GameServer.PAWN_HIT_SHIELD,damage:e.damageAmount}))}break;case ObjectType.OBSTACLE:if(e.bIgnoreObstacles&&!k.data.health)continue;if(k.data.bIgnoreProjectiles)continue;if(!e.bMelee){if(!k.data.bBlockLOS&&"window"!=k.data.obstacleId){var W=k.data.obstacleId.indexOf("sandbags")>=0?80:40;if((d=this.getObjectById(e.causerId))&&d.data.bBot&&(W=80),!k.data.bBlock&&this.Dist(G.point.x,G.point.y,e.startX,e.startY)<W)continue}k.data.material!=Material.SANDBAG&&(D=S),C=!0}break;case ObjectType.CAR:case ObjectType.TANK:if(!e.bMelee&&this.Dist(G.point.x,G.point.y,e.startX,e.startY)<50)continue;this.vehicleHasOccupant(k)||(D=S);break;case ObjectType.HELICOPTER:D=S}if(!P[L.id]){if(L.health){var V=L.team!=e.team;switch(L.type){case ObjectType.EQUIPMENT:e.controllerId==L.ownerId&&this.game.bFriendlyFire&&(V=!0),V&&L.weaponData.bMine&&(L.ownerId=e.controllerId,this.detonate(k));break;case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:V=V||!this.vehicleHasOccupant(k)}if(V){P[L.id]=!0;n=e.damageAmount;if(D>0){var U=(1-D/S)*(N==Material.METAL?.25:.75);D!=S&&(n=Math.ceil(n*U))}var H=e.bMelee,x=G.bHeadshot,F=!H&&G.distance>.5*M,Y=!H&&G.distance<250,q=DamageType.DAMAGE_BULLET;if(O&&(O.bDinosaur&&(q=DamageType.DAMAGE_MELEE),this.isMeleeWeapon(O)&&(x=!1,q=DamageType.DAMAGE_MELEE)),x&&(n*=O.headshotMult?O.headshotMult:1.4),!H&&this.characterHasEquipment(k,"kevlar")&&q==DamageType.DAMAGE_BULLET){var K=!0;n*=.75}if(O){if(this.characterHasEquipment(k,"dino_vest")&&O.bDinosaur){var J=!0;n*=.5}Y?O.type==Weapon.TYPE_SHOTGUN&&(n*=1.5,k.data.type==ObjectType.DINOSAUR&&(n*=1.25)):G.distance>O.dropRange&&(n*=.5),this.hasMod(O,Mods.AMMO_HOLLOW_POINT)&&this.onStoppingPowerHit(k,n)}if(O){if(this.isVehicle(k)&&O.bDinosaur&&O.penetration>=4){var z=1+.2*O.penetration;n*=z}if(this.isVehicle(k))switch(O.round){case"408":case"50bmg":n*=2}(this.isVehicle(k)||k.data.type==ObjectType.DINOSAUR||k.data.bJuggernaut)&&O.penetration>=5&&(n*=z=1+.2*O.penetration)}k.data.type==ObjectType.DINOSAUR&&"arrow"==O.round&&(n*=this.game.bSurvival?5:2);var X={eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:q,damageAmount:n,pawnId:k.data.id,attackerId:e.controllerId,causerId:e.causerId,weaponId:e.weaponId,useId:e.useId};F&&(X.bLongshot=1),Y&&(X.bNearshot=1),H&&(X.bMelee=1),e.bDirectlyCausedByPlayer&&(X.bDirectlyCausedByPlayer=1),w&&(X.bShield=1),K&&(X.bKevlar=1),J&&(X.bDinoVest=1),this.requestEvent(X),C=!0}}if(C){if(O.bExplosive)this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:[Math.round(G.point.x),Math.round(G.point.y)],radius:O.radius?O.radius:100,damage:n||e.damageAmount,playerId:e.controllerId,causerId:e.causerId,weaponId:O.id,bExplosive:O.bExplosive});else if(O.bPoison)for(t=0;t<5;t++)this.createFlame([G.point.x,G.point.y],[this.Random(-200,200),this.Random(-200,200)],e.team,e.controllerId,O,O.fireTime,!0);else _.push({x:Math.round(G.point.x+this.Random(-10,10)),y:Math.round(G.point.y+this.Random(-10,10)),rotation:f+this.ToRad(180),impactType:N,damageAmount:n||e.damageAmount,intensity:(Y?O.type==Weapon.TYPE_SHOTGUN?1.75:1.25:1)+(n>=200?.5:0)});if(++D>=S){if(e.endX=G.point.x,e.endY=G.point.y,"arrow"==O.round&&!O.bExplosive&&!O.bPoison)this.createArrow([G.point.x,G.point.y],{angle:f}).angularVelocity=this.Random(-5,5);break}}}}}}_&&this.createImpactEffects(_),this.batchData.length>=this.settings.maxBatchItems&&(e.bServer=!0);break;case GameServer.EVENT_GAME_PAUSE:this.game.bPaused=e.bPaused;break;case GameServer.EVENT_BUY:if(r=this.getPlayerById(e.pawnId))if(be=this.getObjectById(e.pawnId))if(e.bAmmo){if(ee=be.data.inventory[e.index]){if(ee.bEquipment)var Q=this.getWeaponMoneyCost(ee);else Q=this.getSharedData("ammoCost")[ee.round]*ee.magSize;r.money>=Q&&(r.money-=Q,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:be.data.id,data:{money:r.money}}),e.index<=1?this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:be.data.id,index:e.index,type:GameServer.INV_AMMO_ADD,value:ee.magSize,barrelAmmo:ee.barrel?ee.barrel.magSize:1}):e.index>=3&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:be.data.id,type:GameServer.INV_EQUIPMENT_ADD,slot:3==e.index?"equipment":"grenade",value:1}))}}else if(e.itemId){var Z;if(Z=this.getItemData(e.itemId)){Q=Z.cost;r.money>=Q&&(r.money-=Q,r.items&&(r.items.push({id:e.itemId}),r.itemIndex=r.items.length-1),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:be.data.id,data:{items:r.items,itemIndex:r.itemIndex,itemId:e.itemId,money:r.money}}))}}else if(void 0!==e.modId){var $=this.getModData(e.modId);if($){Q=this.getModMoneyCost($);if(r.money>=Q)r.money-=Q,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:be.data.id,data:{money:r.money}}),(ee=be.data.inventory[e.index])&&(ee.mods||(ee.mods={}),ee.mods[e.modType]=e.modId,this.applyWeaponMods(ee,ee.mods),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:be.data.id,inventory:be.data.inventory,type:GameServer.INV_INVENTORY}))}else{var ee;(ee=be.data.inventory[e.index])&&(ee.mods||(ee.mods={}),ee.mods[e.modType]=null,this.applyWeaponMods(ee,ee.mods),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:be.data.id,inventory:be.data.inventory,type:GameServer.INV_INVENTORY}))}}else if(e.weaponId){var ae=this.getWeaponData(e.weaponId);if(ae){ae.mods={optic:null};Q=this.getWeaponMoneyCost(ae);if(r.money>=Q)if(r.money-=Q,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:be.data.id,data:{money:r.money}}),e.index<=2)this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:be.data.id,index:e.index,item:ae,type:GameServer.INV_ITEM_REPLACE});else{var te=3==e.index?"equipment":"grenade";this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:be.data.id,slot:te,value:ae.id,type:GameServer.INV_EQUIPMENT_SET,sfxId:"wpn_ammo"})}}}break;case GameServer.EVENT_GAME_END:e.condition==MatchState.END_CONDITION_FORFEIT&&(e.winningTeam=-1),this.game.gameModeData.winner=e.winningTeam,this.endGame();break;case GameServer.EVENT_PLAYER_TRIGGER_EQUIPMENT:var ie;(ie=this.getObjectById(e.playerId))&&(ie.data.controllableId&&0==ie.data.seatIndex?this.triggerCountermeasure(ie):this.triggerCharacterEquipment(e,"equipment")),e.bServer=!0;break;case GameServer.EVENT_PLAYER_TRIGGER_GRENADE:this.triggerCharacterEquipment(e,"grenade"),e.bServer=!0;break;case GameServer.EVENT_PLAYER_TRIGGER_WEAPON:if(e){if(this.game.cinematic&&e.value){this.game.bMultiplayer||(console.log("Skip cinematic",e),this.loadNextCinematicAction());break}if(be=this.getObjectById(e.playerId))switch(be.data.type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:this.triggerCharacterWeapon(e)}}break;case GameServer.EVENT_PLAYER_UPDATE_INVENTORY:if(be=this.getObjectById(e.pawnId)){var se=be.data.inventory;switch(e.bRemoveEquipment&&(be.data.equipment=null,e.equipment=null),"number"!=typeof e.type&&console.warn("Invalid type:",e.type),e.type){case GameServer.INV_PERK_ADD:(re=be.data.perks)&&-1==re.indexOf(e.perkId)&&re.push(e.perkId),this.updateCharacterPerks(be),e.perks=re;break;case GameServer.INV_PERKS:var re=be.data.perks;this.updateCharacterPerks(be),e.perks=re;break;case GameServer.INV_PERKS_SET:be.data.perks=e.perks,this.updateCharacterPerks(be);break;case GameServer.INV_FIRE:if((ge=se[e.index]).bBarrel){var ne=ge.barrel;ne&&(ne.mag--,e.mag=ne.mag),e.bBarrel=ge.bBarrel}else this.isMeleeWeapon(ge)||ge.bDinosaur||(ge.mag--,ge.bBoltAction&&(ge.bNeedsBoltPull=!0),e.mag=ge.mag);break;case GameServer.INV_CLASS_DATA:if(!this.game.gameModeData.bNoClasses&&this.game.bModeGame)if((r=this.getPlayerById(e.pawnId))&&r.bVIP)e={};else{var oe=this.getWeaponData(e.primary.id);this.applyWeaponMods(oe,e.primary.mods,be?be.data.id:null);var de=this.getWeaponData(e.secondary.id);this.applyWeaponMods(de,e.secondary.mods,be?be.data.id:null);var le=this.getWeaponData(e.equipment);be.data.inventory=[oe,de],be.data.equipment=le,delete be.data.bBandolier,this.setCharacterCurrentInventoryItem(be,0),e.inventory=be.data.inventory,e.equipment=be.data.equipment,e.currentInventoryIndex=0;re=[e.playerPerk,e.weaponPerk];be.data.perks=re,this.updateCharacterPerks(be),e.perks=re}else e={};break;case GameServer.INV_MOD_SET:if(me=be.data.inventory[e.index]){var he=me.mods?me.mods:{};he[e.modType]=e.modId,this.applyWeaponMods(me,he),e.inventory=be.data.inventory}break;case GameServer.INV_UNDERBARREL_EQUIP:var me;(me=this.getCurrentCharacterInventoryItem(be,!1))&&me.barrel&&(me.bBarrel=e.value,this.setCharacterCurrentInventoryItem(be,e.index),e.item=me,e.mag=me.barrel.mag,e.ammo=me.barrel.ammo);break;case GameServer.INV_EQUIPMENT_SET:var ce=this.getWeaponData(e.value);if(ce){switch(null!=e.ammo&&(ce.ammo=e.ammo),be.data[e.slot]=ce,e.slot){case"equipment":be.data.inventory[Character.INDEX_EQUIPMENT]=ce;break;case"grenade":be.data.inventory[Character.INDEX_GRENADE]=ce}e[e.slot]=be.data[e.slot]}break;case GameServer.INV_EQUIPMENT_ADD:var pe=be.data[e.slot];pe&&null!=pe.ammo&&(pe.ammo+=e.value,pe.ammo=Math.min(pe.ammo,pe.ammoMax)),e[e.slot]=pe;break;case GameServer.INV_AMMO:se[e.index].bPassive||null==se[e.index].ammo||(se[e.index].ammo=e.value,e.item=se[e.index]);break;case GameServer.INV_AMMO_ADD:se[e.index].bPassive||null==se[e.index].ammo||(se[e.index].ammo+=e.value,se[e.index].ammo=Math.min(se[e.index].ammo,999),e.barrelAmmo>0&&se[e.index].barrel&&(se[e.index].barrel.ammo=Math.min(se[e.index].barrel.ammo+(e.barrelAmmo?e.barrelAmmo:1),99)),e.item=se[e.index]);break;case GameServer.INV_MAG:se[e.index].mag=e.value,e.item=se[e.index];break;case GameServer.INV_MAG_ADD:se[e.index].mag+=e.value,e.item=se[e.index];break;case GameServer.INV_BURSTS:se[e.index].bursts=e.value,e.item=se[e.index];break;case GameServer.INV_BURSTS_ADD:se[e.index].bursts+=e.value,e.item=se[e.index];break;case GameServer.INV_ITEM:e.bBarrel?e.item=se[e.index].barrel:e.item=se[e.index];break;case GameServer.INV_ITEM_ADD:2==se.length&&se.splice(0,1),se.push(e.item),this.setCharacterCurrentInventoryItem(be,1),e.currentInventoryIndex=1,e.inventory=se;break;case GameServer.INV_ITEM_REPLACE:switch(se[e.index]=e.item,e.index==be.data.currentInventoryIndex&&this.setCharacterCurrentInventoryItem(be,e.index),e.index){case Character.INDEX_EQUIPMENT:be.data.equipment=e.item,e.equipment=e.item;break;case Character.INDEX_GRENADE:be.data.grenade=e.item,e.grenade=e.item}e.bReplace=1,e.inventory=se;break;case GameServer.INV_INVENTORY_REPLACE:be.data.inventory=e.inventory,this.setCharacterCurrentInventoryItem(be,0),e.currentInventoryIndex=0,e.inventory=e.inventory;break;case GameServer.INV_CURRENT_INVENTORY_INDEX:if(this.characterCanSwitchWeapons(be)&&be.data.inventory[e.value]){this.setCharacterCurrentInventoryItem(be,e.value),e.currentInventoryIndex=e.value;var ge=be.data.inventory[e.value];be.data.bReloading&&(e.bReload=!0)}break;case GameServer.INV_INVENTORY:e.inventory=se;break;case GameServer.INV_EQUIPMENT:e[e.slot]=be.data[e.slot]}let a=Object.keys(e);for(t=0;t<a.length;t++){let i=a[t],s=e[i];"boolean"==typeof s?e[i]=1==s?1:0:null==s&&delete e[i]}}break;case GameServer.EVENT_PLAYER_INPUT:var Ee=e.keyInfo;if(Ee){r=this.getPlayerById(e.playerId);var be=this.getObjectById(e.playerId);for(a=Object.keys(Ee),t=0;t<a.length;t++){let i=a[t],s=Ee[i];switch(i){case Control.UP:case Control.DOWN:case Control.LEFT:case Control.RIGHT:r?(r.input||(r.input={}),r.input[i]=s):be&&(be.input||(be.input={}),be.input[i]=s)}let n={keyId:i,value:s};if(be&&be.data.controllableId){let e=this.getObjectById(be.data.controllableId);this.handleControllableInput(be,e,n)}else this.handlePlayerInput(be,n);i!=Control.LOOK&&this.dispatchTrigger({event:"playerInput",playerId:e.playerId,keyId:i,bValue:1==s})}}e.bServer=!0}e.bServer||this.onEvent(e)}}characterCanSwitchWeapons(e){var a=e.data;return this.seatCanInput(e)&&!a.weapon.bFireDelay&&!a.bInteracting&&!a.bShieldCooldown&&!a.weapon.bMeleeDelay}characterCanMelee(e){var a=e.data,t=this.getPlayerById(a.id);if(t&&t.controllableId)return!1;if(a.bShieldCooldown)return!1;var i=this.getCurrentCharacterInventoryItem(e),s=!this.isMeleeWeapon(i)||i.bCanMelee;return!a.bInteracting&&!this.characterHasWeaponDelay(e)&&s&&!a.bSprinting}triggerCharacterMeleeAttack(e){if(this.characterCanMelee(e)){this.cancelCharacterReload(e),this.cancelCharacterBoltPull(e);var a=e.data,t=a.melee;a.weapon.bMeleeDelay=!0,a.weapon.meleeDelayTimer=(t?t.fireRate:30)*this.game.fpsMult;var i=t?t.damage:100;this.createBullet({x:e.position[0],y:e.position[1]-10,rotation:a.aimRotation,range:t?t.range:50,damage:i,instigatorId:a.id,causerId:a.id,weaponId:t?t.id:"melee_knife",weaponData:null,bDirectlyCausedByPlayer:!0,bMelee:!0,bIgnoreObstacles:!1}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_MELEE_ATTACK})}}getSeatData(e){if(!e||null==e.data.seatIndex||!e.data.controllableId)return null;var a=this.getObjectById(e.data.controllableId);return a&&a.data.seats?a.data.seats[e.data.seatIndex]:null}getVehiclePawnIds(e){var a=[],t=e.data.seats;if(t)for(var i=0;i<t.length;i++){var s=t[i];s.pawnId&&a.push(s.pawnId)}return a}getVehicleDriverId(e){var a=e.data.seats;if(a)for(var t=0;t<a.length;t++){var i=a[t];if(i.pawnId)return i.pawnId}return null}getVehicleMuzzlePosition(e,a){var t=this.getCurrentVehicleWeapon(e,a),i=[e.position[0],e.position[1]];if(t.muzzlePos){var s=t.muzzlePos[0],r=t.muzzlePos[1],n=s||r;i[0]+=Math.cos(e.angle)*n,i[1]+=Math.sin(e.angle)*n}return i}cycleVehicleWeapon(e,a){var t=e.data,i=t.weapons;if(i){var s=i[a];if(s&&s.length>1){var r=t.seats[a];null==r.weaponIndex&&(r.weaponIndex=0);var n=s[r.weaponIndex];n&&(n.bWantsToFire=!1);var o=r.weaponIndex;r.weaponIndex++,r.weaponIndex>s.length-1&&(r.weaponIndex=0);for(var d=0;d<s.length;d++)s[d].aimRotation=s[o].aimRotation;this.pushObjectDataUpdate(t.id,["seats"]),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_VEHICLE_UPDATE,index:a,weaponIndex:r.weaponIndex})}}}setVehicleWeaponIndex(e,a,t){var i=e.data,s=i.weapons;if(s){var r=s[a];if(r&&r.length>1){var n=i.seats[a];null==n.weaponIndex&&(n.weaponIndex=0);var o=n.weaponIndex;r[o].bWantsToFire=!1,r[t]&&t!=o&&(n.weaponIndex=t,this.pushObjectDataUpdate(i.id,["seats"]),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_VEHICLE_UPDATE,index:a,weaponIndex:n.weaponIndex}))}}}canSwitchSeats(e){return!e.data.seatTimer&&!e.data.vehicleCooldown&&e.data.controllableId}getCurrentVehicleWeapon(e,a){var t=e?e.data.weapons:null;if(t){var i=e.data.seats[a],s=i&&null!=i.weaponIndex?i.weaponIndex:0;if(t[a])return t[a][s]}return null}switchSeats(e){if(this.canSwitchSeats(e)){var a=this.getObjectById(e.data.controllableId);if(a)if(null!=this.getAvailableSeatIndex(a)){var t=this.getCurrentVehicleWeapon(a,e.data.seatIndex);t&&(t.bWantsToFire=!1),e.data.seatTimer=Math.round(.35*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_SWITCH_SEATS,value:!0})}}}handleControllableInput(e,a,t){if(e&&a&&t){var i=a.data.type,s=t.keyId,r=t.value,n=this.getSeatData(e);switch(n&&n.bInput&&this.handlePlayerInput(e,t),s){case Control.RELOAD:(c=this.getCurrentVehicleWeapon(a,e.data.seatIndex))&&c.weaponData&&c.overheat>0&&0==c.weaponData.overheatCooldownNum&&!c.bCooldown&&(c.bCooldown=!0,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.data.id,type:GameServer.PAWN_WEAPON_COOLDOWN,index:e.data.seatIndex,value:c.bCooldown}))}switch(i){case ObjectType.MOUNTED_WEAPON:switch(s){case Control.LOOK:if(a.data.weapons)if((c=this.getCurrentVehicleWeapon(a,e.data.seatIndex))&&r.pos){var o=this.getVehicleMuzzlePosition(a,e.data.seatIndex);this.setVehicleWeaponAimRotation(c,this.Angle(o[0],o[1],r.pos[0],r.pos[1]))}}break;case ObjectType.CAR:case ObjectType.TANK:var d=a.data.speed?a.data.speed:100;if(i==ObjectType.TANK)var l=6;else if(a.mass<Number.MAX_VALUE){var h=.001*this.getTotalVelocity(a)/d;l=Math.min(d*Math.min(1,Math.abs(h)),100/(.3*a.mass)),l=Math.min(30,l)}else l=0;switch(s){case Control.WEAPON:this.cycleVehicleWeapon(a,e.data.seatIndex);break;case Control.SWITCH:this.switchSeats(e);break;case Control.LOOK:if(a.data.weapons)if((c=this.getCurrentVehicleWeapon(a,e.data.seatIndex))&&r.pos){o=this.getVehicleMuzzlePosition(a,e.data.seatIndex);this.setVehicleWeaponAimRotation(c,this.Angle(o[0],o[1],r.pos[0],r.pos[1]))}}break;case ObjectType.HELICOPTER:var m=a.data.speed;switch(s){case Control.WEAPON:this.cycleVehicleWeapon(a,e.data.seatIndex);break;case Control.SWITCH:this.switchSeats(e);break;case Control.LOOK:if(e.data.seatTimer)return;var c;if(a.data.weapons)if((c=this.getCurrentVehicleWeapon(a,e.data.seatIndex))&&r.pos){o=this.getVehicleMuzzlePosition(a,e.data.seatIndex);this.setVehicleWeaponAimRotation(c,this.Angle(o[0],o[1],r.pos[0],r.pos[1]))}break;case Control.LEFT:0==e.data.seatIndex&&r&&a.position[0]>0&&a.applyForce([-m,0]);break;case Control.RIGHT:0==e.data.seatIndex&&r&&a.position[0]<this.getMapWidth()&&a.applyForce([m,0]);break;case Control.UP:0==e.data.seatIndex&&r&&a.position[1]>0&&a.applyForce([0,-m]);break;case Control.DOWN:0==e.data.seatIndex&&r&&a.position[1]<this.getMapHeight()&&a.applyForce([0,m])}}}}toggleUnderbarrelEquipped(e){var a=this.getCurrentCharacterInventoryItem(e,!1);if(a&&this.hasUnderbarrelMod(a)){var t=e.data;this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.id,type:GameServer.INV_UNDERBARREL_EQUIP,index:t.currentInventoryIndex,value:!a.bBarrel})}}handlePlayerInput(e,a){if(e&&a){var t=a.keyId,i=a.value,s=e;if(s){var r=s.data;if(s.data.seatTimer)return;switch(t){case Control.SWITCH:var n=r.inventory;n[r.currentInventoryIndex].barrel&&n[r.currentInventoryIndex].bBarrel?this.toggleUnderbarrelEquipped(e):r.bBot&&n.length>1&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:r.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:0==r.currentInventoryIndex?1:0});break;case Control.INV_NEXT:case Control.INV_PREV:break;case Control.WEAPON:this.toggleUnderbarrelEquipped(s);break;case Control.ITEM:var o=this.getPlayerById(r.id);r.bReloading&&this.cancelCharacterReload(s),o&&this.characterIsFree(s)&&this.useItem(o.id);break;case Control.ITEM_1:0!=r.currentInventoryIndex&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:r.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:0});break;case Control.ITEM_2:1!=r.currentInventoryIndex&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:r.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:1});break;case Control.ITEM_3:2!=r.currentInventoryIndex&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:r.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:2});break;case Control.LOOK:r.desiredAimRotation=i.angle,r.lookPos=i.pos,r.bAiming=1==i.bAiming?1:0,i.pawn&&!r.bBot&&(this.isValidArray(i.pawn)&&(r.clientPos=i.pawn,e.position=i.pawn),this.isValidArray(i.velocity)&&(e.velocity=i.velocity));break;case Control.MELEE:s.data.type==ObjectType.CHARACTER&&this.triggerCharacterMeleeAttack(s);break;case Control.RELOAD:this.reloadCharacterWeapon(s,!0);break;case Control.LEFT:switch(r.type){case ObjectType.DINOSAUR:r.bWantsToMove=i&&this.pawnCanMove(e);break;case ObjectType.CHARACTER:r.bWantsToMove=i&&this.pawnCanMove(e),r.bWantsToMove?r.moveX=-1:delete r.moveX}break;case Control.RIGHT:switch(r.type){case ObjectType.DINOSAUR:r.bWantsToMove=i&&this.pawnCanMove(e);break;case ObjectType.CHARACTER:r.bWantsToMove=i&&this.pawnCanMove(e),i?r.moveX=1:delete r.moveX}break;case Control.UP:switch(r.type){case ObjectType.DINOSAUR:r.bWantsToMove=i&&this.pawnCanMove(e);break;case ObjectType.CHARACTER:r.bWantsToMove=i&&this.pawnCanMove(e),i?r.moveY=-1:delete r.moveY}break;case Control.DOWN:switch(r.type){case ObjectType.DINOSAUR:r.bWantsToMove=i&&this.pawnCanMove(e);break;case ObjectType.CHARACTER:r.bWantsToMove=i&&this.pawnCanMove(e),i?r.moveY=1:delete r.moveY}break;case Control.JUMP:break;case Control.CROUCH:switch(r.type){case ObjectType.CHARACTER:this.setDataValue(s,"bCrouching",i&&this.characterCanCrouch(s))}break;case Control.SPRINT:switch(r.type){case ObjectType.CHARACTER:this.setDataValue(s,"bSprinting",i&&this.characterCanSprint(s))}break;case Control.FIRE:this.triggerCharacterWeapon({playerId:e.data.id,value:i})}}}}triggerCharacterJump(e){}executeInteractable(e,a){if(this.matchInProgress()&&e&&!e.data.bPendingRemoval){e.data.bLimitInteractions&&delete e.data.currentPawnId,this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a,type:GameServer.PAWN_INTERACTABLE_USED,interactableId:e.data.id}),this.dispatchTrigger({event:"objectUsed",objectId:e.data.id,userId:a});var t=this.getObjectById(a),i=e.data;if(t&&t.ai&&t.ai.desiredItemId==i.id&&(delete t.ai.desiredItemId,delete t.ai.bWantsItem),i){switch(i.type){case ObjectType.REVIVER:this.respawnPlayer(i.itemData.playerId,{position:[e.position[0],e.position[1]-30]}),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a,type:GameServer.PAWN_END_REVIVE,reviveId:i.itemData.playerId}),(m=this.getPlayerById(a))&&this.game.bSurvival&&(this.game.gameModeData.waveRevives++,this.game.gameModeData.waveRevives<4&&this.addPlayerMoney(m.id,250)),this.removeNextStep(e);break;case ObjectType.LEVER:if(!i.bDisabled&&!t.data.shieldCooldownTimer){if(i.targetId){var s=this.getObjectById(i.targetId);if(s)switch(s.data.type){case ObjectType.DOOR:this.setDoorClosed(s,!s.data.bClosed)}}i.triggerId&&this.checkTriggerAndExecuteById(i.triggerId,{objectId:t.data.id,leverId:i.id}),this.startCharacterShieldCooldown(t)}break;case ObjectType.DOOR:i.cooldownTimer||i.leverId||i.bDisabled||(this.setDoorClosed(e,!i.bClosed,t),this.startCharacterShieldCooldown(t));break;case ObjectType.EQUIPMENT:switch(i.weaponData.id){case"ammo_box":for(var r=t.data.inventory,n=1,o=0;o<r.length;o++){!(p=r[o])||p.bMelee||p.bEquipment||null==p.ammo||this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:o,type:GameServer.INV_AMMO_ADD,value:p.magSize*n,barrelAmmo:p.barrel?p.barrel.magSize:1})}this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_EQUIPMENT_ADD,slot:"grenade",value:1}),t.data.equipment&&"ammo_box"!=t.data.equipment.id&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_EQUIPMENT_ADD,slot:"equipment",value:1})}break;case ObjectType.CRATE:switch(i.crateType){case Crate.STORE:if((m=this.getPlayerById(a))&&m.bBot){if(this.needsBetterWeapon(t)){var d=this.clone(this.data.weapons);this.ShuffleArray(d);e:for(o=0;o<d.length;o++){var l=d[o];if(!l.bHidden&&!l.bVehicle&&!l.bExcludeFromStore&&this.getWeaponMoneyCost(l)<=m.money)switch(l.type){case Weapon.TYPE_RIFLE:case Weapon.TYPE_LMG:case Weapon.TYPE_SNIPER:case Weapon.TYPE_DMR:this.requestEvent({eventId:GameServer.EVENT_BUY,pawnId:m.id,weaponId:l.id,index:0});break e}}}if(m.items.length<3){var h=this.clone(this.data.items);this.ShuffleArray(h);for(o=0;o<h.length;o++){let e=h[o];if(e.cost<=m.money){switch(e.id){case Item.AMMO_AIRDROP:if(this.getDisposableCrates().length>=2)continue}this.requestEvent({eventId:GameServer.EVENT_BUY,pawnId:m.id,itemId:e.id});break}}}}break;case Crate.BOMB:case Crate.BOMB_GENERIC:if(i.bBombPlanted)this.setDataValue(e,"bBombPlanted",!1),i.bombTimer=i.bombTimerMax,i.itemData.interactTeam=0==i.team?1:0,this.pushObjectDataUpdate(i.id,["bBombPlanted","bombTimer","itemData"]),(m=this.getPlayerById(a))&&(m.defuses++,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a,data:{defuses:m.defuses}})),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{playerId:a,defuseTeam:i.team,bombNum:i.bombNum}});else this.setDataValue(e,"bBombPlanted",!0),i.itemData.interactTeam=i.team,this.pushObjectDataUpdate(i.id,["bBombPlanted","itemData"]),(m=this.getPlayerById(a))&&(m.plants++,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a,data:{plants:m.plants}})),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{playerId:a,plantTeam:0==i.team?1:0,bombNum:i.bombNum}});break;case Crate.ITEM:var m;if(g=this.getItemData(i.itemId))if(m=this.getPlayerById(a))m.items&&(m.items.push({id:i.itemId}),m.itemIndex=m.items.length-1,this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a,data:{items:m.items,itemIndex:m.itemIndex,itemId:i.itemId}}));else if(t=this.getObjectById(a)){t.data.pawnItems||(t.data.pawnItems=[]);var c=t.data.pawnItems;c&&c.push({id:i.itemId})}break;case Crate.AMMO:for(r=t.data.inventory,n=4,o=0;o<r.length;o++){var p;if((p=r[o])&&!p.bMelee&&!p.bEquipment&&null!=p.ammo){p.mag;this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:o,type:GameServer.INV_AMMO_ADD,value:p.magSize*n,barrelAmmo:(p.barrel?p.barrel.magSize:1)*n})}}this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_EQUIPMENT_ADD,slot:"grenade",value:4}),t.data.equipment&&"ammo_box"!=t.data.equipment.id&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_EQUIPMENT_ADD,slot:"equipment",value:4})}if((h=i.items)&&h.length>0)for(o=0;o<h.length;o++){var g;(g=h[o])&&this.spawnItem(g,e.position,g.team)}break;case ObjectType.MOUNTED_WEAPON:case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:var E=this.getAvailableSeatIndex(e);null!=E&&this.enterVehicle(t,e,E);break;case ObjectType.DROPPED_WEAPON:if(t){var b=i.itemData.weaponData;if(b.type==Weapon.TYPE_MELEE&&"blowtorch"!=b.id){if(!t.data.bNoPickups)t.data.inventory[2]&&!b.id||(this.dropCharacterEquipment(t,"melee"),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:2,slot:"melee",value:b.id,type:GameServer.INV_EQUIPMENT_SET,sfxId:"wpn_ammo"}),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:2,item:b,type:GameServer.INV_ITEM_REPLACE}),this.removeNextStep(e))}else if(b.type==Weapon.TYPE_GRENADE){var u=t.data.grenade;u&&u.id==b.id?(this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,slot:"grenade",value:1,type:GameServer.INV_EQUIPMENT_ADD,sfxId:"wpn_ammo"}),this.removeNextStep(e)):t.data.bNoPickups||(this.dropCharacterEquipment(t,"grenade"),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,slot:"grenade",value:b.id,type:GameServer.INV_EQUIPMENT_SET,sfxId:"wpn_ammo"}),this.removeNextStep(e))}else if(b.bEquipment){var I=t.data.equipment;I&&I.id==b.id?(this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,slot:"equipment",value:1,type:GameServer.INV_EQUIPMENT_ADD,sfxId:"wpn_ammo"}),this.removeNextStep(e)):t.data.bNoPickups||(this.dropCharacterEquipment(t,"equipment"),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,slot:"equipment",value:b.id,type:GameServer.INV_EQUIPMENT_SET,sfxId:"wpn_ammo"}),this.removeNextStep(e),t.data.currentInventoryIndex==Character.INDEX_EQUIPMENT&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:0}))}else{r=t.data.inventory;var T=this.getCharacterInventoryItemIndex(t,b.id);if(T>=0)this.isMeleeWeapon(b)||(this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:T,value:b.mag+b.ammo,type:GameServer.INV_AMMO_ADD,sfxId:"wpn_ammo",barrelAmmo:b.barrel?b.barrel.mag+b.barrel.ammo:0}),this.removeNextStep(e));else if(!t.data.bNoPickups){if(r[0])if(r[1])if(r.length<=1)r[0]&&"none"==r[0].id?this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:0,item:b,type:GameServer.INV_ITEM_REPLACE}):this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,item:b,type:GameServer.INV_ITEM_ADD,sfxId:"wpn_ammo"});else{var v=t.data.currentInventoryIndex;for(o=0;o<r.length;o++){var y=r[o];if(y&&"none"==y.id){v=o;break}}v=Math.min(1,v),this.dropCharacterWeapon(t,v),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:v,item:b,type:GameServer.INV_ITEM_REPLACE}),v>=0&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,value:v,type:GameServer.INV_CURRENT_INVENTORY_INDEX})}else this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:1,item:b,type:GameServer.INV_ITEM_REPLACE}),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,value:1,type:GameServer.INV_CURRENT_INVENTORY_INDEX});else this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,index:0,item:b,type:GameServer.INV_ITEM_REPLACE}),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,value:0,type:GameServer.INV_CURRENT_INVENTORY_INDEX});this.removeNextStep(e)}}}}i.itemData&&null!=i.itemData.uses&&(i.itemData.uses--,i.itemData.uses<=0&&this.removeNextStep(e),this.pushObjectDataUpdate(i.id,["itemData"]))}}}setPlayerControllable(e,a){this.getObjectById(e)&&a&&(a.data.controllerId=e);var t=this.getPlayerById(e);t&&(t.controllableId=a?a.data.id:null,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{controllableId:t.controllableId}}))}getAvailableSeatIndex(e){if(e)for(var a=e.data.seats,t=0;t<a.length;t++){if(!a[t].pawnId)return t}return null}hasAvailableSeat(e){return!e.data.bAutomated&&!e.data.bDisabled&&null!=this.getAvailableSeatIndex(e)}clearPlayerControllable(e,a){var t=this.getObjectById(e),i=t?this.getObjectById(t.data.controllableId):null;i&&t&&(this.isVehicle(i)&&this.exitVehicle(t,a),delete t.data.controllableId,i.data.controllerId=null);var s=this.getPlayerById(e);s&&(s.controllableId=null,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:e,data:{controllableId:null}})),t&&(t.data.bCrouching=!1)}startInteraction(e,a){var t=e.data;if(a&&this.characterCanInteract(e,a)){a.data.bLimitInteractions&&(a.data.currentPawnId=t.id);var i=a.data.itemData,s=i?i.interactTime:0;if(s>0){switch(a.data.type){case ObjectType.CRATE:i.ownerId&&(i.ownerId,t.id);break;case ObjectType.REVIVER:this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_START_REVIVE})}this.cancelCharacterBoltPull(e),this.cancelCharacterReload(e),e.velocity[0]=0,t.bInteracting=!0,t.interactTimer=s,t.interactableId=a.data.id,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_START_INTERACTION,interactableId:a.data.id,timer:s})}else this.isVehicle(a)?this.canEnterVehicle(e,a)&&this.executeInteractable(a,t.id):this.executeInteractable(a,t.id)}}attemptInteract(e){if(this.matchInProgress()){var a=this.getObjectById(e),t=this.getPlayerById(e);if(t&&t.controllableId){var i=this.getObjectById(t.controllableId);i&&i.data.type,this.canExitVehicle(a)&&this.clearPlayerControllable(t.id)}else{if(!a)return;var s=a.data,r=this.getInteractableForPawn(a);if(r)!s.bBot&&s.bInteracting?this.stopCharacterInteract(a):this.startInteraction(a,r);else{var n=s.equipment;if(n)switch(n.id){case"c4":if(!a.data.weapon.bThrowDelay)for(var o=this.getGrenades(s.id,"c4"),d=0;d<o.length;d++)this.detonate(o[d])}}}}}getTouchingVehicle(e,a){for(var t=this.getVehicles(),i=0;i<t.length;i++){var s=t[i];if(s.data.health){if(s.data.bAutomated&&s.data.team!=e.data.team)continue;if(this.DistBodies(e,s)<100||s.getAABB().overlaps(e.getAABB())){if(a&&s.data.health>=s.data.maxHealth)continue;return s}}}return null}getNearbyVehicle(e){for(var a=[],t=this.getVehicles(),i=0;i<t.length;i++){var s=t[i];!s.data.bPendingRemoval&&(-1==s.data.team||s.data.team==e.data.team)&&this.hasAvailableSeat(s)&&this.DistBodies(s,e)<1e3&&a.push(s)}return a.length>0?a[this.Random(0,a.length-1)]:null}getAIBestBombCrate(e){if(!e.data.bCanInteract)return[];for(var a=[],t=Object.keys(this.game.objects),i=0;i<t.length;i++){var s=this.game.objects[t[i]];if(s.data)switch(s.data.type){case ObjectType.CRATE:s.data.crateType!=Crate.BOMB&&s.data.crateType!=Crate.BOMB_GENERIC||(s.data.team==e.data.team?s.data.bBombPlanted&&a.push(s):a.push(s))}}return a.sort(((a,t)=>{var i=this.DistBodies(e,a),s=this.DistBodies(e,t);return i<s?-1:i>s?1:0})),a}getDesiredInteractable(e){var a=e.data,t=(e.ai,this.getPlayerById(a.id));if(0==a.team){var i=this.getRevivers();if(i.length>0)return i.sort(((a,t)=>{var i=this.DistBodies(a,e),s=this.DistBodies(t,e);return i<s?-1:i>s?1:0})),i[0];if(t&&t.money>=2500&&(this.needsBetterWeapon(e)||t.items.length<1)&&this.game.gameModeData.bIntermission)return this.getStoreCrate()}if(this.needsAmmo(e)){var s=this.getEquipment("ammo_box");return s.sort(((a,t)=>{var i=this.DistBodies(a,e),s=this.DistBodies(t,e);return i<s?-1:i>s?1:0})),s[0]}var r=this.getDisposableCrates();if(r.length>0){for(var n=r.length-1;n>=0;n--){switch(r[n].data.crateType){case Crate.AMMO:this.needsAmmo(e)||r.splice(n,1)}}return r.sort(((a,t)=>{var i=this.DistBodies(a,e),s=this.DistBodies(t,e);return i<s?-1:i>s?1:0})),r[0]}}needsBetterWeapon(e){var a=this.getCurrentCharacterInventoryItem(e);if(a)switch(a.type){case Weapon.TYPE_RIFLE:case Weapon.TYPE_LMG:case Weapon.TYPE_SNIPER:case Weapon.TYPE_DMR:return!1}return!0}getTouchingInteractable(e){var a=e.data,t=e.ai;if(t.objectiveItemId){var i=this.getObjectById(t.objectiveItemId);if(i&&e.getAABB().overlaps(i.getAABB()))return i}if(!i&&t.desiredItemId){var s=this.getObjectById(t.desiredItemId);if(s&&e.getAABB().overlaps(s.getAABB()))return s}var r=this.needsAmmo(e),n=this.getTypes([ObjectType.CAR,ObjectType.TANK,ObjectType.HELICOPTER,ObjectType.MOUNTED_WEAPON,ObjectType.REVIVER,ObjectType.CRATE,ObjectType.EQUIPMENT]);e:for(var o=0;o<n.length;o++){let t=n[o];if(!t.data||t.data.bDisabled||t.data.bPendingRemoval)continue;switch(t.data.type){case ObjectType.REVIVER:if(t.data.team!=a.team)continue e;break;case ObjectType.CRATE:if(t.data.crateType==Crate.STORE||t.data.crateType==Crate.BOMB||t.data.crateType==Crate.BOMB_GENERIC)break;if(r&&t.data.crateType==Crate.AMMO)break;continue e;case ObjectType.EQUIPMENT:if(r&&"ammo_box"==t.data.weaponData.id)break;continue e}let i=t.data.itemData;if((!i||null==i.interactTeam||i.interactTeam==a.team)&&(this.DistBodies(e,t)<500&&t.getAABB().overlaps(e.getAABB())))return t}return null}getInteractables(){for(var e=[],a=Object.keys(this.game.objects),t=0;t<a.length;t++){var i=this.game.objects[a[t]];if(i.data)switch(i.data.type){case ObjectType.CAR:case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.MOUNTED_WEAPON:i.data.health&&this.hasAvailableSeat(i)&&e.push(i);break;case ObjectType.CRATE:case ObjectType.DROPPED_WEAPON:case ObjectType.DOOR:case ObjectType.LEVER:case ObjectType.REVIVER:e.push(i);break;case"equipment":"ammo_box"==i.data.weaponData.id&&e.push(i)}}return e.sort(((e,a)=>{var t=null!=e.data.value?e.data.value:-1,i=null!=a.data.value?a.data.value:-1;return t>i?-1:t<i?1:0})),e}getInteractableForPawn(e){for(var a=this.getInteractables(),t=0;t<a.length;t++){var i=a[t],s=i.data;if(!s.bPendingRemoval){if(s.itemData&&null!=s.itemData.interactTeam&&s.itemData.interactTeam!=e.data.team)continue;if(i.getAABB().overlaps(e.getAABB())){if(this.isVehicle(i)&&!this.hasAvailableSeat(i))continue;return i}}}return null}stopCharacterInteract(e){if(e){var a=e.data;if(a){if(a.interactableId){var t=this.getObjectById(a.interactableId);t&&t.data.bLimitInteractions&&delete t.data.currentPawnId}a.bInteracting=!1,delete a.interactableId,delete a.interactTimer,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_END_INTERACTION});var i=this.getCurrentCharacterInventoryItem(e);i&&0==i.mag&&i.ammo>0&&this.reloadCharacterWeapon(e)}}}characterCanCrouch(e){return!e.data.bBot}characterCanSprint(e){var a=e.data;return!a.bCrouching&&a.bWantsToMove&&!a.bStunned&&!a.bFlashed&&!a.controllableId}characterCanClimb(e){var a=e.data;return!a.controllableId&&(!!a.bBot&&!(a.bUseDelay||a.bEquipmentDelay||a.bCrouching||a.controllableId))}onStartWeaponFire(e){var a=this.getCurrentCharacterInventoryItem(e);if(a)switch(a.id){case"flamethrower":case"minigun":this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_START_FLAME}),e.data.weapon.bStartFlame=!0}}onEndWeaponFire(e){var a=this.getCurrentCharacterInventoryItem(e);a&&a.id}hasMeleeEquipped(e){var a=this.getCurrentCharacterInventoryItem(e);return!!a&&this.isMeleeWeapon(a)}getCurrentCharacterInventoryItem(e,a=!0){if(!e)return null;var t=e.data.inventory[e.data.currentInventoryIndex];return a&&t&&t.bBarrel&&t.barrel?t.barrel:t}getCharacterInventoryItemIndex(e,a){for(var t=e.data.inventory,i=0;i<t.length;i++){var s=t[i];if(s&&s.id==a)return i}return-1}reloadCharacterWeapon(e,a){if(this.characterCanReload(e)){var t=e.data,i=this.getCurrentCharacterInventoryItem(e,!1);t.reloadTimer=t.reloadTimerMax,t.bReloading=!0,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_RELOAD,bManual:a,bBarrel:i.bBarrel})}}seatCanInput(e){var a=this.getSeatData(e);return!a||a.bInput}characterCanReload(e){var a=e.data;this.getPlayerById(a.id);if(!this.seatCanInput(e))return!1;var t=this.getCurrentCharacterInventoryItem(e);if(t&&t.bMelee)return!1;var i=a.weapon,s=t&&t.mag<t.magSize&&(t.ammo>0||i.bUnlimitedAmmo);return!a.bInteracting&&!this.characterHasWeaponDelay(e)&&!a.bReloading&&s}triggerCharacterEquipment(e,a){if(this.matchInProgress()){var t=this.getObjectById(e.playerId);if(t){var i=t.data[a];if(i)if(i.ammo>0)this.useCharacterEquipment(t,a,e.worldX,e.worldY);else switch(i.id){case"c4":for(var s=this.getGrenades(t.data.id,"c4"),r=0;r<s.length;r++)this.detonate(s[r]);break;case"blowtorch":this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:Character.INDEX_EQUIPMENT})}}}}getNumCharactersOnTeam(e){this.game.world;for(var a=0,t=Object.keys(this.game.objects),i=0;i<t.length;i++){var s=this.game.objects[t[i]];if(s.data&&!s.data.bPendingRemoval)switch(s.data.type){case ObjectType.CHARACTER:s.data.health&&s.data.team==e&&a++}}return a}getNumPawnsOnTeam(e,a){for(var t=0,i=Object.keys(this.game.objects),s=0;s<i.length;s++){let o=this.game.objects[i[s]];if(o.data&&o.data.health&&!o.data.bPendingRemoval){if(a&&!this.getPlayerById(o.data.id))continue;switch(o.data.type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:o.data.team!=e&&null!=e||t++;break;case ObjectType.EGG:if(o.data.team==e||null==e)for(var r=o.data.items,n=0;n<r.length;n++)switch(r[n].type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:t++}}}}return t}getNumDinosaursOnTeam(e,a){for(var t=0,i=Object.keys(this.game.objects),s=0;s<i.length;s++){var r=this.game.objects[i[s]];if(r.data)switch(r.data.type){case ObjectType.DINOSAUR:r.data.health&&r.data.team==e&&(a?a.indexOf(r.data.dinoType)>=0&&t++:t++);break;case ObjectType.EGG:if(r.data.health&&r.data.team==e&&r.data.items)for(var n=r.data.items,o=0;o<n.length;o++){var d=n[o];a?a.indexOf(d.dinoType)>=0&&t++:d.type==ObjectType.DINOSAUR&&(t+=r.data.items.length)}}}return t}getFlames(e){for(var a=[],t=Object.keys(this.game.objects),i=0;i<t.length;i++){var s=this.game.objects[t[i]];s.data&&!s.data.bPendingRemoval&&s.data.type==ObjectType.FLAME&&(e&&s.data.playerId!=e||a.push(s))}return a}getCharactersAndDinosaurs(){return this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR])}getEggs(){return this.getTypeArray(ObjectType.EGG)}getNodeBodies(e){for(var a=[],t=Object.keys(this.game.objects),i=0;i<t.length;i++){let s=t[i],r=this.game.objects[s],n=r?r.data:null;if(n&&!n.bPendingRemoval){if(!r.shapes.length)continue;let t=r.getAABB();if(t&&!t.containsPoint(e))continue;switch(n.type){case ObjectType.GROUND:(n.spriteId||n.shape)&&a.push(r);break;case ObjectType.OBSTACLE:case ObjectType.MOUNTED_WEAPON:a.push(r);break;case ObjectType.CRATE:case ObjectType.CAR:case ObjectType.TANK:r.mass!=Number.MAX_VALUE&&n.crateType!=Crate.BOMB||a.push(r);break;case ObjectType.DOOR:a.push(r)}if(a.length>30){console.warn("Max objects at node",e,a.length);break}}}return a}getTypeArray(e){var a=this.game?this.game.types[e]:null;if(a){for(var t=a.length-1;t>=0;t--){let e=a[t];e&&e.data&&!e.data.bPendingRemoval||a.splice(t,1)}return a}return[]}getTypes(e){for(var a=[],t=0;t<e.length;t++){let s=this.getTypeArray(e[t]);for(var i=0;i<s.length;i++){let e=s[i];e&&e.data&&!e.data.bPendingRemoval&&a.push(e)}}return a}getCharacters(){return this.getTypeArray(ObjectType.CHARACTER)}getStructures(){return this.getTypeArray(ObjectType.GROUND)}getMapStructure(){for(var e in this.game.objects){let a=this.game.objects[e];if(a.data&&a.data.spriteId==this.game.mapId)return a}return null}getGrounds(){var e=[];for(var a in this.game.objects){let t=this.game.objects[a];if(t.data&&!t.data.bPendingRemoval)switch(t.data.type){case ObjectType.GROUND:e.push(t)}}return e}getDinosaurs(){return this.getTypeArray(ObjectType.DINOSAUR)}getNearbyRequest(e,a,t=500,i=null){if(this.game.cinematic)return null;var s=e.data;if(s.type==ObjectType.DINOSAUR&&!this.game.bRanked)return null;if(!this.getPlayersOnTeam(s.team))return null;for(var r=this.getCharacters(),n=0;n<r.length;n++){let d=r[n];if(d.data&&d.data.team==s.team&&(d.data.id!=s.id&&d.data.currentRequest==a&&(!s.controllableId||a==Commands.REQUEST_VEHICLE))){if(s.type==ObjectType.DINOSAUR&&i&&s.playerId!=i)continue;var o=this.Dist(d.position[0],d.position[1],e.position[0],e.position[1]);if(o<t)return{dist:o,position:d.position}}}return null}getCharactersOnTeam(e){for(var a=[],t=this.getCharacters(),i=0;i<t.length;i++){let s=t[i];s.data&&s.data.team==e&&a.push(s)}return a}hasPawnOccupants(e){if(e){var a=e.data.seats;if(a)for(var t=0;t<a.length;t++){let e=a[t];if(e.pawnId&&this.getObjectById(e.pawnId))return!0}}return!1}getNumHelicoptersOnTeam(e,a,t){var i=0;this.getHelicopters();for(var s in this.game.objects){let t=this.game.objects[s];if(t.data&&t.data.health&&!t.data.bDisabled)switch(t.data.type){case ObjectType.HELICOPTER:null!=e&&t.data.team!=e||(a?a.indexOf(t.data.vehicleId)>=0&&i++:i++)}}return i}getAttackHelicopters(e){for(var a=[],t=this.getTypeArray(ObjectType.HELICOPTER),i=0;i<t.length;i++){let s=t[i];if(s.data&&s.data.health)switch(s.data.vehicleId){case Helicopter.APACHE:case Helicopter.COBRA:case Helicopter.KIOWA:e?s.data.playerId==e&&a.push(s):a.push(s)}}return a}getHelicopters(e){for(var a=[],t=this.getTypeArray(ObjectType.HELICOPTER),i=0;i<t.length;i++){let s=t[i];s.data&&s.data.health&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}getDoors(){return this.getTypeArray(ObjectType.DOOR)}getOpenedDoors(){for(var e=[],a=this.getDoors(),t=0;t<a.length;t++){let i=a[t];i.data&&(i.data.bClosed||e.push(i))}return e}getLevers(){return this.getTypeArray(ObjectType.LEVER)}getRevivers(e){for(var a=[],t=this.getTypeArray(ObjectType.REVIVER),i=0;i<t.length;i++){let s=t[i];s.data&&!s.data.bPendingRemoval&&(null==e||e==s.data.team)&&a.push(s)}return a}getReviverByPlayerId(e){var a=this.getRevivers();if(a)for(var t=0;t<a.length;t++){let i=a[t];if(i.data.itemData.playerId==e)return i}return null}getCrates(){return this.getTypeArray(ObjectType.CRATE)}getStoreCrate(){for(var e=this.getCrates(),a=0;a<e.length;a++){let t=e[a];if(t.data&&t.data.crateType==Crate.STORE)return t}return null}getBomb(e,a){for(var t=this.getCrates(),i=0;i<t.length;i++){let s=t[i];if(s.data&&s.data.crateType==Crate.STORE&&s.data.team==e&&s.data.num==a)return s}return null}getBombCrates(e){for(var a=[],t=this.getCrates(),i=0;i<t.length;i++){let s=t[i];s.data&&(s.data.crateType!=Crate.BOMB&&s.data.crateType!=Crate.BOMB_GENERIC||(null!=e?s.data.team==e&&a.push(s):a.push(s)))}return a}changeTeam(e){var a=this.getPlayerById(e);if(a){a.team=0==a.team?1:0,this.setCurrentClass(a,a.currentClass),this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{bInfofeed:!0,message:"STR_X_SWITCHED_TEAM",messageParams:[a.name]}}),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{team:a.team}});var t=this.getObjectById(e);if(t){this.setDataValue(t,"team",a.team),this.setDataValue(t,"avatar",a.avatar);var i=this.getObjectById(t.data.controllableId);i&&this.setDataValue(i,"team",a.team),this.killPawn(t.data.id)}}}getDisposableCrates(){for(var e=[],a=this.getCrates(),t=0;t<a.length;t++){let i=a[t];i.data&&i.data.bDisposable&&e.push(i)}return e}getFlagCTF(e){for(var a=this.getFlags(),t=0;t<a.length;t++){let i=a[t];if(i.data&&i.data.team==e)return i}return null}getFlagDomination(e){for(var a=this.getFlags(),t=0;t<a.length;t++){let i=a[t];if(i.data&&i.data.num==e)return i}return null}getFlags(){return this.getTypeArray(ObjectType.FLAG)}getDroppedWeapons(){return this.getTypeArray(ObjectType.DROPPED_WEAPON)}getSpawners(){return this.getTypeArray(ObjectType.SPAWNER)}getAutomatedTurrets(e){for(var a=[],t=this.getMountedWeapons(e),i=0;i<t.length;i++){let s=t[i];s.data&&s.data.bAutomated&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}getMountedWeapons(e){for(var a=[],t=this.getTypeArray(ObjectType.MOUNTED_WEAPON),i=0;i<t.length;i++){let s=t[i];s.data&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}getNumAutomatedTurrets(e){for(var a=[],t=this.getTypeArray(ObjectType.MOUNTED_WEAPON),i=0;i<t.length;i++){let s=t[i];s.data&&s.data.bAutomated&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}getNumMountedTurrets(e){for(var a=[],t=this.getTypeArray(ObjectType.MOUNTED_WEAPON),i=0;i<t.length;i++){let s=t[i];s.data&&!s.data.bAutomated&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}getNumMountedWeaponsOnTeam(e){for(var a=0,t=this.getTypeArray(ObjectType.MOUNTED_WEAPON),i=0;i<t.length;i++){let s=t[i];s.data&&!s.data.bDisabled&&s.data.team==e&&a++}return a}getAvailableVehicles(e){var a=[];for(var t in this.game.objects){let i=this.game.objects[t];!i.data||!i.data.health||i.data.bDisabled||-1!=i.data.team&&i.data.team!=e.data.team||this.isVehicle(i)&&this.hasAvailableSeat(i)&&a.push(i)}return a}useItem(e){var a=this.getPlayerById(e),t=this.getObjectById(e);if(!t)return!1;var i=t.data,s=a?a.team:i.team,r=!0,n=a?a.items:i.pawnItems;if(n&&n.length>0){var o=n[a&&null!=a.itemIndex?a.itemIndex:0].id,d=this.getItemData(o);if(!d)return console.warn("Invalid item"),!1;if(d.bAirdrop&&(this.getNumHelicoptersOnTeam(s,[Helicopter.MH6])>=5||this.getNumHelicoptersOnTeam(s,[Helicopter.SEAKNIGHT,Helicopter.OSPREY])>=3)&&(r=!1),d.type==ObjectType.TANK&&this.getTanks(0,!0).length>=this.settings.maxSurvivalTanks&&(r=!1),d.type==ObjectType.CAR&&this.getNumCars()>=this.settings.maxSurvivalCars&&(r=!1),d.type==ObjectType.MOUNTED_WEAPON&&this.getNumMountedWeaponsOnTeam(s)>=this.settings.maxSurvivalTurrets&&(r=!1),d.id==Item.BLACKHAWK&&this.getNumHelicoptersOnTeam(0,[Helicopter.BLACKHAWK])>=2&&(r=!1),d.type==ObjectType.HELICOPTER&&!d.bAirdrop&&this.getNumHelicoptersOnTeam(s,[Helicopter.COBRA,Helicopter.APACHE,Helicopter.KIOWA,Helicopter.BLACKHAWK])>=this.settings.maxSurvivalHelicopters&&(r=!1),d.type==ObjectType.EGG||d.type==ObjectType.DINOSAUR){var l={1:.25,2:.25,3:.5,4:.5};this.getNumDinosaursOnTeam(s)>=this.settings.maxSurvivalDinosaurs&&(r=!1)}if(r){if(d.bAirdrop){switch(d.id){case Item.QUAD:case Item.GROWLER:case Item.MRAP:case Item.LAV25:var h=200;break;case Item.ESCORT_AIRDROP:case Item.SUPPORT_AIRDROP:case Item.ABRAMS:case Item.T90:h=250;break;default:h=150}this.createTriggerArea({position:t.position,width:h,height:h,team:t.data.team,icon:d.id}).data.destroyTimer=6*this.game.settings.fps}var m=20;switch(o){case Item.EGG_COMPY:this.createEgg([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{eggType:Egg.LARGE,team:t.data.team,playerId:e,hatchTimer:3,items:[{type:ObjectType.DINOSAUR,dinoType:Dinosaur.COMPY,bRegenHealth:!0,bBot:!0,playerId:t.data.id,damageMultipliers:l},{type:ObjectType.DINOSAUR,dinoType:Dinosaur.COMPY,bRegenHealth:!0,bBot:!0,playerId:t.data.id,damageMultipliers:l},{type:ObjectType.DINOSAUR,dinoType:Dinosaur.COMPY,bRegenHealth:!0,bBot:!0,playerId:t.data.id,damageMultipliers:l}]});break;case Item.EGG_DILO:this.createEgg([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{eggType:Egg.LARGE,team:t.data.team,playerId:e,hatchTimer:3,items:[{type:ObjectType.DINOSAUR,dinoType:Dinosaur.DILO,bRegenHealth:!0,bBot:!0,botSkill:BotSkill.SKILL_NORMAL,playerId:t.data.id,damageMultipliers:l},{type:ObjectType.DINOSAUR,dinoType:Dinosaur.DILO,bRegenHealth:!0,botSkill:BotSkill.SKILL_NORMAL,bBot:!0,playerId:t.data.id,damageMultipliers:l}]});break;case Item.EGG_RAPTOR:this.createEgg([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{eggType:Egg.LARGE,team:t.data.team,playerId:e,hatchTimer:3,items:[{type:ObjectType.DINOSAUR,dinoType:Dinosaur.RAPTOR,bRegenHealth:!0,bBot:!0,botSkill:BotSkill.SKILL_INSANE,playerId:t.data.id,damageMultipliers:l}]});break;case Item.EGG_NEEDLER:this.createEgg([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{eggType:Egg.LARGE,team:t.data.team,playerId:e,hatchTimer:3,items:[{type:ObjectType.DINOSAUR,dinoType:Dinosaur.NEEDLER,bRegenHealth:!0,bBot:!0,botSkill:BotSkill.SKILL_HARD,playerId:t.data.id,damageMultipliers:l},{type:ObjectType.DINOSAUR,dinoType:Dinosaur.NEEDLER,bRegenHealth:!0,bBot:!0,botSkill:BotSkill.SKILL_HARD,playerId:t.data.id,damageMultipliers:l}]});break;case Item.EGG_ALLOSAURUS:this.createEgg([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{eggType:Egg.HUGE,team:t.data.team,playerId:e,hatchTimer:5,items:[{type:ObjectType.DINOSAUR,dinoType:Dinosaur.ALLOSAURUS,bRegenHealth:!0,bBot:!0,botSkill:BotSkill.SKILL_INSANE,playerId:t.data.id,damageMultipliers:l}]});break;case Item.EGG_SPINOSAURUS:this.createEgg([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{eggType:Egg.HUGE,team:t.data.team,playerId:e,hatchTimer:5,items:[{type:ObjectType.DINOSAUR,dinoType:Dinosaur.SPINOSAURUS,bRegenHealth:!0,bBot:!0,botSkill:BotSkill.SKILL_INSANE,playerId:t.data.id,damageMultipliers:l}]});break;case Item.SENTRY:case Item.SENTRY_SAM:case Item.SENTRY_FLAME:case Item.SENTRY_SHOTGUN:case Item.SENTRY_GRENADE:case Item.SENTRY_SNIPER:case Item.SENTRY_RAILGUN:var c=this.createMountedWeapon([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{team:i.team,playerId:i.id,vehicleId:o.substr(5),bAutomated:!0,bUnlimitedAmmo:!1});this.game.gameModeId==GameMode.EVOLUTION&&(this.setDataValue(c,"ammo",Math.round(.25*c.data.ammo)),this.setDataValue(c,"ammoMax",Math.round(.25*c.data.ammoMax)));break;case Item.M2:this.createMountedWeapon([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{angle:t.angle,team:i.team,playerId:i.id,vehicleId:o.substr(5),bUnlimitedAmmo:!1,ammo:1e3});break;case Item.BGM71:this.createMountedWeapon([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{angle:t.angle,team:i.team,playerId:i.id,vehicleId:o.substr(5),bUnlimitedAmmo:!1,ammo:20});break;case Item.M242:this.createMountedWeapon([t.position[0]+Math.cos(t.data.aimRotation)*m,t.position[1]+Math.sin(t.data.aimRotation)*m],{angle:t.angle,team:i.team,playerId:i.id,vehicleId:o.substr(5),bUnlimitedAmmo:!1,ammo:500});break;case Item.COBRA:case Item.BLACKHAWK:case Item.APACHE:case Item.KIOWA:if(this.getAttackHelicopters(i.id).length<2){var p=this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:o.substr(5),bAutomated:!0});if(p)switch(p.data.regenThreshold=.5,p.data.enemyThreshold=600,o){case Item.KIOWA:p.data.bKillOccupantsWhenDestroyed=!0,p.data.bLeaveWhenNoOccupants=!0;for(var g=0;g<2;g++){let e=this.getWeaponData(0==g?"m249":"l115a3");this.setRandomWeaponMods(e);let a=this.createCharacter({position:p.position,team:i.team,inventory:[{id:e.id,mods:e.mods}],equipment:"kevlar",damageMultipliers:{1:.5,2:.5,3:.5,4:.5},bUnlimitedAmmo:!0,bBot:!0,botSkill:BotSkill.SKILL_HARD,bInteract:!1,bCanInteract:!1,avatarId:AvatarPresets.DINOGEN_RANDOM});a&&(a.data.playerId=t.data.id,this.enterVehicle(a,p,g+1))}break;case Item.BLACKHAWK:p.data.bKillOccupantsWhenDestroyed=!0,p.data.bLeaveWhenNoOccupants=!0,p.data.seats[1].bInput=!0,delete p.data.weapons[1][0].weaponData,p.data.seats[2].bInput=!0,delete p.data.weapons[2][0].weaponData;let e=[{weaponId:"m240",avatarId:AvatarPresets.DINOGEN_RANDOM},{weaponId:"m60e4",avatarId:AvatarPresets.DINOGEN_RANDOM},{weaponId:"smaw",avatarId:AvatarPresets.DINOGEN_HEAVY},{weaponId:"smaw",avatarId:AvatarPresets.DINOGEN_HEAVY}];for(g=0;g<e.length;g++){let a=e[g],s=this.getWeaponData(a.weaponId);this.setRandomWeaponMods(s);let r=this.createCharacter({position:p.position,team:i.team,inventory:[{id:s.id,mods:s.mods}],equipment:"kevlar",damageMultipliers:{1:.5,2:.5,3:.5,4:.5},bUnlimitedAmmo:!0,bBot:!0,botSkill:BotSkill.SKILL_INSANE,bInteract:!1,bCanInteract:!1,pawnName:a.name,avatarId:a.avatarId,avatar:a.avatar});r&&(r.data.playerId=t.data.id,this.enterVehicle(r,p,g+1))}}}else r=!1;break;case Item.SUPPORT_AIRDROP:var E=[{type:ObjectType.EQUIPMENT,team:i.team,weaponId:"health_box"},{type:ObjectType.EQUIPMENT,team:i.team,weaponId:"trophy",offset:50},{type:ObjectType.EQUIPMENT,team:i.team,weaponId:this.RandomBoolean()?"jammer":"sensor",offset:50}];this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.MH6,weapons:[[{id:"m240"}]],bAutomated:!0,items:E,destination:this.clone(t.position),defendTimer:5*this.game.settings.fps});break;case Item.ESCORT_AIRDROP:var b=[];for(g=0;g<3;g++){switch(g){case 1:var u={type:ObjectType.CRATE,crateType:Crate.WEAPON,items:[{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0}]};break;case 2:u={type:ObjectType.CRATE,crateType:Crate.ITEM,itemId:this.getRandomItemId()};break;default:u={type:ObjectType.CRATE,crateType:Crate.AMMO}}b.push(u)}this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.OSPREY,bAutomated:!0,items:b,destination:this.clone(t.position),defendTimer:10*this.game.settings.fps});break;case Item.AMMO_AIRDROP:this.getCurrentMapData();this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.MH6,bAutomated:!0,items:[{type:ObjectType.CRATE,crateType:Crate.AMMO}],destination:this.clone(t.position)});break;case Item.WEAPON_AIRDROP:this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.MH6,bAutomated:!0,items:[{type:ObjectType.CRATE,crateType:Crate.WEAPON,items:[{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0}]}],destination:this.clone(t.position)});break;case Item.HEAVY_AIRDROP:this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.MH6,bAutomated:!0,items:[{type:ObjectType.CRATE,crateType:Crate.WEAPON,items:[{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomHeavyWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomHeavyWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomHeavyWeapon(),bRandomVelocity:!0}]}],destination:this.clone(t.position)});break;case Item.ABRAMS:case Item.T90:switch(o){case Item.ABRAMS:var I=Tank.ABRAMS;break;case Item.T90:I=Tank.T90}this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.SEAKNIGHT,bAutomated:!0,items:[{type:ObjectType.TANK,vehicleId:I}],destination:this.clone(t.position)});break;case Item.QUAD:case Item.GROWLER:case Item.MRAP:case Item.LAV25:if(this.getCars().length<this.settings.maxSurvivalCars){this.getCurrentMapData();switch(o){case Item.QUAD:var T=Car.QUAD;break;case Item.GROWLER:T=Car.GROWLER;break;case Item.MRAP:T=Car.MRAP;break;case Item.LAV25:T=Car.LAV25}this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{team:i.team,playerId:i.id,vehicleId:Helicopter.SEAKNIGHT,bAutomated:!0,items:[{type:ObjectType.CAR,vehicleId:T}],destination:this.clone(t.position)})}else r=!1;break;default:console.warn("Unhandled item",o)}}if(a&&a.bBot&&!r)return n.length>1&&(a.itemIndex++,a.itemIndex>=n.length&&(a.itemIndex=0)),!1;this.onEvent({eventId:GameServer.EVENT_USE_ITEM,playerId:e,itemId:o,team:s,bUnavailable:!r}),r&&(a?(n.splice(a.itemIndex,1),a.itemIndex=Math.max(0,Math.min(a.items.length-1,a.itemIndex)),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:{items:a.items,itemIndex:a.itemIndex}})):i.pawnItems.splice(0,1)),t&&(i.weapon.bEquipmentDelay=!0,i.weapon.equipmentDelayTimer=Math.round(.3*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:i.id,type:GameServer.PAWN_PLACE_EQUIPMENT,itemId:o}))}return r}getDrivableVehicles(e){for(var a=[],t=Object.keys(this.game.objects),i=0;i<t.length;i++){let s=this.game.objects[t[i]];s.data&&s.data.health&&this.isVehicle(s,!1)&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}onTickRateChanged(e){for(var a in console.log("onTickRateChanged",e),this.game.objects){let t=this.game.objects[a];if(t.data&&t.data.health){let a=t.data;switch(a.type){case ObjectType.HELICOPTER:case ObjectType.CAR:case ObjectType.TANK:a.speed&&(a.speed=Math.round(a.speed/e));break;case ObjectType.FLAG:a.captureTimerMax&&this.setDataValue(t,"captureTimerMax",Math.round(a.captureTimerMax*e))}switch(a.regenTimerMax&&(a.regenTimerMax=Math.round(a.regenTimerMax*e)),a.itemData&&a.itemData.interactTime&&(a.itemData.interactTime=Math.round(a.itemData.interactTime*e)),a.destroyTimer&&(a.destroyTimer=Math.ceil(a.destroyTimer*e)),a.type){case ObjectType.CHARACTER:let e=a.inventory[a.currentInventoryIndex];e&&e.reloadTime&&(a.reloadTimerMax=Math.round(Math.ceil(e.reloadTime*this.game.settings.fps)/a.reloadMultiplier),a.bReloading?a.reloadTimer=Math.min(a.reloadTimer,a.reloadTimerMax):a.reloadTimer=a.reloadTimerMax)}}}}getVehicles(e){for(var a=[],t=this.getTypes([ObjectType.CAR,ObjectType.TANK,ObjectType.HELICOPTER,ObjectType.MOUNTED_WEAPON]),i=0;i<t.length;i++){let s=t[i];s.data&&s.data.health&&(e?s.data.playerId==e&&a.push(s):a.push(s))}return a}getNumCars(e){for(var a=0,t=this.getTypes([ObjectType.CAR,ObjectType.HELICOPTER]),i=0;i<t.length;i++){let r=t[i];if(r.data&&r.data.health&&!r.data.bDisabled)switch(r.data.type){case ObjectType.HELICOPTER:if(r.data.items)for(var s=0;s<r.data.items.length;s++){let t=r.data.items[i];t&&t.type==ObjectType.CAR&&(e?e.indexOf(t.vehicleId)>=0&&a++:a++)}break;case ObjectType.CAR:e?e.indexOf(r.data.vehicleId)>=0&&a++:a++}}return a}getCars(e,a){for(var t=[],i=this.getTypeArray(ObjectType.CAR),s=0;s<i;s++){let r=i[s];if(r.data&&r.data.health)switch(r.data.type){case ObjectType.CAR:e?e.indexOf(r.data.vehicleId)>=0&&(null!=a&&r.data.team!=a||t.push(r)):null!=a&&r.data.team!=a||t.push(r)}}return t}getTanks(e,a){for(var t=[],i=this.getTypes([ObjectType.TANK,ObjectType.HELICOPTER]),s=0;s<i.length;s++){let n=i[s];if(n.data)switch(n.data.type){case ObjectType.TANK:if(a&&n.data.bDisabled)continue;null!=e&&n.data.team!=e||t.push(n);break;default:let i=n.data.items;if(i)for(var r=0;r<i.length;r++){let s=i[r];if(s.type==ObjectType.TANK){if(a&&s.bDisabled)continue;null!=e&&n.data.team!=e||t.push(n)}}}}return t}getTriggerAreas(){return this.getTypeArray(ObjectType.TRIGGER_AREA)}getObstacles(){return this.getTypeArray(ObjectType.OBSTACLE)}getTrees(){return this.getTypeArray(ObjectType.TREE)}getObstaclesWithHealth(e){for(var a=[],t=this.getObstacles(),i=0;i<t.length;i++){let s=t[i];s.data&&(s.data.bPendingRemoval||!s.data.health||s.data.bGodMode||e&&e!=s.data.playerId||a.push(s))}return a}hasNearbyJammer(e){for(var a=this.getEquipment("jammer"),t=0;t<a.length;t++){let i=a[t];if(i.data&&i.data.team!=e.data.team&&this.DistBodies(e,i)<=.5*i.data.weaponData.radius)return!0}return!1}hasNearbyMotionSensor(e){for(var a=this.getEquipment("sensor"),t=0;t<a.length;t++){let i=a[t];if(i.data&&i.data.team!=e.data.team&&this.DistBodies(e,i)<=.5*i.data.weaponData.radius&&this.checkLineOfSight(e.position[0],e.position[1],i.position[0],i.position[1]))return!0}return!1}getMines(e){for(var a=[],t=this.getEquipment(),i=0;i<t.length;i++){let e=t[i];e.data&&e.data.weaponData.bMine&&a.push(e)}return a}getEquipment(e){for(var a=[],t=this.getTypeArray(ObjectType.EQUIPMENT),i=0;i<t.length;i++){var s=t[i];s.data&&(e&&s.data.weaponData.id!=e||a.push(s))}return a}ejectFlare(e,a){var t=e.data,i=this.getWeaponData("rocket_flare");this.createRocket(e.position,{rocketType:Rocket.DEFAULT,team:t.team,playerId:t.playerId?t.playerId:t.id,causerId:t.id,angle:a?this.Angle(e.position[0],e.position[1],a.position[0],a.position[1])+this.ToRad(90):this.RandomAngle(),weaponId:i.id,damage:i.damage,radius:i.radius})}getIncomingGuidedRocket(e){for(var a=this.getRockets(),t=0;t<a.length;t++){let i=a[t],s=i.data;if(s&&s.enemyId==e.data.id&&this.DistBodies(e,i)<1500)return i}return null}getNearbyFlare(e){for(var a=this.getRockets(),t=0;t<a.length;t++){let i=a[t];if(i.data&&"rocket_flare"==i.data.weaponId&&i.data.team!=e.data.team&&this.DistBodies(e,i)<1500)return i}return null}getRockets(){return this.getTypeArray(ObjectType.ROCKET)}getSmokeGrenades(){for(var e=[],a=this.getGrenades(null,"smoke"),t=0;t<a.length;t++){let i=a[t];i.data&&"smoke"==i.data.weaponId&&i.data.bActivated&&e.push(i)}return e}getGrenades(e,a){for(var t=[],i=this.getTypeArray(ObjectType.GRENADE),s=0;s<i.length;s++){var r=i[s];if(r.data){if(a&&r.data.weaponId!=a)continue;e?e==r.data.playerId&&t.push(r):t.push(r)}}return t}useCharacterEquipment(e,a,t,i){if(this.characterCanUseEquipment(e,a)){var s=e.data,r=s[a],n=!0,o=s.desiredAimRotation?s.desiredAimRotation:s.aimRotation;switch(r.type){case Weapon.TYPE_GRENADE:s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.4*this.game.settings.fps);var d=Math.min(1200,1.5*this.Dist(t,i,e.position[0],e.position[1])),l=50,h=s.bBot?this.Angle(e.position[0],e.position[1],t,i):o;this.createGrenade([e.position[0]+Math.cos(h)*l,e.position[1]+Math.sin(h)*l],{team:s.team,playerId:s.id,causerId:s.id,rotation:h,velocity:d,damage:r.damage,weaponData:r,weaponId:r.id,bStartDetonationAfterHit:r.bStartDetonationAfterHit,bImpact:r.bImpact}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_THROW_GRENADE,weaponId:r.id});break;default:switch(r.id){case"blowtorch":console.log(r);break;case"ammo_box":var m=this.createEquipment(this.clone(e.position),{team:s.team,angle:s.aimRotation,ownerId:s.id,weaponData:r,itemData:{uses:10,maxUses:10,interactTime:.5}});m.data.destroyTimer=180*this.game.settings.fps;var c=Math.min(400,5*this.Dist(t,i,e.position[0],e.position[1]));m.applyImpulse([Math.cos(o)*c,Math.sin(o)*c],0,0),s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.5*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_THROW_GRENADE,weaponId:r.id});break;case"molotov":s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.4*this.game.settings.fps);d=Math.min(1200,2*this.Dist(t,i,e.position[0],e.position[1]));l=0;h=s.bBot?this.Angle(e.position[0],e.position[1],t,i):o;this.createGrenade([e.position[0]+Math.cos(h)*l,e.position[1]-30+Math.sin(h)*l],{team:s.team,playerId:s.id,causerId:s.id,rotation:h,velocity:d,damage:r.damage,weaponData:r,weaponId:r.id,bStartDetonationAfterHit:r.bStartDetonationAfterHit,bImpact:r.bImpact}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_THROW_GRENADE,weaponId:r.id});break;case"c4":let a=this.getGrenades(s.id,"c4");a.length>=4&&this.removeNextStep(a[0]),s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.3*this.game.settings.fps);d=Math.min(600,4*this.Dist(t,i,e.position[0],e.position[1]));l=0,this.createGrenade([e.position[0]+Math.cos(o)*l,e.position[1]+Math.sin(o)*l],{team:s.team,playerId:s.id,causerId:s.id,rotation:o,velocity:d,weaponData:r,damage:r.damage,weaponId:r.id}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_THROW_GRENADE,weaponId:r.id});break;case"juice":this.setDataValue(e,"health",Math.max(s.health,.5*s.maxHealth)),this.setDataValue(e,"bJuiced",!0),s.juiceTimer=this.game.settings.fps*(this.game.bSurvival?10:5),s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.5*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_USE_STIM,weaponId:r.id});break;case"stim":if(s.health>=s.maxHealth){n=!1;var p=this.getNearestFriendlyPawn(e,{maxRange:100,bInjured:!0,pawnTypes:[ObjectType.CHARACTER,ObjectType.DINOSAUR]});if(p){n=!0;var g=p.data;g.health=g.maxHealth,this.pushObjectDataUpdate(g.id,["health"]),s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.5*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_USE_STIM,bAlly:!0}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:g.id,type:GameServer.PAWN_RECEIVE_STIM})}}else s.health=s.maxHealth,this.pushObjectDataUpdate(s.id,["health"]),s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.5*this.game.settings.fps),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_USE_STIM,weaponId:r.id});break;case"knife":case"spear":s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.5*this.game.settings.fps);d=200,l=0;this.createProjectile([e.position[0]+Math.cos(o)*l,e.position[1]+Math.sin(o)*l],o,s.team,{playerId:s.id,causerId:s.id,rotation:o,velocity:d,damage:r.damage,weaponId:r.id}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_THROW_GRENADE,weaponId:r.id});break;case"deployable_cover":var E=this.getObstaclesWithHealth(s.id);E.length>=2&&this.removeNextStep(E[0]),s.weapon.bEquipmentDelay=!0,s.weapon.equipmentDelayTimer=Math.round(.3*this.game.settings.fps),l=30,this.createObstacle({type:ObjectType.OBSTACLE,position:[e.position[0]+Math.cos(o)*l,e.position[1]+Math.sin(o)*l],angle:s.aimRotation,obstacleId:"deployable_cover",playerId:s.id,health:this.game.bSurvival?5e3:1e3}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_PLACE_EQUIPMENT,weaponId:r.id});break;default:if("beacon"!=r.id&&"tac_insert"!=r.id||this.removeEquipmentByPlayerId(s.id,r.id),r.bPassive)n=!1;else if(r.bThrowable){s.weapon.bThrowDelay=!0,s.weapon.throwDelayTimer=Math.round(.3*this.game.settings.fps);var b=this.createEquipment(this.clone(e.position),{team:s.team,angle:s.aimRotation,ownerId:s.id,weaponData:r});if(b){c=Math.min(400,4*this.Dist(t,i,e.position[0],e.position[1]));var u=o;b.applyImpulse([Math.cos(u)*c,Math.sin(u)*c],0,0)}this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_THROW_GRENADE,weaponId:r.id})}else{s.weapon.bEquipmentDelay=!0,s.weapon.equipmentDelayTimer=Math.round(.3*this.game.settings.fps);var I=[e.position[0],e.position[1]];this.createEquipment(I,{team:s.team,angle:s.aimRotation,ownerId:s.id,weaponData:r}),this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:s.id,type:GameServer.PAWN_PLACE_EQUIPMENT,weaponId:r.id})}}}n&&(this.cancelCharacterReload(e),this.cancelCharacterBoltPull(e),r.ammo--,this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:s.id,type:GameServer.INV_EQUIPMENT,slot:a}))}}deployParachute(e){var a=e.data;a.bParachute||(this.cancelCharacterBoltPull(e),this.cancelCharacterReload(e),a.bParachute=!0,e.damping=this.getSharedData(ObjectType.CHARACTER).parachuteDamping,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_PARACHUTE,value:!0}))}removeParachute(e){var a=e.data;a.bParachute&&(a.bParachute=!1,e.damping=this.getSharedData(ObjectType.CHARACTER).damping,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_PARACHUTE,value:!1}))}triggerCharacterWeapon(e){var a=e.value;this.matchHasEnded()&&(a=!1);var t=this.getObjectById(e.playerId),i=this.getPlayerById(e.playerId),s=i?this.getObjectById(i.controllableId):null;if(s)switch(s.data.type){case ObjectType.ROCKET:return void(a&&this.detonate(s));case ObjectType.MOUNTED_WEAPON:case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:if(t&&null!=t.data.seatIndex){if(s.data.weapons){var r=this.getCurrentVehicleWeapon(s,t.data.seatIndex);r&&(r.bWantsToFire=a&&!t.data.seatTimer,a&&!t.data.bBot&&null!=r.ammo&&0==r.ammo&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.data.id,type:GameServer.PAWN_NO_AMMO}))}var n=this.getSeatData(t);if(!n||!n.bInput)return}}if(t)if(e.worldPosition&&(t.data.inputPosition=e.worldPosition),e.value&&!t.data.seatTimer){var o=t.data.bWantsToFire;t.data.bWantsToFire=!0;var d=this.getCurrentCharacterInventoryItem(t);if(d&&d.mag>0)o||t.data.bReloading||this.onStartWeaponFire(t),t.data.weapon.bFireHandler=!0;else if(d&&0==d.ammo&&!t.data.weapon.bUnlimitedAmmo){if(this.getCurrentCharacterInventoryItem(t,!1).bBarrel)this.toggleUnderbarrelEquipped(t);else if(t.data.bBot){var l=1==t.data.currentInventoryIndex?0:1,h=t.data.inventory[l];h&&(h.mag>0||h.ammo>0)&&this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE_INVENTORY,pawnId:t.data.id,type:GameServer.INV_CURRENT_INVENTORY_INDEX,value:l})}t.data.bBot||this.characterIsFree(t)&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.data.id,type:GameServer.PAWN_NO_AMMO})}else this.reloadCharacterWeapon(t)}else t.data.bWantsToFire&&this.onEndWeaponFire(t),t.data.bWantsToFire=!1}onPlayerKill(e,a,t,i,s){var r=this.game,n=(this.getObjectById(i),this.getPlayerById(e)),o=this.getObjectById(e);!n&&o&&o.data.playerId&&(n=this.getPlayerById(o.data.playerId)),!n&&o&&this.game.scenario&&(n={id:e,team:o.data.team});var d=e==t,l=!0,h=this.getObjectById(t);if(n){var m=n.killedBy;if(m){var c=m.indexOf(t);if(c>=0){var p=!0;m.splice(c)}}var g=!d&&!!h&&n.team==h.data.team;if(!d&&!g){if(l=!!h&&(h.data.type==ObjectType.CHARACTER||h.data.type==ObjectType.DINOSAUR||h.data.type==ObjectType.DUMMY)){n.kills++,s.bHeadshot&&n.headshots++,s.bMelee&&n.melees++,n.multiKillTimer=this.game.settings.fps,n.multiKillCount||(n.multiKillCount=0),n.multiKillCount++,n.bBot&&1==this.Random(1,10-n.botSkill)&&this.setPawnRequest(this.getObjectById(n.id),Commands.TAUNT);var E=this.getPlayerById(t);if(this.isTeamGameMode()){if(n.avengerTimer=this.game.settings.fps,E&&E.avengerTimer>0)var b=!0;if(h){var u=h.data.damagedBy;if(u&&u.length>0)for(var I=0;I<u.length;I++)if(u[I]!=e){let e=this.getPlayerById(u[I]);e&&(e.assists++,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:u[I],data:{assists:e.assists}}))}}}}var T={eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:e,data:{kills:n.kills,headshots:n.headshots,melees:n.melees,currentKillstreak:n.currentKillstreak,bRevenge:p,bAvenger:b}};if(!r.bSurvival){var v={};switch(this.game.bScenario||!h||h.data.type!=ObjectType.CHARACTER&&h.data.type!=ObjectType.DINOSAUR||r.gameModeData.bFirstBlood||(v.firstBloodPlayerId=e,r.gameModeData.bFirstBlood=!0),r.gameModeId){case GameMode.FREE_FOR_ALL:l&&(v.bPlayerKill=!0,n.kills>=r.gameModeData.scoreLimit&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:n.team,playerId:n.id,cameraTargetId:n.id}));break;case GameMode.EVOLUTION:l&&1==n.team&&this.addEvolutionKill(n?n.id:null);break;case GameMode.TEAM_DEATHMATCH:case GameMode.TYRANT:case GameMode.RAPTOR_HUNT:case GameMode.HUMANS_VS_DINOSAURS:if(l){var y=r.gameModeData.scores;y[n.team]++,v.scores=y,r.gameModeId==GameMode.TYRANT?0==n.team?this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_TREX_KILLED,winningTeam:n.team,cameraTargetId:n.id}):y[n.team]>=r.gameModeData.scoreLimit&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:n.team,playerId:this.getPlayersOnTeam(1).id,cameraTargetId:n.id}):y[n.team]>=r.gameModeData.scoreLimit&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:n.team,cameraTargetId:n.id})}}}if((r.bSurvival||r.gameSettings.bEarnMoneyForKills)&&h)switch(h.data.type){case ObjectType.CHARACTER:case ObjectType.CAR:case ObjectType.HELICOPTER:case ObjectType.MOUNTED_WEAPON:case ObjectType.TANK:case ObjectType.DINOSAUR:case ObjectType.EGG:var A=h.data.reward?h.data.reward:100;s.bMelee?A*=2:s.bHeadshot&&(A*=1.5),this.addPlayerMoney(n.id,A)}this.onEvent(T),v&&Object.keys(v).length>0&&this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:v})}}}triggerCallback(e,a){this.game&&this.game.callbacks&&this.game.callbacks[e]&&this.game.callbacks[e](a)}onObjectDeath(e,a,t,i,s){var r=this.getPlayerById(e),n=this.getObjectById(e),o=n.data,d=o.team,l=null,h=0,m=0,c=Math.min(1e3,5*a),p=this.Random(-c,c),g=0,E=this.getObjectById(i);if(E){g=this.Angle(E.position[0],E.position[1],n.position[0],n.position[1])+this.ToRad(this.Random(-15,15)),isNaN(g)&&console.warn("Invalid ragdoll rad");var b=Math.max(100,30*a),u=s.damageType==DamageType.DAMAGE_EXPLOSIVE?1e4:8e3;b=Math.max(2e3,Math.min(b,u)),h=Math.round(Math.cos(g)*b),m=Math.round(Math.sin(g)*b)}switch(this.clearPlayerControllable(e),n.constraint&&(this.game.world.removeConstraint(n.constraint),delete n.constraint),o.type){case ObjectType.CHARACTER:this.triggerCallback("onPlayerKill");break;case ObjectType.DINOSAUR:this.triggerCallback("onDinoKill");break;case ObjectType.HELICOPTER:this.triggerCallback("onHeliKill");break;case ObjectType.CAR:case ObjectType.TANK:this.triggerCallback("onVehicleKill");break;case ObjectType.EGG:this.triggerCallback("onEggKill")}var I=this.getPlayerById(t);switch(this.dispatchTrigger({event:"objectKilled",objectId:e,type:o.type,team:o.team,killerId:t,killerTeam:I?I.team:null,playerId:r?r.id:null,playerIndex:r?this.game.players.indexOf(r):null,playerName:r?r.name:null}),o.type){case ObjectType.OBSTACLE:switch(o.obstacleId){case"barrel_explosive":case"barrel_poison":case"barrel_oil":this.detonate(n);break;default:this.removeNextStep(n)}break;case ObjectType.ROCKET:this.detonate(n);break;case ObjectType.GRENADE:"c4"!=o.weaponId||_data.bMelee||this.detonate(n),this.removeNextStep(n);break;case ObjectType.TANK:case ObjectType.CAR:case ObjectType.MOUNTED_WEAPON:for(var T=o.seats,v=0;v<T.length;v++){let e=T[v];if(e.pawnId){let a=e.pawnId;this.exitVehicle(this.getObjectById(a)),this.clearPlayerControllable(a),o.bKillOccupantsWhenDestroyed?this.killPawn(a):(!this.game.bSurvival||n.data.team>=1)&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:n.data.maxHealth,pawnId:a,attackerId:t,causerId:i,weaponId:s.weaponId})}}var y=this.getSharedData(n.data.vehicleId);this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:n.position,radius:Math.max(y?y.width:150,150),damage:this.settings.vehicleExplosionDamage,playerId:null,causerId:null,weaponId:null}),this.removeNextStep(n);break;case ObjectType.HELICOPTER:for(T=o.seats,v=0;v<T.length;v++){let e=T[v];if(e.pawnId){let a=e.pawnId;this.exitVehicle(this.getObjectById(a)),this.clearPlayerControllable(a),o.bKillOccupantsWhenDestroyed?this.killPawn(a):(!this.game.bSurvival||n.data.team>=1)&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:n.data.maxHealth,pawnId:a,attackerId:t,causerId:i,weaponId:s.weaponId})}}this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:n.position,radius:400,damage:this.settings.vehicleExplosionDamage,playerId:null,causerId:null,weaponId:null}),this.removeNextStep(n);break;case ObjectType.CHARACTER:case ObjectType.DINOSAUR:this.stopCharacterInteract(n);var A=this.getWeaponData(s.weaponId),O=1==n.data.bZombie;if(s.damageType==DamageType.DAMAGE_EXPLOSIVE&&(O=a>=100),A&&!O){switch(A.round){case"50bmg":case"408":case"25mm":O=!0}switch(A.type){case Weapon.TYPE_SHOTGUN:O=s.bNearshot;break;default:O=a>200}switch(A.id){case"melee_katana":case"melee_machete":case"melee_hatchet":case"minigun":case"gatling":case"m2":case"mg42":case"m242":O=!0}A.bDinosaur&&A.type==Weapon.TYPE_MELEE&&a>100&&(O=!0)}if(l={id:this.getRandomUniqueId(),x:Math.round(n.position[0]),y:Math.round(n.position[1]),rotation:g,type:"ragdoll",vx:-h,vy:-m,va:p,data:{damageAmount:a,damageType:s.damageType,type:n.data.type,bGib:O&&!n.data.bJuggernaut,dinoType:n.data.dinoType,bSavage:n.data.bSavage,objectScale:n.data.objectScale,team:n.data.team,tint:n.data.colour},playerId:e},o.interactableId){var R=this.getObjectById(n.data.interactableId);R&&R.data.bLimitInteractions&&delete R.data.currentPawnId}if(n.data.type==ObjectType.CHARACTER){var M=!this.game.bSurvival||0!=n.data.team;this.game.gameModeData.bAllowRevives&&r?M=!1:null!=n.data.bDropWeapons&&(M=1==n.data.bDropWeapons),M&&(n.data.bDropWeapons||1==this.Random(1,this.game.bSurvival?30:20))&&this.dropCharacterWeapon(n,n.data.currentInventoryIndex)}if(this.game.bSurvival&&0!=n.data.team&&!this.game.gameSettings.bDisableMoneyDrops&&(n.data.bSavage||n.data.bJuggernaut)){var _=5;for(v=0;v<_;v++){(G=this.createMoney(n.position,{value:Math.min(500,this.RoundToNearest(n.data.maxHealth/_)),destroyTimer:60})).applyImpulse([this.Random(-500,500),this.Random(-500,500)]),G.angularVelocity=this.Random(-10,10)}}this.removeNextStep(n);break;case ObjectType.EGG:if(this.game.bSurvival&&0!=n.data.team&&!this.game.gameSettings.bDisableMoneyDrops)for(_=5,v=0;v<_;v++){(G=this.createMoney(n.position,{value:Math.min(500,this.RoundToNearest(n.data.maxHealth/_)),destroyTimer:60})).applyImpulse([this.Random(-500,500),this.Random(-500,500)]),G.angularVelocity=this.Random(-10,10)}this.removeNextStep(n);break;default:this.removeNextStep(n)}if((L=o.items)&&o.bDropItemsWhenDestroyed){for(v=0;v<L.length;v++){var D=L[v];this.spawnItem(D,n.position,o.team)}o.items=null}if(r){r.deaths++;var S=r.killedBy;if(S&&t&&-1==S.indexOf(t)&&S.push(t),this.endMultiKill(r),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:e,data:{deaths:r.deaths,currentKillstreak:r.currentKillstreak,bHasPawn:!1}}),r.controllableId){var N=this.getObjectById(r.controllableId);if(N)switch(N.data.type){case ObjectType.MOUNTED_WEAPON:this.clearPlayerControllable(r.id)}}(this.game.bSurvival||this.game.gameModeData.bAllowRevives)&&(r.inventory=[n.data.inventory[0],n.data.inventory[1]],r.melee=n.data.inventory[Character.INDEX_MELEE]?n.data.inventory[Character.INDEX_MELEE].id:n.data.melee,r.equipment=n.data.equipment?n.data.equipment:null,r.grenade=n.data.grenade?n.data.grenade:null)}var C=i;if(E)switch(E.data.type){case ObjectType.ROCKET:C=E.data.causerId;break;case ObjectType.GRENADE:C=E.data.playerId}var P=null!=r&&(n.data.type==ObjectType.CHARACTER||n.data.type==ObjectType.DINOSAUR)&&this.game.gameModeData.bAllowRevives&&0==d&&this.getNumPawnsOnTeam(0)>=1;if(this.game.bScenario,this.onEvent({eventId:GameServer.EVENT_PAWN_DIE,data:{id:e,damageAmount:a,killerId:t,causerId:C,damageInfo:s,ragdoll:l,bReviver:P}}),P){this.createReviver([n.position[0],n.position[1]-30],[.5*h,.5*m],p,this.game.bOperation,{playerId:e,interactTime:1*this.game.settings.fps,interactTeam:o.team,ragdoll:l.data});if(r.money>0&&!this.game.gameSettings.bDisableMoneyDrops){var f=1e3,w=Math.min(0,r.money-f);this.addPlayerMoney(r.id,-1e3);for(_=5,v=0;v<_;v++){var G;(G=this.createMoney(n.position,{value:this.RoundToNearest((f+w)/_),destroyTimer:60})).applyImpulse([this.Random(-500,500),this.Random(-500,500)]),G.angularVelocity=this.Random(-10,10)}}}if(this.game.bScenario)this.getNumPawnsOnTeam(0,!0)<=0&&(this.game.gameModeData.bAllowRespawns||this.game.gameSettings.bDeathmatch||this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_KIA,result:MatchState.END_RESULT_LOSS}));else if(this.game.bSurvival)if(0==d)this.getNumPawnsOnTeam(0,!0)<=0&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_KIA,result:MatchState.END_RESULT_LOSS,winningTeam:1,cameraTargetId:n.data.id});else if(1==d){this.game.gameModeData.kills++,this.game.gameModeData.waveKills++,s.bMelee?this.game.gameModeData.waveMelees++:s.bHeadshot&&this.game.gameModeData.waveHeadshots++,this.game.gameModeData.killTypes&&(null==this.game.gameModeData.killTypes[n.data.type]&&(this.game.gameModeData.killTypes[n.data.type]=0),this.game.gameModeData.killTypes[n.data.type]++);var k=0;switch(n.data.type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:k++;break;case ObjectType.EGG:case ObjectType.HELICOPTER:var L;if(L=n.data.items)for(v=0;v<L.length;v++){let e=L[v];switch(e.type){case ObjectType.MOUNTED_WEAPON:case ObjectType.CHARACTER:case ObjectType.DINOSAUR:k++;break;case ObjectType.CAR:e.bAutomated&&k++,e.characters&&(k+=e.characters.length)}}}n.data.bAutomated&&(n.data.items?console.log(n.data.items):k++),k>0&&(this.game.gameModeData.enemiesRemaining=Math.max(0,this.game.gameModeData.enemiesRemaining-k),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{enemiesRemaining:this.game.gameModeData.enemiesRemaining,kills:this.game.gameModeData.kills}}),this.game.gameModeData.enemiesRemaining<=0&&this.onSurvivalWaveComplete())}}createReviver(e,a,t,i,s){var r=this.getSharedData(ObjectType.REVIVER),n=new this.p2.Body({mass:r.mass,damping:r.damping,position:e,allowSleep:!0,sleepSpeedLimit:1,fixedRotation:!0});if(n.data={id:this.getRandomUniqueId(),x:e[0],y:e[1],type:ObjectType.REVIVER,bLimitInteractions:!0,team:s.interactTeam,itemData:s,value:10},i){var o=30;this.game.bOperation&&(o=30-5*this.game.gameModeData.difficulty),n.data.bleedTimerMax=this.game.settings.fps*o,n.data.bleedTimer=n.data.bleedTimerMax}var d=new this.p2.Circle({radius:r.size?r.size:r.width,collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.GROUND|CollisionGroups.BOUNDS});return n.addShape(d),this.addWorldBody(n),n.applyImpulse([a[0],a[1]],0,0),n.angularVelocity=t,this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.REVIVER,position:n.position,velocity:n.velocity,data:n.data}),n}dropAllCharacterWeapons(e){var a=e.data,t=a.aimRotation;-1==a.scale&&(t+=this.ToRad(-180));for(var i=a.inventory,s=0;s<i.length;s++){var r=i[s];if(r){if(r.bZombie||"none"==r.id)continue;var n=this.Random(100,150),o=Math.cos(a.aimRotation)*n,d=Math.sin(a.aimRotation)*n,l=this.createDroppedWeapon([e.position[0],e.position[1]],{angle:t+this.ToRad(30*s),scale:a.scale,weaponData:r,velocity:[o,d],angularVelocity:this.Random(0,5)});l&&(l.applyImpulse([this.Random(-500,500),this.Random(-500,500)],[0,0]),l.angularVelocity=this.Random(-10,10))}}}dropCharacterEquipment(e,a){var t=e.data,i=t.aimRotation;-1==t.scale&&(i+=this.ToRad(-180));var s=t[a];if(s&&(s.ammo>0||s.type==Weapon.TYPE_MELEE)){if("none"==s.id)return;var r=this.Random(100,150),n=Math.cos(t.aimRotation)*r,o=Math.sin(t.aimRotation)*r;this.createDroppedWeapon([e.position[0],e.position[1]],{angle:i,scale:t.scale,weaponData:this.clone(s),velocity:[n,o],angularVelocity:this.Random(0,5)})}}dropCharacterWeapon(e,a){var t=e.data,i=t.aimRotation;-1==t.scale&&(i+=this.ToRad(-180));var s=t.inventory[a];if(s&&!s.bZombie&&"none"!=s.id){var r=this.Random(120,150),n=Math.cos(t.aimRotation)*r,o=Math.sin(t.aimRotation)*r;this.createDroppedWeapon([e.position[0],e.position[1]],{angle:i,scale:t.scale,weaponData:s,velocity:[n,o],angularVelocity:this.Random(0,5)})}}characterCanInteract(e,a){var t=e.data,i=this.getPlayerById(t.id);if(i&&i.controllableId)return!1;if(a){switch(a.data.type){case ObjectType.DROPPED_WEAPON:if(t.type==ObjectType.DINOSAUR)return 1==this.game.gameSettings.bAllowDinosaurPickups}if(a.data.bDisabled)return!1;if(null!=a.data.interactTeam&&a.data.interactTeam!=t.team)return!1;if(a.data.bLimitInteractions&&a.data.currentPawnId)return!1}return!t.bInteracting}characterIsFree(e){var a=e.data;return!!this.seatCanInput(e)&&(!a.bShieldCooldown&&(!a.bInteracting&&!this.characterHasWeaponDelay(e)&&!a.bReloading))}onVehicleImpact(e,a){var t=e.data,i=a.data;if(this.vehicleHasOccupant(a)){var s=5e-5*(a.velocity[0]*a.velocity[0]+a.velocity[1]*a.velocity[1])*a.mass;s>=50&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_WORLD,damageAmount:s,pawnId:t.id,attackerId:this.getVehicleDriverId(a),causerId:i.id,weaponId:i.vehicleId})}}characterCanUseEquipment(e,a){var t=e.data,i=this.getObjectById(t.controllableId);if(i&&this.isVehicle(i)&&e){var s=this.getSeatData(e);if(!s||!s.bInput)return!1}var r=t[a];return!!r&&(!r.bSprintUse&&t.bSprinting,!t.bInteracting&&!this.characterHasWeaponDelay(e)&&!t.bShieldCooldown)}characterCanFire(e,a){if(!this.matchInProgress())return!1;if(!this.seatCanInput(e))return!1;var t=this.getCurrentCharacterInventoryItem(e);if(!t)return!1;if(a&&!(t.bDinosaur||!!this.isMeleeWeapon(t)||t.mag>0))return!1;var i=e.data;if(t.bRequireLock&&!i.lockOnTargetId)return!1;var s=i.weapon;return!(i.bInteracting||i.bReloading||this.characterHasWeaponDelay(e)||s.bBoltDelay||i.bSprinting||i.bShieldCooldown)}createImpactEffect(e,a,t,i,s){this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,data:{id:this.getRandomUniqueId(),x:Math.round(e),y:Math.round(a),type:"impactEffect",rotation:this.RoundDecimal(t),impactType:i,intensity:s}})}createImpactEffects(e){this.batchData.length>=this.settings.maxBatchItems||e&&e.length>0&&this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,data:{type:"impactEffect",items:e}})}startSurvivalWaveIntermission(){var e=this.game.gameModeData;e.intermissionTimer=this.settings.intermissionTimer*(e.wave>=10?2:1),e.waveTimer=this.game.settings.fps,e.bIntermission=!0,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{timer:e.intermissionTimer,bIntermission:e.bIntermission}}),this.dispatchTrigger({event:"survivalIntermissionStarted",wave:e.wave})}startSurvivalWave(){var e=this.game.gameModeData;e.bIntermission=!1,e.wave++,e.waveKills=0,e.waveHeadshots=0,e.waveMelees=0,e.waveRevives=0,e.killTypes={};var a,t=e.wave;switch(e.numEnemies=Math.min(100,15*t),this.game.gameModeId){case GameMode.SURVIVAL_CHAOS:if(15==t)var i="TIP_SURVIVAL_FLARES";12==t?(e.numEnemies=8,a="carnotaurus"):8==t?(e.numEnemies=10,a="stegosaurus"):3==t?(a="helicopter",e.numEnemies=5):t%25==0?(a="trex",e.numEnemies=Math.min(10,Math.round(t/25)+1)):t%5==0&&(a=10==t?"needler":"juggernaut",e.numEnemies=Math.min(10,5*Math.round(t/5)));break;case GameMode.SURVIVAL_MILITIA:if(15==t)i="TIP_SURVIVAL_FLARES";30==t?e.numEnemies=3:12==t?e.numEnemies=5:3==t?(a="helicopter",e.numEnemies=1):t%5==0&&(a="juggernaut",e.numEnemies=Math.round(t/5)+1);break;case GameMode.SURVIVAL_DINO:3==t?(e.numEnemies=5,a="dilo"):5==t?(a="raptor",e.numEnemies=5):8==t?(e.numEnemies=5,a="stegosaurus"):10==t?(a="needler",e.numEnemies=8):12==t?(a="carnotaurus",e.numEnemies=5):15==t?(a="allosaurus",e.numEnemies=3):20==t?(a="spinosaurus",e.numEnemies=3):t%25==0?(a="trex",e.numEnemies=Math.round(t/25)):t>25&&t%5==0&&(e.numEnemies=50);break;case GameMode.SURVIVAL_ZOMBIE:t%5==0&&(a="juggernaut",e.numEnemies=Math.min(100,t/5*2)),e.spawnTimer=Math.round(this.game.settings.fps*Math.max(.1,1.5-.1*t));break;case GameMode.SURVIVAL_CHICKEN:t%5==0?(a="helicopter",e.numEnemies=Math.min(100,t/5*2)):e.numEnemies=25*t,e.spawnTimer=Math.round(.1*this.game.settings.fps)}e.numEnemies=Math.min(100,e.numEnemies),e.enemiesSpawned=0,e.enemiesRemaining=e.numEnemies,e.spawnTimer=e.spawnTimer?e.spawnTimer:Math.round(this.game.settings.fps*Math.max(.1,1.5-.05*t)),e.spawnTimerMax=e.spawnTimer,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{intermissionTimer:e.intermissionTimer,wave:e.wave,enemies:e.enemies,enemiesRemaining:e.enemiesRemaining,bWaveStart:!0,waveType:a,tipId:i,timer:-1}}),this.dispatchTrigger({event:"survivalWaveStarted",wave:e.wave,numEnemies:e.numEnemies,waveType:a})}spawnSurvivalEnemyVehicle(e){this.getCurrentMapData();var a=this.game.gameModeData.wave,t=e||[];if(e||(10==a?t=[Helicopter.APACHE]:15==a?t=[Helicopter.OSPREY]:a%5==0?30==a&&0==this.game.gameModeData.enemiesSpawned?t=[Tank.ABRAMS]:a>=15?t=[Helicopter.OSPREY]:a>=10?t=[Helicopter.APACHE]:a>=5&&(t=[Helicopter.COBRA]):(a>=3&&t.push(Helicopter.COBRA),a>=10&&(t.push(Helicopter.APACHE),t.push(MountedWeapon.BGM71),t.push(Helicopter.OSPREY),this.getCars([Car.GROWLER],1).length<=1&&t.push(Car.GROWLER)),a>=15&&this.getCars([Car.MRAP],1).length<=1&&t.push(Car.MRAP),a>=20&&this.getCars([Car.LAV25],1).length<=1&&t.push(Car.LAV25),a>=25?t.push(Helicopter.BLACKHAWK):a>=5&&t.push(Helicopter.KIOWA),a>=30&&0==this.getTanks(1).length&&t.push(Tank.ABRAMS))),t.length>0){var i=this.getVehicleData(t[this.Random(0,t.length-1)]),s=this.getSpawnPointForTeam(1),r=this.Angle(s[0],s[1],.5*this.getMapWidth(),.5*this.getMapHeight());switch(i.type){case ObjectType.HELICOPTER:s=[this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],r=this.Angle(s[0],s[1],.5*this.getMapWidth(),.5*this.getMapHeight());var n=this.createHelicopter(s,{vehicleId:i.id,team:1,bAutomated:-1==[Helicopter.KIOWA,Helicopter.BLACKHAWK].indexOf(i.id),angle:r,tint:6710886});if(n){switch(n.data.bKillOccupantsWhenDestroyed=!0,i.id){case Helicopter.OSPREY:this.setDataValue(n,"enemyTypes",[ObjectType.HELICOPTER,ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.CAR,ObjectType.TANK,ObjectType.EGG])}if(!n.data.bAutomated){var o=n.data.weapons[0]?n.data.weapons[0][0]:null;o&&(o.weaponData&&(o.weaponData.ammoMax=o.weaponData.ammo),this.initVehicleWeapons(n,n.data.weapons))}if(a<15)n.data.speed*=.5;else{var d=Math.min(1.25,.5+.05*(a-15));n.data.speed=n.data.speed*d,n.data.flares=1+Math.max(0,Math.floor((a-15)/5)),n.data.enemyThreshold=Math.min(1e3,a-15+50+600)}}break;case ObjectType.TANK:(n=this.createTank(s,{vehicleId:i.id,team:1,bAutomated:!1,angle:r,tint:10066329}))&&(n.data.weapons[0][0].weaponData.damage*=2,n.data.damageMultipliers={1:.05,2:.05,3:.75,4:.025});break;case ObjectType.CAR:n=this.createCar(s,{vehicleId:i.id,team:1,bAutomated:!1,angle:r,tint:10066329});break;case ObjectType.MOUNTED_WEAPON:n=this.createMountedWeapon(s,{vehicleId:i.id,team:1,bAutomated:i.id!=MountedWeapon.BGM71,bAutoLock:i.id==MountedWeapon.BGM71})}if(n)if(n.data.bAutomated)this.game.gameModeData.enemiesSpawned++;else{var l=n.data.seats;if(l)for(var h=0;h<l.length&&this.game.gameModeData.enemiesSpawned<this.game.gameModeData.numEnemies;h++){var m=this.spawnSurvivalEnemyCharacter();this.executeInteractable(n,m.data.id),this.game.gameModeData.enemiesSpawned++}}}if(n){if(n.data.bRegenHealth=!1,n.data.vehicleId==MountedWeapon.BGM71){var c=n.data.weapons[0][0].weaponData;a<50?(c.damage*=.3,c.range=Math.min(3e3,2e3+50*a),c.overheatNum=c.overheatMax=180):(c.damage*=2,c.range=this.settings.maxWorldSize,c.overheatNum=c.overheatMax=120),this.initVehicleWeapons(n,n.data.weapons)}n.data.type==ObjectType.HELICOPTER&&a>=20&&(n.data.health=n.data.maxHealth=n.data.health+100*Math.max(0,a-20),this.pushObjectDataUpdate(n,["health","maxHealth"]))}return n}spawnSurvivalEnemyChicken(e){var a=this.game.gameModeData.wave;if(a%5==0||a>5&&1==this.Random(1,Math.max(5,50-a))){var t=this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{vehicleId:Helicopter.CHICKENCOPTER,team:1,bAutomated:!0});return this.applyCustomVehicleWeapons(t,[[{id:this.getRandomFirearm().id}]]),t}var i=e||this.getBestSpawnPosition(1),s=s=Math.min(BotSkill.SKILL_GOD,Math.floor(.5*a)),r=.8+.025*a,n=a<=25?.05:.1,o=Math.min(5,.35+a*n)*(.1*this.Random(10,20)),d=a>5&&1==this.Random(1,Math.max(5,50-a)),l=this.createDinosaur({id:this.getRandomUniqueId(),x:i[0],y:i[1],team:1,dinoType:Dinosaur.CHICKEN,bBot:!0,botSkill:s,bRegenHealth:!1,speedMultiplier:Math.min(1.2,r*(.01*this.Random(50,100))),healthMultiplier:o,bSavage:d,objectScale:d?2:.1*this.Random(10,15)});return d&&a>=10&&(l.data.inventory[0]=this.getWeaponData("flamethrower")),l}spawnSurvivalEnemyDinosaur(e,a){var t=this.game.gameModeData.wave;if(3==t)var i=[Dinosaur.DILO];else 5==t?i=[Dinosaur.RAPTOR]:8==t?i=[Dinosaur.STEGOSAURUS]:10==t?i=[Dinosaur.NEEDLER]:12==t?i=[Dinosaur.CARNOTAURUS]:15==t?i=[Dinosaur.ALLOSAURUS]:20==t?i=[Dinosaur.SPINOSAURUS]:t%25==0?i=[Dinosaur.TREX]:(i=[Dinosaur.COMPY],t<25&&i.push(Dinosaur.COMPY),t>=3&&(1==this.Random(1,2)&&i.push(Dinosaur.DILO),1==this.Random(1,2)&&i.push(Dinosaur.PACHY)),t>=5&&1==this.Random(1,10)&&i.push(Dinosaur.RAPTOR),t>=8&&1==this.Random(1,10)&&i.push(Dinosaur.STEGOSAURUS),t>=10&&1==this.Random(1,3)&&i.push(Dinosaur.NEEDLER),t>=12&&1==this.Random(1,a?8:12)&&i.push(Dinosaur.CARNOTAURUS),t>=15&&1==this.Random(1,a?10:20)&&i.push(Dinosaur.ALLOSAURUS),t>=20&&1==this.Random(1,a?10:20)&&i.push(Dinosaur.SPINOSAURUS),t>=25&&(1==this.Random(1,100-Math.max(10,t-25))&&i.push(Dinosaur.TREX),1==this.Random(1,10)&&i.push(Dinosaur.RAPTOR)));var s=e||this.getBestSpawnPosition(1),r=r=Math.min(BotSkill.SKILL_GOD,Math.floor(.5*t)),n=.35+.025*t,o=t<=25?.05:.1,d=Math.min(5,.35+t*o),l=t>5&&(a?1==this.Random(1,2):1==this.Random(1,Math.max(5,(this.game.gameModeId==GameMode.SURVIVAL_CHAOS?20:30)-t)));25==t&&(l=!1),a&&t>25&&(l=!0);var h=i[this.Random(0,i.length-1)],m=null;l?m={icon:"icon_indicator_decoy",iconTint:16711680,bClamp:!1}:h==Dinosaur.TREX&&(m={icon:"item_trex",bgIcon:"icon_triangle_bg",iconTint:Colours.ENEMY,bClamp:!1});var c=this.createDinosaur({id:this.getRandomUniqueId(),x:s[0],y:s[1],team:1,dinoType:h,bBot:!0,botSkill:r,bRegenHealth:!1,speedMultiplier:Math.min(1.2,n*(.01*this.Random(90,100))),healthMultiplier:d,bSavage:l,objectScale:l?Math.min(1.5,1.1+.01*t):1,indicatorData:m});if(l)c.data.bImmuneToStun=t>25;else{var p=[16777215*Math.random(),16776960,65535,255,10494192,16711935];c.data.colour=p[this.Random(0,p.length-1)]}return c.data.maxHealth=c.data.health,this.pushObjectDataUpdate(c.data.id,["health","maxHealth","colour","bSavage"]),c}addEvolutionKill(e){if(this.game.gameModeId==GameMode.EVOLUTION){var a=this.getPlayerById(e),t=this.getObjectById(e);if(this.game.gameModeData.dinoKills++,this.game.gameModeData.dinoKills>=this.game.gameModeData.dinoKillsMax)if(this.game.gameModeData.dinoIndex++,this.game.gameModeData.dinoIndex>=this.game.gameModeData.dinos.length){var i=this.game.gameModeData.scores,s=a?a.team:t?t.data.team:null;null!=s&&(i[s]++,this.game.gameModeData.scores=i,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{scores:i}}),this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:s,cameraTargetId:a.id}))}else{this.game.gameModeData.dinoKills=0,this.game.gameModeData.dinoPos=t?t.position:null,this.game.gameModeData.bEvolve=!0;var r=this.game.gameModeData.dinos[this.game.gameModeData.dinoIndex];this.game.gameModeData.dino=r.id,this.game.gameModeData.dinoKillsMax=r.kills,a&&this.setCurrentDinosaur(a,this.game.gameModeData.dino);for(var n=this.getPlayersOnTeam(1),o=0;o<n.length;o++){var d=n[o];d.id!=e&&(d.currentDino=this.game.gameModeData.dino,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:d.id,data:{currentDino:d.currentDino}}))}this.removeNextStep(t);var l=this.getCurrentMapData(),h=[Item.SENTRY,Item.SENTRY,Item.SENTRY,Item.SENTRY_FLAME],m=this.getCharactersOnTeam(0),c=[];this.getNumMountedWeaponsOnTeam(0)<5&&c.push({type:ObjectType.CRATE,crateType:Crate.ITEM,itemId:h[this.Random(0,h.length-1)]});var p=this.game.gameModeData.dinoIndex>Math.ceil(.5*this.game.gameModeData.dinos.length);p&&c.push({type:ObjectType.CRATE,crateType:Crate.AMMO});var g=this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?this.getMapHeight():0],{vehicleId:p?Helicopter.OSPREY:Helicopter.MH6,team:0,destination:m[0]?m[0].position:l.storeSpawn,items:c,bAutomated:!0});this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{bEvolve:!0,dinoKills:this.game.gameModeData.dinoKills,dinoKillsMax:this.game.gameModeData.dinoKillsMax,dino:this.game.gameModeData.dino,dinoIndex:this.game.gameModeData.dinoIndex,heliType:g.data.vehicleId}})}else this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{dinoKills:this.game.gameModeData.dinoKills}})}}bodyIsInWall(e){if(e){var a=25;return e.data.bBot?this.isInWall([[e.position[0],e.position[1]],[e.position[0]-a,e.position[1]-a],[e.position[0]+a,e.position[1]+a]]):this.isInWall([[e.position[0],e.position[1]],[e.position[0]-a,e.position[1]-a],[e.position[0]+a,e.position[1]+a],[e.position[0]+a,e.position[1]-a],[e.position[0]-a,e.position[1]+a]])}return!1}isInWall(e){if(e)try{for(var a=0,t=0;t<e.length;t++){let n=e[t];if(n[0]<0||n[0]>this.getMapWidth()||n[1]<0||n[1]>this.getMapHeight())return!0;var i=this.getMapStructure(),s=i?[i]:this.game.bMultiplayer?this.getGrounds():null;if(s){var r=this.game.world.hitTest(n,s,20);if(!(r&&r.length>0))return!1;a++}}return a>=e.length}catch(e){this.onGameError(e)}return!1}getRandomItemId(){var e=[Item.SENTRY,Item.SENTRY_SHOTGUN,Item.SENTRY_GRENADE,Item.SENTRY_SNIPER,Item.SENTRY_FLAME,Item.M2,Item.M242];return 1==this.Random(1,5)&&e.push(Item.BGM71),e[this.Random(0,e.length-1)]}spawnSurvivalEnemyEgg(e){var a=[],t=this.game.gameModeData.wave;if(t>=20)var i=Egg.MASSIVE,s=this.Random(6,8);else t>=8?(i=Egg.HUGE,s=this.Random(4,6)):(s=4,i=Egg.LARGE);for(var r=0;r<s;r++)this.game.gameModeData.enemiesSpawned<this.game.gameModeData.numEnemies&&this.getNumPawnsOnTeam(1)<this.settings.maxSurvivalEnemies&&(a.push({type:ObjectType.DINOSAUR,dinoType:this.getRandomDinosaur(),bSurvival:!0}),this.game.gameModeData.enemiesSpawned++);var n=this.getCurrentMapData(),o=this.createEgg(n.spawns[this.Random(0,n.spawns.length-1)],{eggType:i,team:1,items:a});return t>10&&(o.health=o.maxHealth=o.health+100*t),o}spawnSurvivalEnemyAirdrop(){var e=this.game.gameModeData.wave,a=this.getSurvivalEnemyCharacterData();a.type=ObjectType.CHARACTER;for(var t=[Car.GROWLER,Car.LAV25],i=[],s=0;s<3;s++)this.game.gameModeData.enemiesSpawned<this.game.gameModeData.numEnemies&&(i.push(a),this.game.gameModeData.enemiesSpawned++);var r=[{type:ObjectType.CAR,team:1,playerId:null,vehicleId:t[this.Random(0,t.length-1)],bAutomated:!i.length,characters:i}],n=(this.getCurrentMapData(),this.getBestSurvivalSpawnPosition(1));if(e>=25)var o=[[{id:"m240"}]];var d=this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{vehicleId:Helicopter.SEAKNIGHT,team:1,destination:this.clone(n),items:r,bAutomated:!0,destinationTimer:.1,bDropItemsWhenDestroyed:!1,weapons:o});if((e=this.game.gameModeData.wave)>25&&this.setMaxHealth(d,d.data.maxHealth+250*(e-25)),d&&r)for(s=0;s<r.length;s++){r[s].bAutomated&&this.game.gameModeData.enemiesSpawned++}return d}spawnSurvivalEnemyTurret(){if((r=this.game.gameModeData.wave)>=15)var e=[MountedWeapon.SENTRY_GRENADE,MountedWeapon.SENTRY_SNIPER,MountedWeapon.SENTRY_FLAME,MountedWeapon.SENTRY_RAILGUN];else e=[MountedWeapon.SENTRY,MountedWeapon.SENTRY_SHOTGUN,MountedWeapon.SENTRY_GRENADE,MountedWeapon.SENTRY_SNIPER,MountedWeapon.SENTRY_FLAME];var a=e[this.Random(0,e.length-1)],t=this.getBestSurvivalSpawnPosition(1);this.getNumHelicoptersOnTeam(0)>=1&&(a=MountedWeapon.SENTRY_SAM,t=this.getBestSpawnPosition(1));var i=[{type:ObjectType.MOUNTED_WEAPON,team:1,playerId:null,vehicleId:a,bAutomated:!0}],s=Helicopter.MH6;(12==r||r>=10&&this.RandomBoolean())&&(s=Helicopter.SEAKNIGHT);var r,n=this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{vehicleId:s,team:1,destination:this.clone(t),items:i,bAutomated:!0,destinationTimer:.1,bDropItemsWhenDestroyed:!1,tint:6710886});return(r=this.game.gameModeData.wave)>=15&&(n.data.flares=1),r>25&&this.setMaxHealth(n,n.data.maxHealth+250*(r-25)),n&&n.data.items?this.game.gameModeData.enemiesSpawned+=n.data.items.length:this.game.gameModeData.enemiesSpawned++,n}setMaxHealth(e,a){if(e){var t=e.data;t.health=t.maxHealth=a,this.pushObjectDataUpdate(t.id,"health","maxHealth")}}spawnSurvivalEnemyZombie(){var e=this.getBestSpawnPosition(1),a=this.game.gameModeData.wave,t=a%5==0||a>=5&&1==this.Random(1,Math.max(5,40-a)),i=this.getAvatarDataById(t?AvatarPresets.ZOMBIE_JUGGERNAUT:AvatarPresets.ZOMBIE),s=t?.5:.25,r=Math.min(BotSkill.SKILL_GOD,Math.floor(a*s)+1),n=a>=25?200:100,o=1+.125*a,d=.1*this.Random(3,10)*(t?.35:1);o=Math.min(o*d,2);var l=Math.round(100+a*n*(1-d))*(t?5:1),h={};if(t&&(h={1:.35,4:.1}),a>=10)var m=this.getRandomMelee().id;else m="melee_knife";var c=null;if(a>=10){c="blast_vest";var p=.1*this.Random(10,15)}var g=this.createCharacter({id:this.getRandomUniqueId(),x:e[0],y:e[1],team:1,inventory:[],melee:m,equipment:c,avatar:i,bBot:!0,botSkill:r,health:l,bRegenHealth:!1,bJuggernaut:t,bZombie:!0,damageMultipliers:h,bInteract:!1,objectScale:p,pawnName:t?"Zombie Juggernaut":null});g.data.maxSpeed*=o,g.data.bDropWeapons=!1,t&&(g.data.bImmuneToStun=!0,g.data.reward=1e3);var E=g.data.inventory[Character.INDEX_MELEE];return E&&(a>=25?E.fireRate=Math.round(.25*E.fireRate):(a>=10||t)&&(E.fireRate=Math.round(.5*E.fireRate))),g}getSurvivalEnemyCharacterData(){var e=this.getBestSpawnPosition(1),a=this.getBotClasses(),t=[Classes.ASSAULT,Classes.COMMANDO,Classes.SUPPORT,Classes.HUNTER],i=a[t[this.Random(0,t.length-1)]].avatar[Faction.MILITIA],s=this.game.gameModeData.wave,r=null,n=s%5==0||s>=5&&1==this.Random(1,Math.max(10,30-s));if(n){i=this.getAvatarDataById(AvatarPresets.JUGGERNAUT);var o=[Weapon.TYPE_LMG];if(s>10&&1==this.Random(1,3)){var d=!0;r="Commander",o=[Weapon.TYPE_DMR],i=this.getAvatarDataById(AvatarPresets.COMMANDER)}else r="Juggernaut"}else{i.body=Character.BODY_MILITIA;var l=[Character.HAIR_BALD,Character.HAIR_BUZZED,Character.HAIR_SHORT,Character.HAIR_LONG];i.hair=l[this.Random(0,l.length-1)];var h=[Character.BEARD_NONE,Character.BEARD_FULL];i.beard=h[this.Random(0,h.length-1)];var m=[Character.HEAD_NONE,Character.HEAD_OPFOR_HELMET,Character.HEAD_MILITIA_SNIPER,Character.HEAD_MILITIA_RADIO];i.head=m[this.Random(0,m.length-1)];var c=[Character.FACEWEAR_NONE,Character.FACEWEAR_GAITER];i.facewear=c[this.Random(0,c.length-1)],i.hairColour=this.getRandomHairColour(),i.hair=this.getRandomHair(),o=[],s<10&&o.push(Weapon.TYPE_PISTOL,Weapon.TYPE_MACHINE_PISTOL),s<20&&s>=3&&o.push(Weapon.TYPE_SMG),s<30?s>=5&&o.push(Weapon.TYPE_CARBINE,Weapon.TYPE_RIFLE,Weapon.TYPE_LMG):o.push(Weapon.TYPE_LMG),s>=15&&o.push(Weapon.TYPE_LAUNCHER),s>=10&&o.push(Weapon.TYPE_DMR,Weapon.TYPE_SNIPER,Weapon.TYPE_SHOTGUN)}for(var p=[],g=0;g<o.length;g++)p=p.concat(this.getAllWeaponsByType(o[g]));if(n&&!d){if(s>=10&&(p=[this.getWeaponData("m82")]),s>=15){p=[this.getWeaponData("minigun"),this.getWeaponData("flamethrower")];var E=1.25}if(s>=20){p.push(this.getWeaponData("railgun"));E=1.5}}n||(s>=20&&p.push(this.getWeaponData("bow"),this.getWeaponData("crossbow")),s>=25&&p.push(this.getWeaponData("railgun")));var b=this.getWeaponData(p[this.Random(0,p.length-1)].id);if(this.setRandomWeaponMods(b),s>=25)switch(b.round){case"556mm":case"762mm":case"762mm_39":case"762mm_54":case"50cal":case"44":b.mods[Mods.TYPE_AMMO]=Mods.AMMO_EXPLOSIVE}var u=[{id:b.id,mods:b.mods}],I=[];if(s>=10&&I.push(Weapon.TYPE_LAUNCHER),s>=3&&!n&&I.push(Weapon.TYPE_SHOTGUN),I.length>1){var T=this.getAllWeaponsByType(I[this.Random(0,I.length-1)]);u.push({id:T[this.Random(0,T.length-1)].id})}var v=[];if(s>=5&&1==this.Random(1,5)&&v.push("frag","stun","flashbang"),n)var y=["frag","semtex","stun","flashbang"];else y=[],s>=3&&1==this.Random(1,50)&&y.push("jammer"),s>=5&&y.push("stim","juice"),s>=8&&(y.push("claymore","betty","c4"),1==this.Random(1,5)&&y.push("molotov")),s>=10&&y.push("semtex","kevlar","blast_vest"),s>=15&&y.push("trophy");var A=["melee_knife","melee_machete"],O=A[this.Random(0,A.length-1)],R=this.game.gameModeId==GameMode.SURVIVAL_CHAOS?.15:.125,M=d?BotSkill.SKILL_GOD:Math.min(BotSkill.SKILL_GOD,Math.floor(s*R)+(n?3:0)),_=s<=50?3:5,D=Math.round(100+s*_),S=1;if(n){var N={1:.35,4:.1};D*=10,S=d?1:.75,O="melee_hatchet"}else b.type==Weapon.TYPE_SHOTGUN&&(D*=2);return{x:e[0],y:e[1],team:1,inventory:u,melee:O,grenade:v[this.Random(0,v.length-1)],equipment:y[this.Random(0,y.length-1)],avatar:i,bBot:!0,botSkill:M,health:D,bRegenHealth:!1,bJuggernaut:n,damageMultipliers:N,bInteract:!1,objectScale:E,speedMultiplier:S,reward:n?1e3:null,bSwitchToMelee:!n,pawnName:r}}spawnSurvivalEnemyCharacter(){var e=this.getSurvivalEnemyCharacterData();return this.createCharacter(e)}onSurvivalWaveComplete(){var e=this.game.gameModeData;if(!e.bIntermission){this.startSurvivalWaveIntermission();var a=75*e.wave*Math.max(1,.25*e.wave);a+=Math.round(2*e.waveKills),a+=50*e.waveMelees;for(var t=Object.keys(e.killTypes),i=0;i<t.length;i++){var s=t[i],r=0;switch(s){case ObjectType.TANK:r=500;break;case ObjectType.EGG:case ObjectType.HELICOPTER:r=250;break;case ObjectType.CAR:r=100}a+=r*e.killTypes[s]}switch(a=this.RoundToNearest(Math.min(1e4,Math.max(100,a))),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{wave:e.wave,bWaveComplete:!0,reward:a,waveKills:e.waveKills,waveMelees:e.waveMelees,killTypes:e.killTypes}}),this.dispatchTrigger({event:"survivalWaveCompleted",wave:e.wave,reward:a,waveKills:e.waveKills,waveMelees:e.waveMelees}),this.game.gameModeId){case GameMode.SURVIVAL_CHICKEN:if(this.getCrates().length<5){let e=[{type:ObjectType.CRATE,crateType:Crate.AMMO},{type:ObjectType.CRATE,crateType:Crate.WEAPON,items:[{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0}]}],a=[Item.SENTRY,Item.SENTRY_SHOTGUN,Item.SENTRY_FLAME,Item.SENTRY_SAM,Item.M2];e.push({type:ObjectType.CRATE,crateType:Crate.ITEM,itemId:a[this.Random(0,a.length-1)]}),this.ShuffleArray(e),e.length=this.Random(1,e.length-1),this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{vehicleId:Helicopter.MH6,team:0,destination:this.getRandomSpawnPosition(),items:e,bAutomated:!0}),this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:"STR_AIRDROP_INBOUND",hqId:"hq_friendly_package"}})}if(this.game.gameModeData.wave>5&&this.getNumCars()<2){let e=[Car.GROWLER,Car.MRAP,Car.LAV25],a=e[this.Random(0,e.length-1)];this.createHelicopter([this.RandomBoolean()?0:this.getMapWidth(),this.RandomBoolean()?0:this.getMapHeight()],{vehicleId:Helicopter.SEAKNIGHT,team:0,destination:this.getBestSpawnPosition(0),items:[{type:ObjectType.CAR,vehicleId:a,team:0}],bAutomated:!0}),this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:"STR_AIRDROP_INBOUND",hqId:"hq_friendly_item_"+a}})}}for(i=0;i<this.game.players.length;i++){let e=this.game.players[i];this.addPlayerMoney(e.id,a)}setTimeout((()=>{this.game&&this.respawnAllPlayers()}),100)}}addPlayerMoney(e,a){var t=this.getPlayerById(e);t&&(t.money=Math.min(this.settings.maxPlayerMoney,Math.max(0,t.money+a)),this.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{money:t.money}}))}respawnPlayer(e,a){var t=this.getPlayerById(e);if(t){if(a||(a=t.respawnData?t.respawnData:{}),t.bSpectator)return;t.respawnData=a,this.removeObject(this.getReviverByPlayerId(t.id)),a.currentFaction&&(t.currentFaction=a.currentFaction,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{currentFaction:t.currentFaction}})),a.dinoType&&(t.currentDino=a.dinoType);var i=null,s=void 0!==a.melee?a.melee:"melee_knife",r=null,n=null;if(a.inventory&&(i=this.clone(a.inventory)),a.equipment&&(n=a.equipment),a.grenade&&(r=a.grenade),this.game.bSurvival||this.game.gameModeData.bAllowRevives)if(t.inventory)i=this.clone(t.inventory),t.inventory=null,s=t.melee,n=t.equipment,r=t.grenade;else if(a.inventory)i=a.inventory;else{switch(this.game.gameModeId){case GameMode.SURVIVAL_CHICKEN:i=[{id:"sawed_off",name:"Chicken Blaster",ammo:200},{id:"m1187",name:"Musket",ammo:400,mods:{ammo:Mods.AMMO_SLUG}}],s="melee_hatchet";break;case GameMode.SURVIVAL_ZOMBIE:i=[{id:"m4a1",ammo:300,mods:{optic:Mods.OPTIC_EOTECH,accessory:Mods.ACCESSORY_MAG_ASSIST}},{id:"m3",ammo:80,mods:{accessory:Mods.ACCESSORY_LASER,ammo:Mods.AMMO_HOLLOW_POINT}}],s="melee_machete";break;default:i=[{id:"mp5",ammo:300},{id:"m9",ammo:300}]}r=void 0!==a.grenade?a.grenade:null!=r?r:"frag",n=void 0!==a.equipment?a.equipment:null!=n?n:"ammo_box"}else if((this.game.bRanked||this.game.gameSettings.bAllowClassSelection)&&!i){var o=t.classes[t.currentClass];s=o.melee,r=o.grenade,n=o.equipment,i=[o.primary,o.secondary]}i||(i=[{id:"m9"}]);var d=a.position;if(d){var l=d;l[0]+=this.Random(-25,25),l[1]+=this.Random(-25,25)}else if(this.game.bSurvival)l=this.getSpawnPointForTeam(t.team);else{l=this.getSpawnPointForTeam(t.team);var h=this.getEquipmentByPlayerId(t.id,"tac_insert");h[0]&&(l=h[0].position)}if(this.game.bSurvival?this.removeEquipmentByPlayerId(t.id,"tac_insert"):(this.removeEquipmentByPlayerId(t.id),this.removeGrenadesByPlayerId(t.id)),null!=a.team&&(t.team=a.team,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{team:t.team}})),!this.getObjectById(t.id)){var m={id:t.id,x:l[0],y:l[1],team:t.team,inventory:i,melee:s,grenade:r,grenadeAmmo:null,equipment:n,equipmentAmmo:null,avatar:t.avatar,bBot:t.bBot,botSkill:t.botSkill},c=t.currentDino?t.currentDino:this.getRandomDinosaur(),p=t.dinosaurs?t.dinosaurs:{},g={id:t.id,x:l[0],y:l[1],dinoType:c,team:t.team,bBot:t.bBot,botSkill:t.botSkill,bCanInteract:this.game.gameSettings.bAllowDinosaurInteract,colour:p[c]?p[c].colour:null};switch(this.game.gameModeId){case GameMode.RAPTOR_HUNT:1==t.team?this.createDinosaur({id:t.id,x:l[0],y:l[1],dinoType:Dinosaur.RAPTOR,team:t.team,bBot:t.bBot,botSkill:t.botSkill}):this.createCharacter(m);break;case GameMode.TYRANT:if(1==t.team)this.createDinosaur({id:t.id,x:l[0],y:l[1],dinoType:Dinosaur.TREX,team:t.team,bBot:t.bBot,botSkill:t.botSkill}).data.regenThreshold=.25;else this.createCharacter(m);break;case GameMode.EVOLUTION:if(1==t.team){var E=this.createDinosaur({id:t.id,x:l[0],y:l[1],dinoType:this.game.gameModeData.dino,team:t.team,bBot:t.bBot,botSkill:t.botSkill,bCanInteract:this.game.gameSettings.bAllowDinosaurInteract});switch(this.game.gameModeData.dino){case Dinosaur.COMPY:E.data.damageMultipliers[DamageType.DAMAGE_BULLET]*=.5,E.data.health=E.data.maxHealth=Math.max(2*this.getCharacterMaxHealth(),E.data.maxHealth);break;case Dinosaur.DILO:case Dinosaur.RAPTOR:case Dinosaur.NEEDLER:case Dinosaur.PACHY:E.data.damageMultipliers[DamageType.DAMAGE_BULLET]*=.75}this.game.gameModeData.dino==Dinosaur.COMPY&&(E.data.health=E.data.maxHealth=Math.max(2*this.getCharacterMaxHealth(),E.data.maxHealth))}else this.createCharacter(m);break;case GameMode.HUMANS_VS_DINOSAURS:1==t.team?this.createDinosaur(g):this.createCharacter(m);break;default:t.currentFaction==ObjectType.DINOSAUR?this.createDinosaur(g):this.createCharacter(m)}this.dispatchTrigger({event:"playerRespawned",playerId:t.id,playerIndex:this.game.players.indexOf(t),playerTeam:t.team})}t.respawnTimer=-1,t.timer_respawn=null,this.game.gameModeData.bAllowRespawns&&t.bBot,this.matchInProgress()&&this.game.gameModeData.bSpawnProtection&&this.startSpawnProtectionTimer(t.id)}else console.warn("Player doesn't exist:",e)}getRandomDinosaur(){var e=[Dinosaur.COMPY,Dinosaur.COMPY,Dinosaur.DILO,Dinosaur.DILO,Dinosaur.PACHY,Dinosaur.PACHY,Dinosaur.RAPTOR,Dinosaur.RAPTOR,Dinosaur.NEEDLER,Dinosaur.STEGOSAURUS,Dinosaur.SPINOSAURUS,Dinosaur.ALLOSAURUS,Dinosaur.CARNOTAURUS];return e[this.Random(0,e.length-1)]}getPlayers(){return this.game.players}getPlayersOnTeam(e){for(var a=[],t=0;t<this.game.players.length;t++){let i=this.game.players[t];i.team==e&&a.push(i)}return a}setPlayerPing(e,a){var t=this.getPlayerById(e);t&&!t.bBot&&(t.ping=a,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{ping:t.ping}}))}updatePlayer(e){if(e){var a=this.getPlayerById(e.id);if(a){for(var t=Object.keys(e),i=0;i<t.length;i++){var s=t[i];a[s]=e[s]}this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:a.id,data:a})}}}getPlayerById(e){if(this.game){for(var a=this.game.players,t=0;t<a.length;t++){var i=a[t];if(i.id==e)return i}return null}}addWorldBody(e,a=!0){a&&(e.shapes.length||console.log("No shapes",e),this.game.world.addBody(e));var t=e.data;if(t)if(t.id||console.warn("Missing id",t),this.game.objects[t.id]=e,t.type){this.game.types[t.type]||(this.game.types[t.type]=[]);var i=this.game.types[t.type];-1==i.indexOf(e)?i.push(e):console.warn("Already exists")}else console.warn("Missing type",t);else console.warn("No data for",e)}removeObjectById(e){var a=this.getObjectById(e);a&&this.removeNextStep(a)}removeObject(e){if(e){e.data||console.warn("No body data",e);var a=this.game.world;e.constraint&&(a.removeConstraint(e.constraint),delete e.constraint);var t=e.data,i=t?t.id:void 0,s=t?t.type:null,r=this.game.types[s];if(r){var n=r.indexOf(e);n>=0&&r.splice(n,1)}delete e.data,a.removeBody(e);for(var o=Object.keys(e),d=0;d<o.length;d++)delete e[o[d]];if(i){var l=this.game.players;for(d=0;d<l.length;d++){var h=l[d];if(h.controllableId==i){this.clearPlayerControllable(h.id);break}}switch(s){case ObjectType.OBSTACLE:this.removeDirtyNodeObject(i);break;case ObjectType.ROCKET:for(var m in this.game.objects){let e=this.game.objects[m];if(e.data&&e.data.currentRocketId==i){delete e.data.currentRocketId;break}}}return delete this.game.objects[i],this.onEvent({eventId:GameServer.EVENT_REMOVE_OBJECT,id:i}),!0}}return!1}createRocket(e,a){var t=new this.p2.Body({mass:.1,position:e,angle:a.angle}),i=0,s=0,r=0,n=!1,o=!1,d=1==a.bAutoLock,l=a.weaponId,h=5*this.game.settings.fps;switch(l){case"hellfire":h=10*this.game.settings.fps,i=1e3,s=500,r=0,n=!0;break;case"rocket_flare":var m=this.getWeaponData(l);i=0,s=100,r=this.Random(50,100);break;default:h=5*this.game.settings.fps;m=this.getWeaponData(l);i=a.damage?a.damage:m.damage,s=a.radius?a.radius:m.radius,o=a.bRequireLock,n=m.bControllable,r=m.velocity?m.velocity:150,d=d||m.bAutoLock}t.data={id:a.id?a.id:this.getRandomUniqueId(),destroyTimer:h,type:ObjectType.ROCKET,damage:i,radius:s,team:a.team,rocketType:a.rocketType,modId:a.modId,playerId:a.playerId,causerId:a.causerId,weaponId:a.weaponId,enemyId:a.enemyId,bRequireLock:a.bRequireLock,bAutoLock:d,velocity:r,bControllable:n};var c=t.data;this.removeUndefinedKeys(c);var p=new this.p2.Circle({radius:12,collisionGroup:CollisionGroups.PROJECTILE,collisionMask:CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.OBJECT|CollisionGroups.HELICOPTER|CollisionGroups.BOUNDS});if(p.sensor=!0,t.addShape(p),this.addWorldBody(t),r){var g=a.angle;t.applyImpulse([Math.cos(g)*r,Math.sin(g)*r],0,0)}if("rocket_flare"==m.id)t.shapes[0].collisionMask=0;else if(o||d||a.lockOnTargetId&&m.bCanLock){var E=a.lockOnTargetId;if(!E){var b=this.getObjectById(a.playerId);b&&(E=b.data.lockOnTargetId)}if(E){var u=this.getObjectById(E);c.enemyId=E,u&&this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.lockOnTargetId,type:GameServer.PAWN_LOCK_ACQUIRED,bRocket:!0})}(u||d)&&(t.shapes[0].collisionMask=CollisionGroups.PAWN|CollisionGroups.HELICOPTER)}if(n){var I=this.getPlayerById(a.playerId);I&&(c.team=I.team)}return(c.enemyId||c.bAutoLock)&&(c.health=c.maxHealth=100),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.ROCKET,position:t.position,velocity:t.velocity,angularVelocity:t.angularVelocity,rotation:t.angle,data:c}),t}createDroppedWeapon(e,a){a.weaponData||(a.weaponData=this.getWeaponData(a.weaponId),a.mods&&a.weaponData&&this.applyWeaponMods(a.weaponData,a.mods));var t=a.weaponData;if(t){if("none"!=t.id&&!t.bZombie&&!t.bDinosaur){t.type!=Weapon.TYPE_MELEE&&(null==t.mag&&(t.mag=t.magSize=t.ammoMax?t.ammoMax:1),null==t.ammo&&(t.ammo=t.ammoMax=1)),a.name&&(t.name=a.name),null!=a.magSize&&(t.magSize=Math.max(1,a.magSize)),null!=a.mag&&(t.mag=Math.min(t.magSize,Math.max(0,a.mag))),null!=a.ammo&&(t.ammo=Math.max(0,a.ammo));var i=new this.p2.Body({mass:null!=a.mass?a.mass:1,position:e,angle:a.angle?a.angle:a.rotation?this.ToRad(a.rotation):0,allowSleep:!0,damping:.99,angularDamping:.98,sleepSpeedLimit:10});i.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.DROPPED_WEAPON,itemData:a,value:1};var s=this.getWorldWeaponData(t.id),r=new this.p2.Circle({width:s.w,height:s.h,radius:Math.min(s.w,s.h),collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.GROUND|CollisionGroups.HELICOPTER|CollisionGroups.OBJECT});return i.addShape(r),this.addWorldBody(i),0==t.ammo&&0==t.mag&&(i.data.destroyTimer=this.game.settings.fps),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.DROPPED_WEAPON,position:i.position,rotation:i.angle,velocity:i.velocity,angularVelocity:i.angularVelocity,data:i.data}),i}}else console.warn("Invalid weaponData")}createEgg(e,a){var t=a.eggType?a.eggType:Egg.LARGE,i=this.getSharedData(t),s=null!=a.mass?a.mass:i.mass,r=new this.p2.Body({mass:s,position:e,angle:a.angle?a.angle:this.RandomAngle(),damping:i.damping,angularDamping:i.angularDamping,allowSleep:!0,sleepSpeedLimit:10});switch(t){case Egg.SMALL:var n=1e3,o=5;break;case Egg.LARGE:n=2e3,o=8;break;case Egg.HUGE:n=5e3,o=12;break;case Egg.MASSIVE:n=1e4,o=15}(a.hatchTimer&&(o=a.hatchTimer),this.game.bSurvival)&&(this.game.gameModeData.wave>=25&&(o*=.5));r.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.EGG,material:Material.FLESH,health:a.health?a.health:n,damageMultipliers:{1:.5,2:1,3:2.5,4:.5},playerId:a.playerId,eggType:t,reward:Math.round(.25*n),items:a.items?a.items:[],team:a.team,playerId:a.playerId,hatchTimer:this.game.settings.fps*o,indicatorData:a.indicatorData,bUntargetable:a.bUntargetable,bRegenHealth:a.bRegenHealth,bGodMode:a.bGodMode,bDisabled:a.bDisabled};var d=r.data;d.maxHealth=d.health;var l=new this.p2.Circle({radius:i.size,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.OBJECT|CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.GROUND});return r.addShape(l),this.addWorldBody(r),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,position:r.position,rotation:r.angle,data:r.data}),r}createMoney(e,a){var t=new this.p2.Body({mass:1,position:e,angle:null!=a.angle?a.angle:this.RandomAngle(),damping:.9,angularDamping:.9,allowSleep:!0,sleepSpeedLimit:10});t.data={id:a.id?a.id:this.getRandomUniqueId(),x:e[0],y:e[1],type:ObjectType.MONEY,value:Math.max(1,a.value?a.value:100),destroyTimer:a.destroyTimer?60*a.destroyTimer:null};var i=new this.p2.Circle({radius:8,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.OBJECT|CollisionGroups.GROUND|CollisionGroups.BOUNDS});return t.addShape(i),this.addWorldBody(t),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,position:t.position,rotation:t.angle,data:t.data}),t}createArrow(e,a){var t=new this.p2.Body({mass:1,position:e,angle:a.angle?a.angle:a.rotation?this.ToRad(a.rotation):0,damping:.9,angularDamping:.9,allowSleep:!0,sleepSpeedLimit:10});t.data={id:a.id?a.id:this.getRandomUniqueId(),x:e[0],y:e[1],type:ObjectType.ARROW,destroyTimer:null!=a.destroyTimer?60*a.destroyTimer:Math.round(60*this.game.settings.fps)};var i=new this.p2.Circle({radius:5,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.OBJECT|CollisionGroups.GROUND});return t.addShape(i),this.addWorldBody(t),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,position:t.position,rotation:t.angle,data:t.data}),t}createFlame(e,a,t,i,s,r=5,n=!1){if(s){var o=new this.p2.Body({mass:1,position:e,velocity:a,angle:this.RandomAngle(),damping:.9,allowSleep:!0,sleepSpeedLimit:10});s.fireDamage||console.warn("Invalid fire damage",s.id),o.data={id:this.getRandomUniqueId(),x:e[0],y:e[1],type:ObjectType.FLAME,team:t,damage:s.fireDamage?s.fireDamage:10,playerId:i,weaponId:s.id,destroyTimer:Math.round(this.game.settings.fps*r),ticker:0,tickerMax:Math.round(5*this.game.fpsMult),bFromWeapon:n},n&&(o.data.cooldownTimer=Math.ceil(3*this.game.fpsMult));var d=CollisionGroups.FLAME,l=CollisionGroups.GROUND|CollisionGroups.BOUNDS|CollisionGroups.OBJECT|CollisionGroups.SHIELD,h=new this.p2.Circle({radius:20,collisionGroup:d,collisionMask:l});o.addShape(h),this.addWorldBody(o),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,angle:o.angle,data:o.data});var m=this.getFlames();if(m.length>=this.settings.maxFlames)for(var c=m.length-this.settings.maxFlames,p=0;p<c;p++)this.removeNextStep(m[p]);if((m=this.getFlames(i)).length>=this.settings.maxFlamesPerPlayer)for(c=m.length-this.settings.maxFlamesPerPlayer,p=0;p<c;p++)this.removeNextStep(m[p]);return o}console.warn("Invalid fire weapon data")}createProjectile(e,a,t,i){var s=new this.p2.Body({mass:.1,position:e,angle:a,angularDamping:.2}),r=this.getWeaponData(i.weaponId);s.data={id:i.id?i.id:this.getRandomUniqueId(),type:ObjectType.PROJECTILE,team:t,playerId:i.playerId,causerId:i.causerId,sourceId:i.sourceId,damage:r.damage,bMelee:r.bArrow||i.weaponId,weaponId:r.id,weaponData:r};var n=s.data,o=i.velocity?i.velocity:200;switch(r.id){case Dinosaur.NEEDLER:var d=new this.p2.Circle({radius:15});n.destroyTimer=this.game.settings.fps,o=this.Random(190,210);break;case"rope":d=new this.p2.Circle({radius:15}),n.bHitSameTeam=!0,n.destroyTimer=this.game.settings.fps;break;default:d=new this.p2.Circle({radius:15})}d.sensor=!0,d.collisionGroup=CollisionGroups.PROJECTILE,d.collisionMask=CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.OBJECT|CollisionGroups.HELICOPTER|CollisionGroups.BOUNDS|CollisionGroups.SHIELD,s.addShape(d),this.addWorldBody(s);var l=a;return s.applyImpulse([Math.cos(l)*o,Math.sin(l)*o],0,0),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.PROJECTILE,position:s.position,rotation:s.angle,velocity:s.velocity,angularVelocity:s.angularVelocity,data:s.data}),s}createEquipment(e,a){var t=a.weaponData;if(t||(t=this.getWeaponData(a.weaponId)),t){var i=this.getSharedData(t.id);if(i){var s=new this.p2.Body({mass:i.mass?i.mass:1,damping:null!=i.damping?i.damping:.99,angularDamping:null!=i.angularDamping?i.angularDamping:.9,position:e,angle:null!=a.angle?a.angle:a.rotation?this.ToRad(a.rotation):0,allowSleep:!0,sleepSpeedLimit:10});a.itemData&&a.itemData.interactTime&&(a.itemData.interactTime=a.itemData.interactTime*this.game.settings.fps),s.data={id:a.id?a.id:this.getRandomUniqueId(),x:e[0],y:e[1],type:ObjectType.EQUIPMENT,health:a.health?a.health:t.health?t.health:1,team:a.team,scale:1,ownerId:a.ownerId,weaponData:t,bHideRadius:a.bHideRadius,itemData:a.itemData?a.itemData:null};var r=s.data;if("trophy"==t.id?(r.material=Material.METAL,r.blockNum=5,r.bCanMelee=!0):"beacon"==t.id&&(r.material=Material.METAL,s.fixedRotation=!0),this.game.bSurvival&&0==r.team&&r.health&&(r.health*=2),t.radius&&(r.radius=t.radius),t.bMine)switch(r.bMine=!0,t.id){case"claymore":r.triggerRange=200;break;case"betty":r.triggerRange=150;break;default:r.triggerRange=100}var n=new this.p2.Circle({radius:i.size?i.size:Math.max(i.width,i.height),collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.GROUND|CollisionGroups.OBJECT|CollisionGroups.BOUNDS});n.sensor=!t.bThrowable&&t.bMine,s.addShape(n);var o=4;switch(t.id){case"health_box":o=1;break;case"jammer":case"sensor":case"trophy":o=2}var d=this.getEquipmentByPlayerId(r.ownerId,t.id);return d.length>=o&&this.removeNextStep(d[0]),this.addWorldBody(s),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.EQUIPMENT,position:s.position,rotation:s.angle,data:r}),s}console.warn("Invalid shared equipment data",t.id)}else console.warn("Invalid weaponData")}getEquipmentByPlayerId(e,a){var t=[];if(e)for(var i=this.getEquipment(),s=0;s<i.length;s++){var r=i[s];r.data.ownerId==e&&(a&&r.data.weaponData.id!=a||t.push(r))}return t}onStoppingPowerHit(e,a){var t=e.data;if(t.type==ObjectType.CHARACTER||t.type==ObjectType.DINOSAUR){var i=.1*Math.max(0,a/25),s=this.game.settings.fps,r=Math.min(s,s*(.25+i));t.stoppingPowerTimer=Math.round(r/e.mass),this.setDataValue(e,"bStoppingPower",!0)}}canAcceptNewPlayers(){return!this.matchHasEnded()&&!this.bGameEnded&&!1!==this.game.gameSettings.bAllowJoinInProgress}getNewPlayerDesiredTeam(){if(!this.game)return 0;switch(this.game.gameModeId){case GameMode.TYRANT:return 0;default:if(this.game.bSurvival)return 0}if(this.game.gameModeData.scoreLimit){var e=this.game.gameModeData.scores;if(e){if(e[0]>e[1])return 1;if(e[0]<e[1])return 0}}if(this.isTeamGameMode()){var a=this.getNumPlayersOnTeam(0),t=this.getNumPlayersOnTeam(1);if(a>t)return 1;if(a<t)return 0}return this.Random(0,1)}getNumPlayersOnTeam(e){var a=0,t=this.game.players;if(t)for(var i=0;i<t.length;i++)t[i].team==e&&a++;return a}serverAction(e,a){if(!this.matchHasEnded()){var t=this.getPlayerById(e),i=this.getObjectById(e);switch(a[0]){case"/error":this.onGameError(new Error("test"));break;case"/clearTriggerAreas":var s=this.getTriggerAreas();this.triggerCallback("chat",{messageText:"Removing "+s.length+" trigger areas"});for(var r=0;r<s.length;r++)this.removeNextStep(s[r]);break;case"/clearObstacles":var n=this.getObstacles();this.triggerCallback("chat",{messageText:"Removing "+n.length+" obstacles"});for(r=0;r<n.length;r++)this.removeNextStep(n[r]);break;case"/clearDecorations":n=this.getObstacles();var o=0;for(r=0;r<n.length;r++){let e=n[r];e.data.bGodMode||!e.data.health&&!e.data.bNoBody||(this.removeNextStep(e),o++)}this.triggerCallback("chat",{messageText:"Removed "+o+" decorations"});break;case"/clearTrees":var d=this.getTrees();this.triggerCallback("chat",{messageText:"Removing "+d.length+" trees"});for(r=0;r<d.length;r++)this.removeNextStep(d[r]);break;case"/clearEquipment":var l=this.getEquipment();this.triggerCallback("chat",{messageText:"Removing "+l.length+" equipment"});for(r=0;r<l.length;r++)this.removeNextStep(l[r]);break;case"/clear":let I=0;I+=(n=this.getObstacles()).length;for(r=0;r<n.length;r++)this.removeNextStep(n[r]);I+=(d=this.getTrees()).length;for(r=0;r<d.length;r++)this.removeNextStep(d[r]);var h=this.getDroppedWeapons();I+=h.length;for(r=0;r<h.length;r++)this.removeNextStep(h[r]);this.triggerCallback("chat",{messageText:"Removing "+I+" objects"});break;case"/spectate":t&&(this.game.gameSettings.bAllowSpectators||t.bAdmin?(t.bSpectator?(t.bSpectator=!1,t.bWaitingToRespawn=!0):(t.bSpectator=!0,this.removeObjectById(t.id),this.removeNextStep(this.getReviverByPlayerId(t.id))),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{team:t.team,kills:t.kills,bWaitingToRespawn:t.bWaitingToRespawn,bSpectator:t.bSpectator}}),this.triggerCallback("chat",{messageText:t.name+(t.bSpectator?" is now a spectator":" is no longer a spectator")}),this.game.bSurvival&&this.getNumPawnsOnTeam(0,!0)<=0&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_KIA,result:MatchState.END_RESULT_LOSS,winningTeam:1})):(console.log("Spectating is disabled"),this.triggerCallback("chat",{messageText:"Spectating is disabled"})));break;case"/team":t&&(t.team=0==t.team?1:0,i&&this.setDataValue(i,"team",t.team),this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:t.id,data:{team:t.team}}));break;case"/money":if(t)for(r=0;r<this.game.players.length;r++){var m=this.game.players[r];this.addPlayerMoney(m.id,a[1]?parseInt(a[1]):this.settings.maxPlayerMoney)}break;case"/kill":this.killPawn(a[1]?a[1]:e);break;case"/killBots":var c=this.getPawns();for(r=0;r<c.length;r++){let e=c[r];e.data.bBot&&this.killPawn(e.data.id)}break;case"/disableBots":for(c=this.getPawns(),r=0;r<c.length;r++){let e=c[r];e.data.bBot&&(e.data.bBot=!1)}break;case"/tickRate":if(a[1]){var p=parseInt(a[1]);this.game.gameSettings.tickRate=p,this.setTickRate(p)}else this.triggerCallback("chat",{messageText:"Tick rate: "+this.game.gameSettings.tickRate});break;case"/numBodies":let T={};for(r=0;r<this.game.world.bodies.length;r++){let e=this.game.world.bodies[r],a=e.data;e.world&&a&&(null==T[a.type]&&(T[a.type]=0),T[a.type]++)}let v=this.game.world.bodies.length+" bodies";for(b=Object.keys(T),r=0;r<b.length;r++){let e=b[r];v+="\n"+e+": "+T[e]}this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:v,bLocalize:!1,bInfofeed:!0}});break;case"/numObstacles":this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:this.getObstacles().length+" obstacles",bLocalize:!1,bInfofeed:!0}});break;case"/obstacles":n=this.getObstacles();let y={};for(r=0;r<n.length;r++){let e=n[r];e.data.bNoBody||(y[e.data.obstacleId]||(y[e.data.obstacleId]=0),y[e.data.obstacleId]++)}let A=n.length+" obstacles";for(b=Object.keys(y),r=0;r<b.length;r++){let e=b[r];A+="\n"+e+": "+y[e]}this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:A,bLocalize:!1,bInfofeed:!0}});break;case"/numPawns":this.onEvent({eventId:GameServer.EVENT_MESSAGE_ADD,data:{message:this.getPawns().length+" pawns",bLocalize:!1,bInfofeed:!0}});break;case"/nodes":this.generateMapNodes();break;case"/showNodes":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{nodes:this.game.nodes,threshold:this.game.nodeThreshold}});break;case"/hideNodes":this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{nodes:null}});break;case"/vars":var g=this.game.gameModeData.vars;if(g){var E="",b=Object.keys(g);for(r=0;r<b.length;r++){E+=(u=b[r])+" = "+g[u]+(r<b.length-1?"\n":"")}this.triggerCallback("chat",{messageText:E,playerText:"Variables",date:Date.now()})}break;case"/var":this.triggerCallback("chat",{messageText:a[1]+" = "+this.getScenarioVarValue(a[1]),playerText:"Variable",date:Date.now()});break;case"/game":for(E="",b=Object.keys(this.game.gameModeData),r=0;r<b.length;r++){var u;E+=(u=b[r])+" = "+this.game.gameModeData[u]+(r<b.length-1?"\n":"")}this.triggerCallback("chat",{messageText:E,playerText:"Game Data",date:Date.now()});break;case"/wave":a[1]?(this.game.gameModeData.wave=parseInt(a[1]),this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{wave:this.game.gameModeData.wave}})):this.onSurvivalWaveComplete();break;case"/function":this.executeScenarioFunction(a[1]);break;case"/trigger":this.executeTriggerById(a[1]);break;case"/spawn":case"/s":try{this.spawn(e,a)}catch(e){this.onGameError(e)}break;case"/item":if(t=this.getPlayerById(e))this.getItemData(a[1])&&(t.items.push({id:a[1]}),t.itemIndex=t.items.length-1,this.onEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:i.data.id,data:{items:t.items,itemIndex:t.itemIndex}}));break;case"/god":i&&(i.data.bGodMode=!i.data.bGodMode,this.triggerCallback("chat",{messageText:"God mode "+(i.data.bGodMode?"enabled":"disabled")}));break;case"/unlimitedAmmo":i&&(i.data.weapon.bUnlimitedAmmo=!i.data.weapon.bUnlimitedAmmo,this.triggerCallback("chat",{messageText:"Unlimited ammo "+(i.data.weapon.bUnlimitedAmmo?"enabled":"disabled")}));break;case"/revive":case"/r":this.respawnAllPlayers();break;case"/survival_char":this.spawnSurvivalEnemyCharacter();break;case"/survival_turret":this.spawnSurvivalEnemyTurret();break;case"/survival_vehicle":this.spawnSurvivalEnemyVehicle();break;case"/survival_car":this.spawnSurvivalEnemyVehicle([ObjectType.CAR]);break;case"/survival_airdrop":this.spawnSurvivalEnemyAirdrop();break;case"/survival_bgm71":this.spawnSurvivalEnemyVehicle([MountedWeapon.BGM71]);break;case"/survival_egg":this.spawnSurvivalEnemyEgg()}}}respawnAllPlayers(e){if(!this.bGameEnded)for(var a=0;a<this.game.players.length;a++){var t=this.game.players[a];if(!this.getObjectById(t.id)||!t.bHasPawn){let a=this.getReviverByPlayerId(t.id),i=e||{};a&&(i.position=this.clone(a.position)),this.respawnPlayer(t.id,i),this.game.bSurvival&&this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_END_REVIVE,reviveId:t.id}),a&&this.removeNextStep(a)}}}spawn(e,a){var t=this.getObjectById(e);if(t){var i=this.clone(t.position);i[0]+=this.Random(-50,50),i[1]+=this.Random(-50,50);var s=a[1];switch(s){case"sprite":this.createPolygon({position:i,rotation:0,spriteId:a[2]});break;case"window":this.createWindow({width:3,height:50,position:i});break;case"character":this.createCharacter({position:i,team:0,inventory:[{id:"m16a4"}],avatar:this.getAvatarDataById(AvatarPresets.DINOGEN),bBot:!0,botSkill:2});break;case"juggernaut":this.createCharacter({position:i,team:1,inventory:[{id:"m240"}],avatar:this.getAvatarDataById(AvatarPresets.JUGGERNAUT),bBot:!0,botSkill:1,health:1e3,bJuggernaut:!0});break;case"zombie":this.createCharacter({position:i,team:1,inventory:[],avatar:this.getAvatarDataById(AvatarPresets.ZOMBIE),bBot:!0,bZombie:!0,botSkill:1,health:500});break;case ObjectType.EGG:var r=[Egg.SMALL,Egg.LARGE,Egg.HUGE];this.createEgg(i,{eggType:r[this.Random(0,r.length-1)],team:null!=a[2]?parseInt(a[2]):1,items:[{type:ObjectType.DINOSAUR,dinoType:this.getRandomDinosaur(),bSavage:!0,bBot:!0},{type:ObjectType.DINOSAUR,dinoType:this.getRandomDinosaur(),bSavage:!0,bBot:!0},{type:ObjectType.DINOSAUR,dinoType:this.getRandomDinosaur(),bSavage:!0,bBot:!0}]});break;case"money":this.createMoney(i,{value:this.Random(100,1e3)});break;case ObjectType.DUMMY:this.createDummy({position:i,team:-1});break;case"item":var n=this.getWeaponData(a[2]);n&&(this.setRandomWeaponMods(n),this.createDroppedWeapon(i,{weaponData:n}));break;case"store":this.createCrate(i,{team:0,crateType:Crate.STORE,mass:0,bDisposable:!1}).mass=0;break;case"bomb":this.createCrate(i,{team:0,crateType:Crate.BOMB,mass:0,bDisposable:!1,itemData:{interactTime:3*this.game.settings.fps}}).data.bombNum=0;break;case"crate_static":this.createCrate(t.position,{team:0,crateType:Crate.AMMO,mass:0}).mass=0;break;case ObjectType.CRATE:this.createCrate(i,{team:t.data.team,crateType:Crate.AMMO});break;case"crate_item":this.createCrate(i,{team:t.data.team,crateType:Crate.ITEM,itemId:this.getRandomItemId()});break;case"crate_weapon":this.createCrate(i,{team:t.data.team,crateType:Crate.WEAPON,items:[{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0},{type:ObjectType.DROPPED_WEAPON,weaponData:this.getRandomWeapon(),bRandomVelocity:!0}]});break;case"turret":this.createMountedWeapon(i,{team:t.data.team,playerId:t.data.id,vehicleId:MountedWeapon.M2,weapons:[[{id:a[2]}]]});break;case MountedWeapon.M2:case MountedWeapon.BGM71:case MountedWeapon.M242:this.createMountedWeapon(i,{team:t.data.team,playerId:t.data.id,vehicleId:s});break;case MountedWeapon.SENTRY:case MountedWeapon.SENTRY_SHOTGUN:case MountedWeapon.SENTRY_SNIPER:case MountedWeapon.SENTRY_GRENADE:case MountedWeapon.SENTRY_SAM:case MountedWeapon.SENTRY_FLAME:case MountedWeapon.SENTRY_RAILGUN:this.createMountedWeapon(i,{team:a[2]?parseInt(a[2]):t.data.team,playerId:t.data.id,vehicleId:s,bAutomated:!0});break;case"minefield":for(var o=a[2]?parseInt(a[2]):200,d=(this.getCurrentMapData(),Math.round(this.getMapWidth()/o)),l=Math.round(this.getMapHeight()/o),h=0;h<d;h++)for(var m=0;m<l;m++)this.createObstacle({type:ObjectType.OBSTACLE,obstacleId:"barrel_explosive",position:[h*o+.5*o,m*o+.5*o],rotation:this.RandomAngle(),mass:0});this.triggerCallback("chat",{messageText:"Created minefield with "+d*l+" explosives"});break;case"forest":this.createForest(a[2]?parseInt(a[2]):400);break;case"boxes":this.createBoxes(a[2]?parseInt(a[2]):400);break;case"rock":this.createObstacle({type:ObjectType.OBSTACLE,position:t.position,health:100,obstacleId:"rock_1",angle:this.RandomAngle()});break;case ObjectType.OBSTACLE:this.createObstacle({type:ObjectType.OBSTACLE,position:t.position,obstacleId:a[2],angle:t.data.aimRotation});break;case ObjectType.TREE:this.createTree({type:ObjectType.TREE,treeType:a[2]?a[2]:"tree",position:t.position});break;case"barrel":this.createObstacle({type:ObjectType.OBSTACLE,position:i,obstacleId:"barrel_generic"});break;case"barrel_explosive":this.createObstacle({type:ObjectType.OBSTACLE,position:i,obstacleId:"barrel_explosive"});break;case"weapon":var c=this.getAllWeapons(),p=this.getWeaponData(c[this.Random(0,c.length-1)].id);this.setRandomWeaponMods(p),this.createDroppedWeapon(i,{weaponData:p});break;case Weapon.TYPE_PISTOL:case Weapon.TYPE_MACHINE_PISTOL:case Weapon.TYPE_SHOTGUN:case Weapon.TYPE_SMG:case Weapon.TYPE_RIFLE:case Weapon.TYPE_CARBINE:case Weapon.TYPE_SNIPER:case Weapon.TYPE_DMR:case Weapon.TYPE_LMG:case Weapon.TYPE_LAUNCHER:c=this.getAllWeaponsByType(s),p=this.getWeaponData(c[this.Random(0,c.length-1)].id);this.setRandomWeaponMods(p),this.createDroppedWeapon(i,{weaponData:p});break;case"ammo":this.createEquipment(i,{team:t.data.team,angle:t.data.aimRotation,weaponId:"ammo_box",itemData:{uses:10,maxUses:10,interactTime:.5}}).data.destroyTimer=60*this.game.settings.fps;break;case"airdrop":this.createHelicopter([0,0],{vehicleId:Helicopter.OSPREY,team:t.data.team,destination:i,items:[{type:ObjectType.EGG,eggType:Egg.LARGE,team:0,items:[{type:ObjectType.DINOSAUR,dinoType:this.getRandomDinosaur()}]}],bAutomated:!0});break;case"helicopter":this.createHelicopter(i,{vehicleId:a[2],team:1,bAutomated:!0});break;case"savage":var g=a[2]?a[2]:this.getRandomDinosaur();this.createDinosaur({id:this.getRandomUniqueId(),x:i[0],y:i[1],team:1,dinoType:g,bBot:!0,botSkill:this.Random(0,5),bSavage:!0});break;case ObjectType.DINOSAUR:g=a[2]?a[2]:this.getRandomDinosaur(),this.createDinosaur({id:this.getRandomUniqueId(),x:i[0],y:i[1],team:1,dinoType:g,bBot:!0,botSkill:this.Random(0,5)});break;case Car.PICKUP:case Car.QUAD:case Car.GROWLER:case Car.MRAP:case Car.LAV25:this.createCar(i,{vehicleId:s,team:-1});break;case Tank.ABRAMS:case Tank.T90:this.createTank(i,{vehicleId:s,team:-1});break;case Helicopter.MH6:case Helicopter.SEAKNIGHT:case Helicopter.BLACKHAWK:case Helicopter.KIOWA:case Helicopter.COBRA:case Helicopter.APACHE:case Helicopter.OSPREY:case Helicopter.CHICKENCOPTER:this.createHelicopter(i,{vehicleId:s,team:-1,bAutomated:1==a[2]});break;default:console.warn("Unhandled spawn",a[1])}}}ejectPawn(e){var a=this.getObjectById(e);if(a){var t=this.getObjectById(a.data.controllableId);t&&(t.position[1]-=500)}}killPawn(e){var a=this.getObjectById(e);if(a){var t=a.data.health;a.data.damageMultipliers&&(a.data.damageMultipliers[DamageType.DAMAGE_WORLD]=1),a.data.bGodMode&&(a.data.bGodMode=!1),this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_WORLD,damageAmount:Math.max(t,500),pawnId:e,attackerId:e,weaponId:"generic"})}}removeEquipmentByPlayerId(e,a){if(e)for(var t=this.getEquipment(),i=0;i<t.length;i++){var s=t[i];s.data.ownerId==e&&(null!=a?s.data.weaponData.id==a&&this.removeNextStep(s):this.removeNextStep(s))}}removeGrenadesByPlayerId(e,a){if(e)for(var t=this.getGrenades(),i=0;i<t.length;i++){var s=t[i];s.data.playerId==e&&(null!=a?s.data.weaponData.id==a&&this.removeNextStep(s):this.removeNextStep(s))}}createSpawner(e,a){if(this.getSpawners().length>=this.settings.maxSpawners)this.scenarioLog("Exceeded spawner limit",Colours.RED_STRING);else{var t=new this.p2.Body({mass:0,fixedRotation:!0,position:e});t.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.SPAWNER,objectData:a.data,timer:0,ids:[],numObjects:a.numObjects?a.numObjects:1,totalObjects:a.totalObjects,randomX:a.randomX,randomY:a.randomY,timerMax:null!=a.timerMax?a.timerMax:10*this.game.settings.fps,bDisabled:a.bDisabled,bSkipServerUpdate:!0},this.addWorldBody(t,!1),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.SPAWNER,position:a.position,data:t.data})}}handleSpawner(e){if(!this.matchHasEnded()){var a=e.data;if(!a.bDisabled){for(var t=0,i=a.numObjects,s=0;s<i;s++){var r=a.ids[s],n=this.getObjectById(r),o=[e.position[0],e.position[1]];if(a.randomX&&(o[0]+=this.Random(.5*-a.randomX,.5*a.randomX)),a.randomY&&(o[1]+=this.Random(.5*-a.randomY,.5*a.randomY)),!n){var d=!0;if(a.timer<=0){var l=a.objectData;if(l){switch(l.type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:case ObjectType.DUMMY:if(this.getPawns().length>=this.settings.maxPawns)return}switch(l.id=a.objectId?a.objectId:this.getRandomUniqueId(),l.type){case ObjectType.SPAWNER:break;case ObjectType.DROPPED_WEAPON:var h=this.clone(l);h.weaponData=this.getWeaponData(l.weaponId),(n=this.createDroppedWeapon(o,h)).data.bSpawned=!0;break;case ObjectType.HELICOPTER:n=this.createHelicopter(o,l);break;case ObjectType.TANK:n=this.createTank(o,l);break;case ObjectType.CAR:n=this.createCar(o,l);break;case ObjectType.MOUNTED_WEAPON:n=this.createMountedWeapon(o,l);break;case ObjectType.ARROW:n=this.createArrow(o,l);break;default:delete l.bRespawn,l.position=o,n=this.createObject(l)}}else console.warn("Invalid spawner data",l);n?(a.ids[s]=n.data.id,t++):this.scenarioLog("Spawner did not create a pawn",Colours.RED_STRING)}break}}d&&(a.timer>0?a.timer--:a.timer=a.timerMax),t>0&&null!=a.totalObjects&&(a.totalObjects-=t,a.totalObjects<=0&&this.removeNextStep(e))}}}createTank(e,a){a.vehicleId||(a.vehicleId=Tank.ABRAMS,console.warn("Missing vehicle id"));var t=this.getSharedData(a.vehicleId),i=new this.p2.Body({mass:null!=a.mass?a.mass:t.mass,position:e,angle:null!=a.angle?a.angle:null!=a.rotation?this.ToRad(a.rotation):0,damping:.99,angularDamping:t.angularDamping,allowSleep:!0,sleepSpeedLimit:10}),s={1:.025,2:.025,3:1,4:.05};this.game.bSurvival&&(s={1:.025,2:.025,3:.35,4:.025}),i.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.TANK,material:Material.METAL,damageMultipliers:s,team:null!=a.team?a.team:-1,speed:2500,health:4e3,vehicleId:a.vehicleId,bAutomated:a.bAutomated,bDisabled:a.bDisabled,bRegenHealth:null!=a.bRegenHealth?a.bRegenHealth:this.game.bSurvival,bUnlimitedAmmo:!0,regenTimerMax:180*this.game.fpsMult,regenTimer:0,regenThreshold:.25,pawnName:a.pawnName,tint:a.tint};var r=i.data,n=this.game.bSurvival&&r.team<=0;switch(r.vehicleId){case Tank.ABRAMS:r.speed=2500,r.maxSpeed=275,r.health=4e3,r.seats=[{position:[0,0],bInvisible:!0},{position:[0,0],damageMultiplier:n?0:.1},{position:[-110,-40],bInput:!0,damageMultiplier:n?.25:.5},{position:[-110,40],bInput:!0,damageMultiplier:n?.25:.5}];var o=this.getWeaponData("m240");o.accuracy=3.5;var d=this.getWeaponData("m2");this.game.bSurvival&&(o.damage*=1.5,d.damage*=1.5),r.weapons=[[{muzzlePos:[0,0],weaponData:this.getWeaponData("m256a1"),aimSpeed:.1},{muzzlePos:[0,0],weaponData:o,aimSpeed:.1}],[{muzzlePos:[0,0],weaponData:d}],[null],[null]];break;case Tank.T90:r.speed=3e3,r.maxSpeed=300,r.health=3800,r.seats=[{position:[0,0],bInvisible:!0},{position:[0,0],damageMultiplier:n?0:.1},{position:[-100,-40],bInput:!0,damageMultiplier:n?.25:.5},{position:[-100,40],bInput:!0,damageMultiplier:n?.25:.5}];d=this.getWeaponData("m2");this.game.bSurvival&&(d.damage*=1.5),r.weapons=[[{muzzlePos:[0,0],weaponData:this.getWeaponData("d81"),aimSpeed:.1}],[{muzzlePos:[0,0],weaponData:d}],[null],[null]]}r.speed/=this.game.fpsMult,this.initVehicleWeapons(i,r.weapons),a.weapons&&this.applyCustomVehicleWeapons(i,a.weapons),null!=a.weaponRotation&&r.weapons&&r.weapons[0]&&this.setVehicleWeaponAimRotation(r.weapons[0][0],i.angle+this.ToRad(a.weaponRotation),1,!0),r.maxHealth=r.health;var l=new this.p2.Box({width:t.width,height:t.height,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.PAWN|CollisionGroups.BOUNDS});return i.addShape(l),this.addWorldBody(i),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.TANK,position:i.position,rotation:i.angle,data:i.data}),i}getCharacterInventoryItemIndex(e,a){if(e){var t=e.data.inventory;if(t)for(var i=0;i<t.length;i++){var s=t[i];if(s&&s.id==a)return i}}return-1}characterHasEquipment(e,a){if(e){var t=e.data.equipment;return t&&t.id==a&&(t.ammo||t.bPassive)}return!1}characterHasGrenade(e,a){if(e){e.data.grenade;return grenade&&grenade.id==a}return!1}setVehicleWeapon(e,a,t,i){if(e)try{var s=e.data,r=s.weapons;if(r){i&&delete s.seats[a].bInput;var n=r[a][t]={aimRotation:0,overheat:0,muzzlePos:[0,0],weaponData:i};this.initVehicleWeapon(e,n),this.pushObjectDataUpdate(s.id,["weapons"])}else this.log("Invalid vehicle weapons")}catch(e){this.onGameError(e)}}createCar(e,a){a.vehicleId||(a.vehicleId=Car.QUAD,console.warn("Missing vehicle id"));var t=this.getSharedData(a.vehicleId),i=new this.p2.Body({mass:null!=a.mass?a.mass:t.mass,position:e,angle:null!=a.angle?a.angle:a.rotation?this.ToRad(a.rotation):0,damping:.99,angularDamping:t.angularDamping,allowSleep:!0,sleepSpeedLimit:10});a.rotation&&(i.angle=this.ToRad(a.rotation)),i.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.CAR,material:Material.METAL,damageMultipliers:{1:.25,2:.25,3:1.5,4:.1},team:null!=a.team?a.team:-1,scale:null!=a.scale?a.scale:1,carData:a,vehicleId:a.vehicleId,bRegenHealth:null==a.bRegenHealth||a.bRegenHealth,regenTimerMax:180*this.game.fpsMult,regenTimer:0,regenThreshold:.25,bAutomated:a.bAutomated,bUntargetable:a.bUntargetable,bUnlimitedAmmo:!0,bKillOccupantsWhenDestroyed:a.bKillOccupantsWhenDestroyed,bLeaveWhenNoOccupants:a.bLeaveWhenNoOccupants,bGodMode:a.bGodMode,pawnName:a.pawnName,tint:a.tint};var s=i.data,r=this.game.bSurvival&&s.team<=0;switch(this.game.bSurvival&&(s.damageMultipliers={1:.1,2:.1,3:1.5,4:.01}),s.vehicleId){case Car.QUAD:s.speed=500,s.health=500,s.seats=[{position:[5,0]},{position:[-30,0],bInput:!0}];break;case Car.PICKUP:s.speed=1e3,s.health=1e3,s.seats=[{position:[40,0],bInvisible:!0},{position:[-20,-20],bInput:!0},{position:[-20,20],bInput:!0},{position:[-65,-20],bInput:!0},{position:[-65,20],bInput:!0}],s.weapons=[[null],[null],[null],[null],[null]];break;case Car.GROWLER:s.speed=1e3,s.health=1e3,s.seats=[{position:[0,-15]},{position:[-45,0]},{position:[0,15],bInput:!0,damageMultiplier:.5}],s.weapons=[[null],[{muzzlePos:[-45,0],weaponData:this.getWeaponData("m240"),aimRotation:0}],[null]];break;case Car.MRAP:r&&(s.damageMultipliers[DamageType.DAMAGE_BULLET]=.05,s.damageMultipliers[DamageType.DAMAGE_EXPLOSIVE]=.25),s.speed=1250,s.health=2e3,s.seats=[{position:[30,0],bInvisible:!0,bBack:!0},{position:[-15,0],damageMultiplier:r?0:.1},{position:[-70,-35],bInput:!0,damageMultiplier:r?.25:.5},{position:[-70,35],bInput:!0,damageMultiplier:r?.25:.5}];var n=this.getWeaponData("m2");this.game.bSurvival&&(n.damage*=1.25),s.weapons=[[null],[{muzzlePos:[-10,0],weaponData:n,aimRotation:0}],[null],[null]];break;case Car.LAV25:this.game.bSurvival&&(s.damageMultipliers[DamageType.DAMAGE_BULLET]=.05,s.damageMultipliers[DamageType.DAMAGE_EXPLOSIVE]=1),s.speed=1200,s.health=2e3,s.seats=[{position:[20,0],bBack:!0,bInvisible:!0},{position:[-30,0],damageMultiplier:r?0:.1},{position:[-100,-35],bInput:!0,damageMultiplier:r?.25:.5},{position:[-100,35],bInput:!0,damageMultiplier:r?.25:.5}];var o=this.getWeaponData("m242");o.accuracy=1,this.game.bSurvival&&0==s.team&&(s.damage*=1.5),s.weapons=[[{muzzlePos:[-20,0],weaponData:o,aimRotation:0}],[{muzzlePos:[-30,0],weaponData:this.getWeaponData("m240"),aimRotation:0}],[null],[null]]}a.weapons&&this.applyCustomVehicleWeapons(i,a.weapons),this.initVehicleWeapons(i,s.weapons),null!=a.weaponRotation&&s.weapons&&s.weapons[0]&&this.setVehicleWeaponAimRotation(s.weapons[0][0],i.angle+this.ToRad(a.weaponRotation),1,!0),s.maxHealth=s.health,s.speed/=this.game.fpsMult,a.speed&&(s.speed=a.speed),this.removeUndefinedKeys(s);var d=new this.p2.Box({width:t.width,height:t.height,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.PAWN|CollisionGroups.BOUNDS});return i.addShape(d),this.addWorldBody(i),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.CAR,position:i.position,rotation:i.angle,data:i.data}),i}applyCustomVehicleWeapons(e,a){var t=e.data;if(t.bCustomWeapons=!0,a)for(var i=0;i<a.length;i++){if(!t.seats[i])continue;let r=a[i];if(r)for(var s=0;s<r.length;s++){let a=r[s];if(a){if(!t.weapons){t.weapons=[];for(let e=0;e<t.seats.length;e++)t.weapons.push([null])}t.weapons[i][s],t.weapons[i][s]={muzzlePos:t.type==ObjectType.MOUNTED_WEAPON?[0,0]:t.seats[i].position,aimRotation:0};let r=this.getWeaponData(a.id,a);r&&!r.bEquipment&&(r.bVehicle&&this.initVehicleWeapon(e,a),r.bVehicle=!0,t.weapons[i][s].weaponData=r,delete t.seats[i].bInput)}}}}detachRope(e){if(e){var a=e.data;if(a.attachId){this.game.world.removeConstraint(e.constraint),delete e.constraint;var t=this.getObjectById(a.attachId);if(t){var i=this.getSharedData(t.data.vehicleId);i&&i.mass,this.game.world.removeConstraint(t.constraint),delete t.constraint,this.setDataValue(t,"attachToId",null)}this.setDataValue(e,"attachId",null)}}}attachObjects(e,a){if(a&&a.data.health){a.data.attachToId=e.data.id;var t=new this.p2.RevoluteConstraint(e,a,{worldPivot:[e.position[0],e.position[1]]});t.setRelaxation(.5),t.setStiffness(100),this.game.world.addConstraint(t),a.constraint=t,e.constraint=t,this.setDataValue(a,"attachToId",e.data.id),this.setDataValue(e,"attachId",a.data.id)}}createHelicopter(e,a){a.vehicleId||(a.vehicleId=Helicopter.MH6,console.warn("Missing vehicle id"));var t=this.getSharedData(a.vehicleId);t||(t={mass:10,width:32,height:32});var i=Math.max(0,null!=a.mass?a.mass:t.mass?t.mass:10),s=new this.p2.Body({mass:i,position:e,angle:null!=a.angle?a.angle:null!=a.rotation?this.ToRad(a.rotation):0,angularDamping:.8,damping:.5,allowSleep:!0,sleepSpeedLimit:10});s.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.HELICOPTER,material:Material.METAL,damageMultipliers:{1:.5,2:.1,3:2,4:.1},mass:i,sway:this.Random(0,99),swayDir:this.RandomBoolean()?1:-1,swayMax:100,team:null!=a.team?a.team:-1,scale:null!=a.scale?a.scale:1,angleMult:.015,vehicleId:a.vehicleId,bRegenHealth:null!=a.bRegenHealth?a.bRegenHealth:this.game.bSurvival,regenTimerMax:180*this.game.fpsMult,regenTimer:0,regenThreshold:.25,speed:2500,playerId:a.playerId,bAutomated:a.bAutomated,bUntargetable:a.bUntargetable,bDisabled:a.bDisabled,bUnlimitedAmmo:!0,bGodMode:a.bGodMode,items:a.items,bDropItemsWhenDestroyed:null==a.bDropItemsWhenDestroyed||a.bDropItemsWhenDestroyed,bKillOccupantsWhenDestroyed:a.bKillOccupantsWhenDestroyed,destination:a.destination,destinationTimer:(a.destinationTimer?a.destinationTimer:3)*this.game.settings.fps,defendTimer:a.defendTimer?a.defendTimer:0,itemTimerMax:(a.itemTimerMax?a.itemTimerMax:5)*this.game.settings.fps,pawnName:a.pawnName,indicatorData:a.indicatorData,interactTeam:a.interactTeam,tint:a.tint,enemyTypes:a.enemyTypes};var r=s.data;this.game.bSurvival&&(r.reward=500);var n=this.getWeaponData("gatling");switch(r.vehicleId){case Helicopter.MH6:r.health=1e3,r.speed=2e3,r.seats=[{position:[40,0],bInvisible:!0}],r.weapons=[[{muzzlePos:[40,0],aimRotation:0,overheat:0}]];break;case Helicopter.SEAKNIGHT:r.health=3e3,r.speed=1250,r.seats=[{position:[50,0],bInvisible:!0},{position:[0,0],bInvisible:!0},{position:[-50,0],bInvisible:!0},{position:[-100,0],bInvisible:!0}],r.weapons=[[{muzzlePos:[0,0],aimRotation:0,overheat:0}],[null],[null],[null]];break;case Helicopter.COBRA:r.health=1500,r.speed=2e3,r.seats=[{position:[80,0],bInvisible:!0}],r.weapons=[[{muzzlePos:[80,0],weaponData:n}]];break;case Helicopter.APACHE:r.health=2e3,r.speed=1500,r.seats=[{position:[80,0],bInvisible:!0}],r.weapons=[[{muzzlePos:[80,0],weaponData:this.getWeaponData("rocket_guided")},{muzzlePos:[80,0],weaponData:n}]];break;case Helicopter.KIOWA:r.health=1750,r.speed=1750,r.seats=[{position:[150,0],bInvisible:!0},{position:[100,-30],bInput:!0},{position:[100,30],bInput:!0}],r.weapons=[[{muzzlePos:[150,0],weaponData:this.getWeaponData("minigun")}],[null],[null]];break;case Helicopter.BLACKHAWK:r.health=3e3,r.speed=1250,r.seats=[{position:[150,0],bInvisible:!0},{position:[120,-35],bInvisible:!1},{position:[120,35],bInvisible:!1},{position:[70,-35],bInvisible:!1,bInput:!0},{position:[70,35],bInvisible:!1,bInput:!0}],r.weapons=[[{muzzlePos:[0,0],aimRotation:0,overheat:0}],[{muzzlePos:[120,-40],weaponData:this.getWeaponData("minigun")}],[{muzzlePos:[120,40],weaponData:this.getWeaponData("minigun")}],[null],[null]];break;case Helicopter.OSPREY:r.health=3250,r.speed=1500;var o=this.getWeaponData("m242");this.game.bSurvival&&0!=r.team&&(o.accuracy=5),r.seats=[{position:[100,0],bInvisible:!0},{position:[50,0],bInvisible:!0},{position:[-50,-20],bInvisible:!0,bInput:!0},{position:[-50,20],bInvisible:!0,bInput:!0}],r.weapons=[[{muzzlePos:[0,0],weaponData:o}],[{muzzlePos:[160,0],weaponData:n}],[null],[null]];break;case Helicopter.CHICKENCOPTER:r.health=500,r.speed=1e3,r.seats=[{position:[0,0]}];var d=this.getWeaponData("m2");r.weapons=[[{muzzlePos:[0,0],weaponData:d}]];break;default:console.warn("Unhandled helicopter",r.vehicleId),r.health=1e3,r.speed=1500,r.seats=[{position:[0,0]}],r.weapons=[[{muzzlePos:[0,0],weaponData:this.getWeaponData("m2")}]]}if(r.speed=Math.round(r.speed/this.game.fpsMult),r.bAutomated){var l=r.weapons[0]?r.weapons[0][0]:null;l&&l.weaponData&&(l.weaponData.ammoMax=l.weaponData.ammo)}this.initVehicleWeapons(s,r.weapons),a.weapons&&this.applyCustomVehicleWeapons(s,a.weapons),r.maxHealth=r.health,this.game.bSurvival&&0==r.team&&(r.damageMultipliers={1:.1,2:.1,3:.25,4:.1});var h=new this.p2.Box({width:t.width,height:t.height,collisionGroup:CollisionGroups.HELICOPTER,collisionMask:r.bAutomated?CollisionGroups.HELICOPTER|CollisionGroups.PROJECTILE:CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.PAWN|CollisionGroups.BOUNDS});return s.addShape(h),this.addWorldBody(s),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.HELICOPTER,position:s.position,rotation:s.angle,data:s.data}),s}initVehicleWeapons(e,a){if(e.data.weaponIndex=0,a)for(var t=0;t<a.length;t++){var i=a[t];if(i)for(var s=0;s<i.length;s++){var r=i[s];r&&this.initVehicleWeapon(e,r)}}}initVehicleWeapon(e,a){a.overheat=0,a.aimRotation=e.angle,a.weaponData&&(a.weaponData.bVehicle=!0,a.weaponData.ammoMax&&(a.ammo=a.weaponData.ammoMax,a.weaponData.overheatMax=100,a.weaponData.overheatNum=Math.round(a.weaponData.overheatMax/a.weaponData.ammoMax),a.weaponData.overheatCooldownNum=0))}setPawnRequest(e,a){if(e&&e.data&&e.data.type==ObjectType.CHARACTER&&(this.setDataValue(e,"currentRequest",a||0),a)){switch(a){case Commands.REQUEST_FOLLOW:var t=10;break;default:t=3}e.data.requestTimer=this.game.settings.fps*t}}createDoor(e){var a=new this.p2.Body({mass:0,position:e.position,angle:null!=e.rotation?this.ToRad(e.rotation):0,allowSleep:!0,sleepSpeedLimit:10}),t=e.size?e.size:100;switch(e.doorType){case"garage":case"garage_large":case"sliding":var i=Material.METAL;break;default:i=Material.WOOD}return e.material&&(i=e.material),a.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.DOOR,bClosed:e.bClosed,bDisabled:e.bDisabled,triggerId:e.triggerId,material:i,width:50,size:t,cooldownTimer:0,team:-1,doorType:e.doorType,leverId:e.leverId,health:e.health},a.addShape(new this.p2.Box({width:a.data.width,height:t,collisionGroup:CollisionGroups.PAWN})),this.addWorldBody(a),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.DOOR,position:a.position,rotation:a.angle,data:a.data}),this.setDoorClosed(a,a.data.bClosed),a}setDoorClosed(e,a,t,i,s){if(e){var r=e.data;if(!s&&r.cooldownTimer>0)return;var n=r.bClosed;r.bClosed=a;var o=e.shapes[0];if(a?(o.collisionGroup=CollisionGroups.GROUND,o.collisionMask=CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.HELICOPTER|CollisionGroups.FLAME):(o.collisionGroup=0,o.collisionMask=0),r.bClosed!=n){var d=null;if(t&&(r.cooldownTimer=Math.round(.5*this.game.settings.fps),!a)){var l=t.previousPosition?t.previousPosition:t.position;switch(e.angle){case this.ToRad(90):case this.ToRad(-90):d=e.position[1]>l[1]?1:-1;break;default:d=e.position[0]>l[0]?1:-1}}this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:r.id,causerId:t?t.data.id:null,type:GameServer.PAWN_UPDATE_DOOR,bClosed:r.bClosed,scale:d,bImpact:i}),r.bClosed?this.dispatchTrigger({event:"doorClosed",objectId:r.id,causerId:t?t.data.id:null}):this.dispatchTrigger({event:"doorOpened",objectId:r.id,causerId:t?t.data.id:null})}r.bDisabled&&(r.bClosed?this.addDirtyNodeObject(e):this.removeDirtyNodeObject(r.id))}}createForest(e=200){for(var a=Math.max(100,e),t=(this.getCurrentMapData(),Math.round(this.getMapWidth()/a)),i=Math.round(this.getMapHeight()/a),s=a,r=0;r<t;r++)for(var n=0;n<i;n++){var o=[r*a+.5*a+this.Random(-s,s),n*a+.5*a+this.Random(-s,s)];this.isInWall([o])||this.createTree({type:ObjectType.TREE,treeType:this.RandomBoolean()?"tree":"tree_palm",position:o,angle:this.RandomAngle()})}}createBoxes(e=200){for(var a=Math.max(200,e),t=Math.round(this.getMapWidth()/a),i=Math.round(this.getMapHeight()/a),s=.5*a,r=["box","box","box_small"],n=0;n<t;n++)for(var o=0;o<i;o++){var d=[n*a+a+this.Random(-s,s),o*a+a+this.Random(-s,s)];this.isInWall([d])||this.createObstacle({type:ObjectType.OBSTACLE,obstacleId:r[this.Random(0,r.length-1)],position:d,angle:this.RandomAngle()})}this.triggerCallback("chat",{messageText:"Added "+t*i+" boxes"})}createMountedWeapon(e,a){var t=new this.p2.Body({mass:a.mass?a.mass:0,position:e,angle:null!=a.angle?a.angle:null!=a.rotation?this.ToRad(a.rotation):0,damping:.99,angularDamping:.99,allowSleep:!0,sleepSpeedLimit:10});t.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.MOUNTED_WEAPON,material:Material.METAL,vehicleId:a.vehicleId,weaponType:a.vehicleId,team:null!=a.team?a.team:-1,scale:1,playerId:a.playerId,damageMultipliers:{1:1,2:2,3:1,4:.1},bAutomated:a.bAutomated,ammo:null!=a.ammo?a.ammo:100,bRegenHealth:null==a.bRegenHealth||a.bRegenHealth,regenThreshold:.25,reward:a.bAutomated?500:50,pawnName:a.pawnName,maxRange:a.maxRange,bUntargetable:a.bUntargetable,bUnlimitedAmmo:null!=a.bUnlimitedAmmo?a.bUnlimitedAmmo:!a.ammo,bDisableAutomatedLaser:a.bDisableAutomatedLaser,bGodMode:a.bGodMode,bAutoLock:a.bAutoLock};var i=t.data;if(this.game.bSurvival)if(0==i.team)i.damageMultipliers={1:.1,2:.25,3:1,4:.1};else{var s=!0;i.damageMultipliers={1:1,2:2,3:2,4:.1}}var r=this.getWeaponData(i.vehicleId);switch(i.vehicleId){case MountedWeapon.M2:i.health=500,i.weaponData={type:i.vehicleId},i.seats=[{position:[-20,0],bTurret:!0}],i.weapons=[[{id:r.id,muzzlePos:[0,0],weaponData:r}]];break;case MountedWeapon.M242:i.health=750,i.frame="bushmaster",i.weaponData={type:i.vehicleId},i.seats=[{position:[-20,0],bTurret:!0}],r.fireRate=Math.round(.75*r.fireRate),i.weapons=[[{id:r.id,muzzlePos:[0,0],weaponData:r}]];break;case MountedWeapon.BGM71:i.health=500,i.weaponData={type:i.vehicleId},i.seats=[{position:[-20,0],bBack:!0,bTurret:!0}],i.weapons=[[{muzzlePos:[0,0],weaponData:this.getWeaponData("bgm71")}]];break;default:switch(i.health=500,i.weaponData={type:i.vehicleId},i.seats=[{position:[-25,0],bTurret:!0}],i.vehicleId){case MountedWeapon.SENTRY_SHOTGUN:i.ammo=500,(r=this.getWeaponData("jackhammer")).damage=35,r.fireRate=15,r.accuracy=15,r.range=650;break;case MountedWeapon.SENTRY_SNIPER:i.ammo=250,i.health=1e3,(r=this.getWeaponData("m82")).fireRate=60,this.game.bSurvival&&(r.range=2500,0!=i.team&&(r.damage=1e3));break;case MountedWeapon.SENTRY_GRENADE:i.ammo=250,(r=this.getWeaponData("thumper")).accuracy=0,r.fireRate=90,r.damage=350,r.radius=300;break;case MountedWeapon.SENTRY_SAM:i.ammo=50,(r=this.getWeaponData("smaw")).fireRate=180,r.bAutoLock=!0,r.range=s?4e3:2500,s&&(i.maxRange=r.range,r.damage*=1.5);break;case MountedWeapon.SENTRY_FLAME:i.ammo=1e3,i.health=1e3,(r=this.getWeaponData("flamethrower")).damage=r.fireDamage=25,r.fireRate=6,r.velocity=1500,r.fireTime=1;break;case MountedWeapon.SENTRY_RAILGUN:i.ammo=75,i.health=1e3,(r=this.getWeaponData("railgun")).damage=750,r.fireRate=70;break;default:i.ammo=1e3,(r=this.getWeaponData(a.weaponId?a.weaponId:"mg4")).penetration=1}r.useId=i.vehicleId,i.weapons=[[{muzzlePos:[0,0],weaponData:r}]]}switch(null!=a.ammo&&(i.ammo=a.ammo),i.ammo&&(i.ammoMax=i.ammo),r&&(i.range=r.range),this.initVehicleWeapons(t,i.weapons),a.weapons&&this.applyCustomVehicleWeapons(t,a.weapons),this.setVehicleWeaponAimRotation(i.weapons[0],t.angle),this.game.gameModeId){case GameMode.EVOLUTION:i.damageMultipliers={1:.5,2:.5,3:.5,4:.5}}if(i.maxHealth=i.health,t.addShape(new this.p2.Circle({radius:this.getSharedData("turret").size,collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT})),i.playerId){var n=this.getMountedWeapons(i.playerId);n.length>=this.settings.maxTurretsPerPlayer&&this.removeNextStep(n[0])}return this.addWorldBody(t),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.MOUNTED_WEAPON,position:t.position,rotation:t.angle,data:t.data}),t}createWindow(e){var a=null!=e.mass?e.mass:0,t=new this.p2.Body({mass:a,position:e.position,angle:null!=e.rotation?this.ToRad(e.rotation):0,allowSleep:!0,sleepSpeedLimit:1});t.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.WINDOW,width:e.width?e.width:3,height:e.height,material:Material.GLASS,health:e.health?e.health:1,bSkipServerUpdate:0==a};var i=t.data;i.maxHealth=i.health,i.team=-1,i.damageMultipliers={1:1,2:.1,3:50},t.addShape(new this.p2.Box({width:e.width,height:e.height,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.HELICOPTER})),this.addWorldBody(t),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.WINDOW,position:t.position,rotation:t.angle,data:t.data})}createFlag(e,a){var t=new this.p2.Body({mass:a.flagType==GameMode.DOMINATION?0:10,position:e,fixedRotation:!0,allowSleep:!0,sleepSpeedLimit:10}),i=10*this.game.settings.fps;switch(t.data={id:a.id?a.id:this.getRandomUniqueId(),x:t.position[0],y:t.position[1],type:ObjectType.FLAG,num:a.num,flagType:a.flagType?a.flagType:this.game.gameModeId,team:a.team,bIsBeingCaptured:!1,bIsContested:!1,captureTimer:[i,i],captureTimerMax:i,pointTimer:0,pointTimerMax:2*this.game.settings.fps},t.data.flagType){case GameMode.DOMINATION:var s=this.getSharedData("flagCaptureSize");t.data.size=s;var r=new this.p2.Circle({radius:Math.round(.5*s)});r.sensor=!0;break;default:s=50,t.data.size=100,r=new this.p2.Circle({radius:Math.round(.5*s),collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.GROUND|CollisionGroups.BOUNDS})}return t.addShape(r),this.addWorldBody(t,null!=r),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.FLAG,position:t.position,data:t.data}),t}createObstacle(e){var a=this.getSharedData(e.obstacleId.indexOf("barrel")>=0?"barrel":e.obstacleId);"window"==e.obstacleId&&(a={mass:0,width:Math.max(20,e.width?e.width:3),height:e.height?e.height:100}),a||(a={mass:0,fixedRotation:!0,bNoBody:!0});var t=null!=e.mass?e.mass:a.mass,i=null!=e.angle?e.angle:null!=e.rotation?this.ToRad(e.rotation):0,s=new this.p2.Body({mass:t,damping:null!=a.damping?a.damping:.95,angularDamping:.99,position:e.position,angle:i,fixedRotation:0==t,allowSleep:!0,sleepSpeedLimit:10}),r={id:e.id?e.id:this.getRandomUniqueId(),obstacleId:e.obstacleId,spriteId:a.spriteId,scale:e.scale,playerId:e.playerId,type:ObjectType.OBSTACLE,width:a.width,height:a.height,items:e.items,bDropItemsWhenDestroyed:!0,indicatorData:e.indicatorData,mass:t,damping:s?s.damping:0,fixedRotation:!!s&&s.fixedRotation,tint:e.tint,objectScale:e.objectScale,opacity:e.opacity,bFlashing:e.bFlashing,bNoBody:a.bNoBody||e.bNoBody,bBlockLOS:!0,bSkipServerUpdate:0==t,layer:e.layer};switch(e.obstacleId){case"crate":r.material=Material.WOOD,r.bBlockLOS=!1;break;case"tv":r.material=Material.GLASS;break;case"sofa_1":case"sofa_2":case"sofa_3":case"chair_1":case"chair_2":r.bBlockLOS=!1,r.bIgnoreProjectiles=!0;break;case"cabinet_1":case"cabinet_2":case"table_large":case"table_circle":r.health=200,r.material=Material.WOOD,r.bBlockLOS=!1;break;case"bed":case"target_base":case"turret_base":case"turret_base_2":r.material=Material.WOOD,r.bBlockLOS=!1,r.bIgnoreProjectiles=!0;break;case"deployable_cover":r.material=Material.METAL,r.health=1e3,r.bBlockLOS=!1;break;case"window":r.material=Material.GLASS,r.health=1;break;case"armory":case"armory_table":case"armory_weapons":r.material=Material.WOOD,r.health=250,r.bBlockLOS=!1;break;case"logs":case"logs_large":r.material=Material.WOOD;break;case"desk":r.material=Material.WOOD,r.health=200,r.bBlockLOS=!1;break;case"generator":r.material=Material.METAL;break;case"target_dummy":r.material=Material.WOOD,r.health=200;break;case"box":case"box_2":r.material=Material.WOOD,r.health=1e3;break;case"box_small":r.material=Material.WOOD,r.health=500,r.bBlockLOS=!1;break;case"barrel_wood":r.health=200,r.material=Material.WOOD,r.bBlockLOS=!1;break;case"barrel_explosive":case"barrel_poison":case"barrel_oil":r.health=75,r.material=Material.METAL,r.damageMultipliers={1:1,3:50},r.bBlockLOS=!1;break;case"barrel_generic":r.health=1,r.material=Material.METAL,r.bGodMode=!0,r.bBlockLOS=!1;break;case"sandbags":case"sandbags_large":case"sandbags_small":r.material=Material.SANDBAG,r.damageMultipliers={1:.1},r.bBlockLOS=!1;break;case ObjectType.WINDOW:r.health=1,r.material=Material.GLASS;break;default:r.material=Material.DEFAULT}if(e.material&&(r.material=e.material),e.health&&(r.health=e.health),null!=e.bIgnoreProjectiles&&(r.bIgnoreProjectiles=e.bIgnoreProjectiles),r.health>0&&(r.maxHealth=r.health,r.team=-1),null!=e.bGodMode&&(r.bGodMode=e.bGodMode),this.removeUndefinedKeys(r),s){s.data=r;var n=CollisionGroups.OBJECT;if(t>0)var o=CollisionGroups.BOUNDS|CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.OBJECT|CollisionGroups.FLAME|CollisionGroups.HELICOPTER|CollisionGroups.PROJECTILE;else o=CollisionGroups.OBJECT|CollisionGroups.PAWN|CollisionGroups.FLAME|CollisionGroups.HELICOPTER|CollisionGroups.PROJECTILE;if(!r.bNoBody)if(r.spriteId)this.loadPolygon(r.spriteId,s,r.width,r.height,1,{material:new this.p2.Material,collisionGroup:n,collisionMask:o});else if("circle"==a.shape){var d=a.size?a.size:a.width;if(d<this.game.nodeThreshold)(l=new this.p2.Circle({radius:this.game.nodeThreshold,collisionMask:0})).sensor=!0,s.addShape(l);s.addShape(new this.p2.Circle({radius:d,collisionGroup:n,collisionMask:o}))}else{if(a.width<this.game.nodeThreshold)(l=new this.p2.Box({width:this.game.nodeThreshold,height:Math.max(a.height,this.game.nodeThreshold),collisionMask:0})).sensor=!0,s.addShape(l);else if(a.height<this.game.nodeThreshold){var l;(l=new this.p2.Box({width:Math.max(a.width,this.game.nodeThreshold),height:this.game.nodeThreshold,collisionMask:0})).sensor=!0,s.addShape(l)}s.addShape(new this.p2.Box({width:a.width,height:a.height,collisionGroup:n,collisionMask:o}))}this.addWorldBody(s,!r.bNoBody),this.addDirtyNodeObject(s)}return this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.OBSTACLE,position:e.position,rotation:i,data:r}),s}createTriggerArea(e){var a=new this.p2.Body({mass:0,fixedRotation:!0,position:e.position,angle:null!=e.rotation?this.ToRad(e.rotation):0,allowSleep:!0});a.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.TRIGGER_AREA,team:e.team,icon:e.icon,areaWidth:e.width?e.width:150,areaHeight:e.height?e.height:150,onTouchTriggerId:e.onTouchTriggerId,targetId:e.targetId,targetTeam:e.targetTeam,targetType:e.targetType,indicatorData:e.indicatorData,uses:null!=e.uses?e.uses:1,bHidden:e.bHidden,bBotsCanTrigger:e.bBotsCanTrigger,attachToId:e.attachToId,bSkipServerUpdate:1==e.bHidden,ticker:1};var t=a.data,i=new this.p2.Box({width:t.areaWidth,height:t.areaHeight,collisionGroup:CollisionGroups.OBJECT,collisionMask:0});return i.sensor=!0,a.addShape(i),this.addWorldBody(a),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:t.type,position:e.position,rotation:e.rotation,data:t}),a}createTree(e){var a,t=e.angle?e.angle:e.rotation?this.ToRad(e.rotation):0;a=new this.p2.Body({mass:0,fixedRotation:!0,position:e.position,angle:t,allowSleep:!0});var i={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.TREE,treeType:e.treeType,bBack:e.bBack,bSkipServerUpdate:!0};a.data=i,this.addWorldBody(a,!1),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.TREE,position:e.position,rotation:t,data:i})}createDummy(e){var a=this.getSharedData("target_dummy"),t=new this.p2.Body({mass:a.mass,damping:.9,angularDamping:.9,position:e.position,angle:e.angle?e.angle:e.rotation?this.ToRad(e.rotation):0,allowSleep:!0,sleepSpeedLimit:1});t.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.DUMMY,material:Material.WOOD,indicatorData:e.indicatorData,damageMultipliers:e.damageMultipliers,health:200,reward:25,width:a.width,height:a.height,damping:t.damping,angularDamping:t.angularDamping,bUntargetable:e.bUntargetable};var i=t.data;i.maxHealth=i.health;var s=new this.p2.Circle({radius:a.size?a.size:a.width,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.HELICOPTER|CollisionGroups.OBJECT});return t.addShape(s),this.addWorldBody(t),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:i.type,position:t.position,rotation:t.angle,data:i}),t}createLever(e,a){var t=this.getSharedData(ObjectType.LEVER),i=new this.p2.Body({mass:0,angle:null!=a.angle?a.angle:null!=a.rotation?this.ToRad(a.rotation):0,position:e,allowSleep:!0,sleepSpeedLimit:10});i.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.LEVER,leverType:a.leverType,targetId:a.targetId,triggerId:a.triggerId,bDisabled:a.bDisabled,indicatorData:a.indicatorData,glowTint:a.glowTint,tint:null!=a.tint?a.tint:null,bHidden:a.bHidden},this.removeUndefinedKeys(i.data);var s=new this.p2.Circle({radius:t.size?t.size:t.width,collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT});return i.addShape(s),this.addWorldBody(i),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.LEVER,position:i.position,rotation:i.angle,data:i.data}),i}startCharacterShieldCooldown(e){if(e){this.cancelCharacterBoltPull(e),this.cancelCharacterReload(e);var a=e.data;a.bShieldCooldown=!0,a.shieldCooldownTimer=Math.ceil(.3*this.game.settings.fps),a.bDoorCooldown=!0,this.requestEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.id,type:GameServer.PAWN_START_SHIELD_COOLDOWN,bDoor:!0})}}createCrate(e,a){var t=this.getSharedData(a.frame?a.frame:ObjectType.CRATE);if(t){var i=null!=a.mass?a.mass:t.mass?t.mass:1,s=new this.p2.Body({mass:i,damping:.99,angularDamping:.99,position:e,angle:a.angle?a.angle:a.rotation?this.ToRad(a.rotation):0,allowSleep:!0,sleepSpeedLimit:10});s.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.CRATE,itemData:a.itemData?a.itemData:{},team:a.team,crateType:a.crateType,items:a.items,itemId:a.itemId,ownerId:a.ownerId,bDisabled:a.bDisabled,bLimitInteractions:a.bLimitInteractions,bDisposable:null==a.bDisposable||a.bDisposable,mass:i,indicatorData:a.indicatorData};var r=s.data;switch(r.crateType){case Crate.BOMB:case Crate.BOMB_GENERIC:r.bombNum=a.num,r.bombTimerMax=r.bombTimer=this.game.settings.fps*(a.bombTimerMax?a.bombTimerMax:60),r.bDisposable=!1,r.itemData={interactTime:3*this.game.settings.fps,interactTeam:0==o?1:0};break;case Crate.AMMO:r.itemData={uses:5,maxUses:5,interactTime:1*this.game.settings.fps};break;case Crate.ITEM:case Crate.WEAPON:r.itemData={uses:1,maxUses:1,interactTime:.5*this.game.settings.fps}}if(a.itemData)for(var n=Object.keys(a.itemData),o=0;o<n.length;o++){var d=n[o];r.itemData[d]=a.itemData[d]}r.bDisposable&&(r.destroyTimer=180*this.game.settings.fps);var l=new this.p2.Box({width:t.width,height:t.height,collisionGroup:CollisionGroups.OBJECT,collisionMask:CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.OBJECT});s.addShape(l),0==i&&(l=new this.p2.Circle({radius:this.game.nodeThreshold}),s.addShape(l)),this.addWorldBody(s),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.CRATE,position:s.position,rotation:s.angle,data:s.data});var h=this.getDisposableCrates();return h.length>this.settings.maxCrates&&this.removeNextStep(h[0]),s}console.warn("Invalid crate shared data")}createGrenade(e,a){var t=new this.p2.Body({mass:1,position:e,angle:a.angle?a.angle:0,damping:a.bImpact?0:.6,angularDamping:.5,allowSleep:!0,sleepSpeedLimit:10}),i=this.getObjectById(a.causerId),s=a.weaponData?a.weaponData:this.getWeaponData(a.weaponId),r=!!s&&s.bRemoteDetonation;t.data={id:a.id?a.id:this.getRandomUniqueId(),type:ObjectType.GRENADE,team:a.team,damage:a.damage?a.damage:s.damage,radius:a.radius?a.radius:s.radius,causerId:a.causerId,playerId:a.playerId,weaponId:a.weaponId,modId:a.modId,bDetonationTimerEnabled:!0,detonationTimer:(s?s.detonationTimer:this.game.settings.fps)*this.game.fpsMult,bRemoteDetonation:r,bStartDetonationAfterHit:a.bStartDetonationAfterHit,bAutomated:!!i&&i.data.bAutomated,bImpact:a.bImpact,lifespan:0};var n=t.data;switch(s.id){case"semtex":break;default:n.minTimer=Math.round(3*this.game.fpsMult)}var o=this.getSharedData(ObjectType.GRENADE);if(r)var d=CollisionGroups.GROUND|CollisionGroups.OBJECT|CollisionGroups.HELICOPTER|CollisionGroups.BOUNDS;else d=CollisionGroups.GROUND|CollisionGroups.PAWN|CollisionGroups.OBJECT|CollisionGroups.HELICOPTER|CollisionGroups.BOUNDS;if(r){n.bDetonationTimerEnabled=!1,t.allowSleep=!1,t.data.health=1;var l=new this.p2.Circle({collisionGroup:CollisionGroups.PROJECTILE,collisionMask:d,radius:o.width})}else l=new this.p2.Circle({collisionGroup:CollisionGroups.PROJECTILE,collisionMask:d,radius:o.width});a.bImpact&&(l.sensor=!0),t.addShape(l),this.addWorldBody(t);var h=a.rotation,m=a.velocity;return t.angularVelocity=.01*m,t.applyImpulse([Math.cos(h)*m,Math.sin(h)*m],0,0),this.requestEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:ObjectType.GRENADE,rotation:t.angle,position:t.position,velocity:t.velocity,angularVelocity:t.angularVelocity,data:t.data}),t}getCharacterMaxHealth(){return this.game.gameModeData.bHardcore?100:200}createPolygon(e){if(e.spriteId){var a=this.getSharedData(e.spriteId);if(!a)return void console.warn("Unhandled sprite",e.spriteId)}else a={shape:e.shape,width:e.width,height:e.height,radius:e.radius};var t=e.width?e.width:a.width,i=e.height?e.height:a.height,s=new this.p2.Body({mass:0,damping:1,position:e.position,angle:e.angle?e.angle:e.rotation?this.ToRad(e.rotation):0,allowSleep:!0,sleepSpeedLimit:1});if(!e.bNoBody)if("box"==e.shape){var r=new this.p2.Box({width:e.width,height:e.height,collisionGroup:CollisionGroups.GROUND,collisionMask:CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.HELICOPTER|CollisionGroups.OBJECT|CollisionGroups.FLAME});s.addShape(r)}else"circle"==e.shape?(r=new this.p2.Circle({radius:e.radius,collisionGroup:CollisionGroups.GROUND,collisionMask:CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.HELICOPTER|CollisionGroups.OBJECT|CollisionGroups.FLAME}),s.addShape(r)):e.spriteId&&this.loadPolygon(e.spriteId,s,t,i,e.scale?e.scale:1,{material:new this.p2.Material,collisionGroup:CollisionGroups.GROUND,collisionMask:CollisionGroups.PAWN|CollisionGroups.PROJECTILE|CollisionGroups.HELICOPTER|CollisionGroups.OBJECT|CollisionGroups.FLAME});s.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.GROUND,material:e.material,spriteId:e.spriteId,texture:e.texture,shape:e.shape,width:t,height:i,radius:e.radius,scale:e.scale,bNoBody:e.bNoBody,tint:e.tint,bHideOutline:e.bHideOutline,bSkipServerUpdate:!0};var n=s.data;return this.removeUndefinedKeys(n),this.addWorldBody(s,!n.bNoBody),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,position:s.position,rotation:s.angle,data:n}),this.addDirtyNodeObject(s),s}createDinosaur(e){var a=this.getSharedData(e.dinoType);a||(console.warn("Invalid dinoType",e.dinoType),a={mass:1,width:30,height:30});var t=null!=a.mass?a.mass:1,i=new this.p2.Body({mass:t,damping:null!=a.damping?a.damping:.99,angularDamping:.95,position:e.position?e.position:[e.x,e.y],allowSleep:1==e.bBot,sleepSpeedLimit:1});switch(e.dinoType){case Dinosaur.CHICKEN:case Dinosaur.LIZARD:var s=new this.p2.Circle({radius:a.width,collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.BOUNDS|CollisionGroups.PAWN|CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT});break;default:s=new this.p2.Box({width:a.width,height:a.height,collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.BOUNDS|CollisionGroups.PAWN|CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT})}i.addShape(s),i.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.DINOSAUR,material:Material.FLESH,team:e.team,health:100,dinoType:e.dinoType,lungeMult:2,aimRotation:this.RandomAngle(),desiredAimRotation:this.RandomAngle(),lookPos:[i.position[0]+this.Random(-100,100),i.position[1]+this.Random(-100,100)],maxSpeed:a.maxSpeed?a.maxSpeed:300,speedMultiplier:e.speedMultiplier?Math.max(0,Math.min(e.speedMultiplier,40)):1,baseSpeedMultiplier:1,reloadMultiplier:1,bRegenHealth:null==e.bRegenHealth||e.bRegenHealth,regenTimerMax:180*this.game.fpsMult,regenTimer:0,bGodMode:e.bGodMode,bHideHealthBar:e.bHideHealthBar,bIgnoreOutOfSight:e.bIgnoreOutOfSight,bIgnoreEnemies:e.bIgnoreEnemies,bInvestigate:0!=e.bInvestigate,bBot:e.bBot,bUntargetable:e.bUntargetable,bCanInteract:e.bCanInteract,botSkill:e.botSkill>=0?e.botSkill:BotSkill.SKILL_EASY,playerId:e.playerId,weapon:{fireDelayTimer:0,burstTimer:0,recoil:0,bUnlimitedAmmo:!0},damageMultipliers:{1:1,2:1,3:this.game.bSurvival?1.5:2,4:this.game.bSurvival?1:.75},pawnName:e.pawnName,indicatorData:e.indicatorData,objectScale:e.objectScale,maxRange:e.maxRange,colour:e.colour};var r=i.data;this.removeUndefinedKeys(r);var n=this.getWeaponData(r.dinoType);switch(n||(n=this.getWeaponData(Dinosaur.COMPY)),r.inventory=[n],r.bCanLunge=n.range<200,r.lungeMult=r.maxSpeed>=500?1.6:2,r.dinoType){case Dinosaur.CHICKEN:r.health=100,r.reward=50;break;case Dinosaur.LIZARD:r.bCanLunge=!1,r.health=100,r.reward=5;break;case Dinosaur.COMPY:r.bCanLunge=!1,r.health=250,r.reward=50,this.game.bSurvival&&(r.health=200,r.maxSpeed=600);break;case Dinosaur.DILO:r.health=250,r.reward=100,this.game.bSurvival&&(r.health=300,r.maxSpeed=600);break;case Dinosaur.RAPTOR:r.lungeMult=2,r.health=500,r.reward=this.game.bSurvival?500:250,this.game.bSurvival&&(n.damage*=2,r.health=750,r.maxSpeed=0==r.team?600:800);break;case Dinosaur.PACHY:r.lungeMult=3,r.health=500,r.reward=200,r.damageMultipliers[DamageType.DAMAGE_BULLET]=.75,r.damageMultipliers[DamageType.DAMAGE_MELEE]=.75,this.game.bSurvival&&(r.health=1e3,r.maxSpeed=500);break;case Dinosaur.NEEDLER:r.health=250,r.reward=this.game.bSurvival?500:250,this.game.bSurvival&&(r.health=250,r.maxSpeed=400);break;case Dinosaur.CARNOTAURUS:r.lungeMult=2.8,r.health=1250,r.reward=this.game.bSurvival?1e3:500,r.damageMultipliers[DamageType.DAMAGE_MELEE]=.5,this.game.bSurvival&&(r.damageMultipliers[DamageType.DAMAGE_BULLET]=.5,n.damage*=2,r.health=2e3);break;case Dinosaur.ALLOSAURUS:r.health=1500,r.reward=this.game.bSurvival?1e3:500,r.damageMultipliers[DamageType.DAMAGE_MELEE]=.5,this.game.bSurvival&&(r.damageMultipliers[DamageType.DAMAGE_BULLET]=.5,n.damage*=2,r.health=3e3);break;case Dinosaur.SPINOSAURUS:r.health=2e3,r.reward=this.game.bSurvival?1500:500,r.damageMultipliers[DamageType.DAMAGE_MELEE]=.5,this.game.bSurvival&&(r.damageMultipliers[DamageType.DAMAGE_BULLET]=.5,n.damage*=2,r.health=4e3);break;case Dinosaur.TREX:r.health=1e4,r.reward=5e3,r.damageMultipliers[DamageType.DAMAGE_BULLET]=.25,r.damageMultipliers[DamageType.DAMAGE_EXPLOSIVE]=1.25,r.damageMultipliers[DamageType.DAMAGE_MELEE]=.25,r.damageMultipliers[DamageType.DAMAGE_FIRE]=.25,this.game.bSurvival&&(n.damage*=2,r.maxSpeed=325,r.bImmuneToStun=!0,r.damageMultipliers[DamageType.DAMAGE_BULLET]=.1);break;case Dinosaur.STEGOSAURUS:r.health=1500,r.reward=this.game.bSurvival?1e3:500,r.damageMultipliers[DamageType.DAMAGE_BULLET]=.5,r.damageMultipliers[DamageType.DAMAGE_MELEE]=.5,r.damageMultipliers[DamageType.DAMAGE_FIRE]=.5,this.game.bSurvival&&(r.health=2e3,r.damageMultipliers[DamageType.DAMAGE_BULLET]=.25,r.maxSpeed=200)}if(r.maxSpeed=Math.round(r.maxSpeed*r.speedMultiplier),e.damageMultipliers&&this.applyDamageMultipliers(r.damageMultipliers,e.damageMultipliers),this.setCharacterCurrentInventoryItem(i,0),r.regenAmount=Math.ceil(.005*r.maxHealth),this.game.gameModeData.bHardcore&&(r.health=Math.max(200,Math.round(.5*r.health))),r.bBot&&!this.game.bSurvival&&(r.maxSpeed=r.maxSpeed*Math.min(1,Math.max(.75,(r.botSkill+1)/BotSkill.SKILL_INSANE))),e.speedMult&&console.warn("Deprecated"),e.healthMultiplier&&(r.health=r.maxHealth=Math.round(r.health*e.healthMultiplier)),e.bSavage){r.bSavage=!0,r.maxSpeed=Math.floor(1.1*r.maxSpeed),r.health=Math.max(1.25*r.health,1e3),r.reward*=4,r.colour=16711680;var o=r.inventory[0];o&&(o.fireRate=Math.ceil(.5*o.fireRate))}return e.health&&(r.health=e.health),r.maxHealth=r.health,this.addWorldBody(i),r.bBot&&(this.initPawnAI(i,r.botSkill),e.wanderArea&&this.setAIWanderArea(i,e.wanderArea),e.investigatePosition&&this.setAIInvestigatePos(i,e.investigatePosition),e.followTargetId&&this.setAIFollowTargetId(i,e.followTargetId)),this.getPlayerById(r.id)&&this.game.gameSettings.playerDamageMultipliers&&(r.damageMultipliers||(r.damageMultipliers={}),this.applyDamageMultipliers(r.damageMultipliers,this.game.gameSettings.playerDamageMultipliers)),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,position:i.position,rotation:i.angle,data:i.data}),i}applyDamageMultipliers(e,a){if(e&&a)for(var t=Object.keys(a),i=0;i<t.length;i++){let s=t[i];null!=a[s]&&null!=e[s]&&(e[s]*=a[s])}}createCharacter(e){var a=this.getSharedData(ObjectType.CHARACTER),t=new this.p2.Body({mass:1,fixedRotation:a.fixedRotation,damping:a.damping,position:e.position?e.position:[e.x,e.y],allowSleep:1==e.bBot,sleepSpeedLimit:1}),i=new this.p2.Circle({radius:a.width,collisionGroup:CollisionGroups.PAWN,collisionMask:CollisionGroups.BOUNDS|CollisionGroups.GROUND|CollisionGroups.PROJECTILE|CollisionGroups.OBJECT|CollisionGroups.PAWN});t.addShape(i),e.avatarId&&(e.avatar=this.getAvatarDataById(e.avatarId)),e.avatar||(e.avatar=this.getAvatarDataById(AvatarPresets.DINOGEN)),t.data={id:e.id?e.id:this.getRandomUniqueId(),type:ObjectType.CHARACTER,material:e.bJuggernaut?Material.METAL:Material.FLESH,team:e.team,health:e.health?e.health:this.getCharacterMaxHealth(),aimRotation:e.angle?e.angle:e.rotation?this.ToRad(e.rotation):0,desiredAimRotation:0,lookPos:this.clone(t.position),maxSpeed:e.maxSpeed?e.maxSpeed:a.maxSpeed,reloadMultiplier:1,speedMultiplier:1,baseSpeedMultiplier:null!=e.speedMultiplier?Math.max(0,Math.min(e.speedMultiplier,40)):1,bRegenHealth:null==e.bRegenHealth||e.bRegenHealth,regenTimerMax:180*this.game.fpsMult,regenTimer:0,weapon:{fireDelayTimer:0,burstTimer:0,recoil:0},bGodMode:e.bGodMode,bHideHealthBar:e.bHideHealthBar,bIgnoreOutOfSight:e.bIgnoreOutOfSight,bIgnoreEnemies:e.bIgnoreEnemies,bInvestigate:0!=e.bInvestigate,bBot:e.bBot,botSkill:e.botSkill,bUntargetable:e.bUntargetable,bJuggernaut:e.bJuggernaut,bZombie:e.bZombie,avatar:e.avatar,legScale:e.legScale,pawnName:e.pawnName,indicatorData:e.indicatorData,bDropWeapons:e.bDropWeapons,objectScale:e.objectScale,reward:null!=e.reward?e.reward:null,bSwitchToMelee:e.bSwitchToMelee,maxRange:e.maxRange,bCanInteract:null==e.bCanInteract||e.bCanInteract};var s=t.data;if(this.removeUndefinedKeys(s),s.desiredAimRotation=s.aimRotation,s.lookPos[0]+=100*Math.cos(s.aimRotation),s.lookPos[1]+=100*Math.sin(s.aimRotation),s.maxHealth=s.health,s.weapon.bUnlimitedAmmo=this.game.gameModeData.bUnlimitedAmmo||e.bUnlimitedAmmo,e.inventory){e.inventory[1]||(e.inventory[1]=null);for(var r=[],n=0;n<e.inventory.length;n++){var o=e.inventory[n];if(o&&o.id){var d=this.getWeaponData(o.id);d?(this.applyWeaponMods(d,o.mods),null!=o.mag&&(d.mag=Math.max(0,Math.min(99999,o.mag))),null!=o.ammo&&(d.ammo=Math.max(0,Math.min(99999,o.ammo))),null!=o.name&&(d.name=o.name),r.push(d)):o.id&&console.warn("Invalid item:",o.id)}else r.push(null)}s.inventory=r}else s.inventory=[{id:"m9"}];s.melee=this.getWeaponData(e.melee?e.melee:"melee_knife"),"string"==typeof e.grenade?s.grenade=this.getWeaponData(e.grenade):s.grenade=e.grenade,"string"==typeof e.equipment?s.equipment=this.getWeaponData(e.equipment):s.equipment=e.equipment,s.inventory.push(s.melee,s.equipment,s.grenade);var l=0;for(n=0;n<s.inventory.length;n++)if(s.inventory[n]){l=n;break}if(this.setCharacterCurrentInventoryItem(t,l),this.addWorldBody(t),s.bBot){var h=this.initPawnAI(t,s.botSkill);null!=e.bCamp&&(h.bCamp=e.bCamp,h.campPos=[t.position[0],t.position[1]]),null!=e.bInteract&&(h.bInteract=e.bInteract),e.wanderArea&&this.setAIWanderArea(t,e.wanderArea),e.investigatePosition&&this.setAIInvestigatePos(t,e.investigatePosition),e.followTargetId&&this.setAIFollowTargetId(t,e.followTargetId),e.destination&&this.setAIDestination(t,e.destination)}e.damageMultipliers&&(s.damageMultipliers=e.damageMultipliers);var m=this.getPlayerById(s.id);return this.game.bScenario?m&&(s.damageMultipliers={1:.5,2:.5,3:.5,4:.5}):this.game.bSurvival&&(m&&(s.damageMultipliers={1:.1,2:.25,3:.25,4:.25}),s.bBot&&(s.weapon.bUnlimitedAmmo=!0)),m&&this.game.gameSettings.playerDamageMultipliers&&(s.damageMultipliers||(s.damageMultipliers={}),this.applyDamageMultipliers(s.damageMultipliers,this.game.gameSettings.playerDamageMultipliers)),this.onEvent({eventId:GameServer.EVENT_SPAWN_OBJECT,type:s.type,position:t.position,data:s}),t}initPawnAI(e,a){var t=e.data;(null==a||a<0)&&(a=0);var i=a,s={pathTicker:1,distanceMoved:0,distanceTimer:0,distanceTimerMax:30*this.game.settings.fps,actionTicker:0,actionTickerMax:Math.max(5,30-10*i),wanderTicker:0,wanderTickerMax:3,ticker:this.Random(1,3),botSkill:i,destThreshold:t.type==ObjectType.DINOSAUR?20:50,fireBurstTimer:0,fireBurstTimerMax:Math.round((this.Random(25,30)+10*i)*this.game.fpsMult),fireCooldownTimer:0,fireCooldownTimerMax:Math.round((this.Random(90,100)-15*i)*this.game.fpsMult),semiCooldownTimer:0,semiCooldownTimerMax:Math.round((this.Random(15,20)-2*i)*this.game.fpsMult),lookRange:2e3+500*i,bFireCooldown:!0,bInteract:1==t.bCanInteract,bInvestigate:1==t.bIgnoreOutOfSight&&0!=t.bInvestigate,enemyDistMax:1e3,enemyDistMult:1};switch(t.bZombie?(s.bInteract=!1,s.semiCooldownTimerMax=1,s.fireBurstTimerMax=Math.ceil(5*s.fireBurstTimerMax)):i==BotSkill.SKILL_EASY?(s.fireBurstTimerMax=Math.ceil(.4*s.fireBurstTimerMax),s.fireCooldownTimerMax=Math.ceil(1.5*s.fireCooldownTimerMax)):i==BotSkill.SKILL_NORMAL?(s.fireBurstTimerMax=Math.ceil(.5*s.fireBurstTimerMax),s.fireCooldownTimerMax=Math.ceil(1.2*s.fireCooldownTimerMax)):i==BotSkill.SKILL_INSANE?(s.semiCooldownTimerMax=Math.ceil(.5*s.semiCooldownTimerMax),s.fireBurstTimerMax=Math.ceil(1.5*s.fireBurstTimerMax)):i>=BotSkill.SKILL_GOD&&(s.semiCooldownTimerMax=2,s.fireCooldownTimerMax=1,s.fireBurstTimerMax=Math.ceil(5*s.fireBurstTimerMax)),t.type){case ObjectType.CHARACTER:t.bSwitchToMelee=null!=t.bSwitchToMelee?t.bSwitchToMelee:s.botSkill>=BotSkill.SKILL_HARD}return e.ai=s,s}raycastBodies(e,a){try{var t=this.p2,i=new this.p2.Ray({mode:t.Ray.ANY,from:e.position,to:a.position,skipBackfaces:!0,collisionGroup:CollisionGroups.PAWN|CollisionGroups.HELICOPTER}),s=new this.p2.RaycastResult;return this.game.world.raycast(s,i),!!s&&s.body==a}catch(e){this.onGameError(e)}return!1}raycast(e,a,t,i,s,r){try{var n=this.p2,o=[],d=new this.p2.Ray({mode:n.Ray.ALL,from:[e,a],to:[t,i],skipBackfaces:!r,callback:e=>{var a=n.vec2.create();e.getHitPoint(a,d),o.push({body:e.body,point:{x:a[0],y:a[1]},distance:e.getHitDistance(d)}),s&&e.body===s&&e.stop()}}),l=new this.p2.RaycastResult;return this.game.world.raycast(l,d),o.sort((function(e,a){return e.distance<a.distance?-1:e.distance>a.distance?1:0})),o}catch(e){this.onGameError(e)}return null}endMultiKill(e){if(e){var a=e.multiKillCount;a>1&&(this.requestEvent({eventId:GameServer.EVENT_PLAYER_MULTI_KILL,playerId:e.id,kills:a}),this.game.bSurvival&&this.addPlayerMoney(e.id,Math.min(500,50*a))),e.multiKillTimer=0,e.multiKillCount=0}}getInitEventData(){return{eventId:GameServer.EVENT_GAME_INIT,shared:this.data.shared,mapId:this.game.mapId,gameModeId:this.game.gameModeId,settings:this.game.settings,gameModeData:this.game.gameModeData,mapData:this.getCurrentMapData()}}getGameStartEventData(){return{eventId:GameServer.EVENT_GAME_START,timer:0}}getGameModeEventData(){var e=this.clone(this.game.gameModeData);return e.tickRate=this.game.settings.fps,{eventId:GameServer.EVENT_GAME_UPDATE,data:e}}getNumPlayers(){return this.game.players.length}getPlayers(){return this.game.players}getCurrentGameData(){return{timer:this.game.gameTimer,scores:this.game.gameModeData.scores}}getObjectsEventData(){var e=[];for(var a in this.game.objects){let t=this.game.objects[a],i=t?t.data:null;if(i)switch(i.type){case ObjectType.CHARACTER:e.push({eventId:GameServer.EVENT_SPAWN_OBJECT,type:i.type,position:t.position,rotation:t.angle,data:i});break;default:e.push({eventId:GameServer.EVENT_SPAWN_OBJECT,type:i.type,position:t.position,angle:t.angle,rotation:t.angle,velocity:t.velocity,angularVelocity:t.angularVelocity,data:i})}}for(var t=this.getCharacters(),i=0;i<t.length;i++){let a=t[i];if(a.data&&a.data.controllableId){let t=this.getObjectById(a.data.controllableId);t&&t.data.seats&&e.push({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:a.data.id,type:GameServer.PAWN_VEHICLE_ENTER,vehicleId:t.data.id,scale:t.data.scale,seatIndex:a.data.seatIndex,seat:t.data.seats[a.data.seatIndex]})}}return e}onBeginContact(e){this.game&&e.bodyA&&e.bodyB&&(this.onHit(e.bodyA,e.bodyB),this.onHit(e.bodyB,e.bodyA))}onHit(e,a){var t=e.data,i=a.data;if((!i||!i.bInvisible&&!i.bPendingRemoval&&t.type!=ObjectType.REVIVER)&&t){if(t.bInvisible||t.bPendingRemoval||i.type==ObjectType.REVIVER)return;switch(t.type){case ObjectType.OBSTACLE:switch(t.obstacleId){case"window":switch(i.type){case ObjectType.CAR:case ObjectType.TANK:this.vehicleHasOccupant(a)&&this.onVehicleImpact(e,a)}break;case"barrel_generic":case"barrel_explosive":case"barrel_poison":case"barrel_oil":this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_HIT})}break;case ObjectType.FLAME:switch(i.type){case ObjectType.GROUND:e.velocity&&(e.velocity[0]*=.25,e.velocity[1]*=.25)}break;case ObjectType.WINDOW:if(this.isVehicle(a))this.removeNextStep(e);else switch(i.type){case ObjectType.GRENADE:this.removeNextStep(e)}break;case ObjectType.DOOR:if(t.bClosed&&!t.leverId&&!t.bDisabled)if(i.type==ObjectType.CHARACTER||i.type==ObjectType.DINOSAUR)(i.bBot||i.bSprinting||i.type==ObjectType.DINOSAUR)&&this.setDoorClosed(e,!1,a,!0,i.bBot);else if(this.isVehicle(a)&&t.material!=Material.METAL){Math.abs(a.velocity[0])>50&&this.setDoorClosed(e,!1,a,!0,i.bBot)}break;case ObjectType.EQUIPMENT:switch(t.weaponData.id){case"ammo_box":case"beacon":this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_HIT})}break;case ObjectType.PROJECTILE:if(!t.bHit){var s=!0;switch(t.bHitSameTeam||(s=t.team!=i.team),t.playerId!=i.id&&t.sourceId!=i.id||(s=!1),i.type){case ObjectType.SHIELD:t.playerId==i.playerId&&(s=!1);break;case ObjectType.WINDOW:this.removeNextStep(a)}if(s)(E=this.getPlayerById(i.id))&&E.bSpawnProtection&&(s=!1);if(s&&"rope"==t.weaponId&&a.mass>0&&!i.controllableId)switch(i.type){case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:case ObjectType.OBSTACLE:case ObjectType.DROPPED_WEAPON:case ObjectType.CRATE:case ObjectType.REVIVER:case ObjectType.CHARACTER:case ObjectType.CRATE:if(!i.controllableId){var r=this.getObjectById(t.sourceId);r&&this.attachObjects(r,a)}break;default:i.health||(s=!1)}if(s){switch(t.bHit=!0,t.weaponData.id){case Dinosaur.DILO:var n={x:e.position[0],y:e.position[1],rotation:e.angle,impactType:Material.VENOM,damageAmount:t.weaponData.damage};this.createImpactEffects([n]),this.createFlame([n.x,n.y],0,t.team,t.playerId,t.weaponData,.8,!0)}if(i.type==ObjectType.CHARACTER||i.type==ObjectType.DINOSAUR){var o=i.material?i.material:Material.DEFAULT;this.createImpactEffect(e.position[0],e.position[1],e.angle,o,1)}else t.weaponData.id==Dinosaur.NEEDLER&&this.createImpactEffect(e.position[0],e.position[1],e.angle,Material.DEFAULT,1);if(t.team!=i.team){var d=DamageType.DAMAGE_MELEE;if(i.health){var l=t.damage;switch(t.weaponId){case"crossbow":case"bow":i.type}l>0&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:d,damageAmount:l,pawnId:i.id,attackerId:t.playerId,causerId:t.id,weaponId:t.weaponId,bMelee:t.bMelee,bKnife:"knife"==t.weaponId,bDirectlyCausedByPlayer:!0})}}var h=e.previousPosition?e.previousPosition:e.position;switch(t.weaponId){case"knife":this.createDroppedWeapon(h,{angle:e.angle,scale:1,weaponData:this.getWeaponData(t.weaponId),playerId:t.playerId,velocity:[.1*e.velocity[0],.1*e.velocity[1]]}).applyImpulse([.5*e.velocity[0],.5*e.velocity[1]],[0,0]);break;case"crossbow":case"bow":this.createImpactEffect(h[0],h[1],e.rotation,"default",1),this.createArrow(h,{angle:e.angle})}this.removeNextStep(e)}}break;case ObjectType.CHARACTER:case ObjectType.DINOSAUR:case ObjectType.DUMMY:switch(i.type){case ObjectType.CAR:case ObjectType.TANK:this.vehicleHasOccupant(a)&&t.team!=i.team&&a.mass>=e.mass&&this.onVehicleImpact(e,a)}break;case ObjectType.DROPPED_WEAPON:case ObjectType.CRATE:case ObjectType.TANK:this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_HIT});break;case ObjectType.CAR:i.type==ObjectType.GROUND&&this.setDataValue(e,"currentSurface",i.material?i.material:Material.DEFAULT),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_HIT});break;case ObjectType.HELICOPTER:switch(i.type){case ObjectType.GROUND:case ObjectType.HELICOPTER:case ObjectType.TANK:this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:t.id,type:GameServer.PAWN_HIT})}if(i.type==ObjectType.GROUND)if(t.health){if(this.matchInProgress()){if(Math.abs(this.ToDeg(e.angle))){e.velocity[0],e.velocity[1];1>.5*e.data.maxHealth&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_WORLD,damageAmount:1,pawnId:t.id,causerId:t.id,weaponId:"generic"})}}}else this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:e.position,radius:500,damage:this.settings.vehicleExplosionDamage,playerId:null,causerId:null,weaponId:null}),this.removeNextStep(e);break;case ObjectType.GRENADE:if(t.bImpact&&t.lifespan>0){if(this.isVehicle(a)&&!this.vehicleHasOccupant(a))break;if(i){if(t.causerId==i.id)break;if(t.team==i.team)break;var m=t.minTimer>0&&!t.bDud;switch(i.type){case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:var c=!0,p=!0;if(!this.vehicleHasOccupant(a))(u=this.getPlayerById(t.playerId))?u.team==i.team&&(c=!1,p=!1):t.team==i.team&&(c=!1,p=!1);if(c){var g=t.damage;this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:g,pawnId:i.id,attackerId:t.playerId,causerId:t.id,weaponId:t.weaponId})}p&&this.detonate(e,i.id);break;case ObjectType.CHARACTER:var E;p=!0;if((u=this.getPlayerById(t.playerId))?u.id==i.id&&(p=!1):t.playerId==i.id&&(p=!1),p&&t.team==i.team&&(p=!this.game.bSurvival),p)this.detonate(e);break;case ObjectType.MOUNTED_WEAPON:p=!0;this.game.bSurvival?p=!1:t.team!=i.team&&-1!=i.team||(p=!1),p&&this.detonate(e);break;case ObjectType.OBSTACLE:console.log(t,i),this.game.bSurvival&&0==t.team&&!i.bBlockLOS||(m?console.log("dud"):this.detonate(e));break;case ObjectType.DOOR:this.detonate(e),i.material!=Material.METAL&&this.setDoorClosed(a,!1,e,!0);break;case ObjectType.LEVER:break;default:this.detonate(e)}}}else{if(t.bStartDetonationAfterHit&&(t.bDetonationTimerEnabled=!0),this.getWeaponData(t.weaponId).bSticky&&!e.constraint){e.velocity=[0,0],e.mass=.1,e.angularVelocity=0,e.angularDamping=.99,e.shapes[0].collisionMask=CollisionGroups.PROJECTILE;var b=new this.p2.RevoluteConstraint(e,a,{worldPivot:[e.position[0],e.position[1]]});this.game.world.addConstraint(b),e.constraint=b,t.stuckToId=a.data.id,this.setDataValue(e,"bStuck",!0)}}break;case ObjectType.ROCKET:if(i)switch(i.type){case ObjectType.HELICOPTER:case ObjectType.TANK:case ObjectType.CAR:case ObjectType.MOUNTED_WEAPON:c=!0,p=!0;var u=this.getPlayerById(t.playerId),I=i.playerId;u?t.causerId==i.id?c=!1:u.id==I?c=this.game.bFriendlyFire:u.team==i.team&&(c=!1):t.team==i.team&&(c=!1),!this.game.bSurvival||this.vehicleHasOccupant(a)&&i.health||(c=!1),p=c,c&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:t.damage,pawnId:i.id,attackerId:t.playerId,causerId:t.id,weaponId:t.weaponId}),p&&this.detonate(e,i.id);break;case ObjectType.CHARACTER:case ObjectType.DINOSAUR:p=!0;var T=this.getObjectById(t.playerId);T&&(T.data.id==i.id||t.team==i.team)&&(p=!1),i.controllableId&&(p=!1),p&&(this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:t.damage,pawnId:i.id,attackerId:t.playerId,causerId:t.id,weaponId:t.weaponId}),this.detonate(e));break;case ObjectType.OBSTACLE:t.bRequireLock||this.detonate(e);break;case ObjectType.EQUIPMENT:case ObjectType.LEVER:break;case ObjectType.DOOR:this.detonate(e),i.material!=Material.METAL&&this.setDoorClosed(a,!1,e,!0);break;default:this.detonate(e)}}}}createExplosion(e){this.requestEvent(e)}getExplosionObjects(){return this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.DUMMY,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR,ObjectType.MOUNTED_WEAPON,ObjectType.CRATE,ObjectType.EQUIPMENT,ObjectType.DROPPED_WEAPON,ObjectType.GRENADE,ObjectType.OBSTACLE,ObjectType.WINDOW,ObjectType.EGG])}checkExplosion(e){if(e.position)var a=e.position[0],t=e.position[1];else a=e.x,t=e.y;var i=e.radius,s=e.damage,r=e.playerId,n=e.causerId,o=e.weaponId,d=e.bLOS,l=e.directHitId,h=this.getPlayerById(r),m=this.getObjectById(n),c=s,p=!d,g=null!=e.team?e.team:null;null==g&&(g=h?h.team:null),null==g&&(g=m?m.data.team:null),this.emitAISound([a,t],[a,t],i,g);var E=this.getExplosionObjects();e:for(var b=0;b<E.length;b++){let r=E[b];if(!r.data||r.data.bPendingRemoval||r.data.bInvisible||r.data.bNoBody)continue;let d=c;switch(r.data.type){case ObjectType.CHARACTER:case ObjectType.DINOSAUR:if(r.data.controllableId){var u=this.getObjectById(r.data.controllableId);if(u&&u.data.type!=ObjectType.MOUNTED_WEAPON)continue e}let e=this.getPlayerById(r.data.id);if(e&&e.bSpawnProtection)continue e;break;case ObjectType.DOOR:if(!r.data.bClosed)continue e;break;case ObjectType.CRATE:if(r.data.crateType==Crate.BOMB)continue e}let g=1,I=this.Dist(a,t,r.position[0],r.position[1]);if(I>i)continue;let T=!p||this.checkLineOfSight([a,t],r.position,!0,r);if(T&&r.mass!=Number.MAX_VALUE)switch(r.data.type){case ObjectType.OBSTACLE:case ObjectType.DROPPED_WEAPON:case ObjectType.CAR:case ObjectType.TANK:case ObjectType.HELICOPTER:let e=this.Angle(a,t,r.position[0],r.position[1]);if(!isNaN(e)){let a=s/r.mass*(.1*this.Random(5,10));r.applyImpulse([Math.cos(e)*a,Math.sin(e)*a]),r.angularVelocity+=e/r.mass*this.Random(1,10)}}if(r.data.health>0){if(r.data.type==ObjectType.DOOR&&r.data.bClosed&&r.data.material!=Material.METAL&&this.setDoorClosed(r,!1,m),!T)continue;let a=!1,t=!1;if(h?(t=r.data.id==h.id,a=r.data.team==h.team&&!t):m&&(t=r.data.id==m.data.id,a=r.data.team==m.data.team&&!t),r.data.type==ObjectType.MOUNTED_WEAPON&&(a=a||m&&r.data.id==m.data.id),this.game.bFriendlyFire||(a=a||t),"bomb"==o&&(a=!1),a)continue;if(this.isVehicle(r)&&this.vehicleHasOccupant(r)&&a&&!this.game.bFriendlyFire)continue;if(this.isVehicle(r)){if(a);else if(r.data.id==l)d=Math.round(.25*d);else if(g=1-I/i,d=s*g,r.data.type==ObjectType.MOUNTED_WEAPON)if("stun"==o||e.modId==Mods.GRENADE_STUN){r.data.bStunned=!0;let e=Math.round(this.game.settings.fps*this.settings.maxStunTime);r.data.stunTimer=Math.ceil(e*g),console.log(e,r.data.stunTimer),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:r.data.id,type:GameServer.PAWN_STUN,bValue:!0,time:r.data.stunTimer})}else if("flashbang"==o||e.modId==Mods.GRENADE_FLASH){r.data.bFlashed=!0;let e=Math.round(this.game.settings.fps*this.settings.maxFlashTime);r.data.flashTimer=Math.ceil(e*g),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:r.data.id,type:GameServer.PAWN_FLASH,bValue:!0,flashIntensity:1,time:r.data.flashTimer})}}else{g=1-I/i,d=s*g;let a=1;if("stun"==o||e.modId==Mods.GRENADE_STUN){r.data.bStunned=!0;let e=Math.round(this.game.settings.fps*this.settings.maxStunTime/Math.max(1,r.mass));this.characterHasEquipment(r,"blast_vest")&&(e*=.5),r.data.stunTimer=Math.max(2*this.game.settings.fps,Math.ceil(e*g*a)),r.data.bImmuneToStun&&(r.data.stunTimer=1),r.data.aimRotation+=this.ToRad(this.Random(-30,30)),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:r.data.id,type:GameServer.PAWN_STUN,bValue:!0,time:r.data.stunTimer})}else if("flashbang"==o||e.modId==Mods.GRENADE_FLASH){r.data.bFlashed=!0,r.data.flashIntensity=Math.min(1,2*g);let e=Math.round(this.game.settings.fps*this.settings.maxFlashTime/Math.max(1,r.mass));this.characterHasEquipment(r,"blast_vest")&&(e*=.5),r.data.flashTimer=Math.ceil(e*g*a),r.data.bImmuneToStun&&(r.data.flashTimer=1),this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:r.data.id,type:GameServer.PAWN_FLASH,bValue:!0,flashIntensity:r.data.flashIntensity,time:r.data.flashTimer})}}}else d=0;if(d>0)switch(r.data.type){case ObjectType.EQUIPMENT:r.data.id!=n&&(r.data.weaponData.bMine?(h&&(r.data.ownerId=h.id),r.data.bTriggered=!0,r.data.triggerTimer=2):this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:d,pawnId:r.data.id,attackerId:h?h.id:n,causerId:n,weaponId:o,bDirectlyCausedByPlayer:!0}));break;case ObjectType.GRENADE:r.data.bRemoteDetonation&&(r.data.bDetonationTimerEnabled=!0,r.data.detonationTimer=2);break;default:let a=this.characterHasEquipment(r,"blast_vest");a&&(d*=.5),this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:d,pawnId:r.data.id,attackerId:h?h.id:n,causerId:n,weaponId:o,useId:e.useId,bDirectlyCausedByPlayer:!0,bBlastVest:a})}}}detonate(e,a){if(e&&e.data){var t=e.data;if(t.bDetonated)return;switch(t.bDetonated=!0,t.type){case ObjectType.CRATE:switch(this.game.gameModeId){case GameMode.DESTRUCTION:var i=this.game.gameModeData.bombs;i[t.bombNum]=null;var s=0==t.team?1:0,r=this.game.gameModeData.scores;if(r[s]++,this.onEvent({eventId:GameServer.EVENT_GAME_UPDATE,data:{scores:r,bombs:i,bombTeam:s,bombNum:t.bombNum}}),r[s]>=this.game.gameModeData.scoreLimit)this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:s,cameraTargetId:t.id});else this.getBombCrates(t.team).length<=1&&this.requestEvent({eventId:GameServer.EVENT_GAME_END,condition:MatchState.END_CONDITION_SCORE,winningTeam:s,cameraTargetId:t.id})}this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:e.position,radius:500,damage:1e3,causerId:t.id,playerId:t.planterId,weaponId:"bomb"}),this.removeNextStep(e);break;case ObjectType.OBSTACLE:var n=this.getPlayerById(t.playerId);switch(n&&(t.team=n.team),t.obstacleId){case"barrel_explosive":this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:e.position,radius:350,damage:500,playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:"barrel",bDirectlyCausedByPlayer:!0,directHitId:a}),this.removeNextStep(e);break;case"barrel_poison":this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:e.position,radius:350,damage:500,playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:"barrel",bDirectlyCausedByPlayer:!0,directHitId:a});for(var o=10,d=this.getWeaponData(Dinosaur.DILO),l=0;l<o;l++)this.createFlame(e.position,[this.Random(-500,500),this.Random(-500,500)],e.data.team,t.playerId?t.playerId:t.id,d,d.fireTime);this.removeNextStep(e);break;case"barrel_oil":this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:e.position,radius:350,damage:500,playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:"barrel",bDirectlyCausedByPlayer:!0,directHitId:a});for(o=10,d=this.getWeaponData("molotov"),l=0;l<o;l++)this.createFlame(e.position,[this.Random(-500,500),this.Random(-500,500)],e.data.team,t.playerId?t.playerId:t.id,d,d.fireTime);this.removeNextStep(e)}break;case ObjectType.EQUIPMENT:if(d=t.weaponData){var h=e.position[0],m=e.position[1]-10;switch(d.id){case"claymore":h+=50*t.scale,m-=10}this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:[h,m],radius:d.radius,damage:d.damage,playerId:t.ownerId?t.ownerId:t.id,causerId:t.id,weaponId:d.id,bDirectlyCausedByPlayer:!0,directHitId:a})}this.removeNextStep(e);break;case ObjectType.GRENADE:if(d=t.weaponData?t.weaponData:this.getWeaponData(t.weaponId),t.stuckToId)this.getObjectById(t.stuckToId)&&this.requestEvent({eventId:GameServer.EVENT_PAWN_DAMAGE,damageType:DamageType.DAMAGE_EXPLOSIVE,damageAmount:d.damage,pawnId:t.stuckToId,attackerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:d.id,useId:d.id,modId:t.modId,bDirectlyCausedByPlayer:!0});if("smoke"==t.weaponId||t.modId==Mods.GRENADE_SMOKE)e.data.destroyTimer=5*this.game.settings.fps,this.setDataValue(e,"bActivated",!0),this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:e.position,radius:200,damage:Math.max(50,d.damage),playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:d.id,modId:t.modId,bDirectlyCausedByPlayer:!0,directHitId:a}),e.shapes[0].sensor=!1,t.modId==Mods.GRENADE_SMOKE&&(e.velocity=[0,0]);else if("napalm"==d.id||"molotov"==d.id||t.modId==Mods.GRENADE_FIRE){var c=e.previousPosition?e.previousPosition:e.position;this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:c,radius:d.radius,damage:d.damage,playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:t.weaponId,modId:t.modId,bDirectlyCausedByPlayer:!0,directHitId:a});o=15;var p=d;t.modId==Mods.GRENADE_FIRE&&(p=this.getWeaponData("napalm"));for(l=0;l<o;l++)this.createFlame(e.position,[this.Random(-500,500),this.Random(-500,500)],e.data.team,t.playerId?t.playerId:t.id,p,p.fireTime);this.removeNextStep(e)}else{t.minTimer;var g=e.previousPosition;0==g[0]&&0==g[1]&&(g=e.position),g[1]-=10;var E=t.killstreakId?t.killstreakId:t.weaponId;this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:g,radius:t.radius,damage:t.damage,playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:E,modId:t.modId,bDirectlyCausedByPlayer:!0}),e.constraint&&(this.game.world.removeConstraint(e.constraint),delete e.constraint,e.collisionMask=CollisionGroups.GROUND|CollisionGroups.PROJECTILE),this.removeNextStep(e)}break;case ObjectType.ROCKET:var b=e.previousPosition;if(0==b[0]&&0==b[1]&&(b=e.position),this.createExplosion({eventId:GameServer.EVENT_SPAWN_EXPLOSION,position:b,radius:t.radius,damage:t.damage,playerId:t.playerId?t.playerId:t.id,causerId:t.id,weaponId:t.useWeaponId?t.useWeaponId:t.weaponId,bDirectlyCausedByPlayer:!0,bLOS:null!=t.enemyId}),t.rocketType==Rocket.NAPALM){o=15;t.weaponId;var u=5;for(l=0;l<o;l++)this.createFlame(e.position,[this.Random(-500,500),this.Random(-500,500)],e.data.team,t.playerId?t.playerId:t.id,this.getWeaponData("napalm"),u)}this.removeNextStep(e)}}}isMeleeWeapon(e){return!!e&&((e.type==Weapon.TYPE_MELEE||e.bMelee)&&!e.bEquipment)}applyWeaponMods(e,a){if(e&&null!=e.mag&&a){e.mods={};var t=e.mods;if(a){var i=this.getWeaponData(e.id);if(t[Mods.TYPE_OPTIC]=a[Mods.TYPE_OPTIC],t[Mods.TYPE_BARREL]=a[Mods.TYPE_BARREL],t[Mods.TYPE_ACCESSORY]=a[Mods.TYPE_ACCESSORY],t[Mods.TYPE_AMMO]=a[Mods.TYPE_AMMO],e.mag=Math.min(e.mag,i.magSize),e.fireMode=i.fireMode,e.accuracy=i.accuracy,e.fireRate=i.fireRate,e.burstFireRate=i.burstFireRate,e.boltDelayTimer=i.boltDelayTimer,e.recoil=i.recoil,e.speedModifier=i.speedModifier,e.range=i.range,e.penetration=i.penetration,e.damage=i.damage,e.radius=i.radius,e.magSize=i.magSize,e.reloadTime=i.reloadTime,e.bExplosive=i.bExplosive,e.rocketType=i.rocketType,this.removeUndefinedKeys(e),e.reloadMultiplier&&(e.reloadMultiplier=1),e.type==Weapon.TYPE_SNIPER)switch(t[Mods.TYPE_OPTIC]){case Mods.OPTIC_REFLEX:e.lookModifier=1.2;break;case Mods.OPTIC_EOTECH:e.lookModifier=1.35;break;case Mods.OPTIC_ACOG:e.lookModifier=1.5}else switch(t[Mods.TYPE_OPTIC]){case Mods.OPTIC_REFLEX:e.lookModifier=i.lookModifier+.025;break;case Mods.OPTIC_EOTECH:e.lookModifier=i.lookModifier+.05;break;case Mods.OPTIC_ACOG:e.lookModifier=i.lookModifier+.1}switch(t[Mods.TYPE_ACCESSORY]){case Mods.ACCESSORY_MAG_ASSIST:e.reloadMultiplier=.5,e.reloadTime=.5*i.reloadTime;break;case Mods.ACCESSORY_GRIP:e.recoil=.5*e.recoil;break;case Mods.ACCESSORY_LASER:e.type==Weapon.TYPE_SHOTGUN?e.accuracy=.9*e.accuracy:e.accuracy=.75*e.accuracy;break;case Mods.ACCESSORY_M203:case Mods.ACCESSORY_M320:case Mods.ACCESSORY_GP25:case Mods.ACCESSORY_MASTERKEY:e.barrel&&t[Mods.TYPE_ACCESSORY]!=e.barrel.id&&delete e.barrel,e.barrel||(e.barrel=this.getWeaponData(t[Mods.TYPE_ACCESSORY]))}switch(t[Mods.TYPE_BARREL]){case Mods.BARREL_SILENCER:e.recoil=.75*e.recoil,e.dropRange=Math.round(.75*e.dropRange);break;case Mods.BARREL_COMPENSATOR:e.recoil=.5*e.recoil;break;case Mods.BARREL_BRAKE:e.recoil=1.05*e.recoil,e.damage=Math.round(1.1*e.damage);break;case Mods.BARREL_HEAVY:e.dropRange=Math.round(1.25*e.dropRange)}switch(t[Mods.TYPE_AMMO]){case Mods.AMMO_FMJ:e.damage=Math.round(1.1*e.damage);break;case Mods.AMMO_PIERCING:e.penetration=e.penetration+1;break;case Mods.AMMO_EXTENDED:switch(e.id){case"l115a3":case"scout":case"dsr1":case"tac50":case"m82":case"intervention":case"flamethrower":e.magSize=Math.floor(2*i.magSize);break;default:e.magSize=Math.floor(1.5*i.magSize)}e.mag=e.magSize;break;case Mods.AMMO_SLUG:e.bSlug=!0,e.damage*=5,e.accuracy*=.25;break;case Mods.AMMO_DRAGONS_BREATH:e.bFlame=!0,e.damage*=.5,e.fireDamage=e.damage,e.fireTime=1,e.velocity=1400;break;case Mods.GRENADE_FIRE:e.damage*=.5,e.fireDamage=10,e.bRocket&&(e.rocketType=Rocket.NAPALM);break;case Mods.GRENADE_HE:e.damage*=.75,e.radius*=1.5;break;case Mods.GRENADE_FLASH:case Mods.GRENADE_STUN:case Mods.GRENADE_SMOKE:e.damage*=.5;break;case Mods.AMMO_EXPLOSIVE:e.bExplosive=!0,e.penetration=1;break;case Mods.ARROW_EXPLOSIVE:"arrow"==e.round&&(e.bExplosive=!0,e.penetration=1);break;case Mods.ARROW_POISON:e.round,e.bPoison=!0,e.damage*=.5,e.fireTime=1,e.fireDamage=10}}}}matchInProgress(){return!(!this.game||this.game.state!=MatchState.STATE_IN_PROGRESS)}isPreGame(){return!(!this.game||this.game.state!=MatchState.STATE_PRE_GAME)}matchHasEnded(){return!this.game||this.game.state==MatchState.STATE_POST_GAME}roundHasEnded(){return!this.game||this.game.state==MatchState.STATE_POST_ROUND}isTeamGameMode(){if(this.game.gameSettings.bTeam)return!0;var e=this.getGameModeData(this.game.gameModeId);return!!e&&e.bTeam}getGameModeData(e){for(var a=this.data.modes,t=0;t<a.length;t++){var i=a[t];if(i.id==e)return this.clone(i)}return null}getSharedData(e,a){var t=this.data.shared;return t[e]?a?this.clone(t[e]):t[e]:null}getVehicleData(e){for(var a=this.data.vehicles,t=0;t<a.length;t++){var i=a[t];if(i.id==e)return i}return null}getModData(e){for(var a=this.data.mods,t=0;t<a.length;t++){var i=a[t];if(i.id==e)return this.clone(i)}return null}getModMoneyCost(e){if(e){if(e.moneyCost)return e.moneyCost;if(e.score)return Math.round(.1*e.score)}return 100}getWeaponMoneyCost(e){if(e){var a=e;if(a.moneyCost)return e.moneyCost;if(a.score){var t=.1;switch(e.type){case Weapon.TYPE_LAUNCHER:t=.5;break;case Weapon.TYPE_LMG:case Weapon.TYPE_DMR:case Weapon.TYPE_SNIPER:t=.2;break;case Weapon.TYPE_PISTOL:case Weapon.TYPE_MACHINE_PISTOL:t=.075;break;case Weapon.TYPE_MELEE:t=.05}return this.RoundToNearest(a.score*t)}}return 100}getWeaponData(e,a){for(var t=this.data.weapons,i=0;i<t.length;i++){var s=t[i];if(s.id==e){var r=this.clone(s);if(a)for(var n=Object.keys(a),o=0;o<n.length;o++)null!=a[n[o]]&&(r[n[o]]=a[n[o]]);if(this.game.bSurvival&&!r.bVehicle)switch(r.id){case"smoke":case"health_box":case"ammo_box":break;default:r.bPassive||!r.ammoMax||!r.bEquipment&&r.type!=Weapon.TYPE_GRENADE||(r.ammoMax=4)}if(delete r.desc,delete r.unlockLevel,delete r.unlockPrestige,delete r.headshotMultiplier,r.reloadTime||(r.reloadTime=1),r.range&&!r.bDinosaur&&!this.isMeleeWeapon(r)&&!r.bFlame&&"tazer"!=r.id&&!r.bEquipment){switch(r.defaultRange=r.range,r.round){case"arrow":r.dropRange=r.range;break;default:r.dropRange=.5*r.range}r.range=r.type==Weapon.TYPE_SHOTGUN||r.bShotgun?2e3:4e3}var d=(n=Object.keys(r)).length;for(i=0;i<d;i++){let e=n[i],a=r[e];"boolean"==typeof a&&(r[e]=1==a?1:0,a||delete r[e])}return r}}return null}getRandomBotName(){var e=this.data.bots;return e?e[this.Random(0,e.length-1)]:"Bot"}getSpriteData(e){var a=this.data.sprites;return a?a[e]:null}getWorldWeaponData(e){var a=this.data.weapons_world;if(a){var t=a.frames[e];if(t)return t.frame}return console.warn("Missing frame data:",e),{x:0,y:0,w:32,h:32}}getMapData(e){for(var a=this.data.maps,t=0;t<a.length;t++){var i=a[t];if(i.id==e)return i}return null}getItemData(e){for(var a=this.data.items,t=0;t<a.length;t++){var i=a[t];if(i.id==e)return i}return null}exitAllPawnsFromVehicle(e){if(e){var a=e.data.seats;if(a)for(var t=0;t<a.length;t++){let e=a[t];if(e.pawnId){let a=e.pawnId;this.exitVehicle(this.getObjectById(a)),this.clearPlayerControllable(a)}}}}killAllPawnsInVehicle(e){if(e){var a=e.data.seats;if(a)for(var t=0;t<a.length;t++){let e=a[t];e.pawnId&&this.killPawn(e.pawnId)}}}removeNextStep(e){if(e){var a=e.data;return a&&(a.bPendingRemoval=!0,this.isVehicle(e)&&(a.bKillOccupantsWhenDestroyed?this.killAllPawnsInVehicle(e):this.exitAllPawnsFromVehicle(e))),this.game.toRemove.push(e),!0}return console.log("No body to remove"),!1}setObjectPosition(e,a){e&&this.isValidArray(a)&&(e.position[0]=a[0],e.position[1]=a[1],this.onEvent({eventId:GameServer.EVENT_PAWN_ACTION,pawnId:e.data.id,type:GameServer.PAWN_MOVE,position:e.position}),this.pushObjectUpdate(e.data.id,["position"]))}getObjectById(e){if(!this.game||!e)return null;var a=this.game.objects[e];return a&&a.data&&!a.data.bPendingRemoval?a:null}getPawns(e){for(var a=[],t=this.getTypes([ObjectType.CHARACTER,ObjectType.DINOSAUR,ObjectType.DUMMY,ObjectType.HELICOPTER,ObjectType.TANK,ObjectType.CAR,ObjectType.MOUNTED_WEAPON,ObjectType.EGG]),i=0;i<t.length;i++){let s=t[i];!s.data||s.data.bPendingRemoval||s.data.bUntargetable||null!=e&&s.data.team!=e||a.push(s)}return a}getBotClasses(){for(var e=this.clone(this.getSharedData("classes")),a=[Weapon.TYPE_RIFLE,Weapon.TYPE_SMG,Weapon.TYPE_LMG,Weapon.TYPE_SNIPER],t=Object.keys(e),i=0;i<t.length;i++){var s=t[i],r=e[s],n=r.primary;switch(this.Random(1,5)){case 1:var o=Weapon.TYPE_DMR;break;case 2:o=Weapon.TYPE_CARBINE;break;default:o=a[i]}var d=this.getAllWeaponsByType(o);n.id=d[this.Random(0,d.length-1)].id;var l=this.getWeaponData(n.id);this.setRandomWeaponMods(l),n.mods=l.mods;var h=r.secondary;switch(s){case Classes.COMMANDO:var m=[Weapon.TYPE_LAUNCHER];break;default:m=[Weapon.TYPE_PISTOL,Weapon.TYPE_MACHINE_PISTOL,Weapon.TYPE_SHOTGUN]}d=this.getAllWeaponsByType(m[this.Random(0,m.length-1)]);switch(s){case Classes.SUPPORT:d.push(this.getWeaponData("riot_shield"));break;case Classes.HUNTER:d.push(this.getWeaponData("bow"),this.getWeaponData("crossbow"))}h.id=d[this.Random(0,d.length-1)].id;var c=this.getWeaponData(h.id);this.setRandomWeaponMods(c),h.mods=c.mods;var p=this.getAllWeaponsByType(Weapon.TYPE_GRENADE);r.grenade=p[this.Random(0,p.length-1)].id,r.melee=this.getRandomMelee().id,r.avatar[Faction.DINOGEN].body=this.getRandomBody(Faction.DINOGEN),r.avatar[Faction.DINOGEN].head=this.RandomBoolean()?Character.HEAD_NONE:Character.HEAD_US_HELMET,r.avatar[Faction.MILITIA].body=this.getRandomBody(Faction.MILITIA),r.avatar[Faction.MILITIA].head=this.RandomBoolean()?Character.HEAD_NONE:Character.HEAD_OPFOR_HELMET,r.avatar[Faction.DINOGEN].facewear=this.Random(1,!1)?Character.FACEWEAR_GAITER:Character.FACEWEAR_NONE,r.avatar[Faction.MILITIA].facewear=this.Random(1,!1)?Character.FACEWEAR_GAITER:Character.FACEWEAR_NONE,r.avatar[Faction.DINOGEN].hair=this.getRandomHair(),r.avatar[Faction.MILITIA].hair=this.getRandomHair(),r.avatar[Faction.DINOGEN].hairColour=this.getRandomHairColour(),r.avatar[Faction.MILITIA].hairColour=this.getRandomHairColour(),r.avatar[Faction.DINOGEN].legs=this.getRandomLegs(),r.avatar[Faction.MILITIA].legs=this.getRandomLegs()}return e.preferredFaction=this.game.bSurvival||this.RandomBoolean()?Faction.DINOGEN:Faction.MILITIA,e}getAvatarDataById(e){switch(e){case AvatarPresets.ZOMBIE:var a=[Character.FACE_ZOMBIE_1,Character.FACE_ZOMBIE_2,Character.FACE_ZOMBIE_3,Character.FACE_ZOMBIE_4,Character.FACE_ZOMBIE_SPRINTER];return{body:(t=[Character.BODY_ZOMBIE,Character.BODY_ZOMBIE_2,Character.BODY_ZOMBIE_3])[this.Random(0,t.length-1)],hair:Character.HAIR_BALD,face:a[this.Random(0,a.length-1)],legs:Character.LEGS_BAREFOOT};case AvatarPresets.ZOMBIE_JUGGERNAUT:return{body:Character.BODY_JUGGERNAUT,hair:Character.HAIR_BALD,face:(a=[Character.FACE_ZOMBIE_1,Character.FACE_ZOMBIE_2,Character.FACE_ZOMBIE_3,Character.FACE_ZOMBIE_4,Character.FACE_ZOMBIE_SPRINTER])[this.Random(0,a.length-1)],legs:Character.LEGS_JUGGERNAUT};case AvatarPresets.PETERSON:return{body:Character.BODY_DINOGEN,eyewear:Character.EYEWEAR_GLASSES,hair:Character.HAIR_HORSESHOE,beard:Character.BEARD_MOUSTACHE,hairColour:Character.HAIR_COLOUR_WHITE};case AvatarPresets.BROCK:return{body:Character.BODY_DINOGEN_RIG,hair:Character.HAIR_STYLED,beard:Character.BEARD_GOATEE,hairColour:Character.HAIR_COLOUR_BROWN};case AvatarPresets.LIAM:return{body:Character.BODY_DINOGEN_HEAVY,eyewear:Character.EYEWEAR_GLASSES,hair:Character.HAIR_SHORT,beard:Character.BEARD_FULL,hairColour:Character.HAIR_COLOUR_BLACK};case AvatarPresets.JUGGERNAUT:return{body:Character.BODY_JUGGERNAUT,head:Character.HEAD_JUGGERNAUT_HELMET,facewear:Character.FACEWEAR_MASK,legs:Character.LEGS_JUGGERNAUT};case AvatarPresets.COMMANDER:return{body:Character.BODY_JUGGERNAUT,head:Character.HEAD_OPFOR_COMMANDER,facewear:Character.FACEWEAR_NONE,legs:Character.LEGS_JUGGERNAUT};case AvatarPresets.SHIRTLESS:return{body:Character.BODY_SHIRTLESS};case AvatarPresets.MILITIA:return{body:Character.BODY_MILITIA,head:Character.HEAD_OPFOR_HELMET};case AvatarPresets.DINOGEN_RANDOM:var t,i=[null,Character.HEAD_US_HELMET_TACTICAL],s=[Character.LEGS_SHORTS,Character.LEGS_BOOTS];return{body:(t=[Character.BODY_DINOGEN,Character.BODY_DINOGEN_RIG])[this.Random(0,t.length-1)],head:i[this.Random(0,i.length-1)],hair:this.getRandomHair(),hairColour:this.getRandomHairColour(),legs:s[this.Random(0,s.length-1)]};case AvatarPresets.DINOGEN_HEAVY:return{body:Character.BODY_DINOGEN_HEAVY,head:Character.HEAD_US_HELMET_TACTICAL};case AvatarPresets.DINOGEN:default:return{body:Character.BODY_DINOGEN,head:Character.HEAD_US_HELMET}}}getRandomBody(e){switch(e){case Faction.MILITIA:var a=[Character.BODY_MILITIA,Character.BODY_MILITIA_RIG,Character.BODY_MILITIA_HEAVY];break;case Faction.DINOGEN:default:a=[Character.BODY_DINOGEN,Character.BODY_DINOGEN_RIG,Character.BODY_DINOGEN_HEAVY]}return a[this.Random(0,a.length-1)]}getRandomHairColour(){var e=[Character.HAIR_COLOUR_BROWN,Character.HAIR_COLOUR_BROWN_LIGHT,Character.HAIR_COLOUR_BLACK,Character.HAIR_COLOUR_BLONDE,Character.HAIR_COLOUR_GINGER];return e[this.Random(0,e.length-1)]}getRandomHair(){var e=[Character.HAIR_BALD,Character.HAIR_SHORT,Character.HAIR_LONG,Character.HAIR_MOHAWK,Character.HAIR_PONYTAIL,Character.HAIR_STYLED,Character.HAIR_UNDERCUT,Character.HAIR_HORSESHOE];return e[this.Random(0,e.length-1)]}getRandomLegs(){var e=[Character.LEGS_BOOTS,Character.LEGS_SHORTS];return e[this.Random(0,e.length-1)]}setRandomWeaponMods(e){if(!(e.bEquipment||e.bVehicle||this.isMeleeWeapon(e))){switch(e.id){case"riot_shield":case"flamethrower":case"bow":case"crossbow":return}e.mods||(e.mods={});var a=this.getModsForWeapon(e.id,Mods.TYPE_OPTIC);e.mods.optic=a[this.Random(0,a.length-1)],a=this.getModsForWeapon(e.id,Mods.TYPE_ACCESSORY),e.mods.accessory=a[this.Random(0,a.length-1)],a=this.getModsForWeapon(e.id,Mods.TYPE_BARREL),e.mods.barrel=a[this.Random(0,a.length-1)],a=this.getModsForWeapon(e.id,Mods.TYPE_AMMO),e.mods.ammo=a[this.Random(0,a.length-1)],this.applyWeaponMods(e,e.mods)}}getAllModsForWeapon(e){var a={},t=this.getModsForWeapon(e,Mods.TYPE_OPTIC);return a.optic=t[this.Random(0,t.length-1)],t=this.getModsForWeapon(e,Mods.TYPE_ACCESSORY),a.accessory=t[this.Random(0,t.length-1)],t=this.getModsForWeapon(e,Mods.TYPE_BARREL),a.barrel=t[this.Random(0,t.length-1)],t=this.getModsForWeapon(e,Mods.TYPE_AMMO),a.ammo=t[this.Random(0,t.length-1)],a}getModsForWeapon(e,a){var t=[null],i=this.getWeaponData(e);if(i&&!this.isMeleeWeapon(i)){if(i.bVehicle)return t;if("bow"==i.id)return t;switch(a){case Mods.TYPE_OPTIC:switch(i.id){case"deagle":case"m82":case"tac50":return t}switch(i.type){case Weapon.TYPE_PISTOL:case Weapon.TYPE_MACHINE_PISTOL:case Weapon.TYPE_SHOTGUN:t.push(Mods.OPTIC_REFLEX,Mods.OPTIC_EOTECH);break;case Weapon.TYPE_LAUNCHER:return t;case Weapon.TYPE_SNIPER:t=[Mods.OPTIC_SCOPE,Mods.OPTIC_REFLEX,Mods.OPTIC_EOTECH,Mods.OPTIC_ACOG];break;case Weapon.TYPE_DMR:t=[Mods.OPTIC_SCOPE_DMR,Mods.OPTIC_REFLEX,Mods.OPTIC_EOTECH,Mods.OPTIC_ACOG];break;default:t.push(Mods.OPTIC_REFLEX,Mods.OPTIC_EOTECH,Mods.OPTIC_ACOG)}break;case Mods.TYPE_ACCESSORY:switch(i.type){case Weapon.TYPE_PISTOL:case Weapon.TYPE_MACHINE_PISTOL:case Weapon.TYPE_SHOTGUN:t.push(Mods.ACCESSORY_LASER);break;default:t.push(Mods.ACCESSORY_LASER,Mods.ACCESSORY_GRIP,Mods.ACCESSORY_GRIP_ANGLED),i.type}!i.bGrenade&&!i.bRocket&&!i.bSingleRoundLoaded&&i.magSize>1&&t.push(Mods.ACCESSORY_MAG_ASSIST);break;case Mods.TYPE_BARREL:if("m82"==i.id||"tac50"==i.id||"pgm"==i.id)t.push(Mods.BARREL_COMPENSATOR,Mods.BARREL_BRAKE,Mods.BARREL_HEAVY);else switch(i.type){case Weapon.TYPE_LAUNCHER:case Weapon.TYPE_SHOTGUN:break;case Weapon.TYPE_DMR:case Weapon.TYPE_SNIPER:case Weapon.TYPE_RIFLE:case Weapon.TYPE_CARBINE:case Weapon.TYPE_SMG:i.bSilenced||i.bRevolver?t.push(Mods.BARREL_COMPENSATOR,Mods.BARREL_BRAKE,Mods.BARREL_HEAVY):t.push(Mods.BARREL_COMPENSATOR,Mods.BARREL_BRAKE,Mods.BARREL_HEAVY,Mods.BARREL_SILENCER);break;case Weapon.TYPE_WEAPON_TACTICAL:return t;default:t.push(Mods.BARREL_COMPENSATOR,Mods.BARREL_BRAKE,Mods.BARREL_HEAVY)}break;case Mods.TYPE_AMMO:switch(i.type){case Weapon.TYPE_LAUNCHER:i.bGrenade&&1==i.magSize&&t.push(null,Mods.GRENADE_STUN,Mods.GRENADE_FLASH,Mods.GRENADE_FIRE,Mods.GRENADE_HE);break;case Weapon.TYPE_WEAPON_TACTICAL:return t;default:t.push(Mods.AMMO_FMJ,Mods.AMMO_PIERCING,Mods.AMMO_HOLLOW_POINT,Mods.AMMO_EXTENDED),i.type==Weapon.TYPE_SHOTGUN&&(i.bBoltAction&&t.push(Mods.AMMO_SLUG),t.push(Mods.AMMO_DRAGONS_BREATH))}}}return t}getAllWeaponsByType(e){for(var a=[],t=0;t<this.data.weapons.length;t++){var i=this.data.weapons[t];i.bHidden||i.bVehicle||i.bDinosaur||i.type==e&&a.push(i)}return a}getAllWeapons(){for(var e=[],a=0;a<this.data.weapons.length;a++){var t=this.data.weapons[a];t.bHidden||t.bVehicle||t.bDinosaur||t.bZombie||e.push(t)}return e}getAllFirearms(){for(var e=[],a=0;a<this.data.weapons.length;a++){var t=this.data.weapons[a];t.bHidden||t.bVehicle||t.bDinosaur||t.bZombie||t.bEquipment||this.isMeleeWeapon(t)||e.push(t)}return e}getAllEquipment(){for(var e=[],a=0;a<this.data.weapons.length;a++){var t=this.data.weapons[a];t.bHidden||t.bVehicle||t.bDinosaur||t.bZombie||!t.bEquipment||this.isMeleeWeapon(t)||t.type==Weapon.TYPE_GRENADE||e.push(t)}return e}getAllGrenades(){for(var e=[],a=0;a<this.data.weapons.length;a++){var t=this.data.weapons[a];t.bHidden||t.bVehicle||t.bDinosaur||t.bZombie||this.isMeleeWeapon(t)||t.type!=Weapon.TYPE_GRENADE||e.push(t)}return e}getAllMelees(){for(var e=[],a=0;a<this.data.weapons.length;a++){var t=this.data.weapons[a];t.bHidden||t.bVehicle||t.bDinosaur||t.bZombie||t.bEquipment||!this.isMeleeWeapon(t)||t.type!=Weapon.TYPE_MELEE||e.push(t)}return e}getRandomWeapon(){var e=this.getAllWeapons(),a=this.clone(e[this.Random(0,e.length-1)]);return this.setRandomWeaponMods(a),a}getRandomHeavyWeapon(){for(var e=this.getAllWeaponsByType(Weapon.TYPE_LMG).concat(this.getAllWeaponsByType(Weapon.TYPE_LAUNCHER)),a=["railgun","minigun","flamethrower","m82","tac50"],t=0;t<a.length;t++)e.push(this.getWeaponData(a[t]));var i=this.clone(e[this.Random(0,e.length-1)]);return this.setRandomWeaponMods(i),i}getRandomFirearm(){var e=this.getAllFirearms(),a=this.clone(e[this.Random(0,e.length-1)]);return this.setRandomWeaponMods(a),a}getRandomEquipment(){var e=this.getAllEquipment();return this.clone(e[this.Random(0,e.length-1)])}getRandomGrenade(){var e=this.getAllGrenades();return this.clone(e[this.Random(0,e.length-1)])}getRandomMelee(){var e=this.getAllMelees();return this.clone(e[this.Random(0,e.length-1)])}getRandomUniqueId(){for(var e=0;e<100;e++){var a=Math.random().toString(36).substr(2,3);if(!this.getObjectById(a))return a}return a}pxmi(e){return e}loadPolygon(e,a,t,i,s,r){var n=this.getSpriteData(e);if(n){for(var o=this.p2,d=o.vec2.create(),l=0;l<n.length;l++){for(var h=[],m=0;m<n[l].shape.length;m+=2)h.push([this.pxmi(1*n[l].shape[m]),this.pxmi(1*n[l].shape[m+1])]);var c=new this.p2.Convex({vertices:h});c.material=r.material,c.collisionGroup=r.collisionGroup,c.collisionMask=r.collisionMask;for(var p=0;p!==c.vertices.length;p++){var g=c.vertices[p];o.vec2.sub(g,g,c.centerOfMass)}o.vec2.scale(d,c.centerOfMass,1),d[0]-=this.pxmi(t/2),d[1]-=this.pxmi(i/2),c.updateTriangles(),c.updateCenterOfMass(),c.updateBoundingRadius(),a.addShape(c,d)}return a.aabbNeedsUpdate=!0,!0}console.log("No sprite data for",e)}getTotalVelocity(e){if(e){var a=e.velocity[0],t=e.velocity[1];return a*a+t*t}return 0}constrainVelocity(e,a){var t,i,s;(i=e.velocity[0])*i+(s=e.velocity[1])*s>a*a&&(t=Math.atan2(s,i),i=Math.cos(t)*a,s=Math.sin(t)*a,e.velocity[0]=i,e.velocity[1]=s)}optimize(e){for(var a=Object.keys(e),t=0;t<a.length;t++){var i=a[t],s=e[i];"boolean"==typeof s?e[i]=1==s?1:0:"number"==typeof s&&s%1!=0&&(e[i]=this.RoundDecimal(s))}}clone(e){return e?JSON.parse(JSON.stringify(e)):null}Random(e,a){return Math.floor(Math.random()*(a-e+1))+e}RandomAngle(){return this.ToRad(this.Random(0,360))}RandomBoolean(){return Math.random()>=.5}DistBodies(e,a){return this.Dist(e.position[0],e.position[1],a.position[0],a.position[1])}DistPositions(e,a){return this.Dist(e[0],e[1],a[0],a[1])}Dist(e,a,t,i){return Math.sqrt((e-t)*(e-t)+(a-i)*(a-i))}Angle(e,a,t,i){var s=t-e,r=i-a;return this.RoundDecimal(Math.atan2(r,s))}ToRad(e){return this.RoundDecimal(e*(Math.PI/180))}ToDeg(e){return e*(180/Math.PI)}WrapAngle(e,a){return this.RoundDecimalFine(a?this.Wrap(e,-Math.PI,Math.PI):this.Wrap(e,-180,180))}Wrap(e,a,t){var i=t-a;if(i<=0)return 0;var s=(e-a)%i;return s<0&&(s+=i),s+a}CheckValidArray(e){return!(!e||isNaN(e[0])||isNaN(e[1]))}RoundNumberArray(e){return e?[Math.round(e[0]),Math.round(e[1])]:e}RoundToNearest(e){return 5*Math.ceil(e/5)}removeUndefinedKeys(e){if(e)for(var a=Object.keys(e),t=a.length-1;t>=0;t--){let i=a[t];void 0===e[i]&&(delete e[i])}}RoundDecimal(e){return Math.trunc(100*e)/100}RoundDecimalFine(e){return Math.trunc(1e4*e)/1e4}ShuffleArray(e){for(var a,t,i=e.length;0!==i;)t=Math.floor(Math.random()*i),a=e[i-=1],e[i]=e[t],e[t]=a;return e}}"undefined"!=typeof module&&(module.exports={GameInstance:GameInstance});
